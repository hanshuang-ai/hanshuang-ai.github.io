<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>claude-code控制流与编排引擎 | 我的博客</title><meta name="author" content="寒霜"><meta name="copyright" content="寒霜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="claude-code控制流与编排引擎"><meta name="application-name" content="claude-code控制流与编排引擎"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="claude-code控制流与编排引擎"><meta property="og:url" content="https://hanshuang-ai.github.io/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/index.html"><meta property="og:site_name" content="我的博客"><meta property="og:description" content="参考链接 Control Flow &amp;amp; The Orchestration Engine控制流与编排引擎sequenceDiagram     participant User as 用户     participant MainLoop as 主循环 (tt)     participan"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="寒霜"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="参考链接 Control Flow &amp;amp; The Orchestration Engine控制流与编排引擎sequenceDiagram     participant User as 用户     participant MainLoop as 主循环 (tt)     participan"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://hanshuang-ai.github.io/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '我的博客',
  title: 'claude-code控制流与编排引擎',
  postAI: '',
  pageFillDescription: 'Control Flow amp The Orchestration Engine, 控制流与编排引擎, The Main Conversation Loop A Streaming State Machine, 主对话循环：流式状态机, Phase 1 Context Window Management, 阶段1：上下文窗口管理, Phase 2 Dynamic System Prompt Assembly, 阶段2：动态系统提示组装, Phase 3 The Streaming State Machine, 阶段3：流状态机, Phase 4 The Tool Execution Pipeline, 阶段4：工具执行管道, Phase 5 Permission Control Flow, 阶段5：权限控制流, Phase 6 Recursive Turn Management, 阶段6：递归轮次管理, Advanced Control Flow Patterns, 高级控制流模式, 1. Input Router State Machine, 1. 输入路由状态机, 2. Stream Backpressure Management, 2. 流背压管理, 3. AgentTool Hierarchical Control Flow, 3. AgentTool层次控制流, 4. Error Recovery Control Flow, 4. 错误恢复控制流, Performance Profiling Points, 性能分析点, 文件总结, 概述, 核心架构特点, 1. 主对话循环：流式状态机, 2. 上下文窗口管理, 3. 动态系统提示组装, 4. 流状态机, 工具执行管道, 并行/顺序执行策略, 执行时间分析, 权限控制系统, 多层决策树, 递归轮次管理, 高级控制流模式, 1. 输入路由状态机, 2. 流背压管理, 3. AgentTool层次控制流, 4. 错误恢复控制流, 性能分析与优化, 性能分析点, 时间优化策略, 技术创新点, 架构创新, 性能创新, 工程实践, 结论参考链接控制流与编排引擎用户主循环工具批处理器读取工具搜索工具编辑工具渲染器搜索注释并更新它们带上下文的流请求我将搜索更新显示多个文件执行工具批次并行执行只读只读进度正在读取进度正在搜索结果文件内容结果个匹配工具结果继续处理结果执行写入工具顺序执行写入进度正在编辑结果成功编辑完成继续处理结果已更新个最终响应主对话循环流式状态机的核心是异步生成器函数这是一个精密的状态机负责编排整个对话流程让我们来检视它的实际结构带时间注释重构的主循环签名完整历史内存对话长度静态提示状态通常项目上下文权限回调共享上下文恢复状态本轮对话的递归深度历史是否已压缩是否从保存点恢复阶段上下文准备阶段自动压缩检查触发时阶段系统提示组装阶段流处理阶段工具执行每个工具阶段递归或完成阶段上下文窗口管理控制流中的第一个关键决策是判断对话是否需要压缩自动压缩逻辑推断实现激进的限制消息数量后备限制基于成本的触发器快速路径先检查消息数量昂贵路径计算阶段识别要保留的消息阶段通过生成摘要阶段重构消息历史性能特性计算其中是消息内容总长度摘要生成一次额外的调用秒内存影响压缩期间临时消息存储阶段动态系统提示组装系统提示组装展现了一个精密的缓存和组合策略系统提示组合管道并行获取动态组件模型特定适配智能截断组合优先级优先级优先级优先级优先级优先级模型特定的提示工程上下文用于推理阶段流状态机流阶段实现了一个复杂的事件驱动状态机流事件处理状态机文本的直接更新累积工具输入的在策略点尝试解析阶段工具执行管道工具执行系统实现了一个精密的并行顺序执行策略并行执行编排器阶段分类工具阶段并行执行只读工具阶段顺序执行写入工具自定义带回压的并行映射实现填充初始槽位竞争下一次完成产出值继续这个生成器如果有空槽位就填充执行时间分析工具类型并发度典型延迟瓶颈读取工具并行毫秒磁盘搜索工具并行毫秒正则表达式网络获取工具并行毫秒网络编辑工具顺序毫秒验证工具顺序毫秒进程执行代理工具并行毫秒子调用阶段权限控制流权限系统实现了一个多层决策树权限决策流层级检查明确拒绝规则最高优先级层级检查模式覆盖层级检查明确允许规则层级交互式提示优先级顺序阶段递归轮次管理控制流为多轮交互实现了尾递归递归控制和状态管理检查递归深度准备下一轮状态重置压缩标志合并下一轮的消息尾递归没有活跃的流工具高级控制流模式输入路由状态机输入处理实现了一个精密的路由系统输入接收命令检测以开头以开头以开头粘贴事件默认执行命令更新状态创建合成工具主循环更新检测内容图像检测到仅文本输入路由实现带优先级的命令检测默认正常提示创建带工具使用的合成助手消息流背压管理流系统实现了精密的背压处理流的背压控制最大缓冲事件数检查压力缓冲区管理高优先级事件立即产出定期排空缓冲区最终排空不缓冲工具结果或错误层次控制流实现了一个引人入胜的父子控制结构层次执行阶段任务分析阶段生成子代理创建隔离上下文运行子代理阶段带进度的并行执行阶段合成通过进行多结果合成将这个发现合成为一个连贯的响应原始任务用于合成的快速模型错误恢复控制流系统实现了精密的错误恢复策略错误恢复状态机通用错误处理策略尝试减少策略强制压缩用压缩历史重试多提供商后备所有提供商都已耗尽性能分析点控制流包含策略性的性能分析点性能测量集成测量产出间时间文件总结概述本文档深入分析了的控制流与编排引擎揭示了其高性能响应背后的复杂状态机和并行处理机制通过反编译和逆向工程分析文档详细展示了如何通过精密的控制流程来管理复杂的对话交互工具执行和错误恢复核心架构特点主对话循环流式状态机异步生成器整个系统的核心管理完整的对话流程六阶段处理流程上下文准备自动压缩检查触发时系统提示组装流处理工具执行每个工具递归或完成上下文窗口管理智能压缩策略计数复杂度激进限制消息数量后备条消息限制成本触发器成本阈值压缩流程识别保留消息最近重要系统消息通过生成摘要重构消息历史动态系统提示组装组件化策略基础提示模型适配上下文目录结构工具定义模型特定优化详细风格上下文用于推理平衡风格上下文用于推理简洁风格上下文用于推理并行获取所有动态组件并行获取智能截断组合流状态机事件驱动架构实时更新文本增量直接更新工具输入累积后解析智能解析在策略点或尝试解析避免频繁解析失败工具执行管道并行顺序执行策略分类执行只读工具并行执行限制个并发写入工具顺序执行避免冲突性能优化自定义实现支持背压控制竞争机制确保高效完成检测动态槽位填充最大化并发利用率执行时间分析工具类型并发度典型延迟瓶颈读取工具并行毫秒磁盘搜索工具并行毫秒正则表达式网络获取工具并行毫秒网络编辑工具顺序毫秒验证工具顺序毫秒进程执行代理工具并行毫秒子调用权限控制系统多层决策树层级明确拒绝规则最高优先级层级模式覆盖检查绕过权限接受编辑模式层级明确允许规则层级交互式提示规则优先级参数本地设置项目设置策略设置用户设置递归轮次管理深度限制最大轮递归防止无限循环状态传递轮次计数器压缩标志恢复状态尾递归优化高效的递归调用实现高级控制流模式输入路由状态机智能识别斜杠命令模式合成工具使用内存模式更新粘贴事件内容类型检测合成对话模式创建用户消息和助手工具使用的合成对话流背压管理缓冲控制最大个缓冲事件压力检测动态暂停和恢复机制优先级处理工具结果和错误立即处理文本增量可缓冲定期排空非暂停状态下定期清空缓冲区层次控制流父子架构主代理任务分割子代理并行执行结果收集合成返回主代理隔离上下文子代理拥有过滤的工具集和独立的控制器多结果合成通过将多个子任务结果合成为连贯响应错误恢复控制流分类恢复策略速率限制多提供商后备上下文溢出减少或强制压缩工具错误重试或降级网络错误重试机制权限拒绝用户提示多提供商后备的故障转移性能分析与优化性能分析点生成器仪表化测量产出间延迟总执行时间产出计数集成跨服务的性能追踪关键指标首个延迟每秒数工具执行时间内存使用情况时间优化策略并行处理尽可能并行执行只读操作智能缓存系统提示组件缓存延迟加载按需加载重量级依赖背压控制防止内存溢出的流控制技术创新点架构创新流式状态机复杂的事件驱动对话管理分层权限系统灵活的多层安全控制工具编排引擎智能的并行顺序执行策略层次代理系统父子代理的任务分解和合成性能创新智能压缩基于多个维度的上下文压缩策略背压管理防止系统过载的流控制机制并发优化工具执行的最大化并行化缓存策略多层次的智能缓存机制工程实践错误恢复全面的错误分类和恢复策略性能监控深度的性能分析和追踪状态管理复杂的递归状态传递模块化设计高度解耦的组件架构结论的控制流与编排引擎体现了现代异步编程和分布式系统的最佳实践其核心价值在于高性能多层次的并行处理和智能优化可靠性全面的错误恢复和故障转移机制可扩展性模块化的工具系统和代理架构用户体验实时的进度反馈和流畅的交互这种复杂的编排设计为助手应用提供了优秀的架构模板特别是在需要处理复杂工作流程和实时交互的场景中文档的深入分析为理解现代系统的控制流设计提供了宝贵的技术参考展现了如何在大规模异步环境中保持系统的响应性和稳定性整个架构的成功关键在于平衡了复杂性功能完整性与性能响应速度通过精密的状态机和编排策略实现了既强大又高效的助手体验',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-27 17:24:10',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="我的博客" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">我的博客</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 1.05rem;">AI<sup>1</sup></a><a href="/tags/Claude/" style="font-size: 1.05rem;">Claude<sup>1</sup></a><a href="/tags/Go/" style="font-size: 1.05rem;">Go<sup>1</sup></a><a href="/tags/Golang/" style="font-size: 1.05rem;">Golang<sup>1</sup></a><a href="/tags/HTML%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">HTML基础<sup>1</sup></a><a href="/tags/SDK/" style="font-size: 1.05rem;">SDK<sup>1</sup></a><a href="/tags/base64/" style="font-size: 1.05rem;">base64<sup>1</sup></a><a href="/tags/canvas/" style="font-size: 1.05rem;">canvas<sup>2</sup></a><a href="/tags/cesium/" style="font-size: 1.05rem;">cesium<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>5</sup></a><a href="/tags/docker/" style="font-size: 1.05rem;">docker<sup>3</sup></a><a href="/tags/echart/" style="font-size: 1.05rem;">echart<sup>1</sup></a><a href="/tags/electron/" style="font-size: 1.05rem;">electron<sup>2</sup></a><a href="/tags/elementUI/" style="font-size: 1.05rem;">elementUI<sup>1</sup></a><a href="/tags/flex/" style="font-size: 1.05rem;">flex<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>3</sup></a><a href="/tags/javascript/" style="font-size: 1.05rem;">javascript<sup>1</sup></a><a href="/tags/js/" style="font-size: 1.05rem;">js<sup>2</sup></a><a href="/tags/position/" style="font-size: 1.05rem;">position<sup>1</sup></a><a href="/tags/vue/" style="font-size: 1.05rem;">vue<sup>17</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" style="font-size: 1.05rem;">事件循环<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/" style="font-size: 1.05rem;">事件监听<sup>1</sup></a><a href="/tags/%E5%8F%AF%E8%A7%86%E5%8C%96/" style="font-size: 1.05rem;">可视化<sup>3</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 1.05rem;">后端<sup>1</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/" style="font-size: 1.05rem;">基本命令<sup>2</sup></a><a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 1.05rem;">存储<sup>1</sup></a><a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 1.05rem;">实战<sup>31</sup></a><a href="/tags/%E5%B8%83%E5%B1%80/" style="font-size: 1.05rem;">布局<sup>1</sup></a><a href="/tags/%E6%89%93%E5%8D%B0/" style="font-size: 1.05rem;">打印<sup>1</sup></a><a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">插件开发<sup>1</sup></a><a href="/tags/%E6%A8%AA%E7%AB%96%E5%B1%8F%E6%A3%80%E6%B5%8B/" style="font-size: 1.05rem;">横竖屏检测<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 1.05rem;">正则<sup>4</sup></a><a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 1.05rem;">浏览器<sup>5</sup></a><a href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/" style="font-size: 1.05rem;">盒模型<sup>1</sup></a><a href="/tags/%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/" style="font-size: 1.05rem;">组件通信<sup>2</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 1.05rem;">缓存<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">编程语言<sup>1</sup></a><a href="/tags/%E8%B7%AF%E7%94%B1/" style="font-size: 1.05rem;">路由<sup>1</sup></a><a href="/tags/%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size: 1.05rem;">过滤器<sup>3</sup></a><a href="/tags/%E9%9F%B3%E9%A2%91/" style="font-size: 1.05rem;">音频<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">21</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">claude-code控制流与编排引擎</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-10-23T06:04:29.000Z" title="发表于 2025-10-23 14:04:29">2025-10-23</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-10-27T09:24:10.633Z" title="更新于 2025-10-27 17:24:10">2025-10-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为北京"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>北京</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://hanshuang-ai.github.io/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/"><header><h1 id="CrawlerTitle" itemprop="name headline">claude-code控制流与编排引擎</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">寒霜</span><time itemprop="dateCreated datePublished" datetime="2025-10-23T06:04:29.000Z" title="发表于 2025-10-23 14:04:29">2025-10-23</time><time itemprop="dateCreated datePublished" datetime="2025-10-27T09:24:10.633Z" title="更新于 2025-10-27 17:24:10">2025-10-27</time></header><p><a target="_blank" rel="noopener" href="https://southbridge-research.notion.site/Control-Flow-The-Orchestration-Engine-2055fec70db181d0b215e1b8584d03fa">参考链接</a></p>
<h1 id="Control-Flow-amp-The-Orchestration-Engine"><a href="#Control-Flow-amp-The-Orchestration-Engine" class="headerlink" title="Control Flow &amp; The Orchestration Engine"></a>Control Flow &amp; The Orchestration Engine</h1><h1 id="控制流与编排引擎"><a href="#控制流与编排引擎" class="headerlink" title="控制流与编排引擎"></a>控制流与编排引擎</h1><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">sequenceDiagram</span>
    <span class="token keyword">participant</span> User as 用户
    <span class="token keyword">participant</span> MainLoop as 主循环 <span class="token text string">(tt)</span>
    <span class="token keyword">participant</span> LLM as LLM API
    <span class="token keyword">participant</span> ToolBatch as 工具批处理器
    <span class="token keyword">participant</span> Tool1 as 读取工具
    <span class="token keyword">participant</span> Tool2 as 搜索工具
    <span class="token keyword">participant</span> Tool3 as 编辑工具
    <span class="token keyword">participant</span> UI as UI渲染器
    User<span class="token arrow operator">->></span>MainLoop<span class="token operator">:</span> <span class="token string">"搜索TODO注释并更新它们"</span>
    MainLoop<span class="token arrow operator">->></span>LLM<span class="token operator">:</span> 带上下文的流请求
    LLM<span class="token arrow operator">-->></span>MainLoop<span class="token operator">:</span> text_delta<span class="token operator">:</span> <span class="token string">"我将搜索TODOs..."</span>
    MainLoop<span class="token arrow operator">-->></span>UI<span class="token operator">:</span> 更新显示
    LLM<span class="token arrow operator">-->></span>MainLoop<span class="token operator">:</span> tool_use<span class="token operator">:</span> GrepTool
    LLM<span class="token arrow operator">-->></span>MainLoop<span class="token operator">:</span> tool_use<span class="token operator">:</span> ReadTool <span class="token text string">(多个文件)</span>
    LLM<span class="token arrow operator">-->></span>MainLoop<span class="token operator">:</span> message_stop
    MainLoop<span class="token arrow operator">->></span>ToolBatch<span class="token operator">:</span> 执行工具批次
    <span class="token keyword">par</span> 并行执行
        ToolBatch<span class="token arrow operator">->></span>Tool1<span class="token operator">:</span> ReadTool.call<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token text string">[只读]</span>
        ToolBatch<span class="token arrow operator">->></span>Tool2<span class="token operator">:</span> GrepTool.call<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token text string">[只读]</span>
        Tool1<span class="token arrow operator">-->></span>UI<span class="token operator">:</span> 进度<span class="token operator">:</span> <span class="token string">"正在读取file1.js"</span>
        Tool2<span class="token arrow operator">-->></span>UI<span class="token operator">:</span> 进度<span class="token operator">:</span> <span class="token string">"正在搜索*.js"</span>
        Tool1<span class="token arrow operator">-->></span>ToolBatch<span class="token operator">:</span> 结果<span class="token operator">:</span> 文件内容
        Tool2<span class="token arrow operator">-->></span>ToolBatch<span class="token operator">:</span> 结果<span class="token operator">:</span> 5个匹配
    <span class="token keyword">end</span>
    ToolBatch<span class="token arrow operator">->></span>MainLoop<span class="token operator">:</span> 工具结果
    MainLoop<span class="token arrow operator">->></span>LLM<span class="token operator">:</span> 继续处理结果
    LLM<span class="token arrow operator">-->></span>MainLoop<span class="token operator">:</span> tool_use<span class="token operator">:</span> EditTool
    MainLoop<span class="token arrow operator">->></span>ToolBatch<span class="token operator">:</span> 执行写入工具
    <span class="token keyword">Note over</span> ToolBatch, Tool3<span class="token operator">:</span> 顺序执行
    ToolBatch<span class="token arrow operator">->></span>Tool3<span class="token operator">:</span> EditTool.call<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token text string">[写入]</span>
    Tool3<span class="token arrow operator">-->></span>UI<span class="token operator">:</span> 进度<span class="token operator">:</span> <span class="token string">"正在编辑file1.js"</span>
    Tool3<span class="token arrow operator">-->></span>ToolBatch<span class="token operator">:</span> 结果<span class="token operator">:</span> 成功
    ToolBatch<span class="token arrow operator">->></span>MainLoop<span class="token operator">:</span> 编辑完成
    MainLoop<span class="token arrow operator">->></span>LLM<span class="token operator">:</span> 继续处理结果
    LLM<span class="token arrow operator">-->></span>MainLoop<span class="token operator">:</span> text_delta<span class="token operator">:</span> <span class="token string">"已更新5个TODOs..."</span>
    MainLoop<span class="token arrow operator">-->></span>UI<span class="token operator">:</span> 最终响应
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/1.svg" class="">

<h2 id="The-Main-Conversation-Loop-A-Streaming-State-Machine"><a href="#The-Main-Conversation-Loop-A-Streaming-State-Machine" class="headerlink" title="The Main Conversation Loop: A Streaming State Machine"></a>The Main Conversation Loop: A Streaming State Machine</h2><h2 id="主对话循环：流式状态机"><a href="#主对话循环：流式状态机" class="headerlink" title="主对话循环：流式状态机"></a>主对话循环：流式状态机</h2><p>The heart of Claude Code is the <code>tt</code> async generator function—a sophisticated state machine that orchestrates the entire conversation flow. Let’s examine its actual structure:<br>Claude Code的核心是<code>tt</code>异步生成器函数——这是一个精密的状态机，负责编排整个对话流程。让我们来检视它的实际结构：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Reconstructed main loop signature with timing annotations</span>
<span class="token comment">// 带时间注释重构的主循环签名</span>
<span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">tt</span><span class="token punctuation">(</span>
  currentMessages<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment">// Full history - Memory: O(conversation_length) // 完整历史 - 内存：O(对话长度)</span>
  baseSystemPromptString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>        <span class="token comment">// Static prompt - ~2KB // 静态提示 - ~2KB</span>
  currentGitContext<span class="token operator">:</span> GitContext<span class="token punctuation">,</span>         <span class="token comment">// Git state - ~1-5KB typically // Git状态 - 通常~1-5KB</span>
  currentClaudeMdContents<span class="token operator">:</span> ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Project context - ~5-50KB // 项目上下文 - ~5-50KB</span>
  permissionGranterFn<span class="token operator">:</span> PermissionGranter<span class="token punctuation">,</span> <span class="token comment">// Permission callback // 权限回调</span>
  toolUseContext<span class="token operator">:</span> ToolUseContext<span class="token punctuation">,</span>         <span class="token comment">// Shared context - ~10KB // 共享上下文 - ~10KB</span>
  activeStreamingToolUse<span class="token operator">?</span><span class="token operator">:</span> ToolUseBlock<span class="token punctuation">,</span>  <span class="token comment">// Resume state // 恢复状态</span>
  loopState<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    turnId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>        <span class="token comment">// UUID for this turn // 本轮对话的UUID</span>
    turnCounter<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>   <span class="token comment">// Recursion depth // 递归深度</span>
    compacted<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>   <span class="token comment">// Was history compressed? // 历史是否已压缩？</span>
    isResuming<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>   <span class="token comment">// Resuming from save? // 是否从保存点恢复？</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ┌─ PHASE 1: Context Preparation [~50-200ms] // 阶段1：上下文准备 [~50-200ms]</span>
  <span class="token comment">// ├─ PHASE 2: Auto-compaction Check [~0-3000ms if triggered] // 阶段2：自动压缩检查 [触发时~0-3000ms]</span>
  <span class="token comment">// ├─ PHASE 3: System Prompt Assembly [~10-50ms] // 阶段3：系统提示组装 [~10-50ms]</span>
  <span class="token comment">// ├─ PHASE 4: LLM Stream Processing [~2000-10000ms] // 阶段4：LLM流处理 [~2000-10000ms]</span>
  <span class="token comment">// ├─ PHASE 5: Tool Execution [~100-30000ms per tool] // 阶段5：工具执行 [每个工具~100-30000ms]</span>
  <span class="token comment">// └─ PHASE 6: Recursion or Completion [~0ms] // 阶段6：递归或完成 [~0ms]</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Phase-1-Context-Window-Management"><a href="#Phase-1-Context-Window-Management" class="headerlink" title="Phase 1: Context Window Management"></a>Phase 1: Context Window Management</h3><h3 id="阶段1：上下文窗口管理"><a href="#阶段1：上下文窗口管理" class="headerlink" title="阶段1：上下文窗口管理"></a>阶段1：上下文窗口管理</h3><p>The first critical decision in the control flow is whether the conversation needs compaction:<br>控制流中的第一个关键决策是判断对话是否需要压缩：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Auto-compaction logic (inferred implementation)</span>
<span class="token comment">// 自动压缩逻辑（推断实现）</span>
<span class="token keyword">class</span> <span class="token class-name">ContextCompactionController</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token constant">COMPACTION_THRESHOLDS</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    tokenCount<span class="token operator">:</span> <span class="token number">100_000</span><span class="token punctuation">,</span>      <span class="token comment">// Aggressive token limit // 激进的token限制</span>
    messageCount<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>        <span class="token comment">// Message count fallback // 消息数量后备限制</span>
    costThreshold<span class="token operator">:</span> <span class="token number">5.00</span>       <span class="token comment">// Cost-based trigger // 基于成本的触发器</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">shouldCompact</span><span class="token punctuation">(</span>
    messages<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    model<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Fast path: check message count first</span>
    <span class="token comment">// 快速路径：先检查消息数量</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messages<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// Expensive path: count tokens</span>
    <span class="token comment">// 昂贵路径：计算tokens</span>
    <span class="token keyword">const</span> tokenCount <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">estimateTokens</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> tokenCount <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">COMPACTION_THRESHOLDS</span><span class="token punctuation">.</span>tokenCount <span class="token operator">||</span>
           messages<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">COMPACTION_THRESHOLDS</span><span class="token punctuation">.</span>messageCount<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">compact</span><span class="token punctuation">(</span>
    messages<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>CompactionResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Phase 1: Identify messages to preserve</span>
    <span class="token comment">// 阶段1：识别要保留的消息</span>
    <span class="token keyword">const</span> preserve <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">identifyPreservedMessages</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 2: Generate summary via LLM</span>
    <span class="token comment">// 阶段2：通过LLM生成摘要</span>
    <span class="token keyword">const</span> summary <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSummary</span><span class="token punctuation">(</span>
      messages<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>m <span class="token operator">=></span> <span class="token operator">!</span>preserve<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      context
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 3: Reconstruct message history</span>
    <span class="token comment">// 阶段3：重构消息历史</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      messages<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSummaryMessage</span><span class="token punctuation">(</span>summary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>messages<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>m <span class="token operator">=></span> preserve<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      tokensaved<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateSavings</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> summary<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Performance Characteristics</strong>:<br><strong>性能特性</strong>：</p>
<ul>
<li>Token counting: O(n) where n is total message content length // Token计算：O(n)，其中n是消息内容总长度</li>
<li>Summary generation: One additional LLM call (<del>2-3s) // 摘要生成：一次额外的LLM调用（</del>2-3秒）</li>
<li>Memory impact: Temporarily doubles message storage during compaction // 内存影响：压缩期间临时 doubling 消息存储</li>
</ul>
<h3 id="Phase-2-Dynamic-System-Prompt-Assembly"><a href="#Phase-2-Dynamic-System-Prompt-Assembly" class="headerlink" title="Phase 2: Dynamic System Prompt Assembly"></a>Phase 2: Dynamic System Prompt Assembly</h3><h3 id="阶段2：动态系统提示组装"><a href="#阶段2：动态系统提示组装" class="headerlink" title="阶段2：动态系统提示组装"></a>阶段2：动态系统提示组装</h3><p>The system prompt assembly reveals a sophisticated caching and composition strategy:<br>系统提示组装展现了一个精密的缓存和组合策略：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// System prompt composition pipeline</span>
<span class="token comment">// 系统提示组合管道</span>
<span class="token keyword">class</span> <span class="token class-name">SystemPromptAssembler</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    hash<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    expiry<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">&#125;</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">assemble</span><span class="token punctuation">(</span>
    basePrompt<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    claudeMd<span class="token operator">:</span> ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    gitContext<span class="token operator">:</span> GitContext<span class="token punctuation">,</span>
    tools<span class="token operator">:</span> ToolDefinition<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    model<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Parallel fetch of dynamic components</span>
    <span class="token comment">// 并行获取动态组件</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>
      claudeMdSection<span class="token punctuation">,</span>
      gitSection<span class="token punctuation">,</span>
      directorySection<span class="token punctuation">,</span>
      toolSection
    <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatClaudeMd</span><span class="token punctuation">(</span>claudeMd<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatGitContext</span><span class="token punctuation">(</span>gitContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDirectoryStructure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatToolDefinitions</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Model-specific adaptations</span>
    <span class="token comment">// 模型特定适配</span>
    <span class="token keyword">const</span> modelSection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModelAdaptations</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Compose with smart truncation</span>
    <span class="token comment">// 智能截断组合</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      base<span class="token operator">:</span> basePrompt<span class="token punctuation">,</span>           <span class="token comment">// Priority 1 // 优先级1</span>
      model<span class="token operator">:</span> modelSection<span class="token punctuation">,</span>        <span class="token comment">// Priority 2 // 优先级2</span>
      claudeMd<span class="token operator">:</span> claudeMdSection<span class="token punctuation">,</span>  <span class="token comment">// Priority 3 // 优先级3</span>
      git<span class="token operator">:</span> gitSection<span class="token punctuation">,</span>           <span class="token comment">// Priority 4 // 优先级4</span>
      directory<span class="token operator">:</span> directorySection<span class="token punctuation">,</span> <span class="token comment">// Priority 5 // 优先级5</span>
      tools<span class="token operator">:</span> toolSection         <span class="token comment">// Priority 6 // 优先级6</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">getModelAdaptations</span><span class="token punctuation">(</span>model<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Model-specific prompt engineering</span>
    <span class="token comment">// 模型特定的提示工程</span>
    <span class="token keyword">const</span> adaptations <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">'claude-3-opus'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        style<span class="token operator">:</span> <span class="token string">'detailed'</span><span class="token punctuation">,</span>
        instructions<span class="token operator">:</span> <span class="token string">'Think step by step. Show your reasoning.'</span><span class="token punctuation">,</span>
        tokenBudget<span class="token operator">:</span> <span class="token number">0.3</span>  <span class="token comment">// 30% of context for reasoning // 30%上下文用于推理</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token string-property property">'claude-3-sonnet'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        style<span class="token operator">:</span> <span class="token string">'balanced'</span><span class="token punctuation">,</span>
        instructions<span class="token operator">:</span> <span class="token string">'Be concise but thorough.'</span><span class="token punctuation">,</span>
        tokenBudget<span class="token operator">:</span> <span class="token number">0.2</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token string-property property">'claude-3-haiku'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        style<span class="token operator">:</span> <span class="token string">'brief'</span><span class="token punctuation">,</span>
        instructions<span class="token operator">:</span> <span class="token string">'Get to the point quickly.'</span><span class="token punctuation">,</span>
        tokenBudget<span class="token operator">:</span> <span class="token number">0.1</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> config <span class="token operator">=</span> adaptations<span class="token punctuation">[</span>model<span class="token punctuation">]</span> <span class="token operator">||</span> adaptations<span class="token punctuation">[</span><span class="token string">'claude-3-sonnet'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatModelInstructions</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Phase-3-The-Streaming-State-Machine"><a href="#Phase-3-The-Streaming-State-Machine" class="headerlink" title="Phase 3: The Streaming State Machine"></a>Phase 3: The Streaming State Machine</h3><h3 id="阶段3：流状态机"><a href="#阶段3：流状态机" class="headerlink" title="阶段3：流状态机"></a>阶段3：流状态机</h3><p>The LLM streaming phase implements a complex event-driven state machine:<br>LLM流阶段实现了一个复杂的事件驱动状态机：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Stream event processing state machine</span>
<span class="token comment">// 流事件处理状态机</span>
<span class="token keyword">class</span> <span class="token class-name">StreamEventProcessor</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> state<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    phase<span class="token operator">:</span> <span class="token string">'idle'</span> <span class="token operator">|</span> <span class="token string">'message_start'</span> <span class="token operator">|</span> <span class="token string">'content'</span> <span class="token operator">|</span> <span class="token string">'tool_input'</span> <span class="token operator">|</span> <span class="token string">'complete'</span><span class="token punctuation">;</span>
    currentMessage<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span><span class="token punctuation">;</span>
    contentBlocks<span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    activeToolInput<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      toolId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
      buffer<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
      parser<span class="token operator">:</span> StreamingToolInputParser<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    metrics<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      firstTokenLatency<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
      tokensPerSecond<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  async <span class="token operator">*</span><span class="token function">processStream</span><span class="token punctuation">(</span>
    stream<span class="token operator">:</span> AsyncIterable<span class="token operator">&lt;</span>StreamEvent<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>UIEvent <span class="token operator">|</span> CliMessage<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> event <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string">'message_start'</span><span class="token operator">:</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>phase <span class="token operator">=</span> <span class="token string">'message_start'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>firstTokenLatency <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
          <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'ui_state'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">'assistant_responding'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token string">'content_block_start'</span><span class="token operator">:</span>
          <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleContentBlockStart</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token string">'content_block_delta'</span><span class="token operator">:</span>
          <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleContentBlockDelta</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token string">'content_block_stop'</span><span class="token operator">:</span>
          <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleContentBlockStop</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token string">'message_stop'</span><span class="token operator">:</span>
          <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finalizeMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token string">'error'</span><span class="token operator">:</span>
          <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> async <span class="token operator">*</span><span class="token function">handleContentBlockDelta</span><span class="token punctuation">(</span>
    event<span class="token operator">:</span> ContentBlockDeltaEvent
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>UIEvent<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> block <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>contentBlocks<span class="token punctuation">[</span>event<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token string">'text_delta'</span><span class="token operator">:</span>
        <span class="token comment">// Direct UI update for text</span>
        <span class="token comment">// 文本的直接UI更新</span>
        block<span class="token punctuation">.</span>text <span class="token operator">+=</span> event<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'ui_text_delta'</span><span class="token punctuation">,</span>
          data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            text<span class="token operator">:</span> event<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
            blockIndex<span class="token operator">:</span> event<span class="token punctuation">.</span>index
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'input_json_delta'</span><span class="token operator">:</span>
        <span class="token comment">// Accumulate JSON for tool input</span>
        <span class="token comment">// 累积工具输入的JSON</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>activeToolInput<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>activeToolInput<span class="token punctuation">.</span>buffer <span class="token operator">+=</span> event<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>partial_json<span class="token punctuation">;</span>

          <span class="token comment">// Try parsing at strategic points</span>
          <span class="token comment">// 在策略点尝试解析</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>partial_json<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
              event<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>partial_json<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>activeToolInput<span class="token punctuation">.</span>parser<span class="token punctuation">.</span><span class="token function">addChunk</span><span class="token punctuation">(</span>
              event<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>partial_json
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              block<span class="token punctuation">.</span>input <span class="token operator">=</span> result<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
              <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
                type<span class="token operator">:</span> <span class="token string">'ui_tool_preview'</span><span class="token punctuation">,</span>
                data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                  toolId<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>activeToolInput<span class="token punctuation">.</span>toolId<span class="token punctuation">,</span>
                  input<span class="token operator">:</span> result<span class="token punctuation">.</span>value
                <span class="token punctuation">&#125;</span>
              <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Phase-4-The-Tool-Execution-Pipeline"><a href="#Phase-4-The-Tool-Execution-Pipeline" class="headerlink" title="Phase 4: The Tool Execution Pipeline"></a>Phase 4: The Tool Execution Pipeline</h3><h3 id="阶段4：工具执行管道"><a href="#阶段4：工具执行管道" class="headerlink" title="阶段4：工具执行管道"></a>阶段4：工具执行管道</h3><p>The tool execution system implements a sophisticated parallel/sequential execution strategy:<br>工具执行系统实现了一个精密的并行/顺序执行策略：</p>
<pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TB
    <span class="token keyword">subgraph</span> <span class="token string">"Tool Request Analysis"</span>
        ToolRequests<span class="token text string">[Tool Use Blocks]</span> <span class="token arrow operator">--></span> Categorize<span class="token text string">&#123;Categorize by Type&#125;</span>
        Categorize <span class="token arrow operator">--></span><span class="token label property">|Read-Only|</span> ReadQueue<span class="token text string">[Read Queue]</span>
        Categorize <span class="token arrow operator">--></span><span class="token label property">|Write/Side-Effect|</span> WriteQueue<span class="token text string">[Write Queue]</span>
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"Parallel Execution Pool"</span>
        ReadQueue <span class="token arrow operator">--></span> ParallelPool<span class="token text string">[Parallel Executor]</span>
        ParallelPool <span class="token arrow operator">--></span> Worker1<span class="token text string">[Worker 1]</span>
        ParallelPool <span class="token arrow operator">--></span> Worker2<span class="token text string">[Worker 2]</span>
        ParallelPool <span class="token arrow operator">--></span> WorkerN<span class="token text string">[Worker N]</span>

        Worker1 <span class="token arrow operator">--></span> Results1<span class="token text string">[Result 1]</span>
        Worker2 <span class="token arrow operator">--></span> Results2<span class="token text string">[Result 2]</span>
        WorkerN <span class="token arrow operator">--></span> ResultsN<span class="token text string">[Result N]</span>
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"Sequential Execution"</span>
        WriteQueue <span class="token arrow operator">--></span> SeqExecutor<span class="token text string">[Sequential Executor]</span>
        Results1 <span class="token arrow operator">--></span> SeqExecutor
        Results2 <span class="token arrow operator">--></span> SeqExecutor
        ResultsN <span class="token arrow operator">--></span> SeqExecutor

        SeqExecutor <span class="token arrow operator">--></span> WriteTool1<span class="token text string">[Write Tool 1]</span>
        WriteTool1 <span class="token arrow operator">--></span> WriteTool2<span class="token text string">[Write Tool 2]</span>
        WriteTool2 <span class="token arrow operator">--></span> FinalResults<span class="token text string">[All Results]</span>
    <span class="token keyword">end</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/2.svg" class="">
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// The parallel execution orchestrator</span>
<span class="token comment">// 并行执行编排器</span>
<span class="token keyword">class</span> <span class="token class-name">ToolExecutionOrchestrator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token constant">CONCURRENCY_LIMIT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">executeToolBatch</span><span class="token punctuation">(</span>
    toolUses<span class="token operator">:</span> ToolUseBlock<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext<span class="token punctuation">,</span>
    permissionFn<span class="token operator">:</span> PermissionGranter
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Phase 1: Categorize tools</span>
    <span class="token comment">// 阶段1：分类工具</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> readOnly<span class="token punctuation">,</span> writeTools <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">categorizeTools</span><span class="token punctuation">(</span>toolUses<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 2: Execute read-only tools in parallel</span>
    <span class="token comment">// 阶段2：并行执行只读工具</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readOnly<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeParallel</span><span class="token punctuation">(</span>readOnly<span class="token punctuation">,</span> context<span class="token punctuation">,</span> permissionFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Phase 3: Execute write tools sequentially</span>
    <span class="token comment">// 阶段3：顺序执行写入工具</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> tool <span class="token keyword">of</span> writeTools<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeSequential</span><span class="token punctuation">(</span>tool<span class="token punctuation">,</span> context<span class="token punctuation">,</span> permissionFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">executeParallel</span><span class="token punctuation">(</span>
    tools<span class="token operator">:</span> ToolUseBlock<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext<span class="token punctuation">,</span>
    permissionFn<span class="token operator">:</span> PermissionGranter
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> executions <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>tool <span class="token operator">=></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createToolExecution</span><span class="token punctuation">(</span>tool<span class="token punctuation">,</span> context<span class="token punctuation">,</span> permissionFn<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Custom parallel map with backpressure</span>
    <span class="token comment">// 自定义带回压的并行映射</span>
    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">parallelMap</span><span class="token punctuation">(</span>executions<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">CONCURRENCY_LIMIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// The parallelMap implementation</span>
<span class="token comment">// parallelMap实现</span>
<span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token generic-function"><span class="token function">parallelMap</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
  generators<span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  concurrency<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> executing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span>IteratorResult<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">>>></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pending <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>generators<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// Fill initial slots</span>
  <span class="token comment">// 填充初始槽位</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>executing<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> concurrency <span class="token operator">&amp;&amp;</span> pending<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> gen <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    executing<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>executing<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Race for next completion</span>
    <span class="token comment">// 竞争下一次完成</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>executing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executing<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>result <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Yield the value</span>
      <span class="token comment">// 产出值</span>
      <span class="token keyword">yield</span> result<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

      <span class="token comment">// Continue this generator</span>
      <span class="token comment">// 继续这个生成器</span>
      <span class="token keyword">const</span> nextPromise <span class="token operator">=</span> result<span class="token punctuation">.</span>generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      executing<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>nextPromise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Fill empty slot if available</span>
    <span class="token comment">// 如果有空槽位就填充</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executing<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> concurrency <span class="token operator">&amp;&amp;</span> pending<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> gen <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      executing<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Execution Timing Analysis</strong>:<br><strong>执行时间分析</strong>：</p>
<table>
<thead>
<tr>
<th>Tool Type</th>
<th>Concurrency</th>
<th>Typical Latency</th>
<th>Bottleneck</th>
</tr>
</thead>
<tbody><tr>
<td>ReadTool</td>
<td>Parallel (10)</td>
<td>10-50ms</td>
<td>Disk I/O</td>
</tr>
<tr>
<td>GrepTool</td>
<td>Parallel (10)</td>
<td>100-500ms</td>
<td>CPU regex</td>
</tr>
<tr>
<td>WebFetchTool</td>
<td>Parallel (3)</td>
<td>500-3000ms</td>
<td>Network</td>
</tr>
<tr>
<td>EditTool</td>
<td>Sequential</td>
<td>20-100ms</td>
<td>Validation</td>
</tr>
<tr>
<td>BashTool</td>
<td>Sequential</td>
<td>50-10000ms</td>
<td>Process exec</td>
</tr>
<tr>
<td>AgentTool</td>
<td>Parallel (5)</td>
<td>2000-20000ms</td>
<td>Sub-LLM calls</td>
</tr>
<tr>
<td>工具类型</td>
<td>并发度</td>
<td>典型延迟</td>
<td>瓶颈</td>
</tr>
<tr>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>读取工具</td>
<td>并行 (10)</td>
<td>10-50毫秒</td>
<td>磁盘I/O</td>
</tr>
<tr>
<td>搜索工具</td>
<td>并行 (10)</td>
<td>100-500毫秒</td>
<td>CPU正则表达式</td>
</tr>
<tr>
<td>网络获取工具</td>
<td>并行 (3)</td>
<td>500-3000毫秒</td>
<td>网络</td>
</tr>
<tr>
<td>编辑工具</td>
<td>顺序</td>
<td>20-100毫秒</td>
<td>验证</td>
</tr>
<tr>
<td>Bash工具</td>
<td>顺序</td>
<td>50-10000毫秒</td>
<td>进程执行</td>
</tr>
<tr>
<td>代理工具</td>
<td>并行 (5)</td>
<td>2000-20000毫秒</td>
<td>子LLM调用</td>
</tr>
</tbody></table>
<h3 id="Phase-5-Permission-Control-Flow"><a href="#Phase-5-Permission-Control-Flow" class="headerlink" title="Phase 5: Permission Control Flow"></a>Phase 5: Permission Control Flow</h3><h3 id="阶段5：权限控制流"><a href="#阶段5：权限控制流" class="headerlink" title="阶段5：权限控制流"></a>阶段5：权限控制流</h3><p>The permission system implements a multi-level decision tree:<br>权限系统实现了一个多层决策树：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Permission decision flow</span>
<span class="token comment">// 权限决策流</span>
<span class="token keyword">class</span> <span class="token class-name">PermissionController</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">checkPermission</span><span class="token punctuation">(</span>
    tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">,</span>
    input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolPermissionContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>PermissionDecision<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Level 1: Check explicit deny rules (highest priority)</span>
    <span class="token comment">// 层级1：检查明确拒绝规则（最高优先级）</span>
    <span class="token keyword">const</span> denyRule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMatchingRule</span><span class="token punctuation">(</span>
      tool<span class="token punctuation">,</span>
      input<span class="token punctuation">,</span>
      context<span class="token punctuation">.</span>alwaysDenyRules
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>denyRule<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> behavior<span class="token operator">:</span> <span class="token string">'deny'</span><span class="token punctuation">,</span> reason<span class="token operator">:</span> denyRule <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Level 2: Check mode overrides</span>
    <span class="token comment">// 层级2：检查模式覆盖</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>mode <span class="token operator">===</span> <span class="token string">'bypassPermissions'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> behavior<span class="token operator">:</span> <span class="token string">'allow'</span><span class="token punctuation">,</span> reason<span class="token operator">:</span> <span class="token string">'bypass_mode'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>mode <span class="token operator">===</span> <span class="token string">'acceptEdits'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isEditTool</span><span class="token punctuation">(</span>tool<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isPathSafe</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> behavior<span class="token operator">:</span> <span class="token string">'allow'</span><span class="token punctuation">,</span> reason<span class="token operator">:</span> <span class="token string">'accept_edits_mode'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Level 3: Check explicit allow rules</span>
    <span class="token comment">// 层级3：检查明确允许规则</span>
    <span class="token keyword">const</span> allowRule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMatchingRule</span><span class="token punctuation">(</span>
      tool<span class="token punctuation">,</span>
      input<span class="token punctuation">,</span>
      context<span class="token punctuation">.</span>alwaysAllowRules
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allowRule<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> behavior<span class="token operator">:</span> <span class="token string">'allow'</span><span class="token punctuation">,</span> reason<span class="token operator">:</span> allowRule <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Level 4: Interactive prompt</span>
    <span class="token comment">// 层级4：交互式提示</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      behavior<span class="token operator">:</span> <span class="token string">'ask'</span><span class="token punctuation">,</span>
      suggestions<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateRuleSuggestions</span><span class="token punctuation">(</span>tool<span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">findMatchingRule</span><span class="token punctuation">(</span>
    tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">,</span>
    input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    rules<span class="token operator">:</span> Record<span class="token operator">&lt;</span>PermissionRuleScope<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Priority order: cliArg > localSettings > projectSettings > ...</span>
    <span class="token comment">// 优先级顺序：cliArg > localSettings > projectSettings > ...</span>
    <span class="token keyword">const</span> scopes<span class="token operator">:</span> PermissionRuleScope<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'cliArg'</span><span class="token punctuation">,</span> <span class="token string">'localSettings'</span><span class="token punctuation">,</span> <span class="token string">'projectSettings'</span><span class="token punctuation">,</span>
      <span class="token string">'policySettings'</span><span class="token punctuation">,</span> <span class="token string">'userSettings'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> scope <span class="token keyword">of</span> scopes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> scopeRules <span class="token operator">=</span> rules<span class="token punctuation">[</span>scope<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> rule <span class="token keyword">of</span> scopeRules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">matchesRule</span><span class="token punctuation">(</span>tool<span class="token punctuation">,</span> input<span class="token punctuation">,</span> rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>scope<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>rule<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Phase-6-Recursive-Turn-Management"><a href="#Phase-6-Recursive-Turn-Management" class="headerlink" title="Phase 6: Recursive Turn Management"></a>Phase 6: Recursive Turn Management</h3><h3 id="阶段6：递归轮次管理"><a href="#阶段6：递归轮次管理" class="headerlink" title="阶段6：递归轮次管理"></a>阶段6：递归轮次管理</h3><p>The control flow implements tail recursion for multi-turn interactions:<br>控制流为多轮交互实现了尾递归：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Recursion control and state management</span>
<span class="token comment">// 递归控制和状态管理</span>
<span class="token keyword">class</span> <span class="token class-name">TurnController</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">manageTurn</span><span class="token punctuation">(</span>
    messages<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    toolResults<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> FullContext<span class="token punctuation">,</span>
    loopState<span class="token operator">:</span> LoopState
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Check recursion depth</span>
    <span class="token comment">// 检查递归深度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loopState<span class="token punctuation">.</span>turnCounter <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSystemMessage</span><span class="token punctuation">(</span>
        <span class="token string">"Maximum conversation depth reached. Please start a new query."</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Prepare next turn state</span>
    <span class="token comment">// 准备下一轮状态</span>
    <span class="token keyword">const</span> nextState <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">...</span>loopState<span class="token punctuation">,</span>
      turnCounter<span class="token operator">:</span> loopState<span class="token punctuation">.</span>turnCounter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
      compacted<span class="token operator">:</span> <span class="token boolean">false</span>  <span class="token comment">// Reset compaction flag // 重置压缩标志</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Merge messages for next turn</span>
    <span class="token comment">// 合并下一轮的消息</span>
    <span class="token keyword">const</span> nextMessages <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token operator">...</span>messages<span class="token punctuation">,</span>
      <span class="token operator">...</span>toolResults<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sortByToolRequestOrder<span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Tail recursion</span>
    <span class="token comment">// 尾递归</span>
    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">tt</span><span class="token punctuation">(</span>
      nextMessages<span class="token punctuation">,</span>
      context<span class="token punctuation">.</span>basePrompt<span class="token punctuation">,</span>
      context<span class="token punctuation">.</span>gitContext<span class="token punctuation">,</span>
      context<span class="token punctuation">.</span>claudeMd<span class="token punctuation">,</span>
      context<span class="token punctuation">.</span>permissionFn<span class="token punctuation">,</span>
      context<span class="token punctuation">.</span>toolContext<span class="token punctuation">,</span>
      <span class="token keyword">undefined</span><span class="token punctuation">,</span>  <span class="token comment">// No active streaming tool // 没有活跃的流工具</span>
      nextState
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Advanced-Control-Flow-Patterns"><a href="#Advanced-Control-Flow-Patterns" class="headerlink" title="Advanced Control Flow Patterns"></a>Advanced Control Flow Patterns</h2><h2 id="高级控制流模式"><a href="#高级控制流模式" class="headerlink" title="高级控制流模式"></a>高级控制流模式</h2><h3 id="1-Input-Router-State-Machine"><a href="#1-Input-Router-State-Machine" class="headerlink" title="1. Input Router State Machine"></a>1. Input Router State Machine</h3><h3 id="1-输入路由状态机"><a href="#1-输入路由状态机" class="headerlink" title="1. 输入路由状态机"></a>1. 输入路由状态机</h3><p>The input processing implements a sophisticated routing system:<br>输入处理实现了一个精密的路由系统：</p>
<pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">stateDiagram-v2</span>
    <span class="token text string">[*]</span> <span class="token arrow operator">--></span> InputReceived // 输入接收
    InputReceived <span class="token arrow operator">--></span> CommandDetection // 命令检测

    CommandDetection <span class="token arrow operator">--></span> SlashCommand<span class="token operator">:</span> starts with / // 以/开头
    CommandDetection <span class="token arrow operator">--></span> BashMode<span class="token operator">:</span> starts with ! // 以!开头
    CommandDetection <span class="token arrow operator">--></span> MemoryMode<span class="token operator">:</span> starts with # // 以#开头
    CommandDetection <span class="token arrow operator">--></span> PasteDetection<span class="token operator">:</span> paste event // 粘贴事件
    CommandDetection <span class="token arrow operator">--></span> NormalPrompt<span class="token operator">:</span> default // 默认

    SlashCommand <span class="token arrow operator">--></span> ExecuteCommand // 执行命令
    ExecuteCommand <span class="token arrow operator">--></span> UpdateState // 更新状态
    UpdateState <span class="token arrow operator">--></span> <span class="token text string">[*]</span>

    BashMode <span class="token arrow operator">--></span> CreateSyntheticTool // 创建合成工具
    CreateSyntheticTool <span class="token arrow operator">--></span> MainLoop // 主循环

    MemoryMode <span class="token arrow operator">--></span> UpdateClaudeMd // 更新ClaudeMd
    UpdateClaudeMd <span class="token arrow operator">--></span> <span class="token text string">[*]</span>

    PasteDetection <span class="token arrow operator">--></span> DetectContent // 检测内容
    DetectContent <span class="token arrow operator">--></span> ProcessImage<span class="token operator">:</span> image detected // 图像检测到
    DetectContent <span class="token arrow operator">--></span> ProcessText<span class="token operator">:</span> text only // 仅文本
    ProcessImage <span class="token arrow operator">--></span> MainLoop
    ProcessText <span class="token arrow operator">--></span> MainLoop

    NormalPrompt <span class="token arrow operator">--></span> MainLoop
    MainLoop <span class="token arrow operator">--></span> <span class="token text string">[*]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/3.svg" class="">
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Input router implementation</span>
<span class="token comment">// 输入路由实现</span>
<span class="token keyword">class</span> <span class="token class-name">InputRouter</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">routeInput</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> AppContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RouterAction<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Command detection with priority</span>
    <span class="token comment">// 带优先级的命令检测</span>
    <span class="token keyword">const</span> matchers<span class="token operator">:</span> <span class="token punctuation">[</span>RegExp<span class="token punctuation">,</span> InputHandler<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span><span class="token operator">/</span><span class="token operator">^</span>\\<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\\w+)(.*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleSlashCommand<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^!(.+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleBashMode<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^#(.+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleMemoryMode<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^```[\\s\\S]+```$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleCodeBlock<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>pattern<span class="token punctuation">,</span> handler<span class="token punctuation">]</span> <span class="token keyword">of</span> matchers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> match <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>match<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Default: normal prompt</span>
    <span class="token comment">// 默认：正常提示</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'prompt'</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createUserMessage</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">handleBashMode</span><span class="token punctuation">(</span>
    match<span class="token operator">:</span> RegExpMatchArray<span class="token punctuation">,</span>
    context<span class="token operator">:</span> AppContext
  <span class="token punctuation">)</span><span class="token operator">:</span> RouterAction <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> command <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Create synthetic assistant message with tool use</span>
    <span class="token comment">// 创建带工具使用的合成助手消息</span>
    <span class="token keyword">const</span> syntheticMessages <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          role<span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
          content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Run this command: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>command<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          role<span class="token operator">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span>
          content<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
              type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
              text<span class="token operator">:</span> <span class="token string">'I\\'</span>ll run that command <span class="token keyword">for</span> you<span class="token punctuation">.</span>'
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span>
              type<span class="token operator">:</span> <span class="token string">'tool_use'</span><span class="token punctuation">,</span>
              id<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bash_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
              name<span class="token operator">:</span> <span class="token string">'BashTool'</span><span class="token punctuation">,</span>
              input<span class="token operator">:</span> <span class="token punctuation">&#123;</span> command<span class="token punctuation">,</span> sandbox<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'synthetic_conversation'</span><span class="token punctuation">,</span>
      messages<span class="token operator">:</span> syntheticMessages
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-Stream-Backpressure-Management"><a href="#2-Stream-Backpressure-Management" class="headerlink" title="2. Stream Backpressure Management"></a>2. Stream Backpressure Management</h3><h3 id="2-流背压管理"><a href="#2-流背压管理" class="headerlink" title="2. 流背压管理"></a>2. 流背压管理</h3><p>The streaming system implements sophisticated backpressure handling:<br>流系统实现了精密的背压处理：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Backpressure control for streaming</span>
<span class="token comment">// 流的背压控制</span>
<span class="token keyword">class</span> <span class="token class-name">StreamBackpressureController</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> buffer<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>StreamEvent<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> pressure <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    current<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    threshold<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment">// Max buffered events // 最大缓冲事件数</span>
    paused<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  async <span class="token operator">*</span><span class="token function">controlledStream</span><span class="token punctuation">(</span>
    source<span class="token operator">:</span> AsyncIterable<span class="token operator">&lt;</span>StreamEvent<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>StreamEvent<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> iterator <span class="token operator">=</span> source<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>asyncIterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Check pressure</span>
      <span class="token comment">// 检查压力</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>current <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>threshold<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>paused <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForDrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> done<span class="token punctuation">,</span> value <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token comment">// Buffer management</span>
      <span class="token comment">// 缓冲区管理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shouldBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>current<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Yield immediately for high-priority events</span>
        <span class="token comment">// 高优先级事件立即产出</span>
        <span class="token keyword">yield</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// Drain buffer periodically</span>
      <span class="token comment">// 定期排空缓冲区</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>paused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drainBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Final drain</span>
    <span class="token comment">// 最终排空</span>
    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drainBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">shouldBuffer</span><span class="token punctuation">(</span>event<span class="token operator">:</span> StreamEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Don't buffer tool results or errors</span>
    <span class="token comment">// 不缓冲工具结果或错误</span>
    <span class="token keyword">return</span> event<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'content_block_delta'</span> <span class="token operator">&amp;&amp;</span>
           event<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'text_delta'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-AgentTool-Hierarchical-Control-Flow"><a href="#3-AgentTool-Hierarchical-Control-Flow" class="headerlink" title="3. AgentTool Hierarchical Control Flow"></a>3. AgentTool Hierarchical Control Flow</h3><h3 id="3-AgentTool层次控制流"><a href="#3-AgentTool层次控制流" class="headerlink" title="3. AgentTool层次控制流"></a>3. AgentTool层次控制流</h3><p>The AgentTool implements a fascinating parent-child control structure:<br>AgentTool实现了一个引人入胜的父子控制结构：</p>
<pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TB
    <span class="token keyword">subgraph</span> <span class="token string">"Main Agent"</span>
        MainTT<span class="token text string">[Main tt Loop]</span>
        MainContext<span class="token text string">[Main Context]</span>
        MainTools<span class="token text string">[All Tools]</span>
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"AgentTool Invocation"</span>
        AgentRequest<span class="token text string">[AgentTool Request]</span>
        TaskSplitter<span class="token text string">[Task Splitter]</span>

        TaskSplitter <span class="token arrow operator">--></span> SubTask1<span class="token text string">[Sub-task 1]</span>
        TaskSplitter <span class="token arrow operator">--></span> SubTask2<span class="token text string">[Sub-task 2]</span>
        TaskSplitter <span class="token arrow operator">--></span> SubTaskN<span class="token text string">[Sub-task N]</span>
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"Sub-Agent 1"</span>
        SubLoop1<span class="token text string">[Sub tt Loop]</span>
        SubContext1<span class="token text string">[Filtered Context]</span>
        SubTools1<span class="token text string">[Tools - AgentTool]</span>
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"Sub-Agent 2"</span>
        SubLoop2<span class="token text string">[Sub tt Loop]</span>
        SubContext2<span class="token text string">[Filtered Context]</span>
        SubTools2<span class="token text string">[Tools - AgentTool]</span>
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"Synthesis"</span>
        Collector<span class="token text string">[Result Collector]</span>
        Synthesizer<span class="token text string">[LLM Synthesizer]</span>
        FinalResult<span class="token text string">[Synthesized Result]</span>
    <span class="token keyword">end</span>

    MainTT <span class="token arrow operator">--></span> AgentRequest
    AgentRequest <span class="token arrow operator">--></span> TaskSplitter

    SubTask1 <span class="token arrow operator">--></span> SubLoop1
    SubTask2 <span class="token arrow operator">--></span> SubLoop2

    SubLoop1 <span class="token arrow operator">--></span> Collector
    SubLoop2 <span class="token arrow operator">--></span> Collector

    Collector <span class="token arrow operator">--></span> Synthesizer
    Synthesizer <span class="token arrow operator">--></span> FinalResult
    FinalResult <span class="token arrow operator">--></span> MainTT
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/4.svg" class="">
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// AgentTool hierarchical execution</span>
<span class="token comment">// AgentTool层次执行</span>
<span class="token keyword">class</span> <span class="token class-name">AgentToolExecutor</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">execute</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> AgentToolInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext<span class="token punctuation">,</span>
    parentMessage<span class="token operator">:</span> CliMessage
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>ToolProgress <span class="token operator">|</span> ToolResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Phase 1: Task analysis</span>
    <span class="token comment">// 阶段1：任务分析</span>
    <span class="token keyword">const</span> subtasks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyzeTask</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 2: Spawn sub-agents</span>
    <span class="token comment">// 阶段2：生成子代理</span>
    <span class="token keyword">const</span> subAgentPromises <span class="token operator">=</span> subtasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>task<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Create isolated context</span>
      <span class="token comment">// 创建隔离上下文</span>
      <span class="token keyword">const</span> subContext <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">...</span>context<span class="token punctuation">,</span>
        tools<span class="token operator">:</span> context<span class="token punctuation">.</span>tools<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'AgentTool'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        abortController<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createLinkedAbort</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>abortController<span class="token punctuation">)</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token operator">...</span>context<span class="token punctuation">.</span>options<span class="token punctuation">,</span>
          maxThinkingTokens<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateTokenBudget</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>prompt<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

      <span class="token comment">// Run sub-agent</span>
      <span class="token comment">// 运行子代理</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runSubAgent</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> subContext<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 3: Parallel execution with progress</span>
    <span class="token comment">// 阶段3：带进度的并行执行</span>
    <span class="token keyword">const</span> results<span class="token operator">:</span> SubAgentResult<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> update <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">trackProgress</span><span class="token punctuation">(</span>subAgentPromises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'progress'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
          toolUseID<span class="token operator">:</span> parentMessage<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          data<span class="token operator">:</span> update
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Phase 4: Synthesis</span>
    <span class="token comment">// 阶段4：合成</span>
    <span class="token keyword">const</span> synthesized <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">synthesizeResults</span><span class="token punctuation">(</span>results<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> synthesized
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">synthesizeResults</span><span class="token punctuation">(</span>
    results<span class="token operator">:</span> SubAgentResult<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    input<span class="token operator">:</span> AgentToolInput
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Multi-result synthesis via LLM</span>
    <span class="token comment">// 通过LLM进行多结果合成</span>
    <span class="token keyword">const</span> synthesisPrompt <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      Synthesize these </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>results<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> findings into a cohesive response:
      将这</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>results<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">个发现合成为一个连贯的响应：
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Finding </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>r<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

      Original task: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>input<span class="token punctuation">.</span>prompt<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
      原始任务：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>input<span class="token punctuation">.</span>prompt<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> synthesizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubAgentExecutor</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      prompt<span class="token operator">:</span> synthesisPrompt<span class="token punctuation">,</span>
      model<span class="token operator">:</span> input<span class="token punctuation">.</span>model <span class="token operator">||</span> <span class="token string">'claude-3-haiku'</span><span class="token punctuation">,</span>  <span class="token comment">// Fast model for synthesis // 用于合成的快速模型</span>
      isSynthesis<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> synthesizer<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-Error-Recovery-Control-Flow"><a href="#4-Error-Recovery-Control-Flow" class="headerlink" title="4. Error Recovery Control Flow"></a>4. Error Recovery Control Flow</h3><h3 id="4-错误恢复控制流"><a href="#4-错误恢复控制流" class="headerlink" title="4. 错误恢复控制流"></a>4. 错误恢复控制流</h3><p>The system implements sophisticated error recovery strategies:<br>系统实现了精密的错误恢复策略：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Error recovery state machine</span>
<span class="token comment">// 错误恢复状态机</span>
<span class="token keyword">class</span> <span class="token class-name">ErrorRecoveryController</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> recoveryStrategies <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">'rate_limit'</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleRateLimit<span class="token punctuation">,</span>
    <span class="token string-property property">'context_overflow'</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleContextOverflow<span class="token punctuation">,</span>
    <span class="token string-property property">'tool_error'</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleToolError<span class="token punctuation">,</span>
    <span class="token string-property property">'network_error'</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleNetworkError<span class="token punctuation">,</span>
    <span class="token string-property property">'permission_denied'</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlePermissionDenied
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">handleError</span><span class="token punctuation">(</span>
    error<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ErrorContext
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> errorType <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">classifyError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> strategy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>recoveryStrategies<span class="token punctuation">[</span>errorType<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">strategy</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Generic error handling</span>
      <span class="token comment">// 通用错误处理</span>
      <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createErrorMessage</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">handleContextOverflow</span><span class="token punctuation">(</span>
    error<span class="token operator">:</span> ContextOverflowError<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ErrorContext
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Strategy 1: Try reducing max_tokens</span>
    <span class="token comment">// 策略1：尝试减少max_tokens</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>details<span class="token punctuation">.</span>requested_tokens <span class="token operator">></span> <span class="token number">4096</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSystemMessage</span><span class="token punctuation">(</span><span class="token string">"Reducing response size..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> retry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">retryWithReducedTokens</span><span class="token punctuation">(</span>
        context<span class="token punctuation">.</span>request<span class="token punctuation">,</span>
        Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>details<span class="token punctuation">.</span>requested_tokens <span class="token operator">*</span> <span class="token number">0.7</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>retry<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">yield</span><span class="token operator">*</span> retry<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Strategy 2: Force compaction</span>
    <span class="token comment">// 策略2：强制压缩</span>
    <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSystemMessage</span><span class="token punctuation">(</span><span class="token string">"Compacting conversation history..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> compacted <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forceCompaction</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Retry with compacted history</span>
    <span class="token comment">// 用压缩历史重试</span>
    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">retryWithMessages</span><span class="token punctuation">(</span>compacted<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">handleRateLimit</span><span class="token punctuation">(</span>
    error<span class="token operator">:</span> RateLimitError<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ErrorContext
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Multi-provider fallback</span>
    <span class="token comment">// 多提供商后备</span>
    <span class="token keyword">const</span> providers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'anthropic'</span><span class="token punctuation">,</span> <span class="token string">'bedrock'</span><span class="token punctuation">,</span> <span class="token string">'vertex'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> context<span class="token punctuation">.</span>provider<span class="token punctuation">;</span>
    <span class="token keyword">const</span> alternatives <span class="token operator">=</span> providers<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">=></span> p <span class="token operator">!==</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> provider <span class="token keyword">of</span> alternatives<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSystemMessage</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Rate limited on </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>current<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, trying </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>provider<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">retryWithProvider</span><span class="token punctuation">(</span>
          context<span class="token punctuation">.</span>request<span class="token punctuation">,</span>
          provider
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span><span class="token operator">*</span> result<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// All providers exhausted</span>
    <span class="token comment">// 所有提供商都已耗尽</span>
    <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createErrorMessage</span><span class="token punctuation">(</span>
      <span class="token string">"All providers are rate limited. Please try again later."</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Performance-Profiling-Points"><a href="#Performance-Profiling-Points" class="headerlink" title="Performance Profiling Points"></a>Performance Profiling Points</h2><h2 id="性能分析点"><a href="#性能分析点" class="headerlink" title="性能分析点"></a>性能分析点</h2><p>The control flow includes strategic profiling points:<br>控制流包含策略性的性能分析点：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Performance measurement integration</span>
<span class="token comment">// 性能测量集成</span>
<span class="token keyword">class</span> <span class="token class-name">PerformanceProfiler</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> spans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> PerformanceSpan<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">instrument</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> AsyncGenerator<span class="token operator">></span></span></span><span class="token punctuation">(</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    generator<span class="token operator">:</span> <span class="token constant">T</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> span <span class="token operator">=</span> tracer<span class="token punctuation">.</span><span class="token function">startSpan</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> start <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> itemCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> generator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          itemCount<span class="token operator">++</span><span class="token punctuation">;</span>

          <span class="token comment">// Measure inter-yield time</span>
          <span class="token comment">// 测量产出间时间</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>itemCount <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            span<span class="token punctuation">.</span><span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token string">'yield'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
              <span class="token string-property property">'yield.latency'</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastYield
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">yield</span> item<span class="token punctuation">;</span>
          lastYield <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        span<span class="token punctuation">.</span><span class="token function">setAttributes</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          <span class="token string-property property">'generator.yield_count'</span><span class="token operator">:</span> itemCount<span class="token punctuation">,</span>
          <span class="token string-property property">'generator.total_time'</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        span<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档深入分析了Claude Code的控制流与编排引擎，揭示了其高性能响应背后的复杂状态机和并行处理机制。通过反编译和逆向工程分析，文档详细展示了Claude Code如何通过精密的控制流程来管理复杂的对话交互、工具执行和错误恢复。</p>
<h2 id="核心架构特点"><a href="#核心架构特点" class="headerlink" title="核心架构特点"></a>核心架构特点</h2><h3 id="1-主对话循环：流式状态机"><a href="#1-主对话循环：流式状态机" class="headerlink" title="1. 主对话循环：流式状态机"></a>1. 主对话循环：流式状态机</h3><ul>
<li><strong>tt异步生成器</strong>：整个系统的核心，管理完整的对话流程</li>
<li><strong>六阶段处理流程</strong>：<ol>
<li>上下文准备 [~50-200ms]</li>
<li>自动压缩检查 [触发时~0-3000ms]</li>
<li>系统提示组装 [~10-50ms]</li>
<li>LLM流处理 [~2000-10000ms]</li>
<li>工具执行 [每个工具~100-30000ms]</li>
<li>递归或完成 [~0ms]</li>
</ol>
</li>
</ul>
<h3 id="2-上下文窗口管理"><a href="#2-上下文窗口管理" class="headerlink" title="2. 上下文窗口管理"></a>2. 上下文窗口管理</h3><ul>
<li><strong>智能压缩策略</strong>：<ul>
<li>Token计数：O(n)复杂度，激进限制100,000 tokens</li>
<li>消息数量后备：200条消息限制</li>
<li>成本触发器：$5.00成本阈值</li>
</ul>
</li>
<li><strong>压缩流程</strong>：<ul>
<li>识别保留消息（最近、重要、系统消息）</li>
<li>通过LLM生成摘要</li>
<li>重构消息历史</li>
</ul>
</li>
</ul>
<h3 id="3-动态系统提示组装"><a href="#3-动态系统提示组装" class="headerlink" title="3. 动态系统提示组装"></a>3. 动态系统提示组装</h3><ul>
<li><strong>组件化策略</strong>：基础提示 + 模型适配 + CLAUDE.md + Git上下文 + 目录结构 + 工具定义</li>
<li><strong>模型特定优化</strong>：<ul>
<li>Opus：详细风格，30%上下文用于推理</li>
<li>Sonnet：平衡风格，20%上下文用于推理</li>
<li>Haiku：简洁风格，10%上下文用于推理</li>
</ul>
</li>
<li><strong>并行获取</strong>：所有动态组件并行获取，智能截断组合</li>
</ul>
<h3 id="4-流状态机"><a href="#4-流状态机" class="headerlink" title="4. 流状态机"></a>4. 流状态机</h3><ul>
<li><strong>事件驱动架构</strong>：message_start → content_block_start → content_block_delta → content_block_stop → message_stop</li>
<li><strong>实时UI更新</strong>：文本增量直接更新UI，工具输入累积后解析</li>
<li><strong>智能JSON解析</strong>：在策略点（}或]）尝试解析，避免频繁解析失败</li>
</ul>
<h2 id="工具执行管道"><a href="#工具执行管道" class="headerlink" title="工具执行管道"></a>工具执行管道</h2><h3 id="并行-顺序执行策略"><a href="#并行-顺序执行策略" class="headerlink" title="并行/顺序执行策略"></a>并行/顺序执行策略</h3><ul>
<li><strong>分类执行</strong>：<ul>
<li>只读工具（ReadTool、GrepTool、WebFetchTool）：并行执行，限制10个并发</li>
<li>写入工具（EditTool、BashTool）：顺序执行，避免冲突</li>
</ul>
</li>
<li><strong>性能优化</strong>：<ul>
<li>自定义parallelMap实现，支持背压控制</li>
<li>竞争机制确保高效完成检测</li>
<li>动态槽位填充，最大化并发利用率</li>
</ul>
</li>
</ul>
<h3 id="执行时间分析"><a href="#执行时间分析" class="headerlink" title="执行时间分析"></a>执行时间分析</h3><table>
<thead>
<tr>
<th>工具类型</th>
<th>并发度</th>
<th>典型延迟</th>
<th>瓶颈</th>
</tr>
</thead>
<tbody><tr>
<td>读取工具</td>
<td>并行 (10)</td>
<td>10-50毫秒</td>
<td>磁盘I/O</td>
</tr>
<tr>
<td>搜索工具</td>
<td>并行 (10)</td>
<td>100-500毫秒</td>
<td>CPU正则表达式</td>
</tr>
<tr>
<td>网络获取工具</td>
<td>并行 (3)</td>
<td>500-3000毫秒</td>
<td>网络</td>
</tr>
<tr>
<td>编辑工具</td>
<td>顺序</td>
<td>20-100毫秒</td>
<td>验证</td>
</tr>
<tr>
<td>Bash工具</td>
<td>顺序</td>
<td>50-10000毫秒</td>
<td>进程执行</td>
</tr>
<tr>
<td>代理工具</td>
<td>并行 (5)</td>
<td>2000-20000毫秒</td>
<td>子LLM调用</td>
</tr>
</tbody></table>
<h2 id="权限控制系统"><a href="#权限控制系统" class="headerlink" title="权限控制系统"></a>权限控制系统</h2><h3 id="多层决策树"><a href="#多层决策树" class="headerlink" title="多层决策树"></a>多层决策树</h3><ol>
<li><strong>层级1</strong>：明确拒绝规则（最高优先级）</li>
<li><strong>层级2</strong>：模式覆盖检查（绕过权限、接受编辑模式）</li>
<li><strong>层级3</strong>：明确允许规则</li>
<li><strong>层级4</strong>：交互式提示</li>
</ol>
<ul>
<li><strong>规则优先级</strong>：CLI参数 &gt; 本地设置 &gt; 项目设置 &gt; 策略设置 &gt; 用户设置</li>
</ul>
<h3 id="递归轮次管理"><a href="#递归轮次管理" class="headerlink" title="递归轮次管理"></a>递归轮次管理</h3><ul>
<li><strong>深度限制</strong>：最大10轮递归，防止无限循环</li>
<li><strong>状态传递</strong>：轮次ID、计数器、压缩标志、恢复状态</li>
<li><strong>尾递归优化</strong>：高效的递归调用实现</li>
</ul>
<h2 id="高级控制流模式-1"><a href="#高级控制流模式-1" class="headerlink" title="高级控制流模式"></a>高级控制流模式</h2><h3 id="1-输入路由状态机-1"><a href="#1-输入路由状态机-1" class="headerlink" title="1. 输入路由状态机"></a>1. 输入路由状态机</h3><ul>
<li><strong>智能识别</strong>：<ul>
<li><code>/</code> → 斜杠命令</li>
<li><code>!</code> → Bash模式（合成工具使用）</li>
<li><code>#</code> → 内存模式（更新CLAUDE.md）</li>
<li>粘贴事件 → 内容类型检测</li>
</ul>
</li>
<li><strong>合成对话</strong>：Bash模式创建用户消息和助手工具使用的合成对话</li>
</ul>
<h3 id="2-流背压管理-1"><a href="#2-流背压管理-1" class="headerlink" title="2. 流背压管理"></a>2. 流背压管理</h3><ul>
<li><strong>缓冲控制</strong>：最大1000个缓冲事件</li>
<li><strong>压力检测</strong>：动态暂停和恢复机制</li>
<li><strong>优先级处理</strong>：工具结果和错误立即处理，文本增量可缓冲</li>
<li><strong>定期排空</strong>：非暂停状态下定期清空缓冲区</li>
</ul>
<h3 id="3-AgentTool层次控制流-1"><a href="#3-AgentTool层次控制流-1" class="headerlink" title="3. AgentTool层次控制流"></a>3. AgentTool层次控制流</h3><ul>
<li><strong>父子架构</strong>：<ul>
<li>主代理 → 任务分割 → 子代理并行执行 → 结果收集 → LLM合成 → 返回主代理</li>
</ul>
</li>
<li><strong>隔离上下文</strong>：子代理拥有过滤的工具集和独立的abort控制器</li>
<li><strong>多结果合成</strong>：通过LLM将多个子任务结果合成为连贯响应</li>
</ul>
<h3 id="4-错误恢复控制流-1"><a href="#4-错误恢复控制流-1" class="headerlink" title="4. 错误恢复控制流"></a>4. 错误恢复控制流</h3><ul>
<li><strong>分类恢复策略</strong>：<ul>
<li>速率限制：多提供商后备</li>
<li>上下文溢出：减少tokens或强制压缩</li>
<li>工具错误：重试或降级</li>
<li>网络错误：重试机制</li>
<li>权限拒绝：用户提示</li>
</ul>
</li>
<li><strong>多提供商后备</strong>：Anthropic → Bedrock → Vertex的故障转移</li>
</ul>
<h2 id="性能分析与优化"><a href="#性能分析与优化" class="headerlink" title="性能分析与优化"></a>性能分析与优化</h2><h3 id="性能分析点-1"><a href="#性能分析点-1" class="headerlink" title="性能分析点"></a>性能分析点</h3><ul>
<li><strong>生成器仪表化</strong>：测量产出间延迟、总执行时间、产出计数</li>
<li><strong>OpenTelemetry集成</strong>：跨服务的性能追踪</li>
<li><strong>关键指标</strong>：<ul>
<li>首个token延迟</li>
<li>每秒token数</li>
<li>工具执行时间</li>
<li>内存使用情况</li>
</ul>
</li>
</ul>
<h3 id="时间优化策略"><a href="#时间优化策略" class="headerlink" title="时间优化策略"></a>时间优化策略</h3><ul>
<li><strong>并行处理</strong>：尽可能并行执行只读操作</li>
<li><strong>智能缓存</strong>：系统提示组件缓存</li>
<li><strong>延迟加载</strong>：按需加载重量级依赖</li>
<li><strong>背压控制</strong>：防止内存溢出的流控制</li>
</ul>
<h2 id="技术创新点"><a href="#技术创新点" class="headerlink" title="技术创新点"></a>技术创新点</h2><h3 id="架构创新"><a href="#架构创新" class="headerlink" title="架构创新"></a>架构创新</h3><ol>
<li><strong>流式状态机</strong>：复杂的事件驱动对话管理</li>
<li><strong>分层权限系统</strong>：灵活的多层安全控制</li>
<li><strong>工具编排引擎</strong>：智能的并行/顺序执行策略</li>
<li><strong>层次代理系统</strong>：父子代理的任务分解和合成</li>
</ol>
<h3 id="性能创新"><a href="#性能创新" class="headerlink" title="性能创新"></a>性能创新</h3><ol>
<li><strong>智能压缩</strong>：基于多个维度的上下文压缩策略</li>
<li><strong>背压管理</strong>：防止系统过载的流控制机制</li>
<li><strong>并发优化</strong>：工具执行的最大化并行化</li>
<li><strong>缓存策略</strong>：多层次的智能缓存机制</li>
</ol>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><ol>
<li><strong>错误恢复</strong>：全面的错误分类和恢复策略</li>
<li><strong>性能监控</strong>：深度的性能分析和追踪</li>
<li><strong>状态管理</strong>：复杂的递归状态传递</li>
<li><strong>模块化设计</strong>：高度解耦的组件架构</li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Claude Code的控制流与编排引擎体现了现代异步编程和分布式系统的最佳实践。其核心价值在于：</p>
<ul>
<li><strong>高性能</strong>：多层次的并行处理和智能优化</li>
<li><strong>可靠性</strong>：全面的错误恢复和故障转移机制</li>
<li><strong>可扩展性</strong>：模块化的工具系统和代理架构</li>
<li><strong>用户体验</strong>：实时的进度反馈和流畅的交互</li>
</ul>
<p>这种复杂的编排设计为AI助手应用提供了优秀的架构模板，特别是在需要处理复杂工作流程和实时交互的场景中。文档的深入分析为理解现代AI系统的控制流设计提供了宝贵的技术参考，展现了如何在大规模异步环境中保持系统的响应性和稳定性。</p>
<p>整个架构的成功关键在于平衡了复杂性（功能完整性）与性能（响应速度），通过精密的状态机和编排策略，实现了既强大又高效的AI助手体验。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">寒霜</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://hanshuang-ai.github.io/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://hanshuang-ai.github.io/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/')">claude-code控制流与编排引擎</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://hanshuang-ai.github.io/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=claude-code控制流与编排引擎&amp;url=https://hanshuang-ai.github.io/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hanshuang-ai.github.io" target="_blank">我的博客</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/10/23/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">claude-code数据结构与消息架构</div></div></a></div><div class="next-post pull-right"><a href="/2025/10/23/claude-code-gong-ju-yu-zhi-xing-yin-qing/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">claude-code工具与执行引擎</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Control-Flow-amp-The-Orchestration-Engine"><span class="toc-number">1.</span> <span class="toc-text">Control Flow &amp; The Orchestration Engine</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%B5%81%E4%B8%8E%E7%BC%96%E6%8E%92%E5%BC%95%E6%93%8E"><span class="toc-number">2.</span> <span class="toc-text">控制流与编排引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Main-Conversation-Loop-A-Streaming-State-Machine"><span class="toc-number">2.1.</span> <span class="toc-text">The Main Conversation Loop: A Streaming State Machine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E5%AF%B9%E8%AF%9D%E5%BE%AA%E7%8E%AF%EF%BC%9A%E6%B5%81%E5%BC%8F%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">2.2.</span> <span class="toc-text">主对话循环：流式状态机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Phase-1-Context-Window-Management"><span class="toc-number">2.2.1.</span> <span class="toc-text">Phase 1: Context Window Management</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B51%EF%BC%9A%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AA%97%E5%8F%A3%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.2.</span> <span class="toc-text">阶段1：上下文窗口管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phase-2-Dynamic-System-Prompt-Assembly"><span class="toc-number">2.2.3.</span> <span class="toc-text">Phase 2: Dynamic System Prompt Assembly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B52%EF%BC%9A%E5%8A%A8%E6%80%81%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%E7%BB%84%E8%A3%85"><span class="toc-number">2.2.4.</span> <span class="toc-text">阶段2：动态系统提示组装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phase-3-The-Streaming-State-Machine"><span class="toc-number">2.2.5.</span> <span class="toc-text">Phase 3: The Streaming State Machine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B53%EF%BC%9A%E6%B5%81%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">2.2.6.</span> <span class="toc-text">阶段3：流状态机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phase-4-The-Tool-Execution-Pipeline"><span class="toc-number">2.2.7.</span> <span class="toc-text">Phase 4: The Tool Execution Pipeline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B54%EF%BC%9A%E5%B7%A5%E5%85%B7%E6%89%A7%E8%A1%8C%E7%AE%A1%E9%81%93"><span class="toc-number">2.2.8.</span> <span class="toc-text">阶段4：工具执行管道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phase-5-Permission-Control-Flow"><span class="toc-number">2.2.9.</span> <span class="toc-text">Phase 5: Permission Control Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B55%EF%BC%9A%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="toc-number">2.2.10.</span> <span class="toc-text">阶段5：权限控制流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phase-6-Recursive-Turn-Management"><span class="toc-number">2.2.11.</span> <span class="toc-text">Phase 6: Recursive Turn Management</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B56%EF%BC%9A%E9%80%92%E5%BD%92%E8%BD%AE%E6%AC%A1%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.12.</span> <span class="toc-text">阶段6：递归轮次管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Advanced-Control-Flow-Patterns"><span class="toc-number">2.3.</span> <span class="toc-text">Advanced Control Flow Patterns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E6%8E%A7%E5%88%B6%E6%B5%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.4.</span> <span class="toc-text">高级控制流模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Input-Router-State-Machine"><span class="toc-number">2.4.1.</span> <span class="toc-text">1. Input Router State Machine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%BE%93%E5%85%A5%E8%B7%AF%E7%94%B1%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">2.4.2.</span> <span class="toc-text">1. 输入路由状态机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Stream-Backpressure-Management"><span class="toc-number">2.4.3.</span> <span class="toc-text">2. Stream Backpressure Management</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B5%81%E8%83%8C%E5%8E%8B%E7%AE%A1%E7%90%86"><span class="toc-number">2.4.4.</span> <span class="toc-text">2. 流背压管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-AgentTool-Hierarchical-Control-Flow"><span class="toc-number">2.4.5.</span> <span class="toc-text">3. AgentTool Hierarchical Control Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-AgentTool%E5%B1%82%E6%AC%A1%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="toc-number">2.4.6.</span> <span class="toc-text">3. AgentTool层次控制流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Error-Recovery-Control-Flow"><span class="toc-number">2.4.7.</span> <span class="toc-text">4. Error Recovery Control Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%94%99%E8%AF%AF%E6%81%A2%E5%A4%8D%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="toc-number">2.4.8.</span> <span class="toc-text">4. 错误恢复控制流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performance-Profiling-Points"><span class="toc-number">2.5.</span> <span class="toc-text">Performance Profiling Points</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E7%82%B9"><span class="toc-number">2.6.</span> <span class="toc-text">性能分析点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">文件总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E7%89%B9%E7%82%B9"><span class="toc-number">3.2.</span> <span class="toc-text">核心架构特点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%BB%E5%AF%B9%E8%AF%9D%E5%BE%AA%E7%8E%AF%EF%BC%9A%E6%B5%81%E5%BC%8F%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">3.2.1.</span> <span class="toc-text">1. 主对话循环：流式状态机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AA%97%E5%8F%A3%E7%AE%A1%E7%90%86"><span class="toc-number">3.2.2.</span> <span class="toc-text">2. 上下文窗口管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8A%A8%E6%80%81%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%E7%BB%84%E8%A3%85"><span class="toc-number">3.2.3.</span> <span class="toc-text">3. 动态系统提示组装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%B5%81%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">3.2.4.</span> <span class="toc-text">4. 流状态机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E6%89%A7%E8%A1%8C%E7%AE%A1%E9%81%93"><span class="toc-number">3.3.</span> <span class="toc-text">工具执行管道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C-%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%E7%AD%96%E7%95%A5"><span class="toc-number">3.3.1.</span> <span class="toc-text">并行&#x2F;顺序执行策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4%E5%88%86%E6%9E%90"><span class="toc-number">3.3.2.</span> <span class="toc-text">执行时间分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.4.</span> <span class="toc-text">权限控制系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%B1%82%E5%86%B3%E7%AD%96%E6%A0%91"><span class="toc-number">3.4.1.</span> <span class="toc-text">多层决策树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E8%BD%AE%E6%AC%A1%E7%AE%A1%E7%90%86"><span class="toc-number">3.4.2.</span> <span class="toc-text">递归轮次管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E6%8E%A7%E5%88%B6%E6%B5%81%E6%A8%A1%E5%BC%8F-1"><span class="toc-number">3.5.</span> <span class="toc-text">高级控制流模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%BE%93%E5%85%A5%E8%B7%AF%E7%94%B1%E7%8A%B6%E6%80%81%E6%9C%BA-1"><span class="toc-number">3.5.1.</span> <span class="toc-text">1. 输入路由状态机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B5%81%E8%83%8C%E5%8E%8B%E7%AE%A1%E7%90%86-1"><span class="toc-number">3.5.2.</span> <span class="toc-text">2. 流背压管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-AgentTool%E5%B1%82%E6%AC%A1%E6%8E%A7%E5%88%B6%E6%B5%81-1"><span class="toc-number">3.5.3.</span> <span class="toc-text">3. AgentTool层次控制流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%94%99%E8%AF%AF%E6%81%A2%E5%A4%8D%E6%8E%A7%E5%88%B6%E6%B5%81-1"><span class="toc-number">3.5.4.</span> <span class="toc-text">4. 错误恢复控制流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="toc-number">3.6.</span> <span class="toc-text">性能分析与优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E7%82%B9-1"><span class="toc-number">3.6.1.</span> <span class="toc-text">性能分析点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">3.6.2.</span> <span class="toc-text">时间优化策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%88%9B%E6%96%B0%E7%82%B9"><span class="toc-number">3.7.</span> <span class="toc-text">技术创新点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%88%9B%E6%96%B0"><span class="toc-number">3.7.1.</span> <span class="toc-text">架构创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%9B%E6%96%B0"><span class="toc-number">3.7.2.</span> <span class="toc-text">性能创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.7.3.</span> <span class="toc-text">工程实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">3.8.</span> <span class="toc-text">结论</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/25/macos-an-zhuang-homebrew/" title="macOS安装homebrew">macOS安装homebrew</a><time datetime="2025-12-25T12:09:27.713Z" title="更新于 2025-12-25 20:09:27">2025-12-25</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2025/01/16/go-yu-yan-ru-men-zhi-nan/" title="Go语言入门指南">Go语言入门指南</a><time datetime="2025-12-16T12:44:28.982Z" title="更新于 2025-12-16 20:44:28">2025-12-16</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2025/12/16/php-shu-zu-wan-quan-zhi-nan/" title="PHP数组完全指南">PHP数组完全指南</a><time datetime="2025-12-16T11:12:19.007Z" title="更新于 2025-12-16 19:12:19">2025-12-16</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2024/12/16/claude-code-agent-sdk-jie-ru-zi-yan-cha-jian/" title="Claude Code Agent SDK 接入自研插件">Claude Code Agent SDK 接入自研插件</a><time datetime="2025-12-16T10:15:32.430Z" title="更新于 2025-12-16 18:15:32">2025-12-16</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2025/11/20/react-ji-chu/" title="React核心基础与实践指南">React核心基础与实践指南</a><time datetime="2025-11-20T05:34:53.956Z" title="更新于 2025-11-20 13:34:53">2025-11-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 寒霜</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">167</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">121</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://hexo.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 0.88rem;">AI<sup>1</sup></a><a href="/tags/Claude/" style="font-size: 0.88rem;">Claude<sup>1</sup></a><a href="/tags/Go/" style="font-size: 0.88rem;">Go<sup>1</sup></a><a href="/tags/Golang/" style="font-size: 0.88rem;">Golang<sup>1</sup></a><a href="/tags/HTML%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">HTML基础<sup>1</sup></a><a href="/tags/SDK/" style="font-size: 0.88rem;">SDK<sup>1</sup></a><a href="/tags/base64/" style="font-size: 0.88rem;">base64<sup>1</sup></a><a href="/tags/canvas/" style="font-size: 0.88rem;">canvas<sup>2</sup></a><a href="/tags/cesium/" style="font-size: 0.88rem;">cesium<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>5</sup></a><a href="/tags/docker/" style="font-size: 0.88rem;">docker<sup>3</sup></a><a href="/tags/echart/" style="font-size: 0.88rem;">echart<sup>1</sup></a><a href="/tags/electron/" style="font-size: 0.88rem;">electron<sup>2</sup></a><a href="/tags/elementUI/" style="font-size: 0.88rem;">elementUI<sup>1</sup></a><a href="/tags/flex/" style="font-size: 0.88rem;">flex<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>3</sup></a><a href="/tags/javascript/" style="font-size: 0.88rem;">javascript<sup>1</sup></a><a href="/tags/js/" style="font-size: 0.88rem;">js<sup>2</sup></a><a href="/tags/position/" style="font-size: 0.88rem;">position<sup>1</sup></a><a href="/tags/vue/" style="font-size: 0.88rem;">vue<sup>17</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" style="font-size: 0.88rem;">事件循环<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/" style="font-size: 0.88rem;">事件监听<sup>1</sup></a><a href="/tags/%E5%8F%AF%E8%A7%86%E5%8C%96/" style="font-size: 0.88rem;">可视化<sup>3</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 0.88rem;">后端<sup>1</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/" style="font-size: 0.88rem;">基本命令<sup>2</sup></a><a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 0.88rem;">存储<sup>1</sup></a><a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 0.88rem;">实战<sup>31</sup></a><a href="/tags/%E5%B8%83%E5%B1%80/" style="font-size: 0.88rem;">布局<sup>1</sup></a><a href="/tags/%E6%89%93%E5%8D%B0/" style="font-size: 0.88rem;">打印<sup>1</sup></a><a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">插件开发<sup>1</sup></a><a href="/tags/%E6%A8%AA%E7%AB%96%E5%B1%8F%E6%A3%80%E6%B5%8B/" style="font-size: 0.88rem;">横竖屏检测<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 0.88rem;">正则<sup>4</sup></a><a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 0.88rem;">浏览器<sup>5</sup></a><a href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/" style="font-size: 0.88rem;">盒模型<sup>1</sup></a><a href="/tags/%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/" style="font-size: 0.88rem;">组件通信<sup>2</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 0.88rem;">缓存<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">编程语言<sup>1</sup></a><a href="/tags/%E8%B7%AF%E7%94%B1/" style="font-size: 0.88rem;">路由<sup>1</sup></a><a href="/tags/%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size: 0.88rem;">过滤器<sup>3</sup></a><a href="/tags/%E9%9F%B3%E9%A2%91/" style="font-size: 0.88rem;">音频<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.7.1",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 寒霜 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>