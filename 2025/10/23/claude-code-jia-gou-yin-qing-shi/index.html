<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="claude-code架构-引擎室, 我的博客">
    <meta name="description" content="参考链接
Architecture: The Engine Room架构：引擎室graph TB
    subgraph &#34;核心：tt控制循环&#34;
        Start([用户输入]) --&gt; Init[初始化回合]
        ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>claude-code架构-引擎室 | 我的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">我的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">我的博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">claude-code架构-引擎室</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-10-23
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-10-24
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    27 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><a target="_blank" rel="noopener" href="https://southbridge-research.notion.site/Architecture-The-Engine-Room-2055fec70db18192963cd6b3a5326476">参考链接</a></p>
<h1 id="Architecture-The-Engine-Room"><a href="#Architecture-The-Engine-Room" class="headerlink" title="Architecture: The Engine Room"></a>Architecture: The Engine Room</h1><h1 id="架构：引擎室"><a href="#架构：引擎室" class="headerlink" title="架构：引擎室"></a>架构：引擎室</h1><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TB
    <span class="token keyword">subgraph</span> <span class="token string">"核心：tt控制循环"</span>
        Start<span class="token text string">([用户输入])</span> <span class="token arrow operator">--></span> Init<span class="token text string">[初始化回合]</span>
        Init <span class="token arrow operator">--></span> Compact<span class="token text string">&#123;需要压缩？&#125;</span>
        Compact <span class="token arrow operator">--></span><span class="token label property">|是|</span> CompactLLM<span class="token text string">[LLM总结]</span>
        CompactLLM <span class="token arrow operator">--></span> Assembly
        Compact <span class="token arrow operator">--></span><span class="token label property">|否|</span> Assembly<span class="token text string">[组装上下文]</span>

        Assembly <span class="token arrow operator">--></span> Stream<span class="token text string">[流式传输到LLM]</span>
        Stream <span class="token arrow operator">--></span> Process<span class="token text string">[处理事件]</span>
        Process <span class="token arrow operator">--></span> Tools<span class="token text string">&#123;工具请求？&#125;</span>

        Tools <span class="token arrow operator">--></span><span class="token label property">|是|</span> Execute<span class="token text string">[执行工具]</span>
        Execute <span class="token arrow operator">--></span> Recurse<span class="token text string">[递归tt]</span>
        Recurse <span class="token arrow operator">--></span> Init

        Tools <span class="token arrow operator">--></span><span class="token label property">|否|</span> End<span class="token text string">([完成])</span>
    <span class="token keyword">end</span>

    <span class="token keyword">style</span> Init <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#e1f5fe</span>
    <span class="token keyword">style</span> Stream <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#fff3e0</span>
    <span class="token keyword">style</span> Execute <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#e8f5e9</span>
    <span class="token keyword">style</span> Recurse <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#fce4ec</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2025/10/23/claude-code-jia-gou-yin-qing-shi/1.svg" class="">
<h2 id="tt控制循环：跳动的心脏"><a href="#tt控制循环：跳动的心脏" class="headerlink" title="tt控制循环：跳动的心脏"></a><code>tt</code>控制循环：跳动的心脏</h2><p>整个Claude Code系统围绕一个名为<code>tt</code>的异步生成器函数运转。这个函数协调每一次交互，从用户输入到LLM通信再到工具执行。让我们剖析这个卓越的工程奇迹：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 来自代码库的实际tt函数签名</span>
<span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">tt</span><span class="token punctuation">(</span>
  currentMessages<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment">// 完整的对话历史</span>
  baseSystemPromptString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>        <span class="token comment">// 静态系统指令</span>
  currentGitContext<span class="token operator">:</span> GitContext<span class="token punctuation">,</span>         <span class="token comment">// 实时git状态</span>
  currentClaudeMdContents<span class="token operator">:</span> ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 项目上下文</span>
  permissionGranterFn<span class="token operator">:</span> PermissionGranter<span class="token punctuation">,</span> <span class="token comment">// 权限回调</span>
  toolUseContext<span class="token operator">:</span> ToolUseContext<span class="token punctuation">,</span>         <span class="token comment">// 共享执行上下文</span>
  activeStreamingToolUse<span class="token operator">?</span><span class="token operator">:</span> ToolUseBlock<span class="token punctuation">,</span>  <span class="token comment">// 恢复流式状态</span>
  loopState<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    turnId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>        <span class="token comment">// 本回合的UUID</span>
    turnCounter<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>   <span class="token comment">// 递归深度跟踪器</span>
    compacted<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>   <span class="token comment">// 历史压缩标志</span>
    isResuming<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>   <span class="token comment">// 从保存状态恢复</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个签名揭示了在起作用的复杂状态管理。该函数产生<code>CliMessage</code>对象，这些对象驱动UI更新，同时保持对话流程。让我们检查每个阶段：</p>
<h3 id="阶段1：回合初始化和上下文准备"><a href="#阶段1：回合初始化和上下文准备" class="headerlink" title="阶段1：回合初始化和上下文准备"></a>阶段1：回合初始化和上下文准备</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token comment">// 通知UI处理已经开始</span>
  <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
    type<span class="token operator">:</span> <span class="token string">"ui_state_update"</span><span class="token punctuation">,</span>
    uuid<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">uistate-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>loopState<span class="token punctuation">.</span>turnId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    timestamp<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">"thinking"</span><span class="token punctuation">,</span> turnId<span class="token operator">:</span> loopState<span class="token punctuation">.</span>turnId <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// 检查上下文窗口压力</span>
  <span class="token keyword">let</span> messagesForLlm <span class="token operator">=</span> currentMessages<span class="token punctuation">;</span>
  <span class="token keyword">let</span> wasCompactedThisIteration <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">shouldAutoCompact</span><span class="token punctuation">(</span>currentMessages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">"ui_notification"</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> message<span class="token operator">:</span> <span class="token string">"上下文较大，尝试压缩..."</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> compactionResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">compactAndStoreConversation</span><span class="token punctuation">(</span>
        currentMessages<span class="token punctuation">,</span>
        toolUseContext<span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      messagesForLlm <span class="token operator">=</span> compactionResult<span class="token punctuation">.</span>messagesAfterCompacting<span class="token punctuation">;</span>
      wasCompactedThisIteration <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      loopState<span class="token punctuation">.</span>compacted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token keyword">yield</span> <span class="token function">createSystemNotificationMessage</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">对话历史已自动压缩。摘要：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>
          compactionResult<span class="token punctuation">.</span>summaryMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text
        <span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>compactionError<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token function">createSystemErrorMessage</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">压缩对话失败：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>compactionError<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>阶段1性能概况</strong>：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>典型持续时间</th>
<th>复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>Token计数</td>
<td>10-50ms</td>
<td>O(n) 消息</td>
</tr>
<tr>
<td>压缩决策</td>
<td>&lt;1ms</td>
<td>O(1)</td>
</tr>
<tr>
<td>LLM总结</td>
<td>2000-3000ms</td>
<td>一次LLM调用</td>
</tr>
<tr>
<td>消息重构</td>
<td>5-10ms</td>
<td>O(n) 消息</td>
</tr>
</tbody></table>
<h3 id="阶段2：动态系统提示组装"><a href="#阶段2：动态系统提示组装" class="headerlink" title="阶段2：动态系统提示组装"></a>阶段2：动态系统提示组装</h3><p>系统提示不是静态的——它是为每个回合新组装的：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token comment">// 并行获取所有上下文源</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>toolSpecs<span class="token punctuation">,</span> dirStructure<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment">// 将工具定义转换为LLM兼容的规格</span>
    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      toolUseContext<span class="token punctuation">.</span>options<span class="token punctuation">.</span>tools
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>tool <span class="token operator">=></span> tool<span class="token punctuation">.</span>isEnabled <span class="token operator">?</span> tool<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>tool<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">convertToolDefinitionToToolSpecification</span><span class="token punctuation">(</span>tool<span class="token punctuation">,</span> toolUseContext<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 获取当前目录结构</span>
    <span class="token function">getDirectoryStructureSnapshot</span><span class="token punctuation">(</span>toolUseContext<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 组装完整的系统提示</span>
  <span class="token keyword">const</span> systemPromptForLlm <span class="token operator">=</span> <span class="token function">assembleSystemPrompt</span><span class="token punctuation">(</span>
    baseSystemPromptString<span class="token punctuation">,</span>      <span class="token comment">// 核心指令</span>
    currentClaudeMdContents<span class="token punctuation">,</span>     <span class="token comment">// 项目特定上下文</span>
    currentGitContext<span class="token punctuation">,</span>           <span class="token comment">// Git状态/分支/提交</span>
    dirStructure<span class="token punctuation">,</span>                <span class="token comment">// 文件树</span>
    toolSpecs                    <span class="token comment">// 可用工具</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 准备带缓存控制的消息</span>
  <span class="token keyword">const</span> apiMessages <span class="token operator">=</span> <span class="token function">prepareMessagesForApi</span><span class="token punctuation">(</span>
    messagesForLlm<span class="token punctuation">,</span>
    <span class="token boolean">true</span> <span class="token comment">// applyEphemeralCacheControl</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>组装过程遵循严格的优先级顺序：</p>
<pre class="line-numbers language-none"><code class="language-none">优先级1：基础指令 (~2KB)
    ↓
优先级2：模型特定适配 (~500B)
    ↓
优先级3：CLAUDE.md内容 (可变，通常5-50KB)
    ↓
优先级4：Git上下文 (~1-5KB)
    ↓
优先级5：目录结构 (截断以适应)
    ↓
优先级6：工具规格 (~10-20KB)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="阶段3：LLM流初始化"><a href="#阶段3：LLM流初始化" class="headerlink" title="阶段3：LLM流初始化"></a>阶段3：LLM流初始化</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token comment">// 初始化流式调用</span>
  <span class="token keyword">const</span> llmStream <span class="token operator">=</span> <span class="token function">callLlmStreamApi</span><span class="token punctuation">(</span>
    apiMessages<span class="token punctuation">,</span>
    systemPromptForLlm<span class="token punctuation">,</span>
    toolSpecificationsForLlm<span class="token punctuation">,</span>
    toolUseContext<span class="token punctuation">.</span>options<span class="token punctuation">.</span>mainLoopModel<span class="token punctuation">,</span>
    toolUseContext<span class="token punctuation">.</span>abortController<span class="token punctuation">.</span>signal
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 为流式响应初始化累加器</span>
  <span class="token keyword">let</span> accumulatedAssistantMessage<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span> <span class="token operator">&amp;</span> <span class="token punctuation">&#123;</span>
    message<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>ApiMessage<span class="token operator">></span> <span class="token operator">&amp;</span> <span class="token punctuation">&#123;</span> content<span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    type<span class="token operator">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span>
    uuid<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">assistant-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>loopState<span class="token punctuation">.</span>turnId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>loopState<span class="token punctuation">.</span>turnCounter<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    timestamp<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token punctuation">&#123;</span> role<span class="token operator">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> currentToolUsesFromLlm<span class="token operator">:</span> ToolUseBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentThinkingContent<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentToolInputJsonBuffer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="阶段4：流事件处理状态机"><a href="#阶段4：流事件处理状态机" class="headerlink" title="阶段4：流事件处理状态机"></a>阶段4：流事件处理状态机</h3><p>这就是魔法发生的地方——实时处理流事件：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> streamEvent <span class="token keyword">of</span> llmStream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 中止检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toolUseContext<span class="token punctuation">.</span>abortController<span class="token punctuation">.</span>signal<span class="token punctuation">.</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token function">createSystemNotificationMessage</span><span class="token punctuation">(</span><span class="token string">"LLM流处理被用户中止。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token string">"message_start"</span><span class="token operator">:</span>
        accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>id <span class="token operator">=</span> streamEvent<span class="token punctuation">.</span>message<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
        accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>model <span class="token operator">=</span> streamEvent<span class="token punctuation">.</span>message<span class="token punctuation">.</span>model<span class="token punctuation">;</span>
        accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>usage <span class="token operator">=</span> streamEvent<span class="token punctuation">.</span>message<span class="token punctuation">.</span>usage<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">"ui_state_update"</span><span class="token punctuation">,</span>
          data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            status<span class="token operator">:</span> <span class="token string">"assistant_responding"</span><span class="token punctuation">,</span>
            model<span class="token operator">:</span> streamEvent<span class="token punctuation">.</span>message<span class="token punctuation">.</span>model
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">"content_block_start"</span><span class="token operator">:</span>
        <span class="token keyword">const</span> newBlockPlaceholder <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>streamEvent<span class="token punctuation">.</span>content_block <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据块类型初始化空内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>content_block<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"thinking"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          currentThinkingContent <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
          newBlockPlaceholder<span class="token punctuation">.</span>thinking <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>content_block<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"tool_use"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          currentToolInputJsonBuffer <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
          newBlockPlaceholder<span class="token punctuation">.</span>input <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>content_block<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"text"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          newBlockPlaceholder<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newBlockPlaceholder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">"content_block_delta"</span><span class="token operator">:</span>
        <span class="token keyword">const</span> lastBlockIndex <span class="token operator">=</span> accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastBlockIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> currentBlock <span class="token operator">=</span> accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">[</span>lastBlockIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"text_delta"</span> <span class="token operator">&amp;&amp;</span> currentBlock<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"text"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          currentBlock<span class="token punctuation">.</span>text <span class="token operator">+=</span> streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
          <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token string">"ui_text_delta"</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              textDelta<span class="token operator">:</span> streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
              blockIndex<span class="token operator">:</span> lastBlockIndex
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"input_json_delta"</span> <span class="token operator">&amp;&amp;</span> currentBlock<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"tool_use"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          currentToolInputJsonBuffer <span class="token operator">+=</span> streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>partial_json<span class="token punctuation">;</span>
          currentBlock<span class="token punctuation">.</span>input <span class="token operator">=</span> currentToolInputJsonBuffer<span class="token punctuation">;</span>

          <span class="token comment">// 尝试解析不完整的JSON进行预览</span>
          <span class="token keyword">const</span> parseAttempt <span class="token operator">=</span> <span class="token function">tryParsePartialJson</span><span class="token punctuation">(</span>currentToolInputJsonBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>parseAttempt<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
              type<span class="token operator">:</span> <span class="token string">"ui_tool_preview"</span><span class="token punctuation">,</span>
              data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                toolId<span class="token operator">:</span> currentBlock<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                preview<span class="token operator">:</span> parseAttempt<span class="token punctuation">.</span>value
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">"content_block_stop"</span><span class="token operator">:</span>
        <span class="token keyword">const</span> completedBlock <span class="token operator">=</span> accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">[</span>streamEvent<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>completedBlock<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"tool_use"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> parsedInput <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>currentToolInputJsonBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            completedBlock<span class="token punctuation">.</span>input <span class="token operator">=</span> parsedInput<span class="token punctuation">;</span>
            currentToolUsesFromLlm<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
              type<span class="token operator">:</span> <span class="token string">"tool_use"</span><span class="token punctuation">,</span>
              id<span class="token operator">:</span> completedBlock<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
              name<span class="token operator">:</span> completedBlock<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
              input<span class="token operator">:</span> parsedInput
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 处理来自LLM的格式错误的JSON</span>
            completedBlock<span class="token punctuation">.</span>input <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
              error<span class="token operator">:</span> <span class="token string">"来自LLM的无效JSON输入"</span><span class="token punctuation">,</span>
              raw_json_string<span class="token operator">:</span> currentToolInputJsonBuffer<span class="token punctuation">,</span>
              parse_error<span class="token operator">:</span> e<span class="token punctuation">.</span>message
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          currentToolInputJsonBuffer <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">"ui_content_block_complete"</span><span class="token punctuation">,</span>
          data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> block<span class="token operator">:</span> completedBlock<span class="token punctuation">,</span> blockIndex<span class="token operator">:</span> streamEvent<span class="token punctuation">.</span>index <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">"message_stop"</span><span class="token operator">:</span>
        <span class="token comment">// LLM生成完成</span>
        <span class="token keyword">const</span> finalAssistantMessage <span class="token operator">=</span> <span class="token function">finalizeCliMessage</span><span class="token punctuation">(</span>
          accumulatedAssistantMessage<span class="token punctuation">,</span>
          loopState<span class="token punctuation">.</span>turnId<span class="token punctuation">,</span>
          loopState<span class="token punctuation">.</span>turnCounter
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> finalAssistantMessage<span class="token punctuation">;</span>

        <span class="token comment">// 移动到阶段5或6...</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>流处理性能</strong>：</p>
<ul>
<li>首个token延迟：300-800ms（因模型而异）</li>
<li>Token吞吐量：50-100 tokens/秒</li>
<li>UI更新频率：文本每个token更新，工具输入批量更新</li>
<li>内存使用：无论响应长度如何都保持恒定</li>
</ul>
<h3 id="阶段5：工具执行编排"><a href="#阶段5：工具执行编排" class="headerlink" title="阶段5：工具执行编排"></a>阶段5：工具执行编排</h3><p>当LLM请求使用工具时，架构转换到执行模式：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finalAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>stop_reason <span class="token operator">===</span> <span class="token string">"tool_use"</span> <span class="token operator">&amp;&amp;</span>
      currentToolUsesFromLlm<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">"ui_state_update"</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">"executing_tools"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> toolResultMessages<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 智能批量处理工具</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> toolOutcomeMessage <span class="token keyword">of</span> <span class="token function">processToolCallsInParallelBatches</span><span class="token punctuation">(</span>
      currentToolUsesFromLlm<span class="token punctuation">,</span>
      finalAssistantMessage<span class="token punctuation">,</span>
      permissionGranterFn<span class="token punctuation">,</span>
      toolUseContext
    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> toolOutcomeMessage<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>toolOutcomeMessage<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'user'</span> <span class="token operator">&amp;&amp;</span> toolOutcomeMessage<span class="token punctuation">.</span>isMeta<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        toolResultMessages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>toolOutcomeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查工具执行期间的中止</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toolUseContext<span class="token punctuation">.</span>abortController<span class="token punctuation">.</span>signal<span class="token punctuation">.</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token function">createSystemNotificationMessage</span><span class="token punctuation">(</span><span class="token string">"工具执行被用户中止。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 排序结果以匹配LLM的请求顺序</span>
    <span class="token keyword">const</span> sortedToolResultMessages <span class="token operator">=</span> <span class="token function">sortToolResultsByOriginalRequestOrder</span><span class="token punctuation">(</span>
      toolResultMessages<span class="token punctuation">,</span>
      currentToolUsesFromLlm
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段6：递归处理结果</span>
    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">tt</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span><span class="token operator">...</span>messagesForLlm<span class="token punctuation">,</span> finalAssistantMessage<span class="token punctuation">,</span> <span class="token operator">...</span>sortedToolResultMessages<span class="token punctuation">]</span><span class="token punctuation">,</span>
      baseSystemPromptString<span class="token punctuation">,</span>
      currentGitContext<span class="token punctuation">,</span>
      currentClaudeMdContents<span class="token punctuation">,</span>
      permissionGranterFn<span class="token punctuation">,</span>
      toolUseContext<span class="token punctuation">,</span>
      <span class="token keyword">undefined</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> <span class="token operator">...</span>loopState<span class="token punctuation">,</span> turnCounter<span class="token operator">:</span> loopState<span class="token punctuation">.</span>turnCounter <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="阶段6：递归控制"><a href="#阶段6：递归控制" class="headerlink" title="阶段6：递归控制"></a>阶段6：递归控制</h3><p><code>tt</code>函数是尾递归的，允许无限的对话深度（由安全措施限制）：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 递归安全措施</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>loopState<span class="token punctuation">.</span>turnCounter <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">yield</span> <span class="token function">createSystemMessage</span><span class="token punctuation">(</span>
    <span class="token string">"已达到最大对话深度。请开始新的查询。"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 递归前的内存压力检查</span>
<span class="token keyword">const</span> estimatedMemory <span class="token operator">=</span> <span class="token function">estimateConversationMemory</span><span class="token punctuation">(</span>messagesForLlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>estimatedMemory <span class="token operator">></span> <span class="token constant">MEMORY_THRESHOLD</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 继续前强制压缩</span>
  <span class="token keyword">const</span> compacted <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">forceCompaction</span><span class="token punctuation">(</span>messagesForLlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  messagesForLlm <span class="token operator">=</span> compacted<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="分层架构"><a href="#分层架构" class="headerlink" title="分层架构"></a>分层架构</h2><p>Claude Code实现了一个清晰的分层架构，每一层都有明确的职责：</p>
<pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TD
    <span class="token keyword">subgraph</span> <span class="token string">"第1层：用户界面"</span>
        React<span class="token text string">[React组件]</span>
        Ink<span class="token text string">[Ink渲染器]</span>
        Yoga<span class="token text string">[Yoga布局引擎]</span>

        React <span class="token arrow operator">--></span> Ink
        Ink <span class="token arrow operator">--></span> Yoga
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"第2层：代理核心"</span>
        TT<span class="token text string">[tt控制循环]</span>
        Context<span class="token text string">[上下文组装]</span>
        Permission<span class="token text string">[权限系统]</span>
        <span class="token keyword">State</span><span class="token text string">[会话状态]</span>

        TT <span class="token arrow operator">--></span> Context
        TT <span class="token arrow operator">--></span> Permission
        TT <span class="token arrow operator">--></span> State
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"第3层：LLM交互"</span>
        Stream<span class="token text string">[流处理器]</span>
        Retry<span class="token text string">[重试逻辑]</span>
        Token<span class="token text string">[Token计数器]</span>

        Stream <span class="token arrow operator">--></span> Retry
        Stream <span class="token arrow operator">--></span> Token
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"第4层：工具系统"</span>
        Executor<span class="token text string">[工具执行器]</span>
        Validator<span class="token text string">[输入验证器]</span>
        Sandbox<span class="token text string">[沙箱管理器]</span>

        Executor <span class="token arrow operator">--></span> Validator
        Executor <span class="token arrow operator">--></span> Sandbox
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"第5层：基础设施"</span>
        FS<span class="token text string">[文件系统]</span>
        Process<span class="token text string">[进程管理器]</span>
        Network<span class="token text string">[网络客户端]</span>
        Telemetry<span class="token text string">[遥测]</span>
    <span class="token keyword">end</span>

    React <span class="token arrow operator">-.-></span> TT
    TT <span class="token arrow operator">-.-></span> Stream
    TT <span class="token arrow operator">-.-></span> Executor
    Executor <span class="token arrow operator">-.-></span> FS
    Executor <span class="token arrow operator">-.-></span> Process
    Stream <span class="token arrow operator">-.-></span> Network
    TT <span class="token arrow operator">-.-></span> Telemetry
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2025/10/23/claude-code-jia-gou-yin-qing-shi/2.svg" class="">
<h3 id="层通信模式"><a href="#层通信模式" class="headerlink" title="层通信模式"></a>层通信模式</h3><p>层之间的通信遵循严格的模式：</p>
<ol>
<li><strong>向下通信</strong>：直接函数调用</li>
<li><strong>向上通信</strong>：事件和回调</li>
<li><strong>跨层通信</strong>：共享上下文对象</li>
</ol>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 示例：UI到代理核心的通信</span>
<span class="token keyword">class</span> <span class="token class-name">UIToAgentBridge</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">handleUserInput</span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 向下：直接调用</span>
    <span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">pd</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据操作类型处理</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token string">'normal_prompt'</span><span class="token operator">:</span>
        <span class="token comment">// 开始新的tt循环迭代</span>
        <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> message <span class="token keyword">of</span> <span class="token function">tt</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// 向上：产生事件</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>uiRenderer<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 示例：工具通过进度与UI通信</span>
<span class="token keyword">class</span> <span class="token class-name">ToolToUIBridge</span> <span class="token punctuation">&#123;</span>
  async <span class="token operator">*</span><span class="token function">executeWithProgress</span><span class="token punctuation">(</span>tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">,</span> input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 工具产生进度</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> event <span class="token keyword">of</span> <span class="token function">tool</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'progress'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 转换为UI事件</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'ui_progress'</span><span class="token punctuation">,</span>
          toolName<span class="token operator">:</span> tool<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
          progress<span class="token operator">:</span> event<span class="token punctuation">.</span>data
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="事件驱动和流式架构"><a href="#事件驱动和流式架构" class="headerlink" title="事件驱动和流式架构"></a>事件驱动和流式架构</h2><p>整个系统构建在流式原语之上：</p>
<h3 id="流背压管理"><a href="#流背压管理" class="headerlink" title="流背压管理"></a>流背压管理</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">StreamBackpressureController</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> queue<span class="token operator">:</span> StreamEvent<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> processing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> pressure <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    high<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>    <span class="token comment">// 开始丢弃非关键事件</span>
    critical<span class="token operator">:</span> <span class="token number">5000</span> <span class="token comment">// 除错误外全部丢弃</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> StreamEvent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 应用背压策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>critical<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 只保留关键事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">=></span>
        e<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'error'</span> <span class="token operator">||</span>
        e<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'message_stop'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 丢弃文本增量，保留结构</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">=></span>
        e<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'content_block_delta'</span> <span class="token operator">||</span>
        e<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'text_delta'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>processing<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">processQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>processing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> batch <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 批量处理</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 让出给事件循环</span>
      <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=></span> <span class="token function">setImmediate</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>processing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="进度事件聚合"><a href="#进度事件聚合" class="headerlink" title="进度事件聚合"></a>进度事件聚合</h3><p>多个并发操作需要协调的进度报告：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ProgressAggregator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> progressStreams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> AsyncIterator<span class="token operator">&lt;</span>ProgressEvent<span class="token operator">>></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  async <span class="token operator">*</span><span class="token function">aggregateProgress</span><span class="token punctuation">(</span>
    operations<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">&#123;</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> operation<span class="token operator">:</span> AsyncIterator<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">&#125;</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>AggregatedProgress<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 启动所有操作</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> id<span class="token punctuation">,</span> operation <span class="token punctuation">&#125;</span> <span class="token keyword">of</span> operations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>progressStreams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> operation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 轮询所有流</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>progressStreams<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>progressStreams<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> stream<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> value<span class="token punctuation">,</span> done <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> stream<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> done <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 竞争获取下一个事件</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>progressStreams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>value<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'progress'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'aggregated_progress'</span><span class="token punctuation">,</span>
          source<span class="token operator">:</span> result<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          progress<span class="token operator">:</span> result<span class="token punctuation">.</span>value
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="状态管理架构"><a href="#状态管理架构" class="headerlink" title="状态管理架构"></a>状态管理架构</h2><p>Claude Code使用务实的方法进行状态管理：</p>
<h3 id="全局会话状态"><a href="#全局会话状态" class="headerlink" title="全局会话状态"></a>全局会话状态</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 带直接突变的单例会话状态</span>
<span class="token keyword">class</span> <span class="token class-name">SessionState</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> instance<span class="token operator">:</span> SessionState<span class="token punctuation">;</span>

  <span class="token comment">// 核心状态</span>
  sessionId<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cwd<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  totalCostUSD<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  totalAPIDuration<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// 模型使用跟踪</span>
  modelTokens<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    inputTokens<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    outputTokens<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    cacheReadInputTokens<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    cacheCreationInputTokens<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// 直接突变方法</span>
  <span class="token function">incrementCost</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>totalCostUSD <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">persistToDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步，非阻塞</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">updateTokenUsage</span><span class="token punctuation">(</span>model<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> usage<span class="token operator">:</span> TokenUsage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>modelTokens<span class="token punctuation">[</span>model<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>modelTokens<span class="token punctuation">[</span>model<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        inputTokens<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        outputTokens<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        cacheReadInputTokens<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        cacheCreationInputTokens<span class="token operator">:</span> <span class="token number">0</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modelTokens<span class="token punctuation">[</span>model<span class="token punctuation">]</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span>inputTokens <span class="token operator">+=</span> usage<span class="token punctuation">.</span>input_tokens <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span>outputTokens <span class="token operator">+=</span> usage<span class="token punctuation">.</span>output_tokens <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span>cacheReadInputTokens <span class="token operator">+=</span> usage<span class="token punctuation">.</span>cache_read_input_tokens <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span>cacheCreationInputTokens <span class="token operator">+=</span> usage<span class="token punctuation">.</span>cache_creation_input_tokens <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">persistToDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 防抖写入以避免过度I/O</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>persistTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>persistTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>
        <span class="token string">'.claude/session.json'</span><span class="token punctuation">,</span>
        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="带弱引用的文件状态"><a href="#带弱引用的文件状态" class="headerlink" title="带弱引用的文件状态"></a>带弱引用的文件状态</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ReadFileState</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> WeakRef<span class="token operator">&lt;</span>FileContent<span class="token operator">>></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizationRegistry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// FileContent被垃圾回收时清理</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">set</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> content<span class="token operator">:</span> FileContent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">get</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> FileContent <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 内容已被垃圾回收</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">checkFreshness</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token string">'fresh'</span> <span class="token operator">|</span> <span class="token string">'stale'</span> <span class="token operator">|</span> <span class="token string">'unknown'</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> cached <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'unknown'</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> stats <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cached<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token string">'stale'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token string">'fresh'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="安全架构"><a href="#安全架构" class="headerlink" title="安全架构"></a>安全架构</h2><p>安全通过多个独立层实现：</p>
<h3 id="第1层：权限系统"><a href="#第1层：权限系统" class="headerlink" title="第1层：权限系统"></a>第1层：权限系统</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">PermissionEvaluator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> ruleCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CompiledRule<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>
    tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">,</span>
    input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolPermissionContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>PermissionDecision<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 优先级顺序评估</span>
    <span class="token keyword">const</span> scopes<span class="token operator">:</span> PermissionRuleScope<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'cliArg'</span><span class="token punctuation">,</span>         <span class="token comment">// 最高优先级：命令行</span>
      <span class="token string">'localSettings'</span><span class="token punctuation">,</span>  <span class="token comment">// 项目特定覆盖</span>
      <span class="token string">'projectSettings'</span><span class="token punctuation">,</span><span class="token comment">// 共享项目规则</span>
      <span class="token string">'policySettings'</span><span class="token punctuation">,</span> <span class="token comment">// 组织策略</span>
      <span class="token string">'userSettings'</span>    <span class="token comment">// 最低优先级：用户偏好</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> scope <span class="token keyword">of</span> scopes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> decision <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">evaluateScope</span><span class="token punctuation">(</span>
        tool<span class="token punctuation">,</span> input<span class="token punctuation">,</span> context<span class="token punctuation">,</span> scope
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>decision<span class="token punctuation">.</span>behavior <span class="token operator">!==</span> <span class="token string">'continue'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> decision<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 没有匹配规则 - 询问用户</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      behavior<span class="token operator">:</span> <span class="token string">'ask'</span><span class="token punctuation">,</span>
      suggestions<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSuggestions</span><span class="token punctuation">(</span>tool<span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">compileRule</span><span class="token punctuation">(</span>rule<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> CompiledRule <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ruleCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ruleCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 解析规则语法：ToolName(glob/pattern)</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\\w+)(?:\\((.+)\\))?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">无效规则：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>rule<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> toolPattern<span class="token punctuation">,</span> pathPattern<span class="token punctuation">]</span> <span class="token operator">=</span> match<span class="token punctuation">;</span>

    <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      toolMatcher<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>toolPattern<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'.*'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">$</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      pathMatcher<span class="token operator">:</span> pathPattern
        <span class="token operator">?</span> <span class="token function">picomatch</span><span class="token punctuation">(</span>pathPattern<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>ruleCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> compiled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> compiled<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="第2层：沙箱架构"><a href="#第2层：沙箱架构" class="headerlink" title="第2层：沙箱架构"></a>第2层：沙箱架构</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// macOS沙箱实现</span>
<span class="token keyword">class</span> <span class="token class-name">MacOSSandboxManager</span> <span class="token punctuation">&#123;</span>
  <span class="token function">generateProfile</span><span class="token punctuation">(</span>
    command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    restrictions<span class="token operator">:</span> SandboxRestrictions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> profile <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
(version 1)
(deny default)

; 基础权限
(allow process-exec (literal "/bin/bash"))
(allow process-exec (literal "/usr/bin/env"))

; 文件系统访问
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>restrictions<span class="token punctuation">.</span>allowRead <span class="token operator">?</span> <span class="token string">'(allow file-read*)'</span> <span class="token operator">:</span> <span class="token string">'(deny file-read*)'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>restrictions<span class="token punctuation">.</span>allowWrite <span class="token operator">?</span> <span class="token string">'(allow file-write*)'</span> <span class="token operator">:</span> <span class="token string">'(deny file-write*)'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

; 网络访问
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>restrictions<span class="token punctuation">.</span>allowNetwork <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
(allow network-outbound)
(allow network-inbound)
</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
(deny network*)
</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

; 系统操作
(allow sysctl-read)
(allow mach-lookup)

; 临时文件
(allow file-write* (subpath "/tmp"))
(allow file-write* (subpath "/var/tmp"))
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> profile<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token function">executeSandboxed</span><span class="token punctuation">(</span>
    command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    profile<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ExecutionResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 将配置文件写入临时文件</span>
    <span class="token keyword">const</span> profilePath <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeTemporaryProfile</span><span class="token punctuation">(</span>profile<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 使用sandbox-exec执行</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sandbox-exec -p '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>profilePath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">' </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>command<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 清理</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>profilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="第3层：路径验证"><a href="#第3层：路径验证" class="headerlink" title="第3层：路径验证"></a>第3层：路径验证</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">PathValidator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> boundaries<span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> deniedPatterns<span class="token operator">:</span> RegExp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> SecurityContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>boundaries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      context<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
      <span class="token operator">...</span>context<span class="token punctuation">.</span>additionalWorkingDirectories
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>deniedPatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token operator">/</span>\\<span class="token operator">/</span>\\<span class="token punctuation">.</span><span class="token punctuation">(</span>ssh<span class="token operator">|</span>gnupg<span class="token punctuation">)</span>\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>     <span class="token comment">// SSH/GPG密钥</span>
      <span class="token operator">/</span>\\<span class="token operator">/</span><span class="token punctuation">(</span>etc<span class="token operator">|</span>sys<span class="token operator">|</span>proc<span class="token punctuation">)</span>\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>    <span class="token comment">// 系统目录</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span>pem$<span class="token operator">|</span>\\<span class="token punctuation">.</span>key$<span class="token operator">/</span><span class="token punctuation">,</span>         <span class="token comment">// 私钥</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span><span class="token punctuation">(</span>env<span class="token operator">|</span>envrc<span class="token punctuation">)</span>$<span class="token operator">/</span>         <span class="token comment">// 环境文件</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">validate</span><span class="token punctuation">(</span>requestedPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ValidationResult <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> absolute <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>requestedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查边界</span>
    <span class="token keyword">const</span> inBoundary <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>boundaries<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
      boundary <span class="token operator">=></span> absolute<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>boundary<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBoundary<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        allowed<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        reason<span class="token operator">:</span> <span class="token string">'路径在允许目录之外'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查被拒绝的模式</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pattern <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deniedPatterns<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>absolute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          allowed<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          reason<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">路径匹配被拒绝的模式：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>pattern<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> allowed<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="性能架构"><a href="#性能架构" class="headerlink" title="性能架构"></a>性能架构</h2><h3 id="ANR（应用程序无响应）检测"><a href="#ANR（应用程序无响应）检测" class="headerlink" title="ANR（应用程序无响应）检测"></a>ANR（应用程序无响应）检测</h3><p>ANR系统使用工作线程监控主事件循环：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 工作线程脚本（嵌入为base64）</span>
<span class="token keyword">const</span> anrWorkerScript <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
const &#123; parentPort &#125; = require('worker_threads');

let config = &#123; anrThreshold: 5000, captureStackTrace: false &#125;;
let lastPing = Date.now();
let anrTimer = null;

function checkANR() &#123;
  const elapsed = Date.now() - lastPing;

  if (elapsed > config.anrThreshold) &#123;
    // 主线程没有响应
    parentPort.postMessage(&#123;
      type: 'anr',
      payload: &#123;
        elapsed,
        stackTrace: config.captureStackTrace
          ? captureMainThreadStack()
          : null
      &#125;
    &#125;);
  &#125;

  // 安排下次检查
  anrTimer = setTimeout(checkANR, 100);
&#125;

async function captureMainThreadStack() &#123;
  // 如果可用，使用检查器协议
  try &#123;
    const &#123; Session &#125; = require('inspector');
    const session = new Session();
    session.connect();

    const &#123; result &#125; = await session.post('Debugger.enable');
    const stack = await session.post('Debugger.getStackTrace');

    session.disconnect();
    return stack;
  &#125; catch (e) &#123;
    return null;
  &#125;
&#125;

parentPort.on('message', (msg) => &#123;
  if (msg.type === 'config') &#123;
    config = msg.payload;
    lastPing = Date.now();
    checkANR(); // 开始监控
  &#125; else if (msg.type === 'ping') &#123;
    lastPing = Date.now();
  &#125;
&#125;);
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 主线程ANR集成</span>
<span class="token keyword">class</span> <span class="token class-name">ANRMonitor</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> worker<span class="token operator">:</span> Worker<span class="token punctuation">;</span>
  <span class="token keyword">private</span> pingInterval<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>Timer<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>options<span class="token operator">:</span> ANROptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 从嵌入脚本创建工作线程</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>anrWorkerScript<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> eval<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置工作线程</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'config'</span><span class="token punctuation">,</span>
      payload<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        anrThreshold<span class="token operator">:</span> options<span class="token punctuation">.</span>threshold <span class="token operator">||</span> <span class="token number">5000</span><span class="token punctuation">,</span>
        captureStackTrace<span class="token operator">:</span> options<span class="token punctuation">.</span>captureStackTrace <span class="token operator">!==</span> <span class="token boolean">false</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始心跳</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pingInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'ping'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>pollInterval <span class="token operator">||</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 处理ANR检测</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'anr'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleANR</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">handleANR</span><span class="token punctuation">(</span>data<span class="token operator">:</span> ANRData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 记录到遥测</span>
    Sentry<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">应用程序无响应</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>elapsed<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">毫秒</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      extra<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        stackTrace<span class="token operator">:</span> data<span class="token punctuation">.</span>stackTrace<span class="token punctuation">,</span>
        eventLoopDelay<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventLoopDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="战略性缓存层"><a href="#战略性缓存层" class="headerlink" title="战略性缓存层"></a>战略性缓存层</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">CacheArchitecture</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// L1：内存缓存</span>
  <span class="token keyword">private</span> schemaCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LRUCache<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> JSONSchema<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> patternCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LRUCache<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CompiledPattern<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> gitContextCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TTLCache<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> GitContext<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token number">30_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 30秒TTL</span>

  <span class="token comment">// L2：弱引用缓存</span>
  <span class="token keyword">private</span> fileContentCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRefCache<span class="token operator">&lt;</span>FileContent<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// L3：磁盘缓存</span>
  <span class="token keyword">private</span> diskCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiskCache</span><span class="token punctuation">(</span><span class="token string">'.claude/cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    <span class="token function-variable function">generator</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> CacheOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查L1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>schemaCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>schemaCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查L2</span>
    <span class="token keyword">const</span> weakRef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileContentCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>weakRef<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> weakRef <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查L3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> diskValue <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>diskCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>diskValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> diskValue<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 生成并缓存</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 存储在适当的缓存中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>weak<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fileContentCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>diskCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> options<span class="token punctuation">.</span>ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>schemaCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="遥测和可观测性设计"><a href="#遥测和可观测性设计" class="headerlink" title="遥测和可观测性设计"></a>遥测和可观测性设计</h2><p>三支柱方法提供全面的可见性：</p>
<h3 id="支柱1：错误跟踪（Sentry）"><a href="#支柱1：错误跟踪（Sentry）" class="headerlink" title="支柱1：错误跟踪（Sentry）"></a>支柱1：错误跟踪（Sentry）</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> wrap<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">(</span>
    fn<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ErrorContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> Parameters<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> span <span class="token operator">=</span> Sentry<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        name<span class="token operator">:</span> context<span class="token punctuation">.</span>operation<span class="token punctuation">,</span>
        op<span class="token operator">:</span> context<span class="token punctuation">.</span>category
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        span<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        span<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">'internal_error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Sentry<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
          contexts<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            operation<span class="token operator">:</span> context<span class="token punctuation">,</span>
            state<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">captureState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          fingerprint<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateFingerprint</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        span<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">captureState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      sessionId<span class="token operator">:</span> SessionState<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
      conversationDepth<span class="token operator">:</span> <span class="token comment">/* 当前深度 */</span><span class="token punctuation">,</span>
      activeTools<span class="token operator">:</span> <span class="token comment">/* 当前执行中 */</span><span class="token punctuation">,</span>
      memoryUsage<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      eventLoopDelay<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventLoopDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="支柱2：指标（OpenTelemetry）"><a href="#支柱2：指标（OpenTelemetry）" class="headerlink" title="支柱2：指标（OpenTelemetry）"></a>支柱2：指标（OpenTelemetry）</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">MetricsCollector</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> meters <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    api<span class="token operator">:</span> meter<span class="token punctuation">.</span><span class="token function">createCounter</span><span class="token punctuation">(</span><span class="token string">'api_calls_total'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tokens<span class="token operator">:</span> meter<span class="token punctuation">.</span><span class="token function">createHistogram</span><span class="token punctuation">(</span><span class="token string">'token_usage'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tools<span class="token operator">:</span> meter<span class="token punctuation">.</span><span class="token function">createHistogram</span><span class="token punctuation">(</span><span class="token string">'tool_execution_duration'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    streaming<span class="token operator">:</span> meter<span class="token punctuation">.</span><span class="token function">createHistogram</span><span class="token punctuation">(</span><span class="token string">'streaming_latency'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function">recordApiCall</span><span class="token punctuation">(</span>result<span class="token operator">:</span> ApiCallResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>meters<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      model<span class="token operator">:</span> result<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
      status<span class="token operator">:</span> result<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
      provider<span class="token operator">:</span> result<span class="token punctuation">.</span>provider
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>meters<span class="token punctuation">.</span>tokens<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>totalTokens<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      model<span class="token operator">:</span> result<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'total'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">recordToolExecution</span><span class="token punctuation">(</span>tool<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> duration<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> success<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>meters<span class="token punctuation">.</span>tools<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      tool<span class="token punctuation">,</span>
      success<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">,</span>
      concurrent<span class="token operator">:</span> <span class="token comment">/* 是否并行？ */</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="支柱3：功能标志（Statsig）"><a href="#支柱3：功能标志（Statsig）" class="headerlink" title="支柱3：功能标志（Statsig）"></a>支柱3：功能标志（Statsig）</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FeatureManager</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">checkGate</span><span class="token punctuation">(</span>
    gate<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">?</span><span class="token operator">:</span> FeatureContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> statsig<span class="token punctuation">.</span><span class="token function">checkGate</span><span class="token punctuation">(</span>gate<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      userID<span class="token operator">:</span> SessionState<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
      custom<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        model<span class="token operator">:</span> context<span class="token operator">?.</span>model<span class="token punctuation">,</span>
        toolsEnabled<span class="token operator">:</span> context<span class="token operator">?.</span>tools<span class="token punctuation">,</span>
        platform<span class="token operator">:</span> process<span class="token punctuation">.</span>platform
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token generic-function"><span class="token function">getConfig</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    config<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    defaultValue<span class="token operator">:</span> <span class="token constant">T</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> dynamicConfig <span class="token operator">=</span> statsig<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dynamicConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h2><h3 id="进程生命周期管理"><a href="#进程生命周期管理" class="headerlink" title="进程生命周期管理"></a>进程生命周期管理</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ProcessManager</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> processes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ChildProcess<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> limits <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    maxProcesses<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    maxMemoryPerProcess<span class="token operator">:</span> <span class="token number">512</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment">// 512MB</span>
    maxTotalMemory<span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>  <span class="token comment">// 2GB</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">spawn</span><span class="token punctuation">(</span>
    id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> SpawnOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ManagedProcess<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查限制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processes<span class="token punctuation">.</span>size <span class="token operator">>=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>limits<span class="token punctuation">.</span>maxProcesses<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">killOldestProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'bash'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-c'</span><span class="token punctuation">,</span> command<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">...</span>options<span class="token punctuation">,</span>
      <span class="token comment">// 资源限制</span>
      env<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">...</span>options<span class="token punctuation">.</span>env<span class="token punctuation">,</span>
        <span class="token constant">NODE_OPTIONS</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--max-old-space-size=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>limits<span class="token punctuation">.</span>maxMemoryPerProcess <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 监控资源</span>
    <span class="token keyword">const</span> monitor <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkProcessHealth</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ManagedProcess</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">checkProcessHealth</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> proc<span class="token operator">:</span> ChildProcess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> usage <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">pidusage</span><span class="token punctuation">(</span>proc<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>usage<span class="token punctuation">.</span>memory <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>limits<span class="token punctuation">.</span>maxMemoryPerProcess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">进程</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">超出内存限制</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        proc<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">'SIGTERM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 进程可能已退出</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="网络连接池"><a href="#网络连接池" class="headerlink" title="网络连接池"></a>网络连接池</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">NetworkPool</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> pools <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ConnectionPool<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">getPool</span><span class="token punctuation">(</span>provider<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ConnectionPool <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pools<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pools<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        maxConnections<span class="token operator">:</span> provider <span class="token operator">===</span> <span class="token string">'anthropic'</span> <span class="token operator">?</span> <span class="token number">10</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        maxIdleTime<span class="token operator">:</span> <span class="token number">30_000</span><span class="token punctuation">,</span>
        keepAlive<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pools<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token function">request</span><span class="token punctuation">(</span>
    provider<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> RequestOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Response<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> pool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
      pool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p><em>本架构分析基于逆向工程和反编译。实际实现可能有所不同。所呈现的模式代表了基于可观察行为和高性能Node.js应用程序常见实践推断出的架构决策。</em></p>
<h1 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档深入分析了Claude Code的核心架构，揭示了其高性能响应背后的精密设计。通过反编译和逆向工程分析，文档详细展示了Claude Code如何通过分层架构、流式处理、智能状态管理等技术实现卓越的用户体验。</p>
<h2 id="核心架构特点"><a href="#核心架构特点" class="headerlink" title="核心架构特点"></a>核心架构特点</h2><h3 id="1-tt控制循环：系统的心脏"><a href="#1-tt控制循环：系统的心脏" class="headerlink" title="1. tt控制循环：系统的心脏"></a>1. tt控制循环：系统的心脏</h3><ul>
<li><strong>六阶段处理流程</strong>：<ol>
<li>回合初始化和上下文准备（10-50ms token计数，2000-3000ms LLM压缩）</li>
<li>动态系统提示组装（并行获取上下文源）</li>
<li>LLM流初始化（异步生成器设置）</li>
<li>流事件处理状态机（实时事件驱动处理）</li>
<li>工具执行编排（智能批量处理）</li>
<li>递归控制（尾递归，深度限制10轮）</li>
</ol>
</li>
<li><strong>性能特征</strong>：首个token延迟300-800ms，token吞吐量50-100/秒，恒定内存使用</li>
</ul>
<h3 id="2-分层架构设计"><a href="#2-分层架构设计" class="headerlink" title="2. 分层架构设计"></a>2. 分层架构设计</h3><ul>
<li><strong>第1层：用户界面</strong>：React组件 + Ink渲染器 + Yoga布局引擎</li>
<li><strong>第2层：代理核心</strong>：tt控制循环 + 上下文组装 + 权限系统 + 会话状态</li>
<li><strong>第3层：LLM交互</strong>：流处理器 + 重试逻辑 + Token计数器</li>
<li><strong>第4层：工具系统</strong>：工具执行器 + 输入验证器 + 沙箱管理器</li>
<li><strong>第5层：基础设施</strong>：文件系统 + 进程管理器 + 网络客户端 + 遥测</li>
</ul>
<h3 id="3-通信模式"><a href="#3-通信模式" class="headerlink" title="3. 通信模式"></a>3. 通信模式</h3><ul>
<li><strong>向下通信</strong>：直接函数调用</li>
<li><strong>向上通信</strong>：事件和回调</li>
<li><strong>跨层通信</strong>：共享上下文对象</li>
</ul>
<h2 id="事件驱动和流式架构-1"><a href="#事件驱动和流式架构-1" class="headerlink" title="事件驱动和流式架构"></a>事件驱动和流式架构</h2><h3 id="流背压管理-1"><a href="#流背压管理-1" class="headerlink" title="流背压管理"></a>流背压管理</h3><ul>
<li><strong>压力阈值</strong>：高压力1000事件（丢弃非关键），临界压力5000事件（仅保留错误）</li>
<li><strong>批处理策略</strong>：100个事件为一批，让出事件循环</li>
<li><strong>智能过滤</strong>：文本增量可过滤，结构事件保留</li>
</ul>
<h3 id="进度事件聚合-1"><a href="#进度事件聚合-1" class="headerlink" title="进度事件聚合"></a>进度事件聚合</h3><ul>
<li><strong>多操作协调</strong>：并发进度报告的统一管理</li>
<li><strong>竞态机制</strong>：Promise.race获取下一个事件</li>
<li><strong>超时保护</strong>：100ms超时防止挂起</li>
</ul>
<h2 id="状态管理架构-1"><a href="#状态管理架构-1" class="headerlink" title="状态管理架构"></a>状态管理架构</h2><h3 id="全局会话状态-1"><a href="#全局会话状态-1" class="headerlink" title="全局会话状态"></a>全局会话状态</h3><ul>
<li><strong>单例模式</strong>：直接突变方法，异步磁盘持久化</li>
<li><strong>令牌跟踪</strong>：详细的模型使用统计</li>
<li><strong>防抖写入</strong>：1秒延迟避免过度I/O</li>
</ul>
<h3 id="文件状态管理"><a href="#文件状态管理" class="headerlink" title="文件状态管理"></a>文件状态管理</h3><ul>
<li><strong>弱引用缓存</strong>：WeakRef + FinalizationRegistry自动清理</li>
<li><strong>新鲜度检查</strong>：基于修改时间的缓存失效</li>
<li><strong>内存安全</strong>：防止悬挂引用和内存泄漏</li>
</ul>
<h2 id="安全架构-1"><a href="#安全架构-1" class="headerlink" title="安全架构"></a>安全架构</h2><h3 id="三层防护体系"><a href="#三层防护体系" class="headerlink" title="三层防护体系"></a>三层防护体系</h3><ol>
<li><p><strong>权限系统</strong>：</p>
<ul>
<li>五级优先级评估（CLI参数 &gt; 本地设置 &gt; 项目设置 &gt; 策略设置 &gt; 用户设置）</li>
<li>规则编译缓存，JIT优化</li>
<li>智能建议生成</li>
</ul>
</li>
<li><p><strong>沙箱架构</strong>：</p>
<ul>
<li>macOS专用sandbox-exec集成</li>
<li>动态配置文件生成</li>
<li>文件系统、网络、系统操作精细控制</li>
</ul>
</li>
<li><p><strong>路径验证</strong>：</p>
<ul>
<li>边界检查（项目根目录 + 额外工作目录）</li>
<li>敏感模式拒绝（SSH/GPG密钥、系统目录、私钥文件）</li>
<li>实时验证结果</li>
</ul>
</li>
</ol>
<h2 id="性能架构-1"><a href="#性能架构-1" class="headerlink" title="性能架构"></a>性能架构</h2><h3 id="ANR检测系统"><a href="#ANR检测系统" class="headerlink" title="ANR检测系统"></a>ANR检测系统</h3><ul>
<li><strong>工作线程监控</strong>：独立线程监控主事件循环</li>
<li><strong>5秒阈值检测</strong>：超时自动触发堆栈捕获</li>
<li><strong>检查器协议集成</strong>：使用inspector模块获取调用栈</li>
<li><strong>遥测报告</strong>：Sentry集成自动上报</li>
</ul>
<h3 id="三级缓存架构"><a href="#三级缓存架构" class="headerlink" title="三级缓存架构"></a>三级缓存架构</h3><ul>
<li><strong>L1缓存</strong>：内存缓存（LRU 100个schema，TTL 30秒git上下文）</li>
<li><strong>L2缓存</strong>：弱引用缓存（文件内容自动垃圾回收）</li>
<li><strong>L3缓存</strong>：磁盘缓存（’.claude/cache’持久化存储）</li>
</ul>
<h2 id="遥测和可观测性"><a href="#遥测和可观测性" class="headerlink" title="遥测和可观测性"></a>遥测和可观测性</h2><h3 id="三支柱方法"><a href="#三支柱方法" class="headerlink" title="三支柱方法"></a>三支柱方法</h3><ol>
<li><p><strong>错误跟踪（Sentry）</strong>：</p>
<ul>
<li>事务边界包装</li>
<li>状态捕获（会话ID、对话深度、内存使用）</li>
<li>指纹生成和错误分类</li>
</ul>
</li>
<li><p><strong>指标收集（OpenTelemetry）</strong>：</p>
<ul>
<li>API调用计数器</li>
<li>Token使用直方图</li>
<li>工具执行持续时间</li>
<li>流延迟监控</li>
</ul>
</li>
<li><p><strong>功能标志（Statsig）</strong>：</p>
<ul>
<li>动态特性开关</li>
<li>配置管理</li>
<li>A/B测试支持</li>
</ul>
</li>
</ol>
<h2 id="资源管理-1"><a href="#资源管理-1" class="headerlink" title="资源管理"></a>资源管理</h2><h3 id="进程生命周期管理-1"><a href="#进程生命周期管理-1" class="headerlink" title="进程生命周期管理"></a>进程生命周期管理</h3><ul>
<li><strong>资源限制</strong>：最大10个进程，每进程512MB，总计2GB</li>
<li><strong>健康监控</strong>：1秒间隔检查进程内存使用</li>
<li><strong>自动清理</strong>：超限进程自动终止</li>
<li><strong>NODE_OPTIONS控制</strong>：动态设置内存限制</li>
</ul>
<h3 id="网络连接池-1"><a href="#网络连接池-1" class="headerlink" title="网络连接池"></a>网络连接池</h3><ul>
<li><strong>提供商隔离</strong>：Anthropic 10连接，其他5连接</li>
<li><strong>连接复用</strong>：30秒空闲时间，keep-alive支持</li>
<li><strong>获取释放</strong>：自动连接管理</li>
</ul>
<h2 id="技术创新点"><a href="#技术创新点" class="headerlink" title="技术创新点"></a>技术创新点</h2><h3 id="架构创新"><a href="#架构创新" class="headerlink" title="架构创新"></a>架构创新</h3><ol>
<li><strong>异步生成器管道</strong>：tt函数的流式处理架构</li>
<li><strong>分层权限系统</strong>：多维度安全控制机制</li>
<li><strong>事件驱动设计</strong>：响应式状态更新</li>
<li><strong>智能缓存策略</strong>：多层次缓存优化</li>
</ol>
<h3 id="性能创新"><a href="#性能创新" class="headerlink" title="性能创新"></a>性能创新</h3><ol>
<li><strong>ANR检测机制</strong>：工作线程监控主线程</li>
<li><strong>背压控制系统</strong>：防止内存溢出的流控制</li>
<li><strong>弱引用缓存</strong>：自动内存管理</li>
<li><strong>连接池优化</strong>：网络资源高效利用</li>
</ol>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><ol>
<li><strong>模块化设计</strong>：清晰的职责分离</li>
<li><strong>错误边界处理</strong>：全面的异常捕获和报告</li>
<li><strong>资源监控</strong>：实时性能和资源使用追踪</li>
<li><strong>可观测性</strong>：三支柱监控体系</li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Claude Code的架构体现了现代软件工程的最佳实践，通过精密的分层设计和创新的技术实现，构建了高性能、高可靠性的AI开发工具。其核心价值在于：</p>
<ul>
<li><strong>卓越性能</strong>：多层次的优化策略确保快速响应</li>
<li><strong>可靠安全</strong>：三层防护体系保障系统安全</li>
<li><strong>可扩展性</strong>：模块化架构支持功能扩展</li>
<li><strong>可观测性</strong>：全面的监控体系确保运维效率</li>
</ul>
<p>这种架构设计为现代AI工具的开发提供了优秀的参考模板，特别是在需要处理复杂流式数据、保证系统响应性和维护高度安全性的场景中。文档的深入分析为理解高性能AI系统的架构设计提供了宝贵的技术参考。</p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/10/23/claude-code-xin-ying-de-zu-jian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="claude-code新颖的组件">
                        
                        <span class="card-title">claude-code新颖的组件</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-10-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            寒霜
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/10/23/claude-code-gong-ju-yu-zhi-xing-yin-qing/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="claude-code工具与执行引擎">
                        
                        <span class="card-title">claude-code工具与执行引擎</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-10-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            寒霜
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('6'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            <!-- Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
             -->
            <!-- <a href="/about" target="_blank">寒霜</a> -->
            <!-- |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
             -->
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">141.7k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
