<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>claude-code架构-引擎室 | 我的博客</title><meta name="author" content="寒霜"><meta name="copyright" content="寒霜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="claude-code架构-引擎室"><meta name="application-name" content="claude-code架构-引擎室"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="claude-code架构-引擎室"><meta property="og:url" content="https://hanshuang-ai.github.io/2025/10/23/claude-code-jia-gou-yin-qing-shi/index.html"><meta property="og:site_name" content="我的博客"><meta property="og:description" content="参考链接 Architecture: The Engine Room架构：引擎室graph TB     subgraph &amp;quot;核心：tt控制循环&amp;quot;         Start([用户输入]) --&amp;gt; Init[初始化回合]         Init --&amp;gt; Compact&amp;amp;#123;需要压缩？&amp;amp;#1"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="寒霜"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="参考链接 Architecture: The Engine Room架构：引擎室graph TB     subgraph &amp;quot;核心：tt控制循环&amp;quot;         Start([用户输入]) --&amp;gt; Init[初始化回合]         Init --&amp;gt; Compact&amp;amp;#123;需要压缩？&amp;amp;#1"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://hanshuang-ai.github.io/2025/10/23/claude-code-jia-gou-yin-qing-shi/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '我的博客',
  title: 'claude-code架构-引擎室',
  postAI: '',
  pageFillDescription: 'Architecture The Engine Room, 架构：引擎室, tt控制循环：跳动的心脏, 阶段1：回合初始化和上下文准备, 阶段2：动态系统提示组装, 阶段3：LLM流初始化, 阶段4：流事件处理状态机, 阶段5：工具执行编排, 阶段6：递归控制, 分层架构, 层通信模式, 事件驱动和流式架构, 流背压管理, 进度事件聚合, 状态管理架构, 全局会话状态, 带弱引用的文件状态, 安全架构, 第1层：权限系统, 第2层：沙箱架构, 第3层：路径验证, 性能架构, ANR（应用程序无响应）检测, 战略性缓存层, 遥测和可观测性设计, 支柱1：错误跟踪（Sentry）, 支柱2：指标（OpenTelemetry）, 支柱3：功能标志（Statsig）, 资源管理, 进程生命周期管理, 网络连接池, 文件总结, 概述, 核心架构特点, 1. tt控制循环：系统的心脏, 2. 分层架构设计, 3. 通信模式, 事件驱动和流式架构, 流背压管理, 进度事件聚合, 状态管理架构, 全局会话状态, 文件状态管理, 安全架构, 三层防护体系, 性能架构, ANR检测系统, 三级缓存架构, 遥测和可观测性, 三支柱方法, 资源管理, 进程生命周期管理, 网络连接池, 技术创新点, 架构创新, 性能创新, 工程实践, 结论参考链接架构引擎室核心控制循环用户输入初始化回合需要压缩是总结否组装上下文流式传输到处理事件工具请求是执行工具递归否完成控制循环跳动的心脏整个系统围绕一个名为的异步生成器函数运转这个函数协调每一次交互从用户输入到通信再到工具执行让我们剖析这个卓越的工程奇迹来自代码库的实际函数签名完整的对话历史静态系统指令实时状态项目上下文权限回调共享执行上下文恢复流式状态本回合的递归深度跟踪器历史压缩标志从保存状态恢复这个签名揭示了在起作用的复杂状态管理该函数产生对象这些对象驱动更新同时保持对话流程让我们检查每个阶段阶段回合初始化和上下文准备通知处理已经开始检查上下文窗口压力上下文较大尝试压缩对话历史已自动压缩摘要压缩对话失败阶段性能概况操作典型持续时间复杂度计数消息压缩决策总结一次调用消息重构消息阶段动态系统提示组装系统提示不是静态的它是为每个回合新组装的并行获取所有上下文源将工具定义转换为兼容的规格获取当前目录结构组装完整的系统提示核心指令项目特定上下文状态分支提交文件树可用工具准备带缓存控制的消息组装过程遵循严格的优先级顺序优先级基础指令优先级模型特定适配优先级内容可变通常优先级上下文优先级目录结构截断以适应优先级工具规格阶段流初始化初始化流式调用为流式响应初始化累加器阶段流事件处理状态机这就是魔法发生的地方实时处理流事件中止检查流处理被用户中止根据块类型初始化空内容尝试解析不完整的进行预览处理来自的格式错误的来自的无效输入生成完成移动到阶段或流处理性能首个延迟因模型而异吞吐量秒更新频率文本每个更新工具输入批量更新内存使用无论响应长度如何都保持恒定阶段工具执行编排当请求使用工具时架构转换到执行模式智能批量处理工具检查工具执行期间的中止工具执行被用户中止排序结果以匹配的请求顺序阶段递归处理结果阶段递归控制函数是尾递归的允许无限的对话深度由安全措施限制递归安全措施已达到最大对话深度请开始新的查询递归前的内存压力检查继续前强制压缩分层架构实现了一个清晰的分层架构每一层都有明确的职责第层用户界面组件渲染器布局引擎第层代理核心控制循环上下文组装权限系统会话状态第层交互流处理器重试逻辑计数器第层工具系统工具执行器输入验证器沙箱管理器第层基础设施文件系统进程管理器网络客户端遥测层通信模式层之间的通信遵循严格的模式向下通信直接函数调用向上通信事件和回调跨层通信共享上下文对象示例到代理核心的通信向下直接调用根据操作类型处理开始新的循环迭代向上产生事件示例工具通过进度与通信工具产生进度转换为事件事件驱动和流式架构整个系统构建在流式原语之上流背压管理开始丢弃非关键事件除错误外全部丢弃应用背压策略只保留关键事件丢弃文本增量保留结构批量处理让出给事件循环进度事件聚合多个并发操作需要协调的进度报告启动所有操作轮询所有流竞争获取下一个事件状态管理架构使用务实的方法进行状态管理全局会话状态带直接突变的单例会话状态核心状态模型使用跟踪直接突变方法异步非阻塞防抖写入以避免过度带弱引用的文件状态被垃圾回收时清理内容已被垃圾回收安全架构安全通过多个独立层实现第层权限系统优先级顺序评估最高优先级命令行项目特定覆盖共享项目规则组织策略最低优先级用户偏好没有匹配规则询问用户解析规则语法无效规则第层沙箱架构沙箱实现基础权限文件系统访问网络访问系统操作临时文件将配置文件写入临时文件使用执行清理第层路径验证密钥系统目录私钥环境文件检查边界路径在允许目录之外检查被拒绝的模式路径匹配被拒绝的模式性能架构应用程序无响应检测系统使用工作线程监控主事件循环工作线程脚本嵌入为主线程没有响应安排下次检查如果可用使用检查器协议开始监控主线程集成从嵌入脚本创建工作线程配置工作线程开始心跳处理检测记录到遥测应用程序无响应毫秒战略性缓存层内存缓存秒弱引用缓存磁盘缓存检查检查检查生成并缓存存储在适当的缓存中遥测和可观测性设计三支柱方法提供全面的可见性支柱错误跟踪当前深度当前执行中支柱指标是否并行支柱功能标志资源管理进程生命周期管理检查限制资源限制监控资源进程超出内存限制进程可能已退出网络连接池本架构分析基于逆向工程和反编译实际实现可能有所不同所呈现的模式代表了基于可观察行为和高性能应用程序常见实践推断出的架构决策文件总结概述本文档深入分析了的核心架构揭示了其高性能响应背后的精密设计通过反编译和逆向工程分析文档详细展示了如何通过分层架构流式处理智能状态管理等技术实现卓越的用户体验核心架构特点控制循环系统的心脏六阶段处理流程回合初始化和上下文准备计数压缩动态系统提示组装并行获取上下文源流初始化异步生成器设置流事件处理状态机实时事件驱动处理工具执行编排智能批量处理递归控制尾递归深度限制轮性能特征首个延迟吞吐量秒恒定内存使用分层架构设计第层用户界面组件渲染器布局引擎第层代理核心控制循环上下文组装权限系统会话状态第层交互流处理器重试逻辑计数器第层工具系统工具执行器输入验证器沙箱管理器第层基础设施文件系统进程管理器网络客户端遥测通信模式向下通信直接函数调用向上通信事件和回调跨层通信共享上下文对象事件驱动和流式架构流背压管理压力阈值高压力事件丢弃非关键临界压力事件仅保留错误批处理策略个事件为一批让出事件循环智能过滤文本增量可过滤结构事件保留进度事件聚合多操作协调并发进度报告的统一管理竞态机制获取下一个事件超时保护超时防止挂起状态管理架构全局会话状态单例模式直接突变方法异步磁盘持久化令牌跟踪详细的模型使用统计防抖写入秒延迟避免过度文件状态管理弱引用缓存自动清理新鲜度检查基于修改时间的缓存失效内存安全防止悬挂引用和内存泄漏安全架构三层防护体系权限系统五级优先级评估参数本地设置项目设置策略设置用户设置规则编译缓存优化智能建议生成沙箱架构专用集成动态配置文件生成文件系统网络系统操作精细控制路径验证边界检查项目根目录额外工作目录敏感模式拒绝密钥系统目录私钥文件实时验证结果性能架构检测系统工作线程监控独立线程监控主事件循环秒阈值检测超时自动触发堆栈捕获检查器协议集成使用模块获取调用栈遥测报告集成自动上报三级缓存架构缓存内存缓存个秒上下文缓存弱引用缓存文件内容自动垃圾回收缓存磁盘缓存持久化存储遥测和可观测性三支柱方法错误跟踪事务边界包装状态捕获会话对话深度内存使用指纹生成和错误分类指标收集调用计数器使用直方图工具执行持续时间流延迟监控功能标志动态特性开关配置管理测试支持资源管理进程生命周期管理资源限制最大个进程每进程总计健康监控秒间隔检查进程内存使用自动清理超限进程自动终止控制动态设置内存限制网络连接池提供商隔离连接其他连接连接复用秒空闲时间支持获取释放自动连接管理技术创新点架构创新异步生成器管道函数的流式处理架构分层权限系统多维度安全控制机制事件驱动设计响应式状态更新智能缓存策略多层次缓存优化性能创新检测机制工作线程监控主线程背压控制系统防止内存溢出的流控制弱引用缓存自动内存管理连接池优化网络资源高效利用工程实践模块化设计清晰的职责分离错误边界处理全面的异常捕获和报告资源监控实时性能和资源使用追踪可观测性三支柱监控体系结论的架构体现了现代软件工程的最佳实践通过精密的分层设计和创新的技术实现构建了高性能高可靠性的开发工具其核心价值在于卓越性能多层次的优化策略确保快速响应可靠安全三层防护体系保障系统安全可扩展性模块化架构支持功能扩展可观测性全面的监控体系确保运维效率这种架构设计为现代工具的开发提供了优秀的参考模板特别是在需要处理复杂流式数据保证系统响应性和维护高度安全性的场景中文档的深入分析为理解高性能系统的架构设计提供了宝贵的技术参考',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-24 18:27:01',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="我的博客" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">我的博客</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 1.05rem;">AI<sup>1</sup></a><a href="/tags/Claude/" style="font-size: 1.05rem;">Claude<sup>1</sup></a><a href="/tags/Go/" style="font-size: 1.05rem;">Go<sup>1</sup></a><a href="/tags/Golang/" style="font-size: 1.05rem;">Golang<sup>1</sup></a><a href="/tags/HTML%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">HTML基础<sup>1</sup></a><a href="/tags/SDK/" style="font-size: 1.05rem;">SDK<sup>1</sup></a><a href="/tags/base64/" style="font-size: 1.05rem;">base64<sup>1</sup></a><a href="/tags/canvas/" style="font-size: 1.05rem;">canvas<sup>2</sup></a><a href="/tags/cesium/" style="font-size: 1.05rem;">cesium<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>5</sup></a><a href="/tags/docker/" style="font-size: 1.05rem;">docker<sup>3</sup></a><a href="/tags/echart/" style="font-size: 1.05rem;">echart<sup>1</sup></a><a href="/tags/electron/" style="font-size: 1.05rem;">electron<sup>2</sup></a><a href="/tags/elementUI/" style="font-size: 1.05rem;">elementUI<sup>1</sup></a><a href="/tags/flex/" style="font-size: 1.05rem;">flex<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>3</sup></a><a href="/tags/javascript/" style="font-size: 1.05rem;">javascript<sup>1</sup></a><a href="/tags/js/" style="font-size: 1.05rem;">js<sup>2</sup></a><a href="/tags/position/" style="font-size: 1.05rem;">position<sup>1</sup></a><a href="/tags/vue/" style="font-size: 1.05rem;">vue<sup>17</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" style="font-size: 1.05rem;">事件循环<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/" style="font-size: 1.05rem;">事件监听<sup>1</sup></a><a href="/tags/%E5%8F%AF%E8%A7%86%E5%8C%96/" style="font-size: 1.05rem;">可视化<sup>3</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 1.05rem;">后端<sup>1</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/" style="font-size: 1.05rem;">基本命令<sup>2</sup></a><a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 1.05rem;">存储<sup>1</sup></a><a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 1.05rem;">实战<sup>31</sup></a><a href="/tags/%E5%B8%83%E5%B1%80/" style="font-size: 1.05rem;">布局<sup>1</sup></a><a href="/tags/%E6%89%93%E5%8D%B0/" style="font-size: 1.05rem;">打印<sup>1</sup></a><a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">插件开发<sup>1</sup></a><a href="/tags/%E6%A8%AA%E7%AB%96%E5%B1%8F%E6%A3%80%E6%B5%8B/" style="font-size: 1.05rem;">横竖屏检测<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 1.05rem;">正则<sup>4</sup></a><a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 1.05rem;">浏览器<sup>5</sup></a><a href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/" style="font-size: 1.05rem;">盒模型<sup>1</sup></a><a href="/tags/%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/" style="font-size: 1.05rem;">组件通信<sup>2</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 1.05rem;">缓存<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">编程语言<sup>1</sup></a><a href="/tags/%E8%B7%AF%E7%94%B1/" style="font-size: 1.05rem;">路由<sup>1</sup></a><a href="/tags/%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size: 1.05rem;">过滤器<sup>3</sup></a><a href="/tags/%E9%9F%B3%E9%A2%91/" style="font-size: 1.05rem;">音频<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">21</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">claude-code架构-引擎室</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-10-23T06:29:35.000Z" title="发表于 2025-10-23 14:29:35">2025-10-23</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-10-24T10:27:01.760Z" title="更新于 2025-10-24 18:27:01">2025-10-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为北京"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>北京</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://hanshuang-ai.github.io/2025/10/23/claude-code-jia-gou-yin-qing-shi/"><header><h1 id="CrawlerTitle" itemprop="name headline">claude-code架构-引擎室</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">寒霜</span><time itemprop="dateCreated datePublished" datetime="2025-10-23T06:29:35.000Z" title="发表于 2025-10-23 14:29:35">2025-10-23</time><time itemprop="dateCreated datePublished" datetime="2025-10-24T10:27:01.760Z" title="更新于 2025-10-24 18:27:01">2025-10-24</time></header><p><a target="_blank" rel="noopener" href="https://southbridge-research.notion.site/Architecture-The-Engine-Room-2055fec70db18192963cd6b3a5326476">参考链接</a></p>
<h1 id="Architecture-The-Engine-Room"><a href="#Architecture-The-Engine-Room" class="headerlink" title="Architecture: The Engine Room"></a>Architecture: The Engine Room</h1><h1 id="架构：引擎室"><a href="#架构：引擎室" class="headerlink" title="架构：引擎室"></a>架构：引擎室</h1><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TB
    <span class="token keyword">subgraph</span> <span class="token string">"核心：tt控制循环"</span>
        Start<span class="token text string">([用户输入])</span> <span class="token arrow operator">--></span> Init<span class="token text string">[初始化回合]</span>
        Init <span class="token arrow operator">--></span> Compact<span class="token text string">&#123;需要压缩？&#125;</span>
        Compact <span class="token arrow operator">--></span><span class="token label property">|是|</span> CompactLLM<span class="token text string">[LLM总结]</span>
        CompactLLM <span class="token arrow operator">--></span> Assembly
        Compact <span class="token arrow operator">--></span><span class="token label property">|否|</span> Assembly<span class="token text string">[组装上下文]</span>

        Assembly <span class="token arrow operator">--></span> Stream<span class="token text string">[流式传输到LLM]</span>
        Stream <span class="token arrow operator">--></span> Process<span class="token text string">[处理事件]</span>
        Process <span class="token arrow operator">--></span> Tools<span class="token text string">&#123;工具请求？&#125;</span>

        Tools <span class="token arrow operator">--></span><span class="token label property">|是|</span> Execute<span class="token text string">[执行工具]</span>
        Execute <span class="token arrow operator">--></span> Recurse<span class="token text string">[递归tt]</span>
        Recurse <span class="token arrow operator">--></span> Init

        Tools <span class="token arrow operator">--></span><span class="token label property">|否|</span> End<span class="token text string">([完成])</span>
    <span class="token keyword">end</span>

    <span class="token keyword">style</span> Init <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#e1f5fe</span>
    <span class="token keyword">style</span> Stream <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#fff3e0</span>
    <span class="token keyword">style</span> Execute <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#e8f5e9</span>
    <span class="token keyword">style</span> Recurse <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#fce4ec</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/10/23/claude-code-jia-gou-yin-qing-shi/1.svg" class="">
<h2 id="tt控制循环：跳动的心脏"><a href="#tt控制循环：跳动的心脏" class="headerlink" title="tt控制循环：跳动的心脏"></a><code>tt</code>控制循环：跳动的心脏</h2><p>整个Claude Code系统围绕一个名为<code>tt</code>的异步生成器函数运转。这个函数协调每一次交互，从用户输入到LLM通信再到工具执行。让我们剖析这个卓越的工程奇迹：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 来自代码库的实际tt函数签名</span>
<span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">tt</span><span class="token punctuation">(</span>
  currentMessages<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment">// 完整的对话历史</span>
  baseSystemPromptString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>        <span class="token comment">// 静态系统指令</span>
  currentGitContext<span class="token operator">:</span> GitContext<span class="token punctuation">,</span>         <span class="token comment">// 实时git状态</span>
  currentClaudeMdContents<span class="token operator">:</span> ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 项目上下文</span>
  permissionGranterFn<span class="token operator">:</span> PermissionGranter<span class="token punctuation">,</span> <span class="token comment">// 权限回调</span>
  toolUseContext<span class="token operator">:</span> ToolUseContext<span class="token punctuation">,</span>         <span class="token comment">// 共享执行上下文</span>
  activeStreamingToolUse<span class="token operator">?</span><span class="token operator">:</span> ToolUseBlock<span class="token punctuation">,</span>  <span class="token comment">// 恢复流式状态</span>
  loopState<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    turnId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>        <span class="token comment">// 本回合的UUID</span>
    turnCounter<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>   <span class="token comment">// 递归深度跟踪器</span>
    compacted<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>   <span class="token comment">// 历史压缩标志</span>
    isResuming<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>   <span class="token comment">// 从保存状态恢复</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个签名揭示了在起作用的复杂状态管理。该函数产生<code>CliMessage</code>对象，这些对象驱动UI更新，同时保持对话流程。让我们检查每个阶段：</p>
<h3 id="阶段1：回合初始化和上下文准备"><a href="#阶段1：回合初始化和上下文准备" class="headerlink" title="阶段1：回合初始化和上下文准备"></a>阶段1：回合初始化和上下文准备</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token comment">// 通知UI处理已经开始</span>
  <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
    type<span class="token operator">:</span> <span class="token string">"ui_state_update"</span><span class="token punctuation">,</span>
    uuid<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">uistate-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>loopState<span class="token punctuation">.</span>turnId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    timestamp<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">"thinking"</span><span class="token punctuation">,</span> turnId<span class="token operator">:</span> loopState<span class="token punctuation">.</span>turnId <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// 检查上下文窗口压力</span>
  <span class="token keyword">let</span> messagesForLlm <span class="token operator">=</span> currentMessages<span class="token punctuation">;</span>
  <span class="token keyword">let</span> wasCompactedThisIteration <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">shouldAutoCompact</span><span class="token punctuation">(</span>currentMessages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">"ui_notification"</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> message<span class="token operator">:</span> <span class="token string">"上下文较大，尝试压缩..."</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> compactionResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">compactAndStoreConversation</span><span class="token punctuation">(</span>
        currentMessages<span class="token punctuation">,</span>
        toolUseContext<span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      messagesForLlm <span class="token operator">=</span> compactionResult<span class="token punctuation">.</span>messagesAfterCompacting<span class="token punctuation">;</span>
      wasCompactedThisIteration <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      loopState<span class="token punctuation">.</span>compacted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token keyword">yield</span> <span class="token function">createSystemNotificationMessage</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">对话历史已自动压缩。摘要：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>
          compactionResult<span class="token punctuation">.</span>summaryMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text
        <span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>compactionError<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token function">createSystemErrorMessage</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">压缩对话失败：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>compactionError<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>阶段1性能概况</strong>：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>典型持续时间</th>
<th>复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>Token计数</td>
<td>10-50ms</td>
<td>O(n) 消息</td>
</tr>
<tr>
<td>压缩决策</td>
<td>&lt;1ms</td>
<td>O(1)</td>
</tr>
<tr>
<td>LLM总结</td>
<td>2000-3000ms</td>
<td>一次LLM调用</td>
</tr>
<tr>
<td>消息重构</td>
<td>5-10ms</td>
<td>O(n) 消息</td>
</tr>
</tbody></table>
<h3 id="阶段2：动态系统提示组装"><a href="#阶段2：动态系统提示组装" class="headerlink" title="阶段2：动态系统提示组装"></a>阶段2：动态系统提示组装</h3><p>系统提示不是静态的——它是为每个回合新组装的：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token comment">// 并行获取所有上下文源</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>toolSpecs<span class="token punctuation">,</span> dirStructure<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment">// 将工具定义转换为LLM兼容的规格</span>
    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      toolUseContext<span class="token punctuation">.</span>options<span class="token punctuation">.</span>tools
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>tool <span class="token operator">=></span> tool<span class="token punctuation">.</span>isEnabled <span class="token operator">?</span> tool<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>tool<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">convertToolDefinitionToToolSpecification</span><span class="token punctuation">(</span>tool<span class="token punctuation">,</span> toolUseContext<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 获取当前目录结构</span>
    <span class="token function">getDirectoryStructureSnapshot</span><span class="token punctuation">(</span>toolUseContext<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 组装完整的系统提示</span>
  <span class="token keyword">const</span> systemPromptForLlm <span class="token operator">=</span> <span class="token function">assembleSystemPrompt</span><span class="token punctuation">(</span>
    baseSystemPromptString<span class="token punctuation">,</span>      <span class="token comment">// 核心指令</span>
    currentClaudeMdContents<span class="token punctuation">,</span>     <span class="token comment">// 项目特定上下文</span>
    currentGitContext<span class="token punctuation">,</span>           <span class="token comment">// Git状态/分支/提交</span>
    dirStructure<span class="token punctuation">,</span>                <span class="token comment">// 文件树</span>
    toolSpecs                    <span class="token comment">// 可用工具</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 准备带缓存控制的消息</span>
  <span class="token keyword">const</span> apiMessages <span class="token operator">=</span> <span class="token function">prepareMessagesForApi</span><span class="token punctuation">(</span>
    messagesForLlm<span class="token punctuation">,</span>
    <span class="token boolean">true</span> <span class="token comment">// applyEphemeralCacheControl</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>组装过程遵循严格的优先级顺序：</p>
<pre class="line-numbers language-none"><code class="language-none">优先级1：基础指令 (~2KB)
    ↓
优先级2：模型特定适配 (~500B)
    ↓
优先级3：CLAUDE.md内容 (可变，通常5-50KB)
    ↓
优先级4：Git上下文 (~1-5KB)
    ↓
优先级5：目录结构 (截断以适应)
    ↓
优先级6：工具规格 (~10-20KB)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="阶段3：LLM流初始化"><a href="#阶段3：LLM流初始化" class="headerlink" title="阶段3：LLM流初始化"></a>阶段3：LLM流初始化</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token comment">// 初始化流式调用</span>
  <span class="token keyword">const</span> llmStream <span class="token operator">=</span> <span class="token function">callLlmStreamApi</span><span class="token punctuation">(</span>
    apiMessages<span class="token punctuation">,</span>
    systemPromptForLlm<span class="token punctuation">,</span>
    toolSpecificationsForLlm<span class="token punctuation">,</span>
    toolUseContext<span class="token punctuation">.</span>options<span class="token punctuation">.</span>mainLoopModel<span class="token punctuation">,</span>
    toolUseContext<span class="token punctuation">.</span>abortController<span class="token punctuation">.</span>signal
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 为流式响应初始化累加器</span>
  <span class="token keyword">let</span> accumulatedAssistantMessage<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span> <span class="token operator">&amp;</span> <span class="token punctuation">&#123;</span>
    message<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>ApiMessage<span class="token operator">></span> <span class="token operator">&amp;</span> <span class="token punctuation">&#123;</span> content<span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    type<span class="token operator">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span>
    uuid<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">assistant-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>loopState<span class="token punctuation">.</span>turnId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>loopState<span class="token punctuation">.</span>turnCounter<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    timestamp<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token punctuation">&#123;</span> role<span class="token operator">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> currentToolUsesFromLlm<span class="token operator">:</span> ToolUseBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentThinkingContent<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentToolInputJsonBuffer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="阶段4：流事件处理状态机"><a href="#阶段4：流事件处理状态机" class="headerlink" title="阶段4：流事件处理状态机"></a>阶段4：流事件处理状态机</h3><p>这就是魔法发生的地方——实时处理流事件：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> streamEvent <span class="token keyword">of</span> llmStream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 中止检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toolUseContext<span class="token punctuation">.</span>abortController<span class="token punctuation">.</span>signal<span class="token punctuation">.</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token function">createSystemNotificationMessage</span><span class="token punctuation">(</span><span class="token string">"LLM流处理被用户中止。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token string">"message_start"</span><span class="token operator">:</span>
        accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>id <span class="token operator">=</span> streamEvent<span class="token punctuation">.</span>message<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
        accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>model <span class="token operator">=</span> streamEvent<span class="token punctuation">.</span>message<span class="token punctuation">.</span>model<span class="token punctuation">;</span>
        accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>usage <span class="token operator">=</span> streamEvent<span class="token punctuation">.</span>message<span class="token punctuation">.</span>usage<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">"ui_state_update"</span><span class="token punctuation">,</span>
          data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            status<span class="token operator">:</span> <span class="token string">"assistant_responding"</span><span class="token punctuation">,</span>
            model<span class="token operator">:</span> streamEvent<span class="token punctuation">.</span>message<span class="token punctuation">.</span>model
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">"content_block_start"</span><span class="token operator">:</span>
        <span class="token keyword">const</span> newBlockPlaceholder <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>streamEvent<span class="token punctuation">.</span>content_block <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据块类型初始化空内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>content_block<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"thinking"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          currentThinkingContent <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
          newBlockPlaceholder<span class="token punctuation">.</span>thinking <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>content_block<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"tool_use"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          currentToolInputJsonBuffer <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
          newBlockPlaceholder<span class="token punctuation">.</span>input <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>content_block<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"text"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          newBlockPlaceholder<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newBlockPlaceholder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">"content_block_delta"</span><span class="token operator">:</span>
        <span class="token keyword">const</span> lastBlockIndex <span class="token operator">=</span> accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastBlockIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> currentBlock <span class="token operator">=</span> accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">[</span>lastBlockIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"text_delta"</span> <span class="token operator">&amp;&amp;</span> currentBlock<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"text"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          currentBlock<span class="token punctuation">.</span>text <span class="token operator">+=</span> streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
          <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token string">"ui_text_delta"</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              textDelta<span class="token operator">:</span> streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
              blockIndex<span class="token operator">:</span> lastBlockIndex
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"input_json_delta"</span> <span class="token operator">&amp;&amp;</span> currentBlock<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"tool_use"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          currentToolInputJsonBuffer <span class="token operator">+=</span> streamEvent<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>partial_json<span class="token punctuation">;</span>
          currentBlock<span class="token punctuation">.</span>input <span class="token operator">=</span> currentToolInputJsonBuffer<span class="token punctuation">;</span>

          <span class="token comment">// 尝试解析不完整的JSON进行预览</span>
          <span class="token keyword">const</span> parseAttempt <span class="token operator">=</span> <span class="token function">tryParsePartialJson</span><span class="token punctuation">(</span>currentToolInputJsonBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>parseAttempt<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
              type<span class="token operator">:</span> <span class="token string">"ui_tool_preview"</span><span class="token punctuation">,</span>
              data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                toolId<span class="token operator">:</span> currentBlock<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                preview<span class="token operator">:</span> parseAttempt<span class="token punctuation">.</span>value
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">"content_block_stop"</span><span class="token operator">:</span>
        <span class="token keyword">const</span> completedBlock <span class="token operator">=</span> accumulatedAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">[</span>streamEvent<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>completedBlock<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"tool_use"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> parsedInput <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>currentToolInputJsonBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            completedBlock<span class="token punctuation">.</span>input <span class="token operator">=</span> parsedInput<span class="token punctuation">;</span>
            currentToolUsesFromLlm<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
              type<span class="token operator">:</span> <span class="token string">"tool_use"</span><span class="token punctuation">,</span>
              id<span class="token operator">:</span> completedBlock<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
              name<span class="token operator">:</span> completedBlock<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
              input<span class="token operator">:</span> parsedInput
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 处理来自LLM的格式错误的JSON</span>
            completedBlock<span class="token punctuation">.</span>input <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
              error<span class="token operator">:</span> <span class="token string">"来自LLM的无效JSON输入"</span><span class="token punctuation">,</span>
              raw_json_string<span class="token operator">:</span> currentToolInputJsonBuffer<span class="token punctuation">,</span>
              parse_error<span class="token operator">:</span> e<span class="token punctuation">.</span>message
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          currentToolInputJsonBuffer <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">"ui_content_block_complete"</span><span class="token punctuation">,</span>
          data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> block<span class="token operator">:</span> completedBlock<span class="token punctuation">,</span> blockIndex<span class="token operator">:</span> streamEvent<span class="token punctuation">.</span>index <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">"message_stop"</span><span class="token operator">:</span>
        <span class="token comment">// LLM生成完成</span>
        <span class="token keyword">const</span> finalAssistantMessage <span class="token operator">=</span> <span class="token function">finalizeCliMessage</span><span class="token punctuation">(</span>
          accumulatedAssistantMessage<span class="token punctuation">,</span>
          loopState<span class="token punctuation">.</span>turnId<span class="token punctuation">,</span>
          loopState<span class="token punctuation">.</span>turnCounter
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> finalAssistantMessage<span class="token punctuation">;</span>

        <span class="token comment">// 移动到阶段5或6...</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>流处理性能</strong>：</p>
<ul>
<li>首个token延迟：300-800ms（因模型而异）</li>
<li>Token吞吐量：50-100 tokens/秒</li>
<li>UI更新频率：文本每个token更新，工具输入批量更新</li>
<li>内存使用：无论响应长度如何都保持恒定</li>
</ul>
<h3 id="阶段5：工具执行编排"><a href="#阶段5：工具执行编排" class="headerlink" title="阶段5：工具执行编排"></a>阶段5：工具执行编排</h3><p>当LLM请求使用工具时，架构转换到执行模式：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finalAssistantMessage<span class="token punctuation">.</span>message<span class="token punctuation">.</span>stop_reason <span class="token operator">===</span> <span class="token string">"tool_use"</span> <span class="token operator">&amp;&amp;</span>
      currentToolUsesFromLlm<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">"ui_state_update"</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">"executing_tools"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> toolResultMessages<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 智能批量处理工具</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> toolOutcomeMessage <span class="token keyword">of</span> <span class="token function">processToolCallsInParallelBatches</span><span class="token punctuation">(</span>
      currentToolUsesFromLlm<span class="token punctuation">,</span>
      finalAssistantMessage<span class="token punctuation">,</span>
      permissionGranterFn<span class="token punctuation">,</span>
      toolUseContext
    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> toolOutcomeMessage<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>toolOutcomeMessage<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'user'</span> <span class="token operator">&amp;&amp;</span> toolOutcomeMessage<span class="token punctuation">.</span>isMeta<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        toolResultMessages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>toolOutcomeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查工具执行期间的中止</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toolUseContext<span class="token punctuation">.</span>abortController<span class="token punctuation">.</span>signal<span class="token punctuation">.</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token function">createSystemNotificationMessage</span><span class="token punctuation">(</span><span class="token string">"工具执行被用户中止。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 排序结果以匹配LLM的请求顺序</span>
    <span class="token keyword">const</span> sortedToolResultMessages <span class="token operator">=</span> <span class="token function">sortToolResultsByOriginalRequestOrder</span><span class="token punctuation">(</span>
      toolResultMessages<span class="token punctuation">,</span>
      currentToolUsesFromLlm
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段6：递归处理结果</span>
    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">tt</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span><span class="token operator">...</span>messagesForLlm<span class="token punctuation">,</span> finalAssistantMessage<span class="token punctuation">,</span> <span class="token operator">...</span>sortedToolResultMessages<span class="token punctuation">]</span><span class="token punctuation">,</span>
      baseSystemPromptString<span class="token punctuation">,</span>
      currentGitContext<span class="token punctuation">,</span>
      currentClaudeMdContents<span class="token punctuation">,</span>
      permissionGranterFn<span class="token punctuation">,</span>
      toolUseContext<span class="token punctuation">,</span>
      <span class="token keyword">undefined</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> <span class="token operator">...</span>loopState<span class="token punctuation">,</span> turnCounter<span class="token operator">:</span> loopState<span class="token punctuation">.</span>turnCounter <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="阶段6：递归控制"><a href="#阶段6：递归控制" class="headerlink" title="阶段6：递归控制"></a>阶段6：递归控制</h3><p><code>tt</code>函数是尾递归的，允许无限的对话深度（由安全措施限制）：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 递归安全措施</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>loopState<span class="token punctuation">.</span>turnCounter <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">yield</span> <span class="token function">createSystemMessage</span><span class="token punctuation">(</span>
    <span class="token string">"已达到最大对话深度。请开始新的查询。"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 递归前的内存压力检查</span>
<span class="token keyword">const</span> estimatedMemory <span class="token operator">=</span> <span class="token function">estimateConversationMemory</span><span class="token punctuation">(</span>messagesForLlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>estimatedMemory <span class="token operator">></span> <span class="token constant">MEMORY_THRESHOLD</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 继续前强制压缩</span>
  <span class="token keyword">const</span> compacted <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">forceCompaction</span><span class="token punctuation">(</span>messagesForLlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  messagesForLlm <span class="token operator">=</span> compacted<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="分层架构"><a href="#分层架构" class="headerlink" title="分层架构"></a>分层架构</h2><p>Claude Code实现了一个清晰的分层架构，每一层都有明确的职责：</p>
<pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TD
    <span class="token keyword">subgraph</span> <span class="token string">"第1层：用户界面"</span>
        React<span class="token text string">[React组件]</span>
        Ink<span class="token text string">[Ink渲染器]</span>
        Yoga<span class="token text string">[Yoga布局引擎]</span>

        React <span class="token arrow operator">--></span> Ink
        Ink <span class="token arrow operator">--></span> Yoga
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"第2层：代理核心"</span>
        TT<span class="token text string">[tt控制循环]</span>
        Context<span class="token text string">[上下文组装]</span>
        Permission<span class="token text string">[权限系统]</span>
        <span class="token keyword">State</span><span class="token text string">[会话状态]</span>

        TT <span class="token arrow operator">--></span> Context
        TT <span class="token arrow operator">--></span> Permission
        TT <span class="token arrow operator">--></span> State
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"第3层：LLM交互"</span>
        Stream<span class="token text string">[流处理器]</span>
        Retry<span class="token text string">[重试逻辑]</span>
        Token<span class="token text string">[Token计数器]</span>

        Stream <span class="token arrow operator">--></span> Retry
        Stream <span class="token arrow operator">--></span> Token
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"第4层：工具系统"</span>
        Executor<span class="token text string">[工具执行器]</span>
        Validator<span class="token text string">[输入验证器]</span>
        Sandbox<span class="token text string">[沙箱管理器]</span>

        Executor <span class="token arrow operator">--></span> Validator
        Executor <span class="token arrow operator">--></span> Sandbox
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"第5层：基础设施"</span>
        FS<span class="token text string">[文件系统]</span>
        Process<span class="token text string">[进程管理器]</span>
        Network<span class="token text string">[网络客户端]</span>
        Telemetry<span class="token text string">[遥测]</span>
    <span class="token keyword">end</span>

    React <span class="token arrow operator">-.-></span> TT
    TT <span class="token arrow operator">-.-></span> Stream
    TT <span class="token arrow operator">-.-></span> Executor
    Executor <span class="token arrow operator">-.-></span> FS
    Executor <span class="token arrow operator">-.-></span> Process
    Stream <span class="token arrow operator">-.-></span> Network
    TT <span class="token arrow operator">-.-></span> Telemetry
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/10/23/claude-code-jia-gou-yin-qing-shi/2.svg" class="">
<h3 id="层通信模式"><a href="#层通信模式" class="headerlink" title="层通信模式"></a>层通信模式</h3><p>层之间的通信遵循严格的模式：</p>
<ol>
<li><strong>向下通信</strong>：直接函数调用</li>
<li><strong>向上通信</strong>：事件和回调</li>
<li><strong>跨层通信</strong>：共享上下文对象</li>
</ol>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 示例：UI到代理核心的通信</span>
<span class="token keyword">class</span> <span class="token class-name">UIToAgentBridge</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">handleUserInput</span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 向下：直接调用</span>
    <span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">pd</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据操作类型处理</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token string">'normal_prompt'</span><span class="token operator">:</span>
        <span class="token comment">// 开始新的tt循环迭代</span>
        <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> message <span class="token keyword">of</span> <span class="token function">tt</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// 向上：产生事件</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>uiRenderer<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 示例：工具通过进度与UI通信</span>
<span class="token keyword">class</span> <span class="token class-name">ToolToUIBridge</span> <span class="token punctuation">&#123;</span>
  async <span class="token operator">*</span><span class="token function">executeWithProgress</span><span class="token punctuation">(</span>tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">,</span> input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 工具产生进度</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> event <span class="token keyword">of</span> <span class="token function">tool</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'progress'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 转换为UI事件</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'ui_progress'</span><span class="token punctuation">,</span>
          toolName<span class="token operator">:</span> tool<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
          progress<span class="token operator">:</span> event<span class="token punctuation">.</span>data
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="事件驱动和流式架构"><a href="#事件驱动和流式架构" class="headerlink" title="事件驱动和流式架构"></a>事件驱动和流式架构</h2><p>整个系统构建在流式原语之上：</p>
<h3 id="流背压管理"><a href="#流背压管理" class="headerlink" title="流背压管理"></a>流背压管理</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">StreamBackpressureController</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> queue<span class="token operator">:</span> StreamEvent<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> processing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> pressure <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    high<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>    <span class="token comment">// 开始丢弃非关键事件</span>
    critical<span class="token operator">:</span> <span class="token number">5000</span> <span class="token comment">// 除错误外全部丢弃</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> StreamEvent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 应用背压策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>critical<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 只保留关键事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">=></span>
        e<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'error'</span> <span class="token operator">||</span>
        e<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'message_stop'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>pressure<span class="token punctuation">.</span>high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 丢弃文本增量，保留结构</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">=></span>
        e<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'content_block_delta'</span> <span class="token operator">||</span>
        e<span class="token punctuation">.</span>delta<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'text_delta'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>processing<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">processQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>processing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> batch <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 批量处理</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 让出给事件循环</span>
      <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=></span> <span class="token function">setImmediate</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>processing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="进度事件聚合"><a href="#进度事件聚合" class="headerlink" title="进度事件聚合"></a>进度事件聚合</h3><p>多个并发操作需要协调的进度报告：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ProgressAggregator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> progressStreams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> AsyncIterator<span class="token operator">&lt;</span>ProgressEvent<span class="token operator">>></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  async <span class="token operator">*</span><span class="token function">aggregateProgress</span><span class="token punctuation">(</span>
    operations<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">&#123;</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> operation<span class="token operator">:</span> AsyncIterator<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">&#125;</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>AggregatedProgress<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 启动所有操作</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> id<span class="token punctuation">,</span> operation <span class="token punctuation">&#125;</span> <span class="token keyword">of</span> operations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>progressStreams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> operation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 轮询所有流</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>progressStreams<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>progressStreams<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> stream<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> value<span class="token punctuation">,</span> done <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> stream<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> done <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 竞争获取下一个事件</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>progressStreams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>value<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'progress'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'aggregated_progress'</span><span class="token punctuation">,</span>
          source<span class="token operator">:</span> result<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          progress<span class="token operator">:</span> result<span class="token punctuation">.</span>value
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="状态管理架构"><a href="#状态管理架构" class="headerlink" title="状态管理架构"></a>状态管理架构</h2><p>Claude Code使用务实的方法进行状态管理：</p>
<h3 id="全局会话状态"><a href="#全局会话状态" class="headerlink" title="全局会话状态"></a>全局会话状态</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 带直接突变的单例会话状态</span>
<span class="token keyword">class</span> <span class="token class-name">SessionState</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> instance<span class="token operator">:</span> SessionState<span class="token punctuation">;</span>

  <span class="token comment">// 核心状态</span>
  sessionId<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cwd<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  totalCostUSD<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  totalAPIDuration<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// 模型使用跟踪</span>
  modelTokens<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    inputTokens<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    outputTokens<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    cacheReadInputTokens<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    cacheCreationInputTokens<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// 直接突变方法</span>
  <span class="token function">incrementCost</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>totalCostUSD <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">persistToDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步，非阻塞</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">updateTokenUsage</span><span class="token punctuation">(</span>model<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> usage<span class="token operator">:</span> TokenUsage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>modelTokens<span class="token punctuation">[</span>model<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>modelTokens<span class="token punctuation">[</span>model<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        inputTokens<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        outputTokens<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        cacheReadInputTokens<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        cacheCreationInputTokens<span class="token operator">:</span> <span class="token number">0</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modelTokens<span class="token punctuation">[</span>model<span class="token punctuation">]</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span>inputTokens <span class="token operator">+=</span> usage<span class="token punctuation">.</span>input_tokens <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span>outputTokens <span class="token operator">+=</span> usage<span class="token punctuation">.</span>output_tokens <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span>cacheReadInputTokens <span class="token operator">+=</span> usage<span class="token punctuation">.</span>cache_read_input_tokens <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span>cacheCreationInputTokens <span class="token operator">+=</span> usage<span class="token punctuation">.</span>cache_creation_input_tokens <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">persistToDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 防抖写入以避免过度I/O</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>persistTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>persistTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>
        <span class="token string">'.claude/session.json'</span><span class="token punctuation">,</span>
        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="带弱引用的文件状态"><a href="#带弱引用的文件状态" class="headerlink" title="带弱引用的文件状态"></a>带弱引用的文件状态</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ReadFileState</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> WeakRef<span class="token operator">&lt;</span>FileContent<span class="token operator">>></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizationRegistry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// FileContent被垃圾回收时清理</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">set</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> content<span class="token operator">:</span> FileContent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">get</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> FileContent <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 内容已被垃圾回收</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">checkFreshness</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token string">'fresh'</span> <span class="token operator">|</span> <span class="token string">'stale'</span> <span class="token operator">|</span> <span class="token string">'unknown'</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> cached <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'unknown'</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> stats <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cached<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token string">'stale'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token string">'fresh'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="安全架构"><a href="#安全架构" class="headerlink" title="安全架构"></a>安全架构</h2><p>安全通过多个独立层实现：</p>
<h3 id="第1层：权限系统"><a href="#第1层：权限系统" class="headerlink" title="第1层：权限系统"></a>第1层：权限系统</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">PermissionEvaluator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> ruleCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CompiledRule<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>
    tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">,</span>
    input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolPermissionContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>PermissionDecision<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 优先级顺序评估</span>
    <span class="token keyword">const</span> scopes<span class="token operator">:</span> PermissionRuleScope<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'cliArg'</span><span class="token punctuation">,</span>         <span class="token comment">// 最高优先级：命令行</span>
      <span class="token string">'localSettings'</span><span class="token punctuation">,</span>  <span class="token comment">// 项目特定覆盖</span>
      <span class="token string">'projectSettings'</span><span class="token punctuation">,</span><span class="token comment">// 共享项目规则</span>
      <span class="token string">'policySettings'</span><span class="token punctuation">,</span> <span class="token comment">// 组织策略</span>
      <span class="token string">'userSettings'</span>    <span class="token comment">// 最低优先级：用户偏好</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> scope <span class="token keyword">of</span> scopes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> decision <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">evaluateScope</span><span class="token punctuation">(</span>
        tool<span class="token punctuation">,</span> input<span class="token punctuation">,</span> context<span class="token punctuation">,</span> scope
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>decision<span class="token punctuation">.</span>behavior <span class="token operator">!==</span> <span class="token string">'continue'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> decision<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 没有匹配规则 - 询问用户</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      behavior<span class="token operator">:</span> <span class="token string">'ask'</span><span class="token punctuation">,</span>
      suggestions<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSuggestions</span><span class="token punctuation">(</span>tool<span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">compileRule</span><span class="token punctuation">(</span>rule<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> CompiledRule <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ruleCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ruleCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 解析规则语法：ToolName(glob/pattern)</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\\w+)(?:\\((.+)\\))?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">无效规则：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>rule<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> toolPattern<span class="token punctuation">,</span> pathPattern<span class="token punctuation">]</span> <span class="token operator">=</span> match<span class="token punctuation">;</span>

    <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      toolMatcher<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>toolPattern<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'.*'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">$</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      pathMatcher<span class="token operator">:</span> pathPattern
        <span class="token operator">?</span> <span class="token function">picomatch</span><span class="token punctuation">(</span>pathPattern<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>ruleCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> compiled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> compiled<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="第2层：沙箱架构"><a href="#第2层：沙箱架构" class="headerlink" title="第2层：沙箱架构"></a>第2层：沙箱架构</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// macOS沙箱实现</span>
<span class="token keyword">class</span> <span class="token class-name">MacOSSandboxManager</span> <span class="token punctuation">&#123;</span>
  <span class="token function">generateProfile</span><span class="token punctuation">(</span>
    command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    restrictions<span class="token operator">:</span> SandboxRestrictions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> profile <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
(version 1)
(deny default)

; 基础权限
(allow process-exec (literal "/bin/bash"))
(allow process-exec (literal "/usr/bin/env"))

; 文件系统访问
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>restrictions<span class="token punctuation">.</span>allowRead <span class="token operator">?</span> <span class="token string">'(allow file-read*)'</span> <span class="token operator">:</span> <span class="token string">'(deny file-read*)'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>restrictions<span class="token punctuation">.</span>allowWrite <span class="token operator">?</span> <span class="token string">'(allow file-write*)'</span> <span class="token operator">:</span> <span class="token string">'(deny file-write*)'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

; 网络访问
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>restrictions<span class="token punctuation">.</span>allowNetwork <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
(allow network-outbound)
(allow network-inbound)
</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
(deny network*)
</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

; 系统操作
(allow sysctl-read)
(allow mach-lookup)

; 临时文件
(allow file-write* (subpath "/tmp"))
(allow file-write* (subpath "/var/tmp"))
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> profile<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token function">executeSandboxed</span><span class="token punctuation">(</span>
    command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    profile<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ExecutionResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 将配置文件写入临时文件</span>
    <span class="token keyword">const</span> profilePath <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeTemporaryProfile</span><span class="token punctuation">(</span>profile<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 使用sandbox-exec执行</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sandbox-exec -p '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>profilePath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">' </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>command<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 清理</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>profilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="第3层：路径验证"><a href="#第3层：路径验证" class="headerlink" title="第3层：路径验证"></a>第3层：路径验证</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">PathValidator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> boundaries<span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> deniedPatterns<span class="token operator">:</span> RegExp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> SecurityContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>boundaries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      context<span class="token punctuation">.</span>projectRoot<span class="token punctuation">,</span>
      <span class="token operator">...</span>context<span class="token punctuation">.</span>additionalWorkingDirectories
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>deniedPatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token operator">/</span>\\<span class="token operator">/</span>\\<span class="token punctuation">.</span><span class="token punctuation">(</span>ssh<span class="token operator">|</span>gnupg<span class="token punctuation">)</span>\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>     <span class="token comment">// SSH/GPG密钥</span>
      <span class="token operator">/</span>\\<span class="token operator">/</span><span class="token punctuation">(</span>etc<span class="token operator">|</span>sys<span class="token operator">|</span>proc<span class="token punctuation">)</span>\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>    <span class="token comment">// 系统目录</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span>pem$<span class="token operator">|</span>\\<span class="token punctuation">.</span>key$<span class="token operator">/</span><span class="token punctuation">,</span>         <span class="token comment">// 私钥</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span><span class="token punctuation">(</span>env<span class="token operator">|</span>envrc<span class="token punctuation">)</span>$<span class="token operator">/</span>         <span class="token comment">// 环境文件</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">validate</span><span class="token punctuation">(</span>requestedPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ValidationResult <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> absolute <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>requestedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查边界</span>
    <span class="token keyword">const</span> inBoundary <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>boundaries<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
      boundary <span class="token operator">=></span> absolute<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>boundary<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBoundary<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        allowed<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        reason<span class="token operator">:</span> <span class="token string">'路径在允许目录之外'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查被拒绝的模式</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pattern <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deniedPatterns<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>absolute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          allowed<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          reason<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">路径匹配被拒绝的模式：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>pattern<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> allowed<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="性能架构"><a href="#性能架构" class="headerlink" title="性能架构"></a>性能架构</h2><h3 id="ANR（应用程序无响应）检测"><a href="#ANR（应用程序无响应）检测" class="headerlink" title="ANR（应用程序无响应）检测"></a>ANR（应用程序无响应）检测</h3><p>ANR系统使用工作线程监控主事件循环：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 工作线程脚本（嵌入为base64）</span>
<span class="token keyword">const</span> anrWorkerScript <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
const &#123; parentPort &#125; = require('worker_threads');

let config = &#123; anrThreshold: 5000, captureStackTrace: false &#125;;
let lastPing = Date.now();
let anrTimer = null;

function checkANR() &#123;
  const elapsed = Date.now() - lastPing;

  if (elapsed > config.anrThreshold) &#123;
    // 主线程没有响应
    parentPort.postMessage(&#123;
      type: 'anr',
      payload: &#123;
        elapsed,
        stackTrace: config.captureStackTrace
          ? captureMainThreadStack()
          : null
      &#125;
    &#125;);
  &#125;

  // 安排下次检查
  anrTimer = setTimeout(checkANR, 100);
&#125;

async function captureMainThreadStack() &#123;
  // 如果可用，使用检查器协议
  try &#123;
    const &#123; Session &#125; = require('inspector');
    const session = new Session();
    session.connect();

    const &#123; result &#125; = await session.post('Debugger.enable');
    const stack = await session.post('Debugger.getStackTrace');

    session.disconnect();
    return stack;
  &#125; catch (e) &#123;
    return null;
  &#125;
&#125;

parentPort.on('message', (msg) => &#123;
  if (msg.type === 'config') &#123;
    config = msg.payload;
    lastPing = Date.now();
    checkANR(); // 开始监控
  &#125; else if (msg.type === 'ping') &#123;
    lastPing = Date.now();
  &#125;
&#125;);
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 主线程ANR集成</span>
<span class="token keyword">class</span> <span class="token class-name">ANRMonitor</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> worker<span class="token operator">:</span> Worker<span class="token punctuation">;</span>
  <span class="token keyword">private</span> pingInterval<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>Timer<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>options<span class="token operator">:</span> ANROptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 从嵌入脚本创建工作线程</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>anrWorkerScript<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> eval<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置工作线程</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'config'</span><span class="token punctuation">,</span>
      payload<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        anrThreshold<span class="token operator">:</span> options<span class="token punctuation">.</span>threshold <span class="token operator">||</span> <span class="token number">5000</span><span class="token punctuation">,</span>
        captureStackTrace<span class="token operator">:</span> options<span class="token punctuation">.</span>captureStackTrace <span class="token operator">!==</span> <span class="token boolean">false</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始心跳</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pingInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'ping'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>pollInterval <span class="token operator">||</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 处理ANR检测</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'anr'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleANR</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">handleANR</span><span class="token punctuation">(</span>data<span class="token operator">:</span> ANRData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 记录到遥测</span>
    Sentry<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">应用程序无响应</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>elapsed<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">毫秒</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      extra<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        stackTrace<span class="token operator">:</span> data<span class="token punctuation">.</span>stackTrace<span class="token punctuation">,</span>
        eventLoopDelay<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventLoopDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="战略性缓存层"><a href="#战略性缓存层" class="headerlink" title="战略性缓存层"></a>战略性缓存层</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">CacheArchitecture</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// L1：内存缓存</span>
  <span class="token keyword">private</span> schemaCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LRUCache<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> JSONSchema<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> patternCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LRUCache<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CompiledPattern<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> gitContextCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TTLCache<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> GitContext<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token number">30_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 30秒TTL</span>

  <span class="token comment">// L2：弱引用缓存</span>
  <span class="token keyword">private</span> fileContentCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRefCache<span class="token operator">&lt;</span>FileContent<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// L3：磁盘缓存</span>
  <span class="token keyword">private</span> diskCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiskCache</span><span class="token punctuation">(</span><span class="token string">'.claude/cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    <span class="token function-variable function">generator</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> CacheOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查L1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>schemaCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>schemaCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查L2</span>
    <span class="token keyword">const</span> weakRef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileContentCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>weakRef<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> weakRef <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查L3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> diskValue <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>diskCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>diskValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> diskValue<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 生成并缓存</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 存储在适当的缓存中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>weak<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fileContentCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>diskCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> options<span class="token punctuation">.</span>ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>schemaCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="遥测和可观测性设计"><a href="#遥测和可观测性设计" class="headerlink" title="遥测和可观测性设计"></a>遥测和可观测性设计</h2><p>三支柱方法提供全面的可见性：</p>
<h3 id="支柱1：错误跟踪（Sentry）"><a href="#支柱1：错误跟踪（Sentry）" class="headerlink" title="支柱1：错误跟踪（Sentry）"></a>支柱1：错误跟踪（Sentry）</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> wrap<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">(</span>
    fn<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ErrorContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> Parameters<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> span <span class="token operator">=</span> Sentry<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        name<span class="token operator">:</span> context<span class="token punctuation">.</span>operation<span class="token punctuation">,</span>
        op<span class="token operator">:</span> context<span class="token punctuation">.</span>category
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        span<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        span<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">'internal_error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Sentry<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
          contexts<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            operation<span class="token operator">:</span> context<span class="token punctuation">,</span>
            state<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">captureState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          fingerprint<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateFingerprint</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        span<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">captureState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      sessionId<span class="token operator">:</span> SessionState<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
      conversationDepth<span class="token operator">:</span> <span class="token comment">/* 当前深度 */</span><span class="token punctuation">,</span>
      activeTools<span class="token operator">:</span> <span class="token comment">/* 当前执行中 */</span><span class="token punctuation">,</span>
      memoryUsage<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      eventLoopDelay<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventLoopDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="支柱2：指标（OpenTelemetry）"><a href="#支柱2：指标（OpenTelemetry）" class="headerlink" title="支柱2：指标（OpenTelemetry）"></a>支柱2：指标（OpenTelemetry）</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">MetricsCollector</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> meters <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    api<span class="token operator">:</span> meter<span class="token punctuation">.</span><span class="token function">createCounter</span><span class="token punctuation">(</span><span class="token string">'api_calls_total'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tokens<span class="token operator">:</span> meter<span class="token punctuation">.</span><span class="token function">createHistogram</span><span class="token punctuation">(</span><span class="token string">'token_usage'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tools<span class="token operator">:</span> meter<span class="token punctuation">.</span><span class="token function">createHistogram</span><span class="token punctuation">(</span><span class="token string">'tool_execution_duration'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    streaming<span class="token operator">:</span> meter<span class="token punctuation">.</span><span class="token function">createHistogram</span><span class="token punctuation">(</span><span class="token string">'streaming_latency'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function">recordApiCall</span><span class="token punctuation">(</span>result<span class="token operator">:</span> ApiCallResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>meters<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      model<span class="token operator">:</span> result<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
      status<span class="token operator">:</span> result<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
      provider<span class="token operator">:</span> result<span class="token punctuation">.</span>provider
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>meters<span class="token punctuation">.</span>tokens<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>totalTokens<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      model<span class="token operator">:</span> result<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'total'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">recordToolExecution</span><span class="token punctuation">(</span>tool<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> duration<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> success<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>meters<span class="token punctuation">.</span>tools<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      tool<span class="token punctuation">,</span>
      success<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">,</span>
      concurrent<span class="token operator">:</span> <span class="token comment">/* 是否并行？ */</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="支柱3：功能标志（Statsig）"><a href="#支柱3：功能标志（Statsig）" class="headerlink" title="支柱3：功能标志（Statsig）"></a>支柱3：功能标志（Statsig）</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FeatureManager</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">checkGate</span><span class="token punctuation">(</span>
    gate<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">?</span><span class="token operator">:</span> FeatureContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> statsig<span class="token punctuation">.</span><span class="token function">checkGate</span><span class="token punctuation">(</span>gate<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      userID<span class="token operator">:</span> SessionState<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
      custom<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        model<span class="token operator">:</span> context<span class="token operator">?.</span>model<span class="token punctuation">,</span>
        toolsEnabled<span class="token operator">:</span> context<span class="token operator">?.</span>tools<span class="token punctuation">,</span>
        platform<span class="token operator">:</span> process<span class="token punctuation">.</span>platform
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token generic-function"><span class="token function">getConfig</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    config<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    defaultValue<span class="token operator">:</span> <span class="token constant">T</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> dynamicConfig <span class="token operator">=</span> statsig<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dynamicConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h2><h3 id="进程生命周期管理"><a href="#进程生命周期管理" class="headerlink" title="进程生命周期管理"></a>进程生命周期管理</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ProcessManager</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> processes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ChildProcess<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> limits <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    maxProcesses<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    maxMemoryPerProcess<span class="token operator">:</span> <span class="token number">512</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment">// 512MB</span>
    maxTotalMemory<span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>  <span class="token comment">// 2GB</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">spawn</span><span class="token punctuation">(</span>
    id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> SpawnOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ManagedProcess<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查限制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processes<span class="token punctuation">.</span>size <span class="token operator">>=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>limits<span class="token punctuation">.</span>maxProcesses<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">killOldestProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'bash'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-c'</span><span class="token punctuation">,</span> command<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">...</span>options<span class="token punctuation">,</span>
      <span class="token comment">// 资源限制</span>
      env<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">...</span>options<span class="token punctuation">.</span>env<span class="token punctuation">,</span>
        <span class="token constant">NODE_OPTIONS</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--max-old-space-size=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>limits<span class="token punctuation">.</span>maxMemoryPerProcess <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 监控资源</span>
    <span class="token keyword">const</span> monitor <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkProcessHealth</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ManagedProcess</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">checkProcessHealth</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> proc<span class="token operator">:</span> ChildProcess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> usage <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">pidusage</span><span class="token punctuation">(</span>proc<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>usage<span class="token punctuation">.</span>memory <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>limits<span class="token punctuation">.</span>maxMemoryPerProcess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">进程</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">超出内存限制</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        proc<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">'SIGTERM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 进程可能已退出</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="网络连接池"><a href="#网络连接池" class="headerlink" title="网络连接池"></a>网络连接池</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">NetworkPool</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> pools <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ConnectionPool<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">getPool</span><span class="token punctuation">(</span>provider<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ConnectionPool <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pools<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pools<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        maxConnections<span class="token operator">:</span> provider <span class="token operator">===</span> <span class="token string">'anthropic'</span> <span class="token operator">?</span> <span class="token number">10</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        maxIdleTime<span class="token operator">:</span> <span class="token number">30_000</span><span class="token punctuation">,</span>
        keepAlive<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pools<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token function">request</span><span class="token punctuation">(</span>
    provider<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> RequestOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Response<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> pool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
      pool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p><em>本架构分析基于逆向工程和反编译。实际实现可能有所不同。所呈现的模式代表了基于可观察行为和高性能Node.js应用程序常见实践推断出的架构决策。</em></p>
<h1 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档深入分析了Claude Code的核心架构，揭示了其高性能响应背后的精密设计。通过反编译和逆向工程分析，文档详细展示了Claude Code如何通过分层架构、流式处理、智能状态管理等技术实现卓越的用户体验。</p>
<h2 id="核心架构特点"><a href="#核心架构特点" class="headerlink" title="核心架构特点"></a>核心架构特点</h2><h3 id="1-tt控制循环：系统的心脏"><a href="#1-tt控制循环：系统的心脏" class="headerlink" title="1. tt控制循环：系统的心脏"></a>1. tt控制循环：系统的心脏</h3><ul>
<li><strong>六阶段处理流程</strong>：<ol>
<li>回合初始化和上下文准备（10-50ms token计数，2000-3000ms LLM压缩）</li>
<li>动态系统提示组装（并行获取上下文源）</li>
<li>LLM流初始化（异步生成器设置）</li>
<li>流事件处理状态机（实时事件驱动处理）</li>
<li>工具执行编排（智能批量处理）</li>
<li>递归控制（尾递归，深度限制10轮）</li>
</ol>
</li>
<li><strong>性能特征</strong>：首个token延迟300-800ms，token吞吐量50-100/秒，恒定内存使用</li>
</ul>
<h3 id="2-分层架构设计"><a href="#2-分层架构设计" class="headerlink" title="2. 分层架构设计"></a>2. 分层架构设计</h3><ul>
<li><strong>第1层：用户界面</strong>：React组件 + Ink渲染器 + Yoga布局引擎</li>
<li><strong>第2层：代理核心</strong>：tt控制循环 + 上下文组装 + 权限系统 + 会话状态</li>
<li><strong>第3层：LLM交互</strong>：流处理器 + 重试逻辑 + Token计数器</li>
<li><strong>第4层：工具系统</strong>：工具执行器 + 输入验证器 + 沙箱管理器</li>
<li><strong>第5层：基础设施</strong>：文件系统 + 进程管理器 + 网络客户端 + 遥测</li>
</ul>
<h3 id="3-通信模式"><a href="#3-通信模式" class="headerlink" title="3. 通信模式"></a>3. 通信模式</h3><ul>
<li><strong>向下通信</strong>：直接函数调用</li>
<li><strong>向上通信</strong>：事件和回调</li>
<li><strong>跨层通信</strong>：共享上下文对象</li>
</ul>
<h2 id="事件驱动和流式架构-1"><a href="#事件驱动和流式架构-1" class="headerlink" title="事件驱动和流式架构"></a>事件驱动和流式架构</h2><h3 id="流背压管理-1"><a href="#流背压管理-1" class="headerlink" title="流背压管理"></a>流背压管理</h3><ul>
<li><strong>压力阈值</strong>：高压力1000事件（丢弃非关键），临界压力5000事件（仅保留错误）</li>
<li><strong>批处理策略</strong>：100个事件为一批，让出事件循环</li>
<li><strong>智能过滤</strong>：文本增量可过滤，结构事件保留</li>
</ul>
<h3 id="进度事件聚合-1"><a href="#进度事件聚合-1" class="headerlink" title="进度事件聚合"></a>进度事件聚合</h3><ul>
<li><strong>多操作协调</strong>：并发进度报告的统一管理</li>
<li><strong>竞态机制</strong>：Promise.race获取下一个事件</li>
<li><strong>超时保护</strong>：100ms超时防止挂起</li>
</ul>
<h2 id="状态管理架构-1"><a href="#状态管理架构-1" class="headerlink" title="状态管理架构"></a>状态管理架构</h2><h3 id="全局会话状态-1"><a href="#全局会话状态-1" class="headerlink" title="全局会话状态"></a>全局会话状态</h3><ul>
<li><strong>单例模式</strong>：直接突变方法，异步磁盘持久化</li>
<li><strong>令牌跟踪</strong>：详细的模型使用统计</li>
<li><strong>防抖写入</strong>：1秒延迟避免过度I/O</li>
</ul>
<h3 id="文件状态管理"><a href="#文件状态管理" class="headerlink" title="文件状态管理"></a>文件状态管理</h3><ul>
<li><strong>弱引用缓存</strong>：WeakRef + FinalizationRegistry自动清理</li>
<li><strong>新鲜度检查</strong>：基于修改时间的缓存失效</li>
<li><strong>内存安全</strong>：防止悬挂引用和内存泄漏</li>
</ul>
<h2 id="安全架构-1"><a href="#安全架构-1" class="headerlink" title="安全架构"></a>安全架构</h2><h3 id="三层防护体系"><a href="#三层防护体系" class="headerlink" title="三层防护体系"></a>三层防护体系</h3><ol>
<li><p><strong>权限系统</strong>：</p>
<ul>
<li>五级优先级评估（CLI参数 &gt; 本地设置 &gt; 项目设置 &gt; 策略设置 &gt; 用户设置）</li>
<li>规则编译缓存，JIT优化</li>
<li>智能建议生成</li>
</ul>
</li>
<li><p><strong>沙箱架构</strong>：</p>
<ul>
<li>macOS专用sandbox-exec集成</li>
<li>动态配置文件生成</li>
<li>文件系统、网络、系统操作精细控制</li>
</ul>
</li>
<li><p><strong>路径验证</strong>：</p>
<ul>
<li>边界检查（项目根目录 + 额外工作目录）</li>
<li>敏感模式拒绝（SSH/GPG密钥、系统目录、私钥文件）</li>
<li>实时验证结果</li>
</ul>
</li>
</ol>
<h2 id="性能架构-1"><a href="#性能架构-1" class="headerlink" title="性能架构"></a>性能架构</h2><h3 id="ANR检测系统"><a href="#ANR检测系统" class="headerlink" title="ANR检测系统"></a>ANR检测系统</h3><ul>
<li><strong>工作线程监控</strong>：独立线程监控主事件循环</li>
<li><strong>5秒阈值检测</strong>：超时自动触发堆栈捕获</li>
<li><strong>检查器协议集成</strong>：使用inspector模块获取调用栈</li>
<li><strong>遥测报告</strong>：Sentry集成自动上报</li>
</ul>
<h3 id="三级缓存架构"><a href="#三级缓存架构" class="headerlink" title="三级缓存架构"></a>三级缓存架构</h3><ul>
<li><strong>L1缓存</strong>：内存缓存（LRU 100个schema，TTL 30秒git上下文）</li>
<li><strong>L2缓存</strong>：弱引用缓存（文件内容自动垃圾回收）</li>
<li><strong>L3缓存</strong>：磁盘缓存（’.claude/cache’持久化存储）</li>
</ul>
<h2 id="遥测和可观测性"><a href="#遥测和可观测性" class="headerlink" title="遥测和可观测性"></a>遥测和可观测性</h2><h3 id="三支柱方法"><a href="#三支柱方法" class="headerlink" title="三支柱方法"></a>三支柱方法</h3><ol>
<li><p><strong>错误跟踪（Sentry）</strong>：</p>
<ul>
<li>事务边界包装</li>
<li>状态捕获（会话ID、对话深度、内存使用）</li>
<li>指纹生成和错误分类</li>
</ul>
</li>
<li><p><strong>指标收集（OpenTelemetry）</strong>：</p>
<ul>
<li>API调用计数器</li>
<li>Token使用直方图</li>
<li>工具执行持续时间</li>
<li>流延迟监控</li>
</ul>
</li>
<li><p><strong>功能标志（Statsig）</strong>：</p>
<ul>
<li>动态特性开关</li>
<li>配置管理</li>
<li>A/B测试支持</li>
</ul>
</li>
</ol>
<h2 id="资源管理-1"><a href="#资源管理-1" class="headerlink" title="资源管理"></a>资源管理</h2><h3 id="进程生命周期管理-1"><a href="#进程生命周期管理-1" class="headerlink" title="进程生命周期管理"></a>进程生命周期管理</h3><ul>
<li><strong>资源限制</strong>：最大10个进程，每进程512MB，总计2GB</li>
<li><strong>健康监控</strong>：1秒间隔检查进程内存使用</li>
<li><strong>自动清理</strong>：超限进程自动终止</li>
<li><strong>NODE_OPTIONS控制</strong>：动态设置内存限制</li>
</ul>
<h3 id="网络连接池-1"><a href="#网络连接池-1" class="headerlink" title="网络连接池"></a>网络连接池</h3><ul>
<li><strong>提供商隔离</strong>：Anthropic 10连接，其他5连接</li>
<li><strong>连接复用</strong>：30秒空闲时间，keep-alive支持</li>
<li><strong>获取释放</strong>：自动连接管理</li>
</ul>
<h2 id="技术创新点"><a href="#技术创新点" class="headerlink" title="技术创新点"></a>技术创新点</h2><h3 id="架构创新"><a href="#架构创新" class="headerlink" title="架构创新"></a>架构创新</h3><ol>
<li><strong>异步生成器管道</strong>：tt函数的流式处理架构</li>
<li><strong>分层权限系统</strong>：多维度安全控制机制</li>
<li><strong>事件驱动设计</strong>：响应式状态更新</li>
<li><strong>智能缓存策略</strong>：多层次缓存优化</li>
</ol>
<h3 id="性能创新"><a href="#性能创新" class="headerlink" title="性能创新"></a>性能创新</h3><ol>
<li><strong>ANR检测机制</strong>：工作线程监控主线程</li>
<li><strong>背压控制系统</strong>：防止内存溢出的流控制</li>
<li><strong>弱引用缓存</strong>：自动内存管理</li>
<li><strong>连接池优化</strong>：网络资源高效利用</li>
</ol>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><ol>
<li><strong>模块化设计</strong>：清晰的职责分离</li>
<li><strong>错误边界处理</strong>：全面的异常捕获和报告</li>
<li><strong>资源监控</strong>：实时性能和资源使用追踪</li>
<li><strong>可观测性</strong>：三支柱监控体系</li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Claude Code的架构体现了现代软件工程的最佳实践，通过精密的分层设计和创新的技术实现，构建了高性能、高可靠性的AI开发工具。其核心价值在于：</p>
<ul>
<li><strong>卓越性能</strong>：多层次的优化策略确保快速响应</li>
<li><strong>可靠安全</strong>：三层防护体系保障系统安全</li>
<li><strong>可扩展性</strong>：模块化架构支持功能扩展</li>
<li><strong>可观测性</strong>：全面的监控体系确保运维效率</li>
</ul>
<p>这种架构设计为现代AI工具的开发提供了优秀的参考模板，特别是在需要处理复杂流式数据、保证系统响应性和维护高度安全性的场景中。文档的深入分析为理解高性能AI系统的架构设计提供了宝贵的技术参考。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">寒霜</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://hanshuang-ai.github.io/2025/10/23/claude-code-jia-gou-yin-qing-shi/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://hanshuang-ai.github.io/2025/10/23/claude-code-jia-gou-yin-qing-shi/')">claude-code架构-引擎室</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://hanshuang-ai.github.io/2025/10/23/claude-code-jia-gou-yin-qing-shi/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=claude-code架构-引擎室&amp;url=https://hanshuang-ai.github.io/2025/10/23/claude-code-jia-gou-yin-qing-shi/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hanshuang-ai.github.io" target="_blank">我的博客</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/10/23/claude-code-gong-ju-yu-zhi-xing-yin-qing/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">claude-code工具与执行引擎</div></div></a></div><div class="next-post pull-right"><a href="/2025/10/23/claude-code-xin-ying-de-zu-jian/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">claude-code新颖的组件</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Architecture-The-Engine-Room"><span class="toc-number">1.</span> <span class="toc-text">Architecture: The Engine Room</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%EF%BC%9A%E5%BC%95%E6%93%8E%E5%AE%A4"><span class="toc-number">2.</span> <span class="toc-text">架构：引擎室</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tt%E6%8E%A7%E5%88%B6%E5%BE%AA%E7%8E%AF%EF%BC%9A%E8%B7%B3%E5%8A%A8%E7%9A%84%E5%BF%83%E8%84%8F"><span class="toc-number">2.1.</span> <span class="toc-text">tt控制循环：跳动的心脏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B51%EF%BC%9A%E5%9B%9E%E5%90%88%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E5%87%86%E5%A4%87"><span class="toc-number">2.1.1.</span> <span class="toc-text">阶段1：回合初始化和上下文准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B52%EF%BC%9A%E5%8A%A8%E6%80%81%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%E7%BB%84%E8%A3%85"><span class="toc-number">2.1.2.</span> <span class="toc-text">阶段2：动态系统提示组装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B53%EF%BC%9ALLM%E6%B5%81%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.3.</span> <span class="toc-text">阶段3：LLM流初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B54%EF%BC%9A%E6%B5%81%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">2.1.4.</span> <span class="toc-text">阶段4：流事件处理状态机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B55%EF%BC%9A%E5%B7%A5%E5%85%B7%E6%89%A7%E8%A1%8C%E7%BC%96%E6%8E%92"><span class="toc-number">2.1.5.</span> <span class="toc-text">阶段5：工具执行编排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B56%EF%BC%9A%E9%80%92%E5%BD%92%E6%8E%A7%E5%88%B6"><span class="toc-number">2.1.6.</span> <span class="toc-text">阶段6：递归控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="toc-number">2.2.</span> <span class="toc-text">分层架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%82%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.2.1.</span> <span class="toc-text">层通信模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%B5%81%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="toc-number">2.3.</span> <span class="toc-text">事件驱动和流式架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E8%83%8C%E5%8E%8B%E7%AE%A1%E7%90%86"><span class="toc-number">2.3.1.</span> <span class="toc-text">流背压管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%BA%A6%E4%BA%8B%E4%BB%B6%E8%81%9A%E5%90%88"><span class="toc-number">2.3.2.</span> <span class="toc-text">进度事件聚合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E6%9E%B6%E6%9E%84"><span class="toc-number">2.4.</span> <span class="toc-text">状态管理架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E4%BC%9A%E8%AF%9D%E7%8A%B6%E6%80%81"><span class="toc-number">2.4.1.</span> <span class="toc-text">全局会话状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E5%BC%B1%E5%BC%95%E7%94%A8%E7%9A%84%E6%96%87%E4%BB%B6%E7%8A%B6%E6%80%81"><span class="toc-number">2.4.2.</span> <span class="toc-text">带弱引用的文件状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">2.5.</span> <span class="toc-text">安全架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC1%E5%B1%82%EF%BC%9A%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.5.1.</span> <span class="toc-text">第1层：权限系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC2%E5%B1%82%EF%BC%9A%E6%B2%99%E7%AE%B1%E6%9E%B6%E6%9E%84"><span class="toc-number">2.5.2.</span> <span class="toc-text">第2层：沙箱架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC3%E5%B1%82%EF%BC%9A%E8%B7%AF%E5%BE%84%E9%AA%8C%E8%AF%81"><span class="toc-number">2.5.3.</span> <span class="toc-text">第3层：路径验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%9E%B6%E6%9E%84"><span class="toc-number">2.6.</span> <span class="toc-text">性能架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ANR%EF%BC%88%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%97%A0%E5%93%8D%E5%BA%94%EF%BC%89%E6%A3%80%E6%B5%8B"><span class="toc-number">2.6.1.</span> <span class="toc-text">ANR（应用程序无响应）检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%98%E7%95%A5%E6%80%A7%E7%BC%93%E5%AD%98%E5%B1%82"><span class="toc-number">2.6.2.</span> <span class="toc-text">战略性缓存层</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%A5%E6%B5%8B%E5%92%8C%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.7.</span> <span class="toc-text">遥测和可观测性设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%9F%B11%EF%BC%9A%E9%94%99%E8%AF%AF%E8%B7%9F%E8%B8%AA%EF%BC%88Sentry%EF%BC%89"><span class="toc-number">2.7.1.</span> <span class="toc-text">支柱1：错误跟踪（Sentry）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%9F%B12%EF%BC%9A%E6%8C%87%E6%A0%87%EF%BC%88OpenTelemetry%EF%BC%89"><span class="toc-number">2.7.2.</span> <span class="toc-text">支柱2：指标（OpenTelemetry）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%9F%B13%EF%BC%9A%E5%8A%9F%E8%83%BD%E6%A0%87%E5%BF%97%EF%BC%88Statsig%EF%BC%89"><span class="toc-number">2.7.3.</span> <span class="toc-text">支柱3：功能标志（Statsig）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="toc-number">2.8.</span> <span class="toc-text">资源管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="toc-number">2.8.1.</span> <span class="toc-text">进程生命周期管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">2.8.2.</span> <span class="toc-text">网络连接池</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">文件总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E7%89%B9%E7%82%B9"><span class="toc-number">3.2.</span> <span class="toc-text">核心架构特点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-tt%E6%8E%A7%E5%88%B6%E5%BE%AA%E7%8E%AF%EF%BC%9A%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%BF%83%E8%84%8F"><span class="toc-number">3.2.1.</span> <span class="toc-text">1. tt控制循环：系统的心脏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.2.2.</span> <span class="toc-text">2. 分层架构设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.3.</span> <span class="toc-text">3. 通信模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%B5%81%E5%BC%8F%E6%9E%B6%E6%9E%84-1"><span class="toc-number">3.3.</span> <span class="toc-text">事件驱动和流式架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E8%83%8C%E5%8E%8B%E7%AE%A1%E7%90%86-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">流背压管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%BA%A6%E4%BA%8B%E4%BB%B6%E8%81%9A%E5%90%88-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">进度事件聚合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E6%9E%B6%E6%9E%84-1"><span class="toc-number">3.4.</span> <span class="toc-text">状态管理架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E4%BC%9A%E8%AF%9D%E7%8A%B6%E6%80%81-1"><span class="toc-number">3.4.1.</span> <span class="toc-text">全局会话状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">3.4.2.</span> <span class="toc-text">文件状态管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84-1"><span class="toc-number">3.5.</span> <span class="toc-text">安全架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E5%B1%82%E9%98%B2%E6%8A%A4%E4%BD%93%E7%B3%BB"><span class="toc-number">3.5.1.</span> <span class="toc-text">三层防护体系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%9E%B6%E6%9E%84-1"><span class="toc-number">3.6.</span> <span class="toc-text">性能架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ANR%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.6.1.</span> <span class="toc-text">ANR检测系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84"><span class="toc-number">3.6.2.</span> <span class="toc-text">三级缓存架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%A5%E6%B5%8B%E5%92%8C%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7"><span class="toc-number">3.7.</span> <span class="toc-text">遥测和可观测性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E6%94%AF%E6%9F%B1%E6%96%B9%E6%B3%95"><span class="toc-number">3.7.1.</span> <span class="toc-text">三支柱方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86-1"><span class="toc-number">3.8.</span> <span class="toc-text">资源管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86-1"><span class="toc-number">3.8.1.</span> <span class="toc-text">进程生命周期管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E6%B1%A0-1"><span class="toc-number">3.8.2.</span> <span class="toc-text">网络连接池</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%88%9B%E6%96%B0%E7%82%B9"><span class="toc-number">3.9.</span> <span class="toc-text">技术创新点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%88%9B%E6%96%B0"><span class="toc-number">3.9.1.</span> <span class="toc-text">架构创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%9B%E6%96%B0"><span class="toc-number">3.9.2.</span> <span class="toc-text">性能创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.9.3.</span> <span class="toc-text">工程实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">3.10.</span> <span class="toc-text">结论</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/25/macos-an-zhuang-homebrew/" title="macOS安装homebrew">macOS安装homebrew</a><time datetime="2025-12-25T12:09:27.713Z" title="更新于 2025-12-25 20:09:27">2025-12-25</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2025/01/16/go-yu-yan-ru-men-zhi-nan/" title="Go语言入门指南">Go语言入门指南</a><time datetime="2025-12-16T12:44:28.982Z" title="更新于 2025-12-16 20:44:28">2025-12-16</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2025/12/16/php-shu-zu-wan-quan-zhi-nan/" title="PHP数组完全指南">PHP数组完全指南</a><time datetime="2025-12-16T11:12:19.007Z" title="更新于 2025-12-16 19:12:19">2025-12-16</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2024/12/16/claude-code-agent-sdk-jie-ru-zi-yan-cha-jian/" title="Claude Code Agent SDK 接入自研插件">Claude Code Agent SDK 接入自研插件</a><time datetime="2025-12-16T10:15:32.430Z" title="更新于 2025-12-16 18:15:32">2025-12-16</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2025/11/20/react-ji-chu/" title="React核心基础与实践指南">React核心基础与实践指南</a><time datetime="2025-11-20T05:34:53.956Z" title="更新于 2025-11-20 13:34:53">2025-11-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 寒霜</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">167</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">121</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://hexo.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 0.88rem;">AI<sup>1</sup></a><a href="/tags/Claude/" style="font-size: 0.88rem;">Claude<sup>1</sup></a><a href="/tags/Go/" style="font-size: 0.88rem;">Go<sup>1</sup></a><a href="/tags/Golang/" style="font-size: 0.88rem;">Golang<sup>1</sup></a><a href="/tags/HTML%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">HTML基础<sup>1</sup></a><a href="/tags/SDK/" style="font-size: 0.88rem;">SDK<sup>1</sup></a><a href="/tags/base64/" style="font-size: 0.88rem;">base64<sup>1</sup></a><a href="/tags/canvas/" style="font-size: 0.88rem;">canvas<sup>2</sup></a><a href="/tags/cesium/" style="font-size: 0.88rem;">cesium<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>5</sup></a><a href="/tags/docker/" style="font-size: 0.88rem;">docker<sup>3</sup></a><a href="/tags/echart/" style="font-size: 0.88rem;">echart<sup>1</sup></a><a href="/tags/electron/" style="font-size: 0.88rem;">electron<sup>2</sup></a><a href="/tags/elementUI/" style="font-size: 0.88rem;">elementUI<sup>1</sup></a><a href="/tags/flex/" style="font-size: 0.88rem;">flex<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>3</sup></a><a href="/tags/javascript/" style="font-size: 0.88rem;">javascript<sup>1</sup></a><a href="/tags/js/" style="font-size: 0.88rem;">js<sup>2</sup></a><a href="/tags/position/" style="font-size: 0.88rem;">position<sup>1</sup></a><a href="/tags/vue/" style="font-size: 0.88rem;">vue<sup>17</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" style="font-size: 0.88rem;">事件循环<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/" style="font-size: 0.88rem;">事件监听<sup>1</sup></a><a href="/tags/%E5%8F%AF%E8%A7%86%E5%8C%96/" style="font-size: 0.88rem;">可视化<sup>3</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 0.88rem;">后端<sup>1</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/" style="font-size: 0.88rem;">基本命令<sup>2</sup></a><a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 0.88rem;">存储<sup>1</sup></a><a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 0.88rem;">实战<sup>31</sup></a><a href="/tags/%E5%B8%83%E5%B1%80/" style="font-size: 0.88rem;">布局<sup>1</sup></a><a href="/tags/%E6%89%93%E5%8D%B0/" style="font-size: 0.88rem;">打印<sup>1</sup></a><a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">插件开发<sup>1</sup></a><a href="/tags/%E6%A8%AA%E7%AB%96%E5%B1%8F%E6%A3%80%E6%B5%8B/" style="font-size: 0.88rem;">横竖屏检测<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 0.88rem;">正则<sup>4</sup></a><a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 0.88rem;">浏览器<sup>5</sup></a><a href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/" style="font-size: 0.88rem;">盒模型<sup>1</sup></a><a href="/tags/%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/" style="font-size: 0.88rem;">组件通信<sup>2</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 0.88rem;">缓存<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">编程语言<sup>1</sup></a><a href="/tags/%E8%B7%AF%E7%94%B1/" style="font-size: 0.88rem;">路由<sup>1</sup></a><a href="/tags/%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size: 0.88rem;">过滤器<sup>3</sup></a><a href="/tags/%E9%9F%B3%E9%A2%91/" style="font-size: 0.88rem;">音频<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.7.1",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 寒霜 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>