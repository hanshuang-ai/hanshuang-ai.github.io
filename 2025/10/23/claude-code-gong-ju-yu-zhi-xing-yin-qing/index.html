<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="claude-code工具与执行引擎, 我的博客">
    <meta name="description" content="参考链接
Tools &amp;amp; The Execution Engine工具与执行引擎graph LR
    subgraph &#34;工具生命周期&#34;
        LLM[LLM决策] --&gt; ToolUse[工具使用块]
       ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>claude-code工具与执行引擎 | 我的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">我的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">我的博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">claude-code工具与执行引擎</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-10-23
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-10-24
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    38 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><a target="_blank" rel="noopener" href="https://southbridge-research.notion.site/Tools-The-Execution-Engine-2055fec70db181088a53cb43ae9168dc">参考链接</a></p>
<h1 id="Tools-amp-The-Execution-Engine"><a href="#Tools-amp-The-Execution-Engine" class="headerlink" title="Tools &amp; The Execution Engine"></a>Tools &amp; The Execution Engine</h1><h1 id="工具与执行引擎"><a href="#工具与执行引擎" class="headerlink" title="工具与执行引擎"></a>工具与执行引擎</h1><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LR
    <span class="token keyword">subgraph</span> <span class="token string">"工具生命周期"</span>
        LLM<span class="token text string">[LLM决策]</span> <span class="token arrow operator">--></span> ToolUse<span class="token text string">[工具使用块]</span>
        ToolUse <span class="token arrow operator">--></span> Validation<span class="token text string">&#123;输入验证&#125;</span>
        Validation <span class="token arrow operator">--></span><span class="token label property">|通过|</span> Permission<span class="token text string">&#123;权限检查&#125;</span>
        Validation <span class="token arrow operator">--></span><span class="token label property">|失败|</span> ErrorResult<span class="token text string">[错误结果]</span>

        Permission <span class="token arrow operator">--></span><span class="token label property">|允许|</span> Execute<span class="token text string">["工具调用()"]</span>
        Permission <span class="token arrow operator">--></span><span class="token label property">|拒绝|</span> ErrorResult
        Permission <span class="token arrow operator">--></span><span class="token label property">|询问|</span> UserPrompt<span class="token text string">[用户对话]</span>

        UserPrompt <span class="token arrow operator">--></span><span class="token label property">|允许|</span> Execute
        UserPrompt <span class="token arrow operator">--></span><span class="token label property">|拒绝|</span> ErrorResult

        Execute <span class="token arrow operator">--></span> Progress<span class="token text string">[产生进度]</span>
        Progress <span class="token arrow operator">--></span> Progress
        Progress <span class="token arrow operator">--></span> Result<span class="token text string">[产生结果]</span>

        Result <span class="token arrow operator">--></span> Transform<span class="token text string">[映射工具结果]</span>
        Transform <span class="token arrow operator">--></span> ToolResultBlock
        ErrorResult <span class="token arrow operator">--></span> ToolResultBlock

        ToolResultBlock <span class="token arrow operator">--></span> LLM
    <span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2025/10/23/claude-code-gong-ju-yu-zhi-xing-yin-qing/1.svg" class="">
<h2 id="The-Tool-Execution-Pipeline-Async-Generators-All-The-Way-Down"><a href="#The-Tool-Execution-Pipeline-Async-Generators-All-The-Way-Down" class="headerlink" title="The Tool Execution Pipeline: Async Generators All The Way Down"></a>The Tool Execution Pipeline: Async Generators All The Way Down</h2><h2 id="工具执行管道：异步生成器贯穿始终"><a href="#工具执行管道：异步生成器贯穿始终" class="headerlink" title="工具执行管道：异步生成器贯穿始终"></a>工具执行管道：异步生成器贯穿始终</h2><p>Claude Code工具系统最引人入胜的方面是在整个执行管道中使用异步生成器。这允许在保持清晰错误边界的同时进行流式进度更新：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 核心工具执行函数（重构）</span>
<span class="token comment">// The core tool execution function (reconstructed)</span>
<span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">executeTool</span><span class="token punctuation">(</span>
  toolUse<span class="token operator">:</span> ToolUseBlock<span class="token punctuation">,</span>
  toolDef<span class="token operator">:</span> ToolDefinition<span class="token punctuation">,</span>
  context<span class="token operator">:</span> ToolUseContext<span class="token punctuation">,</span>
  permissionFn<span class="token operator">:</span> PermissionGranter<span class="token punctuation">,</span>
  assistantMessage<span class="token operator">:</span> CliMessage
<span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>CliMessage<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 阶段1：使用Zod进行输入验证</span>
  <span class="token comment">// Phase 1: Input validation with Zod</span>
  <span class="token keyword">const</span> validationStart <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> validation <span class="token operator">=</span> toolDef<span class="token punctuation">.</span>inputSchema<span class="token punctuation">.</span><span class="token function">safeParse</span><span class="token punctuation">(</span>toolUse<span class="token punctuation">.</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validation<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 格式化Zod错误供LLM使用</span>
    <span class="token comment">// Format Zod errors for LLM consumption</span>
    <span class="token keyword">const</span> errorMessage <span class="token operator">=</span> <span class="token function">formatZodError</span><span class="token punctuation">(</span>validation<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token function">createToolResultMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      tool_use_id<span class="token operator">:</span> toolUse<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">输入验证失败：\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>errorMessage<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// Input validation failed:\n$&#123;errorMessage&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      is_error<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 阶段2：权限检查</span>
  <span class="token comment">// Phase 2: Permission check</span>
  <span class="token keyword">const</span> permissionResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">checkToolPermission</span><span class="token punctuation">(</span>
    toolDef<span class="token punctuation">,</span>
    validation<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
    context<span class="token punctuation">.</span><span class="token function">getToolPermissionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    permissionFn
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>permissionResult<span class="token punctuation">.</span>behavior <span class="token operator">===</span> <span class="token string">'deny'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token function">createToolResultMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      tool_use_id<span class="token operator">:</span> toolUse<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">权限被拒绝：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>permissionResult<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// Permission denied: $&#123;permissionResult.message&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      is_error<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>permissionResult<span class="token punctuation">.</span>behavior <span class="token operator">===</span> <span class="token string">'ask'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 为权限对话框生成UI事件</span>
    <span class="token comment">// Yield UI event for permission dialog</span>
    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'permission_request'</span><span class="token punctuation">,</span>
      toolName<span class="token operator">:</span> toolDef<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      input<span class="token operator">:</span> validation<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
      suggestions<span class="token operator">:</span> permissionResult<span class="token punctuation">.</span>ruleSuggestions
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待用户决定（由外层循环处理）</span>
    <span class="token comment">// Wait for user decision (handled by outer loop)</span>
    <span class="token keyword">const</span> decision <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">permissionFn</span><span class="token punctuation">(</span>
      toolDef<span class="token punctuation">,</span>
      validation<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
      permissionResult
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>decision<span class="token punctuation">.</span>allowed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token function">createToolResultMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        tool_use_id<span class="token operator">:</span> toolUse<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token string">'工具执行被用户取消'</span> <span class="token comment">// Tool execution cancelled by user</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        is_error<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 阶段3：带进度跟踪的工具执行</span>
  <span class="token comment">// Phase 3: Tool execution with progress tracking</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> executeStart <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> progressCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> finalResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用工具的异步生成器</span>
    <span class="token comment">// Call the tool's async generator</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> output <span class="token keyword">of</span> <span class="token function">toolDef</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
      validation<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
      context<span class="token punctuation">,</span>
      <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">// mcpContext - 按要求跳过</span>
      assistantMessage
    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>output<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'progress'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        progressCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
          uuid<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">progress-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>toolUse<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>progressCount<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          timestamp<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          progress<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            toolUseID<span class="token operator">:</span> toolUse<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            data<span class="token operator">:</span> output<span class="token punctuation">.</span>data
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>output<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'result'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        finalResult <span class="token operator">=</span> output<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 阶段4：结果转换</span>
    <span class="token comment">// Phase 4: Result transformation</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finalResult <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> toolDef<span class="token punctuation">.</span><span class="token function">mapToolResultToToolResultBlockParam</span><span class="token punctuation">(</span>
        finalResult<span class="token punctuation">,</span>
        toolUse<span class="token punctuation">.</span>id
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">yield</span> <span class="token function">createToolResultMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        tool_use_id<span class="token operator">:</span> toolUse<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        content<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">?</span> content <span class="token operator">:</span> <span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token punctuation">,</span>
        is_error<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        executionTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> executeStart
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 带有丰富上下文的错误处理</span>
    <span class="token comment">// Error handling with rich context</span>
    <span class="token keyword">yield</span> <span class="token function">createToolResultMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      tool_use_id<span class="token operator">:</span> toolUse<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token function">formatToolError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> toolDef<span class="token punctuation">)</span><span class="token punctuation">,</span>
      is_error<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Performance Characteristics</strong>:<br><strong>性能特征</strong>：</p>
<ul>
<li>Input validation: O(n) where n is input complexity, typically &lt;1ms<ul>
<li>输入验证：O(n)，其中n是输入复杂度，通常&lt;1ms</li>
</ul>
</li>
<li>Permission check: O(rules) + potential user interaction time<ul>
<li>权限检查：O(规则数) + 潜在的用户交互时间</li>
</ul>
</li>
<li>Tool execution: Varies wildly by tool (10ms to 30s)<ul>
<li>工具执行：因工具而异（10ms到30s）</li>
</ul>
</li>
<li>Result transformation: O(output size), typically &lt;5ms<ul>
<li>结果转换：O(输出大小)，通常&lt;5ms</li>
</ul>
</li>
</ul>
<h2 id="The-Shell-Parser-Claude-Code’s-Secret-Weapon"><a href="#The-Shell-Parser-Claude-Code’s-Secret-Weapon" class="headerlink" title="The Shell Parser: Claude Code’s Secret Weapon"></a>The Shell Parser: Claude Code’s Secret Weapon</h2><h2 id="Shell解析器：Claude-Code的秘密武器"><a href="#Shell解析器：Claude-Code的秘密武器" class="headerlink" title="Shell解析器：Claude Code的秘密武器"></a>Shell解析器：Claude Code的秘密武器</h2><p>One of the most innovative components is the custom shell parser that enables passing JavaScript objects through shell commands:<br>最创新的组件之一是自定义shell解析器，它支持通过shell命令传递JavaScript对象：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Shell解析器实现（从反编译重构）</span>
<span class="token comment">// The shell parser implementation (reconstructed from decompilation)</span>
<span class="token keyword">class</span> <span class="token class-name">ShellParser</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">OPERATORS</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\\|\\||&amp;&amp;|;;|\\|&amp;|\\||&lt;|>|>>|&amp;|\\(|\\))</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">SINGLE_QUOTE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^'([^']*)'$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">DOUBLE_QUOTE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^"([^"\\\\]*(\\\\.[^"\\\\]*)*)"$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

  <span class="token comment">// 魔术：用于对象嵌入的随机哨兵</span>
  <span class="token comment">// The magic: random sentinel for object embedding</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token constant">SENTINEL</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token function">parse</span><span class="token punctuation">(</span>
    command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">,</span>
    opts<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">any</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> ParsedCommand <span class="token punctuation">&#123;</span>
    <span class="token comment">// 阶段1：带对象序列化的变量扩展</span>
    <span class="token comment">// Phase 1: Variable expansion with object serialization</span>
    <span class="token keyword">const</span> expandedCommand <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandVariables</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段2：标记化</span>
    <span class="token comment">// Phase 2: Tokenization</span>
    <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tokenize</span><span class="token punctuation">(</span>expandedCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段3：如果提供了opts，进行对象重新水合</span>
    <span class="token comment">// Phase 3: Object rehydration if opts provided</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> opts <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> tokens<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>token <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isSerializedObject</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deserializeObject</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> tokens<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">expandVariables</span><span class="token punctuation">(</span>
    command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    env<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> command<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
      <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\$\\&#123;?(\\w+)\\&#125;?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>match<span class="token punctuation">,</span> varName<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> env<span class="token punctuation">[</span>varName<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 创新：使用哨兵序列化对象</span>
        <span class="token comment">// The innovation: serialize objects with sentinel</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SENTINEL</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SENTINEL</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>value <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">tokenize</span><span class="token punctuation">(</span>command<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> tokens<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> inSingleQuote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> inDoubleQuote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> escape <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> command<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> char <span class="token operator">=</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> next <span class="token operator">=</span> command<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 处理引号和转义字符</span>
      <span class="token comment">// Handle quotes and escapes</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>escape<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">"'"</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inDoubleQuote<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          inSingleQuote <span class="token operator">=</span> <span class="token operator">!</span>inSingleQuote<span class="token punctuation">;</span>
          current <span class="token operator">+=</span> char<span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'"'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inSingleQuote<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          inDoubleQuote <span class="token operator">=</span> <span class="token operator">!</span>inDoubleQuote<span class="token punctuation">;</span>
          current <span class="token operator">+=</span> char<span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\\\\'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          escape <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          current <span class="token operator">+=</span> char<span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        escape <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        current <span class="token operator">+=</span> char<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 在非引号内处理操作符</span>
      <span class="token comment">// Handle operators when not in quotes</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inSingleQuote <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inDoubleQuote<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> remaining <span class="token operator">=</span> command<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> operatorMatch <span class="token operator">=</span> remaining<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\\|\\||&amp;&amp;|;;|\\|&amp;|\\||&lt;|>|>>|&amp;|\\(|\\))</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>operatorMatch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            current <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>operatorMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          i <span class="token operator">+=</span> operatorMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 处理空白字符</span>
        <span class="token comment">// Handle whitespace</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\s</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            current <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

      current <span class="token operator">+=</span> char<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> tokens<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">isSerializedObject</span><span class="token punctuation">(</span>token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> token<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SENTINEL</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
           token<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SENTINEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">deserializeObject</span><span class="token punctuation">(</span>token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SENTINEL</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      <span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SENTINEL</span><span class="token punctuation">.</span>length
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> token<span class="token punctuation">;</span> <span class="token comment">// Fallback to string</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This parser enables commands like:<br>此解析器支持如下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Where $CONFIG is a JavaScript object</span>
<span class="token comment"># 其中$CONFIG是一个JavaScript对象</span>
mytool <span class="token parameter variable">--config</span><span class="token operator">=</span><span class="token variable">$CONFIG</span> <span class="token parameter variable">--name</span><span class="token operator">=</span><span class="token string">"test"</span>

<span class="token comment"># Becomes after parsing with rehydration:</span>
<span class="token comment"># 经过解析和重新水合后变成：</span>
<span class="token punctuation">[</span><span class="token string">'mytool'</span>, <span class="token string">'--config'</span>, <span class="token punctuation">&#123;</span>setting: true, values: <span class="token punctuation">[</span><span class="token number">1,2</span>,3<span class="token punctuation">]</span><span class="token punctuation">&#125;</span>, <span class="token string">'--name'</span>, <span class="token string">'test'</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Core-File-Operation-Tools"><a href="#Core-File-Operation-Tools" class="headerlink" title="Core File Operation Tools"></a>Core File Operation Tools</h2><h2 id="核心文件操作工具"><a href="#核心文件操作工具" class="headerlink" title="核心文件操作工具"></a>核心文件操作工具</h2><h3 id="ReadTool-The-Multimodal-File-Reader"><a href="#ReadTool-The-Multimodal-File-Reader" class="headerlink" title="ReadTool: The Multimodal File Reader"></a>ReadTool: The Multimodal File Reader</h3><h3 id="ReadTool：多模态文件读取器"><a href="#ReadTool：多模态文件读取器" class="headerlink" title="ReadTool：多模态文件读取器"></a>ReadTool：多模态文件读取器</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// ReadTool implementation (reconstructed)</span>
<span class="token comment">// ReadTool实现（重构）</span>
<span class="token keyword">const</span> ReadToolDefinition<span class="token operator">:</span> ToolDefinition <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">'ReadFileTool'</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> <span class="token string">'Read file contents with line numbers, supporting text and images'</span><span class="token punctuation">,</span>
  <span class="token comment">// description: '读取文件内容并支持行号，支持文本和图像',</span>

  inputSchema<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    file_path<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Absolute path to the file'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// file_path: z.string().describe('文件的绝对路径'),</span>
    offset<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Starting line number (1-based)'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// offset: z.number().optional().describe('起始行号（从1开始）'),</span>
    limit<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Maximum lines to read'</span><span class="token punctuation">)</span>
    <span class="token comment">// limit: z.number().optional().default(2000).describe('最大读取行数')</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  async <span class="token operator">*</span><span class="token function">call</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> offset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> limit <span class="token operator">=</span> <span class="token number">2000</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// 进度：开始读取</span>
    <span class="token comment">// Progress: Starting read</span>
    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reading </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查文件是否存在</span>
    <span class="token comment">// Check if file exists</span>
    <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stats<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">File not found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>file_path<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检测文件类型</span>
    <span class="token comment">// Detect file type</span>
    <span class="token class-name"><span class="token keyword">const</span></span> mimeType <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">detectMimeType</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mimeType<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'image/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 处理图像文件</span>
      <span class="token comment">// Handle image files</span>
      <span class="token keyword">const</span> imageData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readImage</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> imageData <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.ipynb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 处理Jupyter笔记本</span>
      <span class="token comment">// Handle Jupyter notebooks</span>
      <span class="token keyword">const</span> notebookData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readNotebook</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> notebookData <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 使用流处理文本文件</span>
    <span class="token comment">// Handle text files with streaming</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新文件缓存</span>
    <span class="token comment">// Update file cache</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> content<span class="token punctuation">.</span>fullContent<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> stats<span class="token punctuation">.</span>mtimeMs
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> content <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token keyword">async</span> <span class="token function">readTextFile</span><span class="token punctuation">(</span>filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> limit<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf8'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lines<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> lineNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> truncated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> chunkLines <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> line <span class="token keyword">of</span> chunkLines<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lineNumber<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lineNumber <span class="token operator">>=</span> offset <span class="token operator">&amp;&amp;</span> lines<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// 截断长行</span>
          <span class="token comment">// Truncate long lines</span>
          <span class="token keyword">const</span> truncatedLine <span class="token operator">=</span> line<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">2000</span>
            <span class="token operator">?</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'... (truncated)'</span>
            <span class="token operator">:</span> line<span class="token punctuation">;</span>

          <span class="token comment">// 使用行号格式化（cat -n风格）</span>
          <span class="token comment">// Format with line numbers (cat -n style)</span>
          lines<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>lineNumber<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>truncatedLine<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lines<span class="token punctuation">.</span>length <span class="token operator">>=</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          truncated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          stream<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      formattedContent<span class="token operator">:</span> lines<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      fullContent<span class="token operator">:</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      lineCount<span class="token operator">:</span> lineNumber<span class="token punctuation">,</span>
      truncated
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token keyword">async</span> <span class="token function">readImage</span><span class="token punctuation">(</span>filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> context<span class="token operator">:</span> ToolUseContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> metadata <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sharp</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果太大则调整大小</span>
    <span class="token comment">// Resize if too large</span>
    <span class="token keyword">let</span> processedBuffer <span class="token operator">=</span> buffer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>width <span class="token operator">></span> <span class="token number">1024</span> <span class="token operator">||</span> metadata<span class="token punctuation">.</span>height <span class="token operator">></span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      processedBuffer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sharp</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
          fit<span class="token operator">:</span> <span class="token string">'inside'</span><span class="token punctuation">,</span>
          withoutEnlargement<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">toBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
      mimeType<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">image/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>metadata<span class="token punctuation">.</span>format<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      base64<span class="token operator">:</span> processedBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      dimensions<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        original<span class="token operator">:</span> <span class="token punctuation">&#123;</span> width<span class="token operator">:</span> metadata<span class="token punctuation">.</span>width<span class="token punctuation">,</span> height<span class="token operator">:</span> metadata<span class="token punctuation">.</span>height <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        processed<span class="token operator">:</span> <span class="token punctuation">&#123;</span> width<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token number">1024</span> <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">mapToolResultToToolResultBlockParam</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> toolUseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'image'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'base64'</span><span class="token punctuation">,</span>
          media_type<span class="token operator">:</span> result<span class="token punctuation">.</span>mimeType<span class="token punctuation">,</span>
          data<span class="token operator">:</span> result<span class="token punctuation">.</span>base64
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 空文件处理</span>
    <span class="token comment">// Empty file handling</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>formattedContent <span class="token operator">||</span> result<span class="token punctuation">.</span>formattedContent<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
        text<span class="token operator">:</span> <span class="token string">'&lt;system-reminder>Warning: the file exists but the contents are empty.&lt;/system-reminder>'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 正常文本结果</span>
    <span class="token comment">// Normal text result</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
      text<span class="token operator">:</span> result<span class="token punctuation">.</span>formattedContent <span class="token operator">+</span>
            <span class="token punctuation">(</span>result<span class="token punctuation">.</span>truncated <span class="token operator">?</span> <span class="token string">'\\n... (content truncated)'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  isReadOnly<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Performance Profile</strong>:<br><strong>性能分析</strong>：</p>
<table>
<thead>
<tr>
<th>File Size</th>
<th>Read Time</th>
<th>Memory Usage</th>
<th>Bottleneck</th>
</tr>
</thead>
<tbody><tr>
<td>&lt;1MB</td>
<td>&lt;10ms</td>
<td>O(file)</td>
<td>Disk I/O</td>
</tr>
<tr>
<td>&lt;1MB</td>
<td>&lt;10ms</td>
<td>O(文件)</td>
<td>磁盘I/O</td>
</tr>
<tr>
<td>1-10MB</td>
<td>10-50ms</td>
<td>O(file)</td>
<td>Memory allocation</td>
</tr>
<tr>
<td>1-10MB</td>
<td>10-50ms</td>
<td>O(文件)</td>
<td>内存分配</td>
</tr>
<tr>
<td>10-100MB</td>
<td>50-500ms</td>
<td>O(limit)</td>
<td>Line processing</td>
</tr>
<tr>
<td>10-100MB</td>
<td>50-500ms</td>
<td>O(限制)</td>
<td>行处理</td>
</tr>
<tr>
<td>&gt;100MB</td>
<td>500ms+</td>
<td>O(limit)</td>
<td>Streaming chunks</td>
</tr>
<tr>
<td>&gt;100MB</td>
<td>500ms+</td>
<td>O(限制)</td>
<td>流式块处理</td>
</tr>
</tbody></table>
<h3 id="EditTool-Surgical-File-Modifications"><a href="#EditTool-Surgical-File-Modifications" class="headerlink" title="EditTool: Surgical File Modifications"></a>EditTool: Surgical File Modifications</h3><h3 id="EditTool：精准文件修改"><a href="#EditTool：精准文件修改" class="headerlink" title="EditTool：精准文件修改"></a>EditTool：精准文件修改</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// EditTool implementation with validation pipeline</span>
<span class="token comment">// 带验证管道的EditTool实现</span>
<span class="token keyword">const</span> EditToolDefinition<span class="token operator">:</span> ToolDefinition <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">'EditFileTool'</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> <span class="token string">'Perform exact string replacement in files with validation'</span><span class="token punctuation">,</span>
  <span class="token comment">// description: '在文件中执行精确字符串替换并进行验证',</span>

  inputSchema<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    file_path<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    old_string<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    new_string<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    expected_replacements<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// expected_replacements: z.number().optional().default(1) // 期望替换次数</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  async <span class="token operator">*</span><span class="token function">call</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> old_string<span class="token punctuation">,</span> new_string<span class="token punctuation">,</span> expected_replacements <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// Validation 1: File was read</span>
    <span class="token comment">// 验证1：文件已被读取</span>
    <span class="token keyword">const</span> cachedFile <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'File must be read with ReadFileTool before editing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// throw new Error('编辑前必须使用ReadFileTool读取文件');</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Validation 2: File hasn't changed</span>
    <span class="token comment">// 验证2：文件未被修改</span>
    <span class="token keyword">const</span> currentStats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cachedFile<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'File has been modified externally since last read'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// throw new Error('文件自上次读取以来已被外部修改');</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Validation 3: No-op check</span>
    <span class="token comment">// 验证3：无操作检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>old_string <span class="token operator">===</span> new_string<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'old_string and new_string cannot be identical'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// throw new Error('old_string和new_string不能相同');</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">'Validating edit...'</span> <span class="token punctuation">&#125;</span>
      <span class="token comment">// data: &#123; status: '正在验证编辑...' &#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Count occurrences</span>
    <span class="token comment">// 计算出现次数</span>
    <span class="token keyword">const</span> occurrences <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countOccurrences</span><span class="token punctuation">(</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      old_string
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">old_string not found in file</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">!==</span> expected_replacements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>expected_replacements<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> replacements but found </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>occurrences<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Perform replacement</span>
    <span class="token keyword">const</span> newContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performReplacement</span><span class="token punctuation">(</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      old_string<span class="token punctuation">,</span>
      new_string<span class="token punctuation">,</span>
      expected_replacements
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Generate diff for preview</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      newContent<span class="token punctuation">,</span>
      file_path
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        status<span class="token operator">:</span> <span class="token string">'Applying edit...'</span><span class="token punctuation">,</span>
        preview<span class="token operator">:</span> diff
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Write file</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFileWithBackup</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> newContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update cache</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> newContent<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Generate result snippet</span>
    <span class="token keyword">const</span> snippet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getContextSnippet</span><span class="token punctuation">(</span>
      newContent<span class="token punctuation">,</span>
      new_string<span class="token punctuation">,</span>
      <span class="token number">5</span> <span class="token comment">// lines of context</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        diff<span class="token punctuation">,</span>
        snippet<span class="token punctuation">,</span>
        replacements<span class="token operator">:</span> expected_replacements
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">countOccurrences</span><span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> searchString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Escape special regex characters</span>
    <span class="token keyword">const</span> escaped <span class="token operator">=</span> searchString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[.*+?^$&#123;&#125;()|[\\]\\\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\\\$&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>escaped<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">performReplacement</span><span class="token punctuation">(</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    oldString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    limit<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Special handling for certain characters during replacement</span>
    <span class="token keyword">const</span> tempOld <span class="token operator">=</span> oldString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$$$$'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tempNew <span class="token operator">=</span> newString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$$$$'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>oldString<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">+</span>
               newString <span class="token operator">+</span>
               result<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> oldString<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      lastIndex <span class="token operator">=</span> index <span class="token operator">+</span> newString<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">mapToolResultToToolResultBlockParam</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> toolUseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
      text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Successfully edited file. </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>replacements<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> replacement(s) made.\\n\\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Preview of changes:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>snippet<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  isReadOnly<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="MultiEditTool-Atomic-Sequential-Edits"><a href="#MultiEditTool-Atomic-Sequential-Edits" class="headerlink" title="MultiEditTool: Atomic Sequential Edits"></a>MultiEditTool: Atomic Sequential Edits</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// MultiEditTool - Complex sequential edit orchestration</span>
<span class="token keyword">const</span> MultiEditToolDefinition<span class="token operator">:</span> ToolDefinition <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">'MultiEditFileTool'</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> <span class="token string">'Apply multiple edits to a file atomically'</span><span class="token punctuation">,</span>

  inputSchema<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    file_path<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    edits<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      old_string<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      new_string<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      expected_replacements<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  async <span class="token operator">*</span><span class="token function">call</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> edits <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// Load file content</span>
    <span class="token keyword">const</span> cachedFile <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'File must be read before editing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        status<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Planning </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>edits<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> edits...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        editCount<span class="token operator">:</span> edits<span class="token punctuation">.</span>length
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Simulate all edits to check for conflicts</span>
    <span class="token keyword">let</span> workingContent <span class="token operator">=</span> cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token keyword">const</span> editResults <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> edit <span class="token operator">=</span> edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
        toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          status<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Validating edit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>edits<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          currentEdit<span class="token operator">:</span> i <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

      <span class="token comment">// Check if this edit would work</span>
      <span class="token keyword">const</span> occurrences <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countOccurrences</span><span class="token punctuation">(</span>
        workingContent<span class="token punctuation">,</span>
        edit<span class="token punctuation">.</span>old_string
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Edit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: old_string not found. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">This may be due to previous edits modifying the text.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">!==</span> edit<span class="token punctuation">.</span>expected_replacements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Edit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: Expected </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>edit<span class="token punctuation">.</span>expected_replacements<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">replacements but found </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>occurrences<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// Apply edit to working copy</span>
      workingContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performReplacement</span><span class="token punctuation">(</span>
        workingContent<span class="token punctuation">,</span>
        edit<span class="token punctuation">.</span>old_string<span class="token punctuation">,</span>
        edit<span class="token punctuation">.</span>new_string<span class="token punctuation">,</span>
        edit<span class="token punctuation">.</span>expected_replacements
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      editResults<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        index<span class="token operator">:</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
        summary<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">summarizeEdit</span><span class="token punctuation">(</span>edit<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// All edits validated - now apply atomically</span>
    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">'Applying all edits...'</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFileWithBackup</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> workingContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update cache</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> workingContent<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        editsApplied<span class="token operator">:</span> editResults<span class="token punctuation">,</span>
        finalContent<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFileSnippet</span><span class="token punctuation">(</span>workingContent<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token comment">// Conflict detection for edit sequences</span>
  <span class="token function">detectEditConflicts</span><span class="token punctuation">(</span>edits<span class="token operator">:</span> EditSequence<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> ConflictReport <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> conflicts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Check if edit j's old_string contains edit i's new_string</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>edits<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>old_string<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>new_string<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conflicts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            edit1<span class="token operator">:</span> i<span class="token punctuation">,</span>
            edit2<span class="token operator">:</span> j<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'dependency'</span><span class="token punctuation">,</span>
            message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Edit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> depends on result of edit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Check for overlapping regions</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">editsOverlap</span><span class="token punctuation">(</span>edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> edits<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conflicts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            edit1<span class="token operator">:</span> i<span class="token punctuation">,</span>
            edit2<span class="token operator">:</span> j<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'overlap'</span><span class="token punctuation">,</span>
            message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Edits </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> may affect same region</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> conflicts<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  isReadOnly<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="The-BashTool-Power-and-Responsibility"><a href="#The-BashTool-Power-and-Responsibility" class="headerlink" title="The BashTool: Power and Responsibility"></a>The BashTool: Power and Responsibility</h2><p>The BashTool is perhaps the most complex tool, implementing multiple safety layers:</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// BashTool implementation with sandbox support</span>
<span class="token keyword">const</span> BashToolDefinition<span class="token operator">:</span> ToolDefinition <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">'BashTool'</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> <span class="token string">'Execute shell commands with streaming output'</span><span class="token punctuation">,</span>

  inputSchema<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    command<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    sandbox<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">boolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    shellExecutable<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">// Complex permission checking for commands</span>
  <span class="token keyword">async</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">,</span> permContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> command<span class="token punctuation">,</span> sandbox <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// Extract command components</span>
    <span class="token keyword">const</span> parsed <span class="token operator">=</span> ShellParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> baseCommand <span class="token operator">=</span> parsed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Forbidden commands check</span>
    <span class="token keyword">const</span> <span class="token constant">FORBIDDEN</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'find'</span><span class="token punctuation">,</span> <span class="token string">'grep'</span><span class="token punctuation">,</span> <span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token string">'head'</span><span class="token punctuation">,</span> <span class="token string">'tail'</span><span class="token punctuation">,</span> <span class="token string">'ls'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>baseCommand<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>permContext<span class="token punctuation">.</span>mode<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'bypass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        behavior<span class="token operator">:</span> <span class="token string">'deny'</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Use dedicated tools instead of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>baseCommand<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Dangerous commands require explicit permission</span>
    <span class="token keyword">const</span> <span class="token constant">DANGEROUS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'rm'</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">,</span> <span class="token string">'mkfs'</span><span class="token punctuation">,</span> <span class="token string">'fdisk'</span><span class="token punctuation">,</span> <span class="token string">'kill'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DANGEROUS</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>cmd <span class="token operator">=></span> command<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        behavior<span class="token operator">:</span> <span class="token string">'ask'</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">'This command could be dangerous'</span><span class="token punctuation">,</span>
        ruleSuggestions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">BashTool(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>baseCommand<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/*)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Sandbox mode analysis</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sandbox <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Commands that work in sandbox</span>
      <span class="token keyword">const</span> <span class="token constant">SANDBOX_SAFE</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'echo'</span><span class="token punctuation">,</span> <span class="token string">'pwd'</span><span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token string">'which'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SANDBOX_SAFE</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>baseCommand<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> behavior<span class="token operator">:</span> <span class="token string">'allow'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Default permission check</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">checkPermissions</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">,</span> permContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  async <span class="token operator">*</span><span class="token function">call</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> command<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> sandbox <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        status<span class="token operator">:</span> <span class="token string">'Preparing command execution...'</span><span class="token punctuation">,</span>
        command<span class="token operator">:</span> command<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        sandbox
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Prepare execution environment</span>
    <span class="token keyword">const</span> execOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      cwd<span class="token operator">:</span> context<span class="token punctuation">.</span>cwd<span class="token punctuation">,</span>
      env<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>process<span class="token punctuation">.</span>env<span class="token punctuation">,</span> <span class="token constant">CLAUDE_CODE</span><span class="token operator">:</span> <span class="token string">'true'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      timeout<span class="token punctuation">,</span>
      maxBuffer<span class="token operator">:</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment">// 10MB</span>
      killSignal<span class="token operator">:</span> <span class="token string">'SIGTERM'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sandbox <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'darwin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// macOS sandbox-exec</span>
      <span class="token keyword">const</span> profile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSandboxProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> sandboxedCommand <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sandbox-exec -p '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>profile<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">' </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>command<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeCommand</span><span class="token punctuation">(</span>sandboxedCommand<span class="token punctuation">,</span> execOptions<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeCommand</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> execOptions<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  async <span class="token operator">*</span><span class="token function">executeCommand</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> options<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'bash'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-c'</span><span class="token punctuation">,</span> command<span class="token punctuation">]</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> stdout <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> stderr <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> outputSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MAX_OUTPUT</span> <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 1MB limit</span>

    <span class="token comment">// Stream stdout</span>
    child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> text <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stdout <span class="token operator">+=</span> text<span class="token punctuation">;</span>
      outputSize <span class="token operator">+=</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>outputSize <span class="token operator">&lt;</span> <span class="token constant">MAX_OUTPUT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Yield progress with streaming output</span>
        context<span class="token punctuation">.</span><span class="token function">yieldProgress</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'stdout'</span><span class="token punctuation">,</span>
          data<span class="token operator">:</span> text<span class="token punctuation">,</span>
          partial<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Stream stderr</span>
    child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> text <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stderr <span class="token operator">+=</span> text<span class="token punctuation">;</span>
      outputSize <span class="token operator">+=</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>outputSize <span class="token operator">&lt;</span> <span class="token constant">MAX_OUTPUT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        context<span class="token punctuation">.</span><span class="token function">yieldProgress</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'stderr'</span><span class="token punctuation">,</span>
          data<span class="token operator">:</span> text<span class="token punctuation">,</span>
          partial<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Handle process completion</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>

      child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> signal<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          exitCode<span class="token operator">:</span> code<span class="token punctuation">,</span>
          signal<span class="token punctuation">,</span>
          stdout<span class="token operator">:</span> stdout<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_OUTPUT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          stderr<span class="token operator">:</span> stderr<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_OUTPUT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          truncated<span class="token operator">:</span> outputSize <span class="token operator">></span> <span class="token constant">MAX_OUTPUT</span><span class="token punctuation">,</span>
          duration<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Handle abort signal</span>
      context<span class="token punctuation">.</span>abortController<span class="token punctuation">.</span>signal<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        child<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">'SIGTERM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> result
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">generateSandboxProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Restrictive sandbox profile for macOS</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      (version 1)
      (deny default)
      (allow process-exec (literal "/bin/bash"))
      (allow process-exec (literal "/usr/bin/env"))
      (allow file-read*)
      (deny file-write*)
      (deny network*)
      (allow sysctl-read)
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token comment">// Git workflow automation</span>
  async <span class="token operator">*</span><span class="token function">handleGitCommit</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Phase 1: Parallel information gathering</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>status<span class="token punctuation">,</span> diff<span class="token punctuation">,</span> log<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'git status --porcelain'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'git diff --cached'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'git log -5 --oneline'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        status<span class="token operator">:</span> <span class="token string">'Analyzing changes...'</span><span class="token punctuation">,</span>
        files<span class="token operator">:</span> status<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 2: Generate commit message</span>
    <span class="token keyword">const</span> commitAnalysis <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyzeChangesForCommit</span><span class="token punctuation">(</span>
      status<span class="token punctuation">,</span>
      diff<span class="token punctuation">,</span>
      context
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 3: Execute commit with HEREDOC</span>
    <span class="token keyword">const</span> commitCommand <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git commit -m "$(cat &lt;&lt;'EOF'
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>commitAnalysis<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

Co-authored-by: Claude &lt;claude@anthropic.com>
EOF
)"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeCommand</span><span class="token punctuation">(</span>commitCommand<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">mapToolResultToToolResultBlockParam</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> toolUseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stdout:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>stdout<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stderr:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>stderr<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Exit code: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>exitCode<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>truncated<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'\\n(Output truncated due to size limits)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
      text<span class="token operator">:</span> output<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n\\n'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  isReadOnly<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Sandbox Mode Decision Tree</strong>:</p>
<pre class="line-numbers language-none"><code class="language-none">Command Analysis
├─ Is it a read operation? (ls, cat, grep)
│  └─ Yes → sandbox&#x3D;true ✓
├─ Does it need network? (curl, wget, git)
│  └─ Yes → sandbox&#x3D;false ✓
├─ Does it write files? (touch, echo &gt;)
│  └─ Yes → sandbox&#x3D;false ✓
├─ Is it a build command? (npm, make, cargo)
│  └─ Yes → sandbox&#x3D;false ✓
└─ Default → sandbox&#x3D;true (safe default)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Search-and-Discovery-Tools"><a href="#Search-and-Discovery-Tools" class="headerlink" title="Search and Discovery Tools"></a>Search and Discovery Tools</h2><h3 id="GrepTool-High-Performance-Content-Search"><a href="#GrepTool-High-Performance-Content-Search" class="headerlink" title="GrepTool: High-Performance Content Search"></a>GrepTool: High-Performance Content Search</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// GrepTool with optimization strategies</span>
<span class="token keyword">const</span> GrepToolDefinition<span class="token operator">:</span> ToolDefinition <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">'GrepTool'</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> <span class="token string">'Fast regex search across files'</span><span class="token punctuation">,</span>

  inputSchema<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    regex<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    include_pattern<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  async <span class="token operator">*</span><span class="token function">call</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> regex<span class="token punctuation">,</span> path<span class="token punctuation">,</span> include_pattern <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// Validate regex</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid regex: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>e<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">'Searching files...'</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Use ripgrep for performance</span>
    <span class="token keyword">const</span> rgCommand <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildRipgrepCommand</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> path<span class="token punctuation">,</span> include_pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> matches <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeRipgrep</span><span class="token punctuation">(</span>rgCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Group by file and limit results</span>
    <span class="token keyword">const</span> fileGroups <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">groupMatchesByFile</span><span class="token punctuation">(</span>matches<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> topFiles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">selectTopFiles</span><span class="token punctuation">(</span>fileGroups<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Top 20 files</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        matchCount<span class="token operator">:</span> matches<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        fileCount<span class="token operator">:</span> fileGroups<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        files<span class="token operator">:</span> topFiles
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">buildRipgrepCommand</span><span class="token punctuation">(</span>regex<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> includePattern<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'rg'</span><span class="token punctuation">,</span>
      <span class="token string">'--files-with-matches'</span><span class="token punctuation">,</span>
      <span class="token string">'--sort=modified'</span><span class="token punctuation">,</span>
      <span class="token string">'--max-count=10'</span><span class="token punctuation">,</span> <span class="token comment">// Limit matches per file</span>
      <span class="token string">'-e'</span><span class="token punctuation">,</span> regex<span class="token punctuation">,</span>
      path
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>includePattern<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'--glob'</span><span class="token punctuation">,</span> includePattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Ignore common non-text files</span>
    <span class="token keyword">const</span> ignorePatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'*.jpg'</span><span class="token punctuation">,</span> <span class="token string">'*.png'</span><span class="token punctuation">,</span> <span class="token string">'*.gif'</span><span class="token punctuation">,</span>
      <span class="token string">'*.mp4'</span><span class="token punctuation">,</span> <span class="token string">'*.mov'</span><span class="token punctuation">,</span>
      <span class="token string">'*.zip'</span><span class="token punctuation">,</span> <span class="token string">'*.tar'</span><span class="token punctuation">,</span> <span class="token string">'*.gz'</span><span class="token punctuation">,</span>
      <span class="token string">'node_modules'</span><span class="token punctuation">,</span> <span class="token string">'.git'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    ignorePatterns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>pattern <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'--glob'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">!</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>pattern<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  isReadOnly<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="AgentTool-Hierarchical-Task-Decomposition"><a href="#AgentTool-Hierarchical-Task-Decomposition" class="headerlink" title="AgentTool: Hierarchical Task Decomposition"></a>AgentTool: Hierarchical Task Decomposition</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// AgentTool - The most sophisticated tool</span>
<span class="token keyword">const</span> AgentToolDefinition<span class="token operator">:</span> ToolDefinition <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">'AgentTool'</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> <span class="token string">'Launch sub-agents for complex tasks'</span><span class="token punctuation">,</span>

  inputSchema<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    description<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    prompt<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    parallelTasksCount<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    model<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  async <span class="token operator">*</span><span class="token function">call</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">,</span> mcpContext<span class="token punctuation">,</span> assistantMessage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> prompt<span class="token punctuation">,</span> parallelTasksCount<span class="token punctuation">,</span> model <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
      toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        status<span class="token operator">:</span> <span class="token string">'Analyzing task complexity...'</span><span class="token punctuation">,</span>
        parallel<span class="token operator">:</span> parallelTasksCount <span class="token operator">></span> <span class="token number">1</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Prepare sub-agent configuration</span>
    <span class="token keyword">const</span> subAgentConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      tools<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filterToolsForSubAgent</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>tools<span class="token punctuation">)</span><span class="token punctuation">,</span>
      model<span class="token operator">:</span> model <span class="token operator">||</span> <span class="token string">'claude-3-haiku-20240307'</span><span class="token punctuation">,</span> <span class="token comment">// Fast model default</span>
      maxTokens<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateTokenBudget</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">,</span>
      systemPrompt<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildSubAgentPrompt</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Execute sub-agents</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeSubAgents</span><span class="token punctuation">(</span>
      prompt<span class="token punctuation">,</span>
      parallelTasksCount<span class="token punctuation">,</span>
      subAgentConfig<span class="token punctuation">,</span>
      context
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Report progress</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> result <span class="token keyword">of</span> results<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
        toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          status<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Sub-agent </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>index<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> complete</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          tokensUsed<span class="token operator">:</span> result<span class="token punctuation">.</span>usage<span class="token punctuation">.</span>total_tokens
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Synthesis phase</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span>
        toolUseID<span class="token operator">:</span> context<span class="token punctuation">.</span>currentToolUseId<span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">'Synthesizing results...'</span> <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> synthesized <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">synthesizeResults</span><span class="token punctuation">(</span>
        results<span class="token punctuation">,</span>
        prompt<span class="token punctuation">,</span>
        context
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> synthesized <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">filterToolsForSubAgent</span><span class="token punctuation">(</span>allTools<span class="token operator">:</span> ToolDefinition<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> ToolDefinition<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Prevent infinite recursion</span>
    <span class="token keyword">return</span> allTools<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>tool <span class="token operator">=></span>
      tool<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'AgentTool'</span> <span class="token operator">&amp;&amp;</span>
      tool<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'UpdateTodoTool'</span> <span class="token comment">// Sub-agents don't manage todos</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token keyword">async</span> <span class="token function">executeSubAgents</span><span class="token punctuation">(</span>
    prompt<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    count<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
    config<span class="token operator">:</span> SubAgentConfig<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>SubAgentResult<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Split task if parallel</span>
    <span class="token keyword">const</span> subtasks <span class="token operator">=</span> count <span class="token operator">></span> <span class="token number">1</span>
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">splitTask</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token punctuation">[</span>prompt<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Create abort controllers linked to parent</span>
    <span class="token keyword">const</span> subControllers <span class="token operator">=</span> subtasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createLinkedAbortController</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>abortController<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Execute in parallel with concurrency limit</span>
    <span class="token keyword">const</span> executions <span class="token operator">=</span> subtasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runSubAgent</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        task<span class="token punctuation">,</span>
        index<span class="token punctuation">,</span>
        config<span class="token punctuation">,</span>
        controller<span class="token operator">:</span> subControllers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
        sharedState<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          readFileState<span class="token operator">:</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">,</span> <span class="token comment">// Shared cache</span>
          permissionContext<span class="token operator">:</span> context<span class="token punctuation">.</span><span class="token function">getToolPermissionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Use parallelMap for controlled concurrency</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> result <span class="token keyword">of</span> <span class="token function">parallelMap</span><span class="token punctuation">(</span>executions<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> results<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token keyword">async</span> <span class="token function">synthesizeResults</span><span class="token punctuation">(</span>
    results<span class="token operator">:</span> SubAgentResult<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    originalPrompt<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> synthesisPrompt <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
You are a synthesis agent. Multiple sub-agents have completed investigations.
Synthesize their findings into a single, cohesive response.

Original task: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>originalPrompt<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
Sub-agent </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> findings:
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>r<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

Tokens used: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>r<span class="token punctuation">.</span>usage<span class="token punctuation">.</span>total_tokens<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
Tools used: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>r<span class="token punctuation">.</span>toolsUsed<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'None'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n---\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

Provide a unified response that combines all findings.
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Use fast model for synthesis</span>
    <span class="token keyword">const</span> synthesizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubAgentExecutor</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      prompt<span class="token operator">:</span> synthesisPrompt<span class="token punctuation">,</span>
      model<span class="token operator">:</span> <span class="token string">'claude-3-haiku-20240307'</span><span class="token punctuation">,</span>
      isSynthesis<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      maxTokens<span class="token operator">:</span> <span class="token number">2000</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> synthesizer<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">calculateTokenBudget</span><span class="token punctuation">(</span>prompt<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Heuristic: longer prompts get more tokens</span>
    <span class="token keyword">const</span> baseTokens <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> promptComplexity <span class="token operator">=</span> prompt<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> multiplier <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>promptComplexity <span class="token operator">/</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>baseTokens <span class="token operator">*</span> multiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token function">mapToolResultToToolResultBlockParam</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> toolUseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
      text<span class="token operator">:</span> result <span class="token comment">// Already formatted by synthesis</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  isReadOnly<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// Sub-agents inherit parent permissions</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Tool-Selection-amp-LLM-Engineering"><a href="#Tool-Selection-amp-LLM-Engineering" class="headerlink" title="Tool Selection &amp; LLM Engineering"></a>Tool Selection &amp; LLM Engineering</h2><p>The LLM receives extensive instructions for tool usage:</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Tool instruction compiler (reconstructed)</span>
<span class="token keyword">class</span> <span class="token class-name">ToolInstructionCompiler</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token function">compileSystemPrompt</span><span class="token punctuation">(</span>tools<span class="token operator">:</span> ToolDefinition<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
## Available Tools

You have access to the following tools:

</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tools<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>tool <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
### </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>description<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>prompt <span class="token operator">||</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

Input Schema:
\\</span><span class="token template-punctuation string">`</span></span>\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\</span><span class="token template-punctuation string">`</span></span>json
$<span class="token punctuation">&#123;</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tool<span class="token punctuation">.</span>inputJSONSchema <span class="token operator">||</span> <span class="token function">zodToJsonSchema</span><span class="token punctuation">(</span>tool<span class="token punctuation">.</span>inputSchema<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\</span><span class="token template-punctuation string">`</span></span>\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">

</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getToolSpecificInstructions</span><span class="token punctuation">(</span>tool<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n---\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

## Tool Usage Guidelines
## 工具使用指南

1. **Batching**: You can call multiple tools in a single response. When multiple independent pieces of information are requested, batch your tool calls together.
   **批处理**：您可以在单个响应中调用多个工具。当请求多个独立信息时，将您的工具调用批处理在一起。

2. **Read Before Write**: ALWAYS use ReadFileTool before EditFileTool or WriteFileTool.
   **先读后写**：在EditFileTool或WriteFileTool之前，始终使用ReadFileTool。

3. **Prefer Specialized Tools**:
   **优先使用专用工具**：
   - Use GrepTool instead of BashTool with grep
     - 使用GrepTool代替带grep的BashTool
   - Use ReadFileTool instead of BashTool with cat
     - 使用ReadFileTool代替带cat的BashTool
   - Use GlobTool instead of BashTool with find
     - 使用GlobTool代替带find的BashTool

4. **Safety First**:
   **安全第一**：
   - Never use BashTool for destructive commands without explicit user request
     - 未经用户明确请求，切勿将BashTool用于破坏性命令
   - Use sandbox=true for BashTool when possible
     - 尽可能为BashTool使用sandbox=true
   - Validate paths are within project boundaries
     - 验证路径在项目边界内

5. **Progress Communication**:
   **进度沟通**：
   - Tool execution may take time
     - 工具执行可能需要时间
   - Users see progress updates
     - 用户可以看到进度更新
   - Be patient with long-running tools
     - 对长时间运行的工具要有耐心

6. **Error Handling**:
   **错误处理**：
   - Tools may fail - have a backup plan
     - 工具可能失败 - 要有备用计划
   - Read error messages carefully
     - 仔细阅读错误消息
   - Suggest fixes based on error details
     - 根据错误细节建议修复方案
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">static</span> <span class="token function">getToolSpecificInstructions</span><span class="token punctuation">(</span>tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> instructions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">'BashTool'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
CRITICAL:
- Forbidden commands: find, grep, cat, head, tail, ls (use dedicated tools)
- Always use ripgrep (rg) instead of grep
- For git operations, follow the structured workflow
- Set sandbox=false only when necessary
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>

      <span class="token string-property property">'EditFileTool'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
CRITICAL:
- The old_string MUST NOT include line number prefixes from ReadFileTool
- Preserve exact indentation and whitespace
- Verify expected_replacements matches actual occurrences
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>

      <span class="token string-property property">'AgentTool'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
When to use:
- Complex searches across multiple files
- Tasks requiring multiple steps
- Open-ended investigations

When NOT to use:
- Simple file reads (use ReadFileTool)
- Specific pattern searches (use GrepTool)
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>

      <span class="token string-property property">'UpdateTodoTool'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
ALWAYS use this tool when:
- Starting a complex task (3+ steps)
- User provides multiple tasks
- Completing any task

Mark tasks complete IMMEDIATELY after finishing them.
Only have ONE task in_progress at a time.
      </span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> instructions<span class="token punctuation">[</span>tool<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Performance-amp-Safety-Patterns"><a href="#Performance-amp-Safety-Patterns" class="headerlink" title="Performance &amp; Safety Patterns"></a>Performance &amp; Safety Patterns</h2><h2 id="性能与安全模式"><a href="#性能与安全模式" class="headerlink" title="性能与安全模式"></a>性能与安全模式</h2><h3 id="Tool-Performance-Characteristics"><a href="#Tool-Performance-Characteristics" class="headerlink" title="Tool Performance Characteristics"></a>Tool Performance Characteristics</h3><h3 id="工具性能特征"><a href="#工具性能特征" class="headerlink" title="工具性能特征"></a>工具性能特征</h3><table>
<thead>
<tr>
<th>Tool</th>
<th>Latency</th>
<th>Memory</th>
<th>CPU</th>
<th>I/O</th>
<th>Parallelizable</th>
</tr>
</thead>
<tbody><tr>
<td>Tool</td>
<td>工具</td>
<td>Latency</td>
<td>Memory</td>
<td>CPU</td>
<td>I/O</td>
</tr>
<tr>
<td>ReadTool</td>
<td>ReadTool</td>
<td>10-50ms</td>
<td>O(file)</td>
<td>Low</td>
<td>High</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>O(文件)</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>EditTool</td>
<td>EditTool</td>
<td>20-100ms</td>
<td>O(file)</td>
<td>Low</td>
<td>Medium</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>O(文件)</td>
<td>低</td>
<td>中</td>
</tr>
<tr>
<td>MultiEditTool</td>
<td>MultiEditTool</td>
<td>50-500ms</td>
<td>O(file)</td>
<td>Medium</td>
<td>Medium</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>O(文件)</td>
<td>中</td>
<td>中</td>
</tr>
<tr>
<td>WriteTool</td>
<td>WriteTool</td>
<td>10-50ms</td>
<td>O(content)</td>
<td>Low</td>
<td>High</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>O(内容)</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>BashTool</td>
<td>BashTool</td>
<td>50ms-30s</td>
<td>Variable</td>
<td>Variable</td>
<td>Variable</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>可变</td>
<td>可变</td>
<td>可变</td>
</tr>
<tr>
<td>GrepTool</td>
<td>GrepTool</td>
<td>100-500ms</td>
<td>O(matches)</td>
<td>High</td>
<td>High</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>O(匹配)</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>GlobTool</td>
<td>GlobTool</td>
<td>50-200ms</td>
<td>O(files)</td>
<td>Low</td>
<td>Medium</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>O(文件)</td>
<td>低</td>
<td>中</td>
</tr>
<tr>
<td>AgentTool</td>
<td>AgentTool</td>
<td>2-20s</td>
<td>O(tasks)</td>
<td>Low</td>
<td>Low</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>O(任务)</td>
<td>低</td>
<td>低</td>
</tr>
<tr>
<td>WebFetchTool</td>
<td>WebFetchTool</td>
<td>500-3000ms</td>
<td>O(page)</td>
<td>Low</td>
<td>Low</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>O(页面)</td>
<td>低</td>
<td>低</td>
</tr>
</tbody></table>
<ul>
<li>BashTool parallel execution only safe for read-only commands</li>
<li>BashTool并行执行仅对只读命令安全</li>
</ul>
<h3 id="Memory-Management-Strategies"><a href="#Memory-Management-Strategies" class="headerlink" title="Memory Management Strategies"></a>Memory Management Strategies</h3><h3 id="内存管理策略"><a href="#内存管理策略" class="headerlink" title="内存管理策略"></a>内存管理策略</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Tool memory optimization patterns</span>
<span class="token comment">// 工具内存优化模式</span>
<span class="token keyword">class</span> <span class="token class-name">ToolMemoryManager</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Pattern 1: Streaming for large files</span>
  <span class="token comment">// 模式1：大文件流处理</span>
  <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">streamLargeFile</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> chunkSize <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      highWaterMark<span class="token operator">:</span> chunkSize
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">yield</span> chunk<span class="token punctuation">;</span>

      <span class="token comment">// Allow GC between chunks</span>
      <span class="token comment">// 在块之间允许垃圾回收</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>global<span class="token punctuation">.</span>gc<span class="token punctuation">)</span> global<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Pattern 2: Weak references for file cache</span>
  <span class="token comment">// 模式2：文件缓存弱引用</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> fileCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> WeakRef<span class="token operator">&lt;</span>FileContent<span class="token operator">>></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token function">cacheFile</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> content<span class="token operator">:</span> FileContent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Register cleanup</span>
    <span class="token comment">// 注册清理</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Pattern 3: Result size limits</span>
  <span class="token comment">// 模式3：结果大小限制</span>
  <span class="token keyword">static</span> <span class="token function">truncateResult</span><span class="token punctuation">(</span>result<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> maxSize <span class="token operator">=</span> <span class="token number">100_000</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> maxSize<span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maxSize<span class="token punctuation">)</span> <span class="token operator">+</span>
           <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\n... (truncated </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>length <span class="token operator">-</span> maxSize<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> characters)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
           <span class="token comment">// `\\n... (截断了$&#123;result.length - maxSize&#125;个字符)`;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Path-Security-Implementation"><a href="#Path-Security-Implementation" class="headerlink" title="Path Security Implementation"></a>Path Security Implementation</h3><h3 id="路径安全实现"><a href="#路径安全实现" class="headerlink" title="路径安全实现"></a>路径安全实现</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Path validation for all file operations</span>
<span class="token comment">// 所有文件操作的路径验证</span>
<span class="token keyword">class</span> <span class="token class-name">PathSecurityValidator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token function">isPathSafe</span><span class="token punctuation">(</span>
    requestedPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> resolved <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>requestedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check primary working directory</span>
    <span class="token comment">// 检查主要工作目录</span>
    <span class="token keyword">const</span> cwd <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>cwd <span class="token operator">||</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Check additional allowed directories</span>
    <span class="token comment">// 检查其他允许的目录</span>
    <span class="token keyword">const</span> additionalDirs <span class="token operator">=</span> context
      <span class="token punctuation">.</span><span class="token function">getToolPermissionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>additionalWorkingDirectories<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dir <span class="token keyword">of</span> additionalDirs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Check against deny patterns</span>
    <span class="token keyword">const</span> <span class="token constant">DENIED_PATHS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'/etc/passwd'</span><span class="token punctuation">,</span>
      <span class="token string">'/etc/shadow'</span><span class="token punctuation">,</span>
      <span class="token string">'~/.ssh/id_rsa'</span><span class="token punctuation">,</span>
      <span class="token string">'/System'</span><span class="token punctuation">,</span> <span class="token comment">// macOS</span>
      <span class="token string">'/Windows/System32'</span> <span class="token comment">// Windows</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token constant">DENIED_PATHS</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>denied <span class="token operator">=></span>
      resolved<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>denied<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档深入分析了Claude Code的工具与执行引擎架构，揭示了其高性能工具系统背后的创新设计。通过反编译和逆向工程分析，文档详细展示了Claude Code如何通过异步生成器、创新的Shell解析器、精密的权限控制和安全机制来实现强大的工具执行能力。</p>
<h2 id="核心架构特点"><a href="#核心架构特点" class="headerlink" title="核心架构特点"></a>核心架构特点</h2><h3 id="1-异步生成器管道架构"><a href="#1-异步生成器管道架构" class="headerlink" title="1. 异步生成器管道架构"></a>1. 异步生成器管道架构</h3><ul>
<li><strong>四阶段执行流程</strong>：<ol>
<li>输入验证（Zod schema验证）&lt;1ms</li>
<li>权限检查（规则匹配 + 用户交互时间）</li>
<li>工具执行（10ms到30s，根据工具类型）</li>
<li>结果转换（&lt;5ms，基于输出大小）</li>
</ol>
</li>
<li><strong>流式进度更新</strong>：支持实时的进度反馈和错误边界</li>
<li><strong>性能特征</strong>：异步生成器贯穿整个执行管道，确保UI响应性</li>
</ul>
<h3 id="2-创新的Shell解析器"><a href="#2-创新的Shell解析器" class="headerlink" title="2. 创新的Shell解析器"></a>2. 创新的Shell解析器</h3><ul>
<li><strong>对象序列化机制</strong>：<ul>
<li>使用随机哨兵字符串嵌入JavaScript对象</li>
<li>支持复杂配置对象通过shell命令传递</li>
<li>三阶段处理：变量展开 → 标记化 → 对象重新水合</li>
</ul>
</li>
<li><strong>高级功能</strong>：<ul>
<li>递归命令替换</li>
<li>环境变量类型保持</li>
<li>特殊字符和引号处理</li>
<li>操作符识别和分割</li>
</ul>
</li>
</ul>
<h3 id="3-多模态文件读取系统"><a href="#3-多模态文件读取系统" class="headerlink" title="3. 多模态文件读取系统"></a>3. 多模态文件读取系统</h3><ul>
<li><strong>ReadTool核心功能</strong>：<ul>
<li>支持文本、图像、Jupyter笔记本的统一读取</li>
<li>智能文件类型检测和处理</li>
<li>大文件的流式读取和行号格式化</li>
<li>图像文件的自动优化和base64编码</li>
</ul>
</li>
<li><strong>性能优化</strong>：<ul>
<li>&lt;1MB文件：&lt;10ms读取时间</li>
<li>10-100MB文件：50-500ms处理时间</li>
<li>支持部分读取和内容截断</li>
</ul>
</li>
</ul>
<h3 id="4-精准文件修改系统"><a href="#4-精准文件修改系统" class="headerlink" title="4. 精准文件修改系统"></a>4. 精准文件修改系统</h3><ul>
<li><strong>EditTool验证管道</strong>：<ol>
<li>文件必须先读取才能编辑</li>
<li>文件修改时间检查，防止外部修改冲突</li>
<li>无操作检查，避免相同的替换字符串</li>
<li>出现次数验证，确保精确替换</li>
</ol>
</li>
<li><strong>MultiEditTool原子性</strong>：<ul>
<li>顺序编辑的冲突检测</li>
<li>所有编辑验证后原子性应用</li>
<li>智能预览和差异生成</li>
</ul>
</li>
</ul>
<h3 id="5-高级Bash执行系统"><a href="#5-高级Bash执行系统" class="headerlink" title="5. 高级Bash执行系统"></a>5. 高级Bash执行系统</h3><ul>
<li><strong>多层安全机制</strong>：<ul>
<li>禁止命令列表（find、grep、cat等，优先使用专用工具）</li>
<li>危险命令交互确认（rm、dd、mkfs等）</li>
<li>macOS沙盒模式支持</li>
<li>流式输出和大小限制</li>
</ul>
</li>
<li><strong>Git工作流自动化</strong>：<ul>
<li>并行信息收集（状态、差异、日志）</li>
<li>智能提交消息生成</li>
<li>HEREDOC格式的安全提交</li>
</ul>
</li>
</ul>
<h3 id="6-高性能搜索系统"><a href="#6-高性能搜索系统" class="headerlink" title="6. 高性能搜索系统"></a>6. 高性能搜索系统</h3><ul>
<li><strong>GrepTool优化策略</strong>：<ul>
<li>使用ripgrep引擎提升性能</li>
<li>智能文件过滤和忽略模式</li>
<li>按文件修改时间排序</li>
<li>结果分组和限制（每文件10个匹配，前20个文件）</li>
</ul>
</li>
<li><strong>AgentTool层次化任务分解</strong>：<ul>
<li>子代理配置和权限继承</li>
<li>并行任务执行和结果合成</li>
<li>令牌预算计算和模型选择</li>
<li>递归防护和工具过滤</li>
</ul>
</li>
</ul>
<h2 id="工具选择与LLM工程"><a href="#工具选择与LLM工程" class="headerlink" title="工具选择与LLM工程"></a>工具选择与LLM工程</h2><h3 id="工具使用指南"><a href="#工具使用指南" class="headerlink" title="工具使用指南"></a>工具使用指南</h3><ol>
<li><strong>批处理原则</strong>：单次响应中调用多个独立工具</li>
<li><strong>先读后写原则</strong>：编辑前必须先读取文件</li>
<li><strong>专用工具优先</strong>：<ul>
<li>使用GrepTool而不是BashTool+grep</li>
<li>使用ReadFileTool而不是BashTool+cat</li>
<li>使用GlobTool而不是BashTool+find</li>
</ul>
</li>
<li><strong>安全第一</strong>：<ul>
<li>破坏性命令需要明确用户请求</li>
<li>尽可能使用sandbox=true</li>
<li>验证路径在项目边界内</li>
</ul>
</li>
<li><strong>进度沟通</strong>：<ul>
<li>工具执行可能需要时间</li>
<li>用户看到进度更新</li>
<li>对长时间运行工具保持耐心</li>
</ul>
</li>
<li><strong>错误处理</strong>：<ul>
<li>工具可能失败，需要备用计划</li>
<li>仔细阅读错误消息</li>
<li>基于错误细节建议修复方案</li>
</ul>
</li>
</ol>
<h3 id="工具性能特征-1"><a href="#工具性能特征-1" class="headerlink" title="工具性能特征"></a>工具性能特征</h3><table>
<thead>
<tr>
<th>工具类型</th>
<th>延迟范围</th>
<th>内存使用</th>
<th>CPU负载</th>
<th>I/O负载</th>
<th>可并行性</th>
</tr>
</thead>
<tbody><tr>
<td>ReadTool</td>
<td>10-50ms</td>
<td>O(文件)</td>
<td>低</td>
<td>高</td>
<td>✓</td>
</tr>
<tr>
<td>EditTool</td>
<td>20-100ms</td>
<td>O(文件)</td>
<td>低</td>
<td>中</td>
<td>✗</td>
</tr>
<tr>
<td>MultiEditTool</td>
<td>50-500ms</td>
<td>O(文件)</td>
<td>中</td>
<td>中</td>
<td>✗</td>
</tr>
<tr>
<td>WriteTool</td>
<td>10-50ms</td>
<td>O(内容)</td>
<td>低</td>
<td>高</td>
<td>✗</td>
</tr>
<tr>
<td>BashTool</td>
<td>50ms-30s</td>
<td>可变</td>
<td>可变</td>
<td>可变</td>
<td>✗*</td>
</tr>
<tr>
<td>GrepTool</td>
<td>100-500ms</td>
<td>O(匹配)</td>
<td>高</td>
<td>高</td>
<td>✓</td>
</tr>
<tr>
<td>GlobTool</td>
<td>50-200ms</td>
<td>O(文件)</td>
<td>低</td>
<td>中</td>
<td>✓</td>
</tr>
<tr>
<td>AgentTool</td>
<td>2-20s</td>
<td>O(任务)</td>
<td>低</td>
<td>低</td>
<td>✓</td>
</tr>
<tr>
<td>WebFetchTool</td>
<td>500-3000ms</td>
<td>O(页面)</td>
<td>低</td>
<td>低</td>
<td>✓</td>
</tr>
</tbody></table>
<h2 id="性能与安全模式-1"><a href="#性能与安全模式-1" class="headerlink" title="性能与安全模式"></a>性能与安全模式</h2><h3 id="内存管理策略-1"><a href="#内存管理策略-1" class="headerlink" title="内存管理策略"></a>内存管理策略</h3><ol>
<li><strong>大文件流处理</strong>：64KB块大小，块间垃圾回收</li>
<li><strong>文件缓存弱引用</strong>：WeakRef + FinalizationRegistry自动清理</li>
<li><strong>结果大小限制</strong>：默认100KB限制，防止内存溢出</li>
</ol>
<h3 id="路径安全实现-1"><a href="#路径安全实现-1" class="headerlink" title="路径安全实现"></a>路径安全实现</h3><ul>
<li><strong>多层验证</strong>：<ol>
<li>主要工作目录检查</li>
<li>额外允许目录检查</li>
<li>拒绝模式匹配</li>
</ol>
</li>
<li><strong>系统敏感路径保护</strong>：<ul>
<li>/etc/passwd、/etc/shadow</li>
<li>~/.ssh/id_rsa</li>
<li>/System (macOS)</li>
<li>/Windows/System32</li>
</ul>
</li>
</ul>
<h3 id="沙盒模式决策树"><a href="#沙盒模式决策树" class="headerlink" title="沙盒模式决策树"></a>沙盒模式决策树</h3><pre class="line-numbers language-none"><code class="language-none">命令分析
├─ 是读操作吗？(ls、cat、grep)
│  └─ 是 → sandbox&#x3D;true ✓
├─ 需要网络吗？(curl、wget、git)
│  └─ 是 → sandbox&#x3D;false ✓
├─ 写文件吗？(touch、echo &gt;)
│  └─ 是 → sandbox&#x3D;false ✓
├─ 是构建命令吗？(npm、make、cargo)
│  └─ 是 → sandbox&#x3D;false ✓
└─ 默认 → sandbox&#x3D;true (安全默认)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="技术创新点"><a href="#技术创新点" class="headerlink" title="技术创新点"></a>技术创新点</h2><h3 id="架构创新"><a href="#架构创新" class="headerlink" title="架构创新"></a>架构创新</h3><ol>
<li><strong>异步生成器管道</strong>：统一的工具执行框架，支持流式进度更新</li>
<li><strong>Shell对象传递</strong>：通过哨兵字符串机制实现复杂对象的shell传递</li>
<li><strong>多模态文件处理</strong>：文本、图像、笔记本的统一读取接口</li>
<li><strong>层次化代理系统</strong>：子代理任务分解和并行执行</li>
</ol>
<h3 id="性能创新"><a href="#性能创新" class="headerlink" title="性能创新"></a>性能创新</h3><ol>
<li><strong>智能缓存机制</strong>：弱引用文件缓存，自动内存管理</li>
<li><strong>并行执行策略</strong>：只读工具的安全并行化</li>
<li><strong>流式处理</strong>：大文件和命令输出的流式处理</li>
<li><strong>结果截断</strong>：防止内存溢出的智能限制</li>
</ol>
<h3 id="安全创新"><a href="#安全创新" class="headerlink" title="安全创新"></a>安全创新</h3><ol>
<li><strong>多层权限控制</strong>：CLI参数、本地设置、项目设置、策略设置、用户设置</li>
<li><strong>路径安全验证</strong>：多层次的路径检查和敏感路径保护</li>
<li><strong>沙盒模式</strong>：macOS的restrictive sandbox profile</li>
<li><strong>工具特定指令</strong>：针对每个工具的详细安全指南</li>
</ol>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><ol>
<li><strong>全面的错误处理</strong>：类型安全的错误报告和恢复策略</li>
<li><strong>进度反馈</strong>：实时的执行状态和进度更新</li>
<li><strong>性能监控</strong>：详细的性能指标和优化策略</li>
<li><strong>模块化设计</strong>：高度解耦的工具接口和可扩展架构</li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Claude Code的工具与执行引擎体现了现代软件工程的最佳实践，通过创新的异步生成器架构和精密的安全机制，实现了既强大又安全的工具执行系统。其核心价值在于：</p>
<ul>
<li><strong>高性能</strong>：异步执行、并行处理、智能缓存</li>
<li><strong>安全性</strong>：多层权限控制、路径验证、沙盒模式</li>
<li><strong>可扩展性</strong>：模块化工具接口、标准化的执行管道</li>
<li><strong>用户友好</strong>：流式进度更新、详细的错误信息</li>
</ul>
<p>这种复杂的工具系统设计为AI助手应用提供了优秀的架构模板，特别是在需要执行实际文件操作和系统命令的场景中。文档的深入分析为理解现代AI系统的工具集成和执行引擎设计提供了宝贵的技术参考，展现了如何在保证安全性的前提下实现强大的工具执行能力。</p>
<p>整个架构的成功关键在于平衡了功能性（丰富的工具集）与安全性（多层保护机制），通过精密的权限控制和异步执行框架，实现了既安全又高效的工具执行体验。</p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/10/23/claude-code-jia-gou-yin-qing-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="claude-code架构-引擎室">
                        
                        <span class="card-title">claude-code架构-引擎室</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-10-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            寒霜
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/10/23/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="claude-code控制流与编排引擎">
                        
                        <span class="card-title">claude-code控制流与编排引擎</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-10-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            寒霜
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('6'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            <!-- Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
             -->
            <!-- <a href="/about" target="_blank">寒霜</a> -->
            <!-- |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
             -->
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">141.7k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
