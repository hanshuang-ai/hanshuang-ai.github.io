<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="claude-code文件编辑-AI辅助的代码修改, 我的博客">
    <meta name="description" content="参考链接
File Editing: AI-Assisted Code Modification文件编辑：AI辅助的代码修改graph TB
    subgraph &#34;文件编辑管道&#34;
        Read[读取工具] --&gt;|cat ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>claude-code文件编辑-AI辅助的代码修改 | 我的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">我的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">我的博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/14.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">claude-code文件编辑-AI辅助的代码修改</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-10-23
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-10-24
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    33 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><a target="_blank" rel="noopener" href="https://southbridge-research.notion.site/File-Editing-AI-Assisted-Code-Modification-2055fec70db18100803ff7287c24c6cc">参考链接</a></p>
<h1 id="File-Editing-AI-Assisted-Code-Modification"><a href="#File-Editing-AI-Assisted-Code-Modification" class="headerlink" title="File Editing: AI-Assisted Code Modification"></a>File Editing: AI-Assisted Code Modification</h1><h1 id="文件编辑：AI辅助的代码修改"><a href="#文件编辑：AI辅助的代码修改" class="headerlink" title="文件编辑：AI辅助的代码修改"></a>文件编辑：AI辅助的代码修改</h1><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TB
    <span class="token keyword">subgraph</span> <span class="token string">"文件编辑管道"</span>
        Read<span class="token text string">[读取工具]</span> <span class="token arrow operator">--></span><span class="token label property">|cat -n 格式|</span> Display<span class="token text string">[LLM看到]</span>
        Display <span class="token arrow operator">--></span><span class="token label property">|去除行号|</span> Edit<span class="token text string">[编辑工具]</span>

        Edit <span class="token arrow operator">--></span> Validate<span class="token text string">&#123;验证&#125;</span>
        Validate <span class="token arrow operator">--></span><span class="token label property">|通过|</span> Apply<span class="token text string">[应用编辑]</span>
        Validate <span class="token arrow operator">--></span><span class="token label property">|失败|</span> Error<span class="token text string">[错误结果]</span>

        Apply <span class="token arrow operator">--></span> Cache<span class="token text string">[更新缓存]</span>
        Cache <span class="token arrow operator">--></span> Diff<span class="token text string">[生成差异]</span>
        Diff <span class="token arrow operator">--></span> Confirm<span class="token text string">[确认]</span>

        <span class="token keyword">subgraph</span> <span class="token string">"验证检查"</span>
            V1<span class="token text string">[文件已读取?]</span>
            V2<span class="token text string">[文件未更改?]</span>
            V3<span class="token text string">[字符串存在?]</span>
            V4<span class="token text string">[计数匹配?]</span>
            V5<span class="token text string">[不是无操作?]</span>
        <span class="token keyword">end</span>

        Validate <span class="token arrow operator">--></span> V1
        V1 <span class="token arrow operator">--></span> V2
        V2 <span class="token arrow operator">--></span> V3
        V3 <span class="token arrow operator">--></span> V4
        V4 <span class="token arrow operator">--></span> V5
    <span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2025/10/23/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/1.svg" class="">
<h2 id="文件编辑管道架构"><a href="#文件编辑管道架构" class="headerlink" title="文件编辑管道架构"></a>文件编辑管道架构</h2><p>Claude Code中的文件编辑不仅仅是更改文本——它是一个精心编排的管道，旨在处理AI辅助代码修改的复杂性：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FileEditingPipeline</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 四阶段编辑循环</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">executeEdit</span><span class="token punctuation">(</span>
    tool<span class="token operator">:</span> EditTool<span class="token punctuation">,</span>
    input<span class="token operator">:</span> EditInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>EditResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 阶段1：验证</span>
    <span class="token keyword">const</span> validation <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateEdit</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token operator">:</span> validation<span class="token punctuation">.</span>error <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 阶段2：准备</span>
    <span class="token keyword">const</span> prepared <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareEdit</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> validation<span class="token punctuation">.</span>fileState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段3：应用</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyEdit</span><span class="token punctuation">(</span>prepared<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段4：验证</span>
    <span class="token keyword">const</span> verified <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verifyEdit</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> verified<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 状态跟踪系统</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> fileStates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> FileState<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">interface</span> <span class="token class-name">FileState</span> <span class="token punctuation">&#123;</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    hash<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    mtime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    encoding<span class="token operator">:</span> BufferEncoding<span class="token punctuation">;</span>
    lineEndings<span class="token operator">:</span> <span class="token string">'\\n'</span> <span class="token operator">|</span> <span class="token string">'\\r\\n'</span> <span class="token operator">|</span> <span class="token string">'\\r'</span><span class="token punctuation">;</span>
    isBinary<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    size<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>为什么使用多个工具而不是一个通用编辑器？</strong></p>
<table>
<thead>
<tr>
<th>工具</th>
<th>目的</th>
<th>保证</th>
<th>失败模式</th>
</tr>
</thead>
<tbody><tr>
<td><code>EditTool</code></td>
<td>单个字符串替换</td>
<td>精确匹配计数</td>
<td>如果出现次数≠预期则失败</td>
</tr>
<tr>
<td><code>MultiEditTool</code></td>
<td>顺序编辑</td>
<td>原子批处理</td>
<td>如果任何编辑无效则失败</td>
</tr>
<tr>
<td><code>WriteTool</code></td>
<td>完整替换</td>
<td>完全覆盖</td>
<td>如果未先读取则失败</td>
</tr>
<tr>
<td><code>NotebookEditTool</code></td>
<td>单元格操作</td>
<td>结构保留</td>
<td>如果单元格缺失则失败</td>
</tr>
</tbody></table>
<p>每个工具都提供特定的保证，这是通用编辑器在保持LLM友好性的同时无法维持的。</p>
<h2 id="行号问题：一个看似复杂的挑战"><a href="#行号问题：一个看似复杂的挑战" class="headerlink" title="行号问题：一个看似复杂的挑战"></a>行号问题：一个看似复杂的挑战</h2><p>文件编辑中最关键的挑战是行号前缀问题：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// LLM从ReadTool看到的内容：</span>
<span class="token keyword">const</span> readOutput <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
1	function hello() &#123;
2	  console.log('Hello, world!');
3	&#125;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// LLM可能错误尝试编辑的内容：</span>
<span class="token keyword">const</span> wrongOldString <span class="token operator">=</span> <span class="token string">"2	  console.log('Hello, world!');"</span><span class="token punctuation">;</span>  <span class="token comment">// 错误 - 包含行号</span>

<span class="token comment">// 它应该使用的内容：</span>
<span class="token keyword">const</span> correctOldString <span class="token operator">=</span> <span class="token string">"  console.log('Hello, world!');"</span><span class="token punctuation">;</span>  <span class="token comment">// 正确 - 无行号</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>行号去除逻辑：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">LineNumberHandler</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// LLM收到关于此问题的广泛指令</span>
  <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token constant">LINE_NUMBER_PATTERN</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\d+\\t</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token function">stripLineNumbers</span><span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> content
      <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=></span> line<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">LINE_NUMBER_PATTERN</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 但真正的挑战是确保LLM做到这一点</span>
  <span class="token keyword">static</span> <span class="token function">validateOldString</span><span class="token punctuation">(</span>
    oldString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    fileContent<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> ValidationResult <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查1：oldString是否包含行号前缀？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">LINE_NUMBER_PATTERN</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>oldString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'old_string似乎包含行号前缀。'</span> <span class="token operator">+</span>
               <span class="token string">'请移除开头的数字和制表符。'</span><span class="token punctuation">,</span>
        suggestion<span class="token operator">:</span> oldString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">LINE_NUMBER_PATTERN</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查2：字符串是否存在于文件中？</span>
    <span class="token keyword">const</span> occurrences <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countOccurrences</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> oldString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 尝试检测是否是行号问题</span>
      <span class="token keyword">const</span> possibleLineNumber <span class="token operator">=</span> oldString<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\\d+)\\t</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>possibleLineNumber<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> lineNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>possibleLineNumber<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> actualLine <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLine</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> lineNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">未找到字符串。您是否包含了行号</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>lineNum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">？</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          suggestion<span class="token operator">:</span> actualLine
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> occurrences <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="EditTool：字符串替换的手术级精度"><a href="#EditTool：字符串替换的手术级精度" class="headerlink" title="EditTool：字符串替换的手术级精度"></a>EditTool：字符串替换的手术级精度</h2><p>EditTool实现零歧义的精确字符串匹配：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">EditToolImplementation</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">executeEdit</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> EditInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>EditResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> old_string<span class="token punctuation">,</span> new_string<span class="token punctuation">,</span> expected_replacements <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// 步骤1：检索缓存文件状态</span>
    <span class="token keyword">const</span> cachedFile <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'文件必须在编辑前使用ReadFileTool读取。'</span> <span class="token operator">+</span>
        <span class="token string">'这确保您拥有当前文件内容。'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 步骤2：验证文件未被外部更改</span>
    <span class="token keyword">const</span> currentStats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cachedFile<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'文件自上次读取以来已被外部修改。'</span> <span class="token operator">+</span>
        <span class="token string">'请再次读取文件以查看当前内容。'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 步骤3：验证编辑</span>
    <span class="token keyword">const</span> validation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateEdit</span><span class="token punctuation">(</span>
      old_string<span class="token punctuation">,</span>
      new_string<span class="token punctuation">,</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      expected_replacements
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>validation<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 步骤4：应用替换</span>
    <span class="token keyword">const</span> newContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performReplacement</span><span class="token punctuation">(</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      old_string<span class="token punctuation">,</span>
      new_string<span class="token punctuation">,</span>
      expected_replacements
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤5：生成差异用于验证</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      newContent<span class="token punctuation">,</span>
      file_path
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤6：以相同编码/行结尾写入</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFilePreservingFormat</span><span class="token punctuation">(</span>
      file_path<span class="token punctuation">,</span>
      newContent<span class="token punctuation">,</span>
      cachedFile
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤7：更新缓存</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> newContent<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤8：生成上下文片段</span>
    <span class="token keyword">const</span> snippet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateContextSnippet</span><span class="token punctuation">(</span>
      newContent<span class="token punctuation">,</span>
      new_string<span class="token punctuation">,</span>
      <span class="token number">5</span> <span class="token comment">// 上下文行数</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      diff<span class="token punctuation">,</span>
      snippet<span class="token punctuation">,</span>
      replacements<span class="token operator">:</span> expected_replacements
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">validateEdit</span><span class="token punctuation">(</span>
    oldString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    fileContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    expectedReplacements<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> EditValidation <span class="token punctuation">&#123;</span>
    <span class="token comment">// 无操作检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldString <span class="token operator">===</span> newString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'old_string和new_string相同。不会进行任何更改。'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 空old_string特殊情况（插入）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldString <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'不允许空的old_string。对于新文件请使用WriteTool。'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 使用精确字符串匹配计算出现次数</span>
    <span class="token keyword">const</span> occurrences <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countExactOccurrences</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> oldString<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'在文件中未找到old_string。确保包括空白字符在内的精确匹配。'</span><span class="token punctuation">,</span>
        suggestion<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findSimilarStrings</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> oldString<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">!==</span> expectedReplacements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">期望</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>expectedReplacements<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">次替换但找到</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>occurrences<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">次出现。</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">将expected_replacements设置为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>occurrences<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">或优化old_string。</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">countExactOccurrences</span><span class="token punctuation">(</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    searchString<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 转义特殊正则表达式字符以进行精确匹配</span>
    <span class="token keyword">const</span> escaped <span class="token operator">=</span> searchString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[.*+?^$&#123;&#125;()|[\\]\\\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\\\$&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>escaped<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">performReplacement</span><span class="token punctuation">(</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    oldString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    limit<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 特殊替换模式的字符转义</span>
    <span class="token keyword">const</span> <span class="token function-variable function">escapeReplacement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> str
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$$$$'</span><span class="token punctuation">)</span>  <span class="token comment">// $ -> $$</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\n'</span><span class="token punctuation">)</span>    <span class="token comment">// 保留换行符</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\r</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 保留回车符</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> escapedNew <span class="token operator">=</span> <span class="token function">escapeReplacement</span><span class="token punctuation">(</span>newString<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 手动替换以尊重限制</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>oldString<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">+</span>
               newString <span class="token operator">+</span>  <span class="token comment">// 使用原始字符串，而非转义字符串</span>
               result<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> oldString<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      lastIndex <span class="token operator">=</span> index <span class="token operator">+</span> newString<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateDiff</span><span class="token punctuation">(</span>
    oldContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 使用统一差异格式</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token function">createUnifiedDiff</span><span class="token punctuation">(</span>
      filePath<span class="token punctuation">,</span>
      filePath<span class="token punctuation">,</span>
      oldContent<span class="token punctuation">,</span>
      newContent<span class="token punctuation">,</span>
      <span class="token string">'编辑前'</span><span class="token punctuation">,</span>
      <span class="token string">'编辑后'</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> context<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> diff<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>为什么<code>expected_replacements</code>很重要</strong>：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 场景：多次出现</span>
<span class="token keyword">const</span> fileContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
function processUser(user) &#123;
  console.log(user);
  return user;
&#125;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 不使用expected_replacements：</span>
<span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  old_string<span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
  new_string<span class="token operator">:</span> <span class="token string">"userData"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：所有出现都被替换（包括函数参数！）</span>

<span class="token comment">// 使用expected_replacements：</span>
<span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  old_string<span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
  new_string<span class="token operator">:</span> <span class="token string">"userData"</span><span class="token punctuation">,</span>
  expected_replacements<span class="token operator">:</span> <span class="token number">2</span>  <span class="token comment">// 仅使用处，不包括参数</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：失败 - 强制使用更具体的old_string</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="MultiEditTool：原子顺序操作"><a href="#MultiEditTool：原子顺序操作" class="headerlink" title="MultiEditTool：原子顺序操作"></a>MultiEditTool：原子顺序操作</h2><p>MultiEditTool解决了多个相关编辑的复杂问题：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">MultiEditToolImplementation</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">executeMultiEdit</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> MultiEditInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>MultiEditResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> edits <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// 加载文件一次</span>
    <span class="token keyword">const</span> cachedFile <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'文件必须在编辑前读取'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 在应用任何编辑之前验证所有编辑</span>
    <span class="token keyword">const</span> validationResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateAllEdits</span><span class="token punctuation">(</span>
      edits<span class="token punctuation">,</span>
      cachedFile<span class="token punctuation">.</span>content
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationResult<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>validationResult<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 顺序应用编辑到工作副本</span>
    <span class="token keyword">let</span> workingContent <span class="token operator">=</span> cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token keyword">const</span> appliedEdits<span class="token operator">:</span> AppliedEdit<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> edit <span class="token operator">=</span> edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据当前工作内容验证此编辑</span>
        <span class="token keyword">const</span> validation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateSingleEdit</span><span class="token punctuation">(</span>
          edit<span class="token punctuation">,</span>
          workingContent<span class="token punctuation">,</span>
          i
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">失败：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>validation<span class="token punctuation">.</span>error<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 应用编辑</span>
        <span class="token keyword">const</span> beforeEdit <span class="token operator">=</span> workingContent<span class="token punctuation">;</span>
        workingContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyEdit</span><span class="token punctuation">(</span>
          workingContent<span class="token punctuation">,</span>
          edit
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        appliedEdits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          index<span class="token operator">:</span> i<span class="token punctuation">,</span>
          edit<span class="token punctuation">,</span>
          diff<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateEditDiff</span><span class="token punctuation">(</span>beforeEdit<span class="token punctuation">,</span> workingContent<span class="token punctuation">)</span><span class="token punctuation">,</span>
          summary<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">summarizeEdit</span><span class="token punctuation">(</span>edit<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 原子失败 - 不写入任何更改</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">MultiEdit在编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>edits<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">处中止：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 所有编辑已验证并应用 - 一次性写入</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFilePreservingFormat</span><span class="token punctuation">(</span>
      file_path<span class="token punctuation">,</span>
      workingContent<span class="token punctuation">,</span>
      cachedFile
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新缓存</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> workingContent<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      editsApplied<span class="token operator">:</span> appliedEdits<span class="token punctuation">,</span>
      totalDiff<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>
        cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        workingContent<span class="token punctuation">,</span>
        file_path
      <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">validateAllEdits</span><span class="token punctuation">(</span>
    edits<span class="token operator">:</span> Edit<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    originalContent<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> ValidationResult <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查空编辑数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>edits<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'未提供编辑'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检测潜在冲突</span>
    <span class="token keyword">const</span> conflicts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">detectEditConflicts</span><span class="token punctuation">(</span>edits<span class="token punctuation">,</span> originalContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conflicts<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'检测到编辑冲突：\\n'</span> <span class="token operator">+</span>
               conflicts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=></span> c<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 模拟所有编辑以确保它们有效</span>
    <span class="token keyword">let</span> simulatedContent <span class="token operator">=</span> originalContent<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> edit <span class="token operator">=</span> edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> occurrences <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countOccurrences</span><span class="token punctuation">(</span>
        simulatedContent<span class="token punctuation">,</span>
        edit<span class="token punctuation">.</span>old_string
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">：未找到old_string。</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">之前的编辑可能已删除它。</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">!==</span> <span class="token punctuation">(</span>edit<span class="token punctuation">.</span>expected_replacements <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">：期望</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>edit<span class="token punctuation">.</span>expected_replacements <span class="token operator">||</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">次</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">替换但找到</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>occurrences<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">次</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 应用到模拟</span>
      simulatedContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyEdit</span><span class="token punctuation">(</span>simulatedContent<span class="token punctuation">,</span> edit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">detectEditConflicts</span><span class="token punctuation">(</span>
    edits<span class="token operator">:</span> Edit<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> EditConflict<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> conflicts<span class="token operator">:</span> EditConflict<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> edit1 <span class="token operator">=</span> edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> edit2 <span class="token operator">=</span> edits<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 冲突类型1：后面的编辑修改前面编辑的结果</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>edit2<span class="token punctuation">.</span>old_string<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>edit1<span class="token punctuation">.</span>new_string<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conflicts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token string">'dependency'</span><span class="token punctuation">,</span>
            edits<span class="token operator">:</span> <span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span>
            description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">依赖于编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">的结果</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 冲突类型2：重叠替换</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">editsOverlap</span><span class="token punctuation">(</span>edit1<span class="token punctuation">,</span> edit2<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conflicts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token string">'overlap'</span><span class="token punctuation">,</span>
            edits<span class="token operator">:</span> <span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span>
            description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">和</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">影响重叠文本</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 冲突类型3：相同目标，不同替换</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>edit1<span class="token punctuation">.</span>old_string <span class="token operator">===</span> edit2<span class="token punctuation">.</span>old_string <span class="token operator">&amp;&amp;</span>
            edit1<span class="token punctuation">.</span>new_string <span class="token operator">!==</span> edit2<span class="token punctuation">.</span>new_string<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conflicts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token string">'contradiction'</span><span class="token punctuation">,</span>
            edits<span class="token operator">:</span> <span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span>
            description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">和</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">以不同方式替换相同文本</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> conflicts<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">editsOverlap</span><span class="token punctuation">(</span>
    edit1<span class="token operator">:</span> Edit<span class="token punctuation">,</span>
    edit2<span class="token operator">:</span> Edit<span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 查找所有出现的位置</span>
    <span class="token keyword">const</span> positions1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findAllPositions</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> edit1<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> positions2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findAllPositions</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> edit2<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查是否有任何位置重叠</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pos1 <span class="token keyword">of</span> positions1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> end1 <span class="token operator">=</span> pos1 <span class="token operator">+</span> edit1<span class="token punctuation">.</span>old_string<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pos2 <span class="token keyword">of</span> positions2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> end2 <span class="token operator">=</span> pos2 <span class="token operator">+</span> edit2<span class="token punctuation">.</span>old_string<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

        <span class="token comment">// 检查重叠</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos1 <span class="token operator">&lt;</span> end2 <span class="token operator">&amp;&amp;</span> pos2 <span class="token operator">&lt;</span> end1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>冲突检测的实际应用</strong>：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 示例：依赖编辑</span>
<span class="token keyword">const</span> edits <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    old_string<span class="token operator">:</span> <span class="token string">"console.log"</span><span class="token punctuation">,</span>
    new_string<span class="token operator">:</span> <span class="token string">"logger.info"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    old_string<span class="token operator">:</span> <span class="token string">"logger.info('test')"</span><span class="token punctuation">,</span>  <span class="token comment">// 依赖第一个编辑！</span>
    new_string<span class="token operator">:</span> <span class="token string">"logger.debug('test')"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：检测到冲突 - 编辑2依赖于编辑1</span>

<span class="token comment">// 示例：安全的顺序编辑</span>
<span class="token keyword">const</span> safeEdits <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    old_string<span class="token operator">:</span> <span class="token string">"var x"</span><span class="token punctuation">,</span>
    new_string<span class="token operator">:</span> <span class="token string">"let x"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    old_string<span class="token operator">:</span> <span class="token string">"var y"</span><span class="token punctuation">,</span>
    new_string<span class="token operator">:</span> <span class="token string">"let y"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：无冲突 - 独立更改</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="WriteTool：完整文件操作"><a href="#WriteTool：完整文件操作" class="headerlink" title="WriteTool：完整文件操作"></a>WriteTool：完整文件操作</h2><p>WriteTool处理完整的文件创建或替换：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">WriteToolImplementation</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">executeWrite</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> WriteInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>WriteResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> content <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// 检查文件是否存在</span>
    <span class="token keyword">const</span> exists <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>exists<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 现有文件 - 必须已被读取</span>
      <span class="token keyword">const</span> cachedFile <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">'现有文件必须在覆盖前使用ReadFileTool读取。'</span> <span class="token operator">+</span>
          <span class="token string">'这可以防止意外数据丢失。'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 验证未被外部修改</span>
      <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cachedFile<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">'文件已被外部修改。'</span> <span class="token operator">+</span>
          <span class="token string">'在覆盖前再次读取文件以查看当前内容。'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 文档文件限制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isDocumentationFile</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>context<span class="token punctuation">.</span>explicitlyAllowed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'创建文档文件（*.md, README）需要明确的用户请求。'</span> <span class="token operator">+</span>
        <span class="token string">'除非特别要求文档，否则专注于代码实现。'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 准备写入操作</span>
    <span class="token keyword">const</span> writeData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareWriteData</span><span class="token punctuation">(</span>
      content<span class="token punctuation">,</span>
      exists <span class="token operator">?</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 确保目录存在</span>
    <span class="token keyword">const</span> dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 写入文件</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> writeData<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      encoding<span class="token operator">:</span> writeData<span class="token punctuation">.</span>encoding<span class="token punctuation">,</span>
      mode<span class="token operator">:</span> writeData<span class="token punctuation">.</span>mode
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新缓存</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> content<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 生成结果</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exists<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> snippet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateContextSnippet</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        action<span class="token operator">:</span> <span class="token string">'updated'</span><span class="token punctuation">,</span>
        snippet
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        action<span class="token operator">:</span> <span class="token string">'created'</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> file_path
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">prepareWriteData</span><span class="token punctuation">(</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    existingFile<span class="token operator">:</span> FileState <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>WriteData<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检测或保留行结尾</span>
    <span class="token keyword">let</span> lineEnding <span class="token operator">=</span> <span class="token string">'\\n'</span><span class="token punctuation">;</span> <span class="token comment">// 默认为LF</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 保留现有行结尾</span>
      lineEnding <span class="token operator">=</span> existingFile<span class="token punctuation">.</span>lineEndings<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'win32'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Windows上新文件默认为CRLF</span>
      lineEnding <span class="token operator">=</span> <span class="token string">'\\r\\n'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 规范化然后应用正确的行结尾</span>
    <span class="token keyword">const</span> normalizedContent <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\r\\n|\\r|\\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> finalContent <span class="token operator">=</span> normalizedContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> lineEnding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测编码（简化 - 实际实现更复杂）</span>
    <span class="token keyword">const</span> encoding <span class="token operator">=</span> existingFile<span class="token operator">?.</span>encoding <span class="token operator">||</span> <span class="token string">'utf8'</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新时保留文件模式</span>
    <span class="token keyword">const</span> mode <span class="token operator">=</span> existingFile <span class="token operator">?</span>
      <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>existingFile<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mode <span class="token operator">:</span>
      <span class="token number">0o644</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> finalContent<span class="token punctuation">,</span>
      encoding<span class="token punctuation">,</span>
      mode
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="验证层：深度防御"><a href="#验证层：深度防御" class="headerlink" title="验证层：深度防御"></a>验证层：深度防御</h2><p>每个编辑操作都经过多层验证：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FileValidationPipeline</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">validateFileOperation</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> FileOperation<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ValidationResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 层1：路径验证</span>
    <span class="token keyword">const</span> pathValidation <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validatePath</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>path<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathValidation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> pathValidation<span class="token punctuation">;</span>

    <span class="token comment">// 层2：权限检查</span>
    <span class="token keyword">const</span> permissionCheck <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkPermissions</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permissionCheck<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> permissionCheck<span class="token punctuation">;</span>

    <span class="token comment">// 层3：文件状态验证</span>
    <span class="token keyword">const</span> stateValidation <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateFileState</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stateValidation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> stateValidation<span class="token punctuation">;</span>

    <span class="token comment">// 层4：内容验证</span>
    <span class="token keyword">const</span> contentValidation <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateContent</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contentValidation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> contentValidation<span class="token punctuation">;</span>

    <span class="token comment">// 层5：安全检查</span>
    <span class="token keyword">const</span> safetyCheck <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performSafetyChecks</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>safetyCheck<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> safetyCheck<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">validatePath</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ValidationResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 绝对路径要求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'文件路径必须是绝对路径'</span><span class="token punctuation">,</span>
        suggestion<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 路径遍历防护</span>
    <span class="token keyword">const</span> resolved <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> normalized <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved <span class="token operator">!==</span> normalized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'路径包含可疑的遍历模式'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 边界检查</span>
    <span class="token keyword">const</span> projectRoot <span class="token operator">=</span> context<span class="token punctuation">.</span>projectRoot<span class="token punctuation">;</span>
    <span class="token keyword">const</span> allowed <span class="token operator">=</span> <span class="token punctuation">[</span>
      projectRoot<span class="token punctuation">,</span>
      <span class="token operator">...</span>context<span class="token punctuation">.</span>additionalWorkingDirectories
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> isAllowed <span class="token operator">=</span> allowed<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>dir <span class="token operator">=></span>
      resolved<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAllowed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'路径在允许的目录之外'</span><span class="token punctuation">,</span>
        allowedDirs<span class="token operator">:</span> allowed
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 特殊文件防护</span>
    <span class="token keyword">const</span> forbidden <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span>git\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>
      <span class="token operator">/</span>node_modules\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>
      <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.env$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span>ssh\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span>gnupg\\<span class="token operator">/</span><span class="token operator">/</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>forbidden<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>pattern <span class="token operator">=></span> pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'不允许对敏感文件进行操作'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">validateFileState</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> FileOperation<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ValidationResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'create'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 检查文件是否已存在</span>
      <span class="token keyword">const</span> exists <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>exists <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>operation<span class="token punctuation">.</span>overwrite<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token string">'文件已存在。使用WriteTool并在之前读取以覆盖。'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'edit'</span> <span class="token operator">||</span> operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'overwrite'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> cached <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token string">'文件必须在编辑前读取'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 陈旧性检查</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cached<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> timeDiff <span class="token operator">=</span> stats<span class="token punctuation">.</span>mtimeMs <span class="token operator">-</span> cached<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            error<span class="token operator">:</span> <span class="token string">'文件已被外部修改'</span><span class="token punctuation">,</span>
            details<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              cachedTime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">,</span>
              currentTime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>mtimeMs<span class="token punctuation">)</span><span class="token punctuation">,</span>
              difference<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>timeDiff<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token string">'文件不再存在或无法访问'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="差异生成和反馈：闭环处理"><a href="#差异生成和反馈：闭环处理" class="headerlink" title="差异生成和反馈：闭环处理"></a>差异生成和反馈：闭环处理</h2><p>每个编辑都为LLM生成丰富的反馈：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">DiffGenerator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token function">generateEditFeedback</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> EditOperation<span class="token punctuation">,</span>
    result<span class="token operator">:</span> EditResult
  <span class="token punctuation">)</span><span class="token operator">:</span> EditFeedback <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> feedback<span class="token operator">:</span> EditFeedback <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      summary<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSummary</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span>
      diff<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span>
      snippet<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateContextSnippet</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span>
      statistics<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateStatistics</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> feedback<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateDiff</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> EditOperation<span class="token punctuation">,</span>
    result<span class="token operator">:</span> EditResult
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> oldContent<span class="token punctuation">,</span> newContent<span class="token punctuation">,</span> filePath <span class="token punctuation">&#125;</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>

    <span class="token comment">// 根据更改大小使用不同的差异策略</span>
    <span class="token keyword">const</span> changeRatio <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateChangeRatio</span><span class="token punctuation">(</span>oldContent<span class="token punctuation">,</span> newContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>changeRatio <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 小更改 - 使用统一差异</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateUnifiedDiff</span><span class="token punctuation">(</span>
        oldContent<span class="token punctuation">,</span>
        newContent<span class="token punctuation">,</span>
        filePath<span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> context<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>changeRatio <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 中等更改 - 使用单词差异</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateWordDiff</span><span class="token punctuation">(</span>
        oldContent<span class="token punctuation">,</span>
        newContent<span class="token punctuation">,</span>
        filePath
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 大更改 - 使用摘要差异</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSummaryDiff</span><span class="token punctuation">(</span>
        oldContent<span class="token punctuation">,</span>
        newContent<span class="token punctuation">,</span>
        filePath
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateContextSnippet</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> EditOperation<span class="token punctuation">,</span>
    result<span class="token operator">:</span> EditResult
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> newContent<span class="token punctuation">,</span> changedRanges <span class="token punctuation">&#125;</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
    <span class="token keyword">const</span> lines <span class="token operator">=</span> newContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> snippets<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> range <span class="token keyword">of</span> changedRanges<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> range<span class="token punctuation">.</span>start <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>lines<span class="token punctuation">.</span>length<span class="token punctuation">,</span> range<span class="token punctuation">.</span>end <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> snippet <span class="token operator">=</span> lines
        <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> lineNum <span class="token operator">=</span> start <span class="token operator">+</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> isChanged <span class="token operator">=</span> lineNum <span class="token operator">>=</span> range<span class="token punctuation">.</span>start <span class="token operator">&amp;&amp;</span> lineNum <span class="token operator">&lt;=</span> range<span class="token punctuation">.</span>end<span class="token punctuation">;</span>
          <span class="token keyword">const</span> prefix <span class="token operator">=</span> isChanged <span class="token operator">?</span> <span class="token string">'>'</span> <span class="token operator">:</span> <span class="token string">' '</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>prefix<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>lineNum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>line<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      snippets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>snippet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 限制总片段大小</span>
    <span class="token keyword">const</span> combined <span class="token operator">=</span> snippets<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n...\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>combined<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> combined<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\\n... (截断)'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> combined<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateUnifiedDiff</span><span class="token punctuation">(</span>
    oldContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> DiffOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> oldLines <span class="token operator">=</span> oldContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newLines <span class="token operator">=</span> newContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用Myers差异算法</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyersDiff</span><span class="token punctuation">(</span>oldLines<span class="token punctuation">,</span> newLines<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hunks <span class="token operator">=</span> diff<span class="token punctuation">.</span><span class="token function">getHunks</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 格式化为统一差异</span>
    <span class="token keyword">const</span> header <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filePath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\t(编辑前)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+++ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filePath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\t(编辑后)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">''</span>
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> formattedHunks <span class="token operator">=</span> hunks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>hunk <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> range <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@@ -</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hunk<span class="token punctuation">.</span>oldStart<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hunk<span class="token punctuation">.</span>oldLength<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hunk<span class="token punctuation">.</span>newStart<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hunk<span class="token punctuation">.</span>newLength<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> @@</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> lines <span class="token operator">=</span> hunk<span class="token punctuation">.</span>lines<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">case</span> <span class="token string">'unchanged'</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>line<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'deleted'</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>line<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'added'</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>line<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">[</span>range<span class="token punctuation">,</span> <span class="token operator">...</span>lines<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> header <span class="token operator">+</span> formattedHunks<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="特殊情况和边缘条件"><a href="#特殊情况和边缘条件" class="headerlink" title="特殊情况和边缘条件"></a>特殊情况和边缘条件</h2><p>文件编辑必须处理许多边缘情况：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">EdgeCaseHandlers</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 空文件处理</span>
  <span class="token keyword">static</span> <span class="token function">handleEmptyFile</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> EditOperation<span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> HandlerResult <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'edit'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          error<span class="token operator">:</span> <span class="token string">'无法编辑空文件。使用WriteTool添加内容。'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// ReadTool的特殊反馈</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        warning<span class="token operator">:</span> <span class="token string">'&lt;system-reminder>警告：文件存在但内容为空。&lt;/system-reminder>'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 二进制文件检测</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">detectBinaryFile</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> Buffer
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查空字节（二进制文件中常见）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查文件扩展名</span>
    <span class="token keyword">const</span> binaryExtensions <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.gif'</span><span class="token punctuation">,</span> <span class="token string">'.pdf'</span><span class="token punctuation">,</span> <span class="token string">'.zip'</span><span class="token punctuation">,</span>
      <span class="token string">'.exe'</span><span class="token punctuation">,</span> <span class="token string">'.dll'</span><span class="token punctuation">,</span> <span class="token string">'.so'</span><span class="token punctuation">,</span> <span class="token string">'.dylib'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>binaryExtensions<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 使用文件魔数</span>
    <span class="token keyword">const</span> magicNumbers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">'png'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x4E</span><span class="token punctuation">,</span> <span class="token number">0x47</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">'jpg'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xD8</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">'pdf'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x25</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">'zip'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x4B</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>type<span class="token punctuation">,</span> magic<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>magicNumbers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bufferStartsWith</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> magic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 符号链接处理</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">handleSymlink</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    operation<span class="token operator">:</span> FileOperation
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>SymlinkResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">lstat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stats<span class="token punctuation">.</span><span class="token function">isSymbolicLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> isSymlink<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readlink</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedTarget <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 检查目标是否存在</span>
      <span class="token keyword">const</span> targetExists <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>resolvedTarget<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetExists <span class="token operator">&amp;&amp;</span> operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'read'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          isSymlink<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">损坏的符号链接：指向不存在的</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 对于编辑操作，提供选择</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'edit'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          isSymlink<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          warning<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">这是指向</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">的符号链接。编辑将修改目标文件。</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          target<span class="token operator">:</span> resolvedTarget
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        isSymlink<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        target<span class="token operator">:</span> resolvedTarget
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> isSymlink<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 编码检测和处理</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">detectEncoding</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    buffer<span class="token operator">:</span> Buffer
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>EncodingInfo<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查BOM</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xEF</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xBB</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xBF</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xFF</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xFE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf16le'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xFE</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf16be'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 尝试UTF-8</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> decoded <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 检查替换字符</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>decoded<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'\\ufffd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token comment">// 回退启发式</span>
    <span class="token keyword">const</span> nullBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">=></span> b <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> highBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">=></span> b <span class="token operator">></span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nullBytes <span class="token operator">></span> buffer<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'binary'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>highBytes <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'ascii'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 默认为utf8并附带警告</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
      hasBOM<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      warning<span class="token operator">:</span> <span class="token string">'编码不确定，假设为UTF-8'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>大规模文件编辑需要仔细优化：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FileEditingPerformance</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 大文件的缓存策略</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> chunkCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ChunkedFile<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">readLargeFile</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> ReadOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>FileContent<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 对超过10MB的文件使用流式处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">streamRead</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 对1-10MB的文件使用分块缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">chunkedRead</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 小文件直接读取</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">directRead</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">chunkedRead</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> ReadOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>FileContent<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> cached <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">&amp;&amp;</span> cached<span class="token punctuation">.</span>mtime <span class="token operator">===</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mtimeMs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 使用缓存块</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assembleFromChunks</span><span class="token punctuation">(</span>cached<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 分块读取</span>
    <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 256KB块</span>
    <span class="token keyword">const</span> chunks<span class="token operator">:</span> Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      highWaterMark<span class="token operator">:</span> chunkSize
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 缓存以备将来使用</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>chunkCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      chunks<span class="token punctuation">,</span>
      mtime<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mtimeMs<span class="token punctuation">,</span>
      encoding<span class="token operator">:</span> <span class="token string">'utf8'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assembleFromChunks</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> chunks <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 批量编辑准备</span>
  <span class="token keyword">static</span> <span class="token function">prepareBatchEdits</span><span class="token punctuation">(</span>
    edits<span class="token operator">:</span> Edit<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> PreparedBatch <span class="token punctuation">&#123;</span>
    <span class="token comment">// 预计算所有位置</span>
    <span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> edit <span class="token keyword">of</span> edits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>positions<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>edit<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        positions<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
          edit<span class="token punctuation">.</span>old_string<span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findAllPositions</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> edit<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 按位置排序编辑（逆序以安全应用）</span>
    <span class="token keyword">const</span> sortedEdits <span class="token operator">=</span> edits
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>edit <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        edit<span class="token punctuation">,</span>
        position<span class="token operator">:</span> positions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>edit<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>position <span class="token operator">-</span> a<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      edits<span class="token operator">:</span> sortedEdits<span class="token punctuation">,</span>
      positions<span class="token punctuation">,</span>
      canApplyInReverse<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 内存高效差异生成</span>
  <span class="token keyword">static</span> <span class="token operator">*</span><span class="token function">generateStreamingDiff</span><span class="token punctuation">(</span>
    oldContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newContent<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Generator<span class="token operator">&lt;</span>DiffChunk<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> oldLines <span class="token operator">=</span> oldContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newLines <span class="token operator">=</span> newContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 对大文件使用滑动窗口</span>
    <span class="token keyword">const</span> windowSize <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">&lt;</span> oldLines<span class="token punctuation">.</span>length <span class="token operator">||</span> newIndex <span class="token operator">&lt;</span> newLines<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> oldWindow <span class="token operator">=</span> oldLines<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>oldIndex<span class="token punctuation">,</span> oldIndex <span class="token operator">+</span> windowSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> newWindow <span class="token operator">=</span> newLines<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>newIndex<span class="token punctuation">,</span> newIndex <span class="token operator">+</span> windowSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">computeWindowDiff</span><span class="token punctuation">(</span>
        oldWindow<span class="token punctuation">,</span>
        newWindow<span class="token punctuation">,</span>
        oldIndex<span class="token punctuation">,</span>
        newIndex
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">yield</span> diff<span class="token punctuation">;</span>

      oldIndex <span class="token operator">+=</span> diff<span class="token punctuation">.</span>oldConsumed<span class="token punctuation">;</span>
      newIndex <span class="token operator">+=</span> diff<span class="token punctuation">.</span>newConsumed<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能特征</strong>：</p>
<table>
<thead>
<tr>
<th>文件大小</th>
<th>操作</th>
<th>方法</th>
<th>时间</th>
<th>内存</th>
</tr>
</thead>
<tbody><tr>
<td>&lt;100KB</td>
<td>读取</td>
<td>直接</td>
<td>&lt;5ms</td>
<td>O(n)</td>
</tr>
<tr>
<td>100KB-1MB</td>
<td>读取</td>
<td>直接</td>
<td>5-20ms</td>
<td>O(n)</td>
</tr>
<tr>
<td>1-10MB</td>
<td>读取</td>
<td>分块</td>
<td>20-100ms</td>
<td>O(chunk)</td>
</tr>
<tr>
<td>&gt;10MB</td>
<td>读取</td>
<td>流式</td>
<td>100ms+</td>
<td>O(1)</td>
</tr>
<tr>
<td>任何</td>
<td>编辑（单个）</td>
<td>内存中</td>
<td>&lt;10ms</td>
<td>O(n)</td>
</tr>
<tr>
<td>任何</td>
<td>编辑（多个）</td>
<td>顺序</td>
<td>&lt;50ms</td>
<td>O(n)</td>
</tr>
<tr>
<td>任何</td>
<td>写入</td>
<td>直接</td>
<td>&lt;20ms</td>
<td>O(n)</td>
</tr>
</tbody></table>
<h2 id="常见失败模式和恢复"><a href="#常见失败模式和恢复" class="headerlink" title="常见失败模式和恢复"></a>常见失败模式和恢复</h2><p>理解常见失败有助于构建健壮的编辑：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FailureRecovery</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 外部修改冲突</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">handleExternalModification</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    cachedState<span class="token operator">:</span> FileState<span class="token punctuation">,</span>
    operation<span class="token operator">:</span> EditOperation
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RecoveryStrategy<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> currentContent <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentStats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 尝试三向合并</span>
    <span class="token keyword">const</span> mergeResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attemptThreeWayMerge</span><span class="token punctuation">(</span>
      cachedState<span class="token punctuation">.</span>content<span class="token punctuation">,</span>    <span class="token comment">// 基础</span>
      operation<span class="token punctuation">.</span>newContent<span class="token punctuation">,</span>   <span class="token comment">// 我们的</span>
      currentContent         <span class="token comment">// 他们的</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeResult<span class="token punctuation">.</span>success <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mergeResult<span class="token punctuation">.</span>conflicts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        strategy<span class="token operator">:</span> <span class="token string">'auto_merge'</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> mergeResult<span class="token punctuation">.</span>merged<span class="token punctuation">,</span>
        warning<span class="token operator">:</span> <span class="token string">'文件已被外部修改。更改已合并。'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 生成冲突标记</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeResult<span class="token punctuation">.</span>conflicts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        strategy<span class="token operator">:</span> <span class="token string">'conflict_markers'</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> mergeResult<span class="token punctuation">.</span>conflictMarked<span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'检测到合并冲突。需要手动解决。'</span><span class="token punctuation">,</span>
        conflicts<span class="token operator">:</span> mergeResult<span class="token punctuation">.</span>conflicts
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 回退：显示差异并询问</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      strategy<span class="token operator">:</span> <span class="token string">'user_decision'</span><span class="token punctuation">,</span>
      error<span class="token operator">:</span> <span class="token string">'文件被外部修改'</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'覆盖外部更改'</span><span class="token punctuation">,</span>
        <span class="token string">'中止编辑'</span><span class="token punctuation">,</span>
        <span class="token string">'再次读取文件'</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      diff<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>cachedState<span class="token punctuation">.</span>content<span class="token punctuation">,</span> currentContent<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 编码问题</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">handleEncodingError</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    error<span class="token operator">:</span> Error<span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RecoveryStrategy<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 尝试不同编码</span>
    <span class="token keyword">const</span> encodings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token string">'latin1'</span><span class="token punctuation">,</span> <span class="token string">'utf16le'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> encoding <span class="token keyword">of</span> encodings<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> encoding <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> <span class="token string">'.test'</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> <span class="token string">'.test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          strategy<span class="token operator">:</span> <span class="token string">'alternate_encoding'</span><span class="token punctuation">,</span>
          encoding<span class="token punctuation">,</span>
          warning<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">使用</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>encoding<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">编码而不是UTF-8</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 二进制回退</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      strategy<span class="token operator">:</span> <span class="token string">'binary_write'</span><span class="token punctuation">,</span>
      warning<span class="token operator">:</span> <span class="token string">'视为二进制文件'</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 磁盘空间问题</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">handleDiskSpaceError</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    requiredBytes<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RecoveryStrategy<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> diskInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDiskInfo</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>diskInfo<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">available</span> <span class="token generic class-name"><span class="token operator">&lt;</span> requiredBytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 计算可以释放什么</span>
      <span class="token keyword">const</span> suggestions <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyzeDiskUsage</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        strategy<span class="token operator">:</span> <span class="token string">'free_space'</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">磁盘空间不足。需要</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatBytes</span><span class="token punctuation">(</span>requiredBytes<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">，</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">有</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatBytes</span><span class="token punctuation">(</span>diskInfo<span class="token punctuation">.</span>available<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        suggestions<span class="token operator">:</span> suggestions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">=></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          path<span class="token operator">:</span> s<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
          size<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatBytes</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span>
          type<span class="token operator">:</span> s<span class="token punctuation">.</span>type
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 可能是配额问题</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      strategy<span class="token operator">:</span> <span class="token string">'quota_check'</span><span class="token punctuation">,</span>
      error<span class="token operator">:</span> <span class="token string">'尽管有可用空间但写入失败。检查磁盘配额。'</span><span class="token punctuation">,</span>
      command<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">quota -v </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">USER</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 部分写入恢复</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">recoverPartialWrite</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    expectedSize<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RecoveryResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>size <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 完全失败 - 检查备份</span>
        <span class="token keyword">const</span> backupPath <span class="token operator">=</span> filePath <span class="token operator">+</span> <span class="token string">'.backup'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>backupPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>backupPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            recovered<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            method<span class="token operator">:</span> <span class="token string">'backup_restore'</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> expectedSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 部分写入 - 检查临时文件</span>
        <span class="token keyword">const</span> tempPath <span class="token operator">=</span> filePath <span class="token operator">+</span> <span class="token string">'.tmp'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> tempStats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tempStats<span class="token punctuation">.</span>size <span class="token operator">===</span> expectedSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
              recovered<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              method<span class="token operator">:</span> <span class="token string">'temp_file_restore'</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        recovered<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        partialSize<span class="token operator">:</span> stats<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        expectedSize
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        recovered<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> error<span class="token punctuation">.</span>message
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档深入分析了Claude Code的文件编辑架构，揭示了AI辅助代码修改背后的精密设计。通过反编译和逆向工程分析，文档详细展示了Claude Code如何通过多层验证、智能冲突检测和原子操作来确保文件编辑的安全性和可靠性。</p>
<h2 id="核心架构特点"><a href="#核心架构特点" class="headerlink" title="核心架构特点"></a>核心架构特点</h2><h3 id="1-四阶段编辑管道"><a href="#1-四阶段编辑管道" class="headerlink" title="1. 四阶段编辑管道"></a>1. 四阶段编辑管道</h3><ul>
<li><strong>阶段1：验证</strong> - 路径、权限、文件状态检查</li>
<li><strong>阶段2：准备</strong> - 编辑前预处理和状态获取</li>
<li><strong>阶段3：应用</strong> - 执行实际的文件修改</li>
<li><strong>阶段4：验证</strong> - 编辑后的验证和反馈生成</li>
<li><strong>优势</strong>：确保每个编辑操作都经过严格的检查和验证流程</li>
</ul>
<h3 id="2-行号问题的解决方案"><a href="#2-行号问题的解决方案" class="headerlink" title="2. 行号问题的解决方案"></a>2. 行号问题的解决方案</h3><ul>
<li><strong>挑战识别</strong>：LLM容易在old_string中包含行号前缀</li>
<li><strong>检测机制</strong>：正则表达式匹配<code>/^\d+\t/</code>模式</li>
<li><strong>智能建议</strong>：自动去除行号并提供修正建议</li>
<li><strong>预防策略</strong>：通过广泛指令和示例引导正确使用</li>
</ul>
<h3 id="3-EditTool：手术级精度编辑"><a href="#3-EditTool：手术级精度编辑" class="headerlink" title="3. EditTool：手术级精度编辑"></a>3. EditTool：手术级精度编辑</h3><ul>
<li><strong>精确匹配</strong>：基于字符串出现次数的严格验证</li>
<li><strong>外部修改检测</strong>：通过文件修改时间戳防止并发冲突</li>
<li><strong>替换限制</strong>：expected_replacements参数防止意外替换</li>
<li><strong>格式保持</strong>：保留原始文件的编码和行结尾格式</li>
</ul>
<h3 id="4-MultiEditTool：原子批量操作"><a href="#4-MultiEditTool：原子批量操作" class="headerlink" title="4. MultiEditTool：原子批量操作"></a>4. MultiEditTool：原子批量操作</h3><ul>
<li><strong>冲突检测</strong>：<ul>
<li>依赖关系检测（后续编辑修改前面编辑的结果）</li>
<li>重叠检测（编辑影响相同文本区域）</li>
<li>矛盾检测（相同目标的不同替换）</li>
</ul>
</li>
<li><strong>原子性保证</strong>：要么全部成功，要么全部失败</li>
<li><strong>顺序验证</strong>：逐步验证每个编辑在当前状态下的有效性</li>
</ul>
<h3 id="5-WriteTool：完整文件操作"><a href="#5-WriteTool：完整文件操作" class="headerlink" title="5. WriteTool：完整文件操作"></a>5. WriteTool：完整文件操作</h3><ul>
<li><strong>安全机制</strong>：<ul>
<li>现有文件必须先读取才能覆盖</li>
<li>外部修改时间戳验证</li>
<li>文档文件创建限制</li>
</ul>
</li>
<li><strong>格式保持</strong>：智能检测和保留原始文件的编码、行结尾、权限</li>
<li><strong>目录创建</strong>：自动创建不存在的目录结构</li>
</ul>
<h2 id="深度防御验证体系"><a href="#深度防御验证体系" class="headerlink" title="深度防御验证体系"></a>深度防御验证体系</h2><h3 id="五层验证架构"><a href="#五层验证架构" class="headerlink" title="五层验证架构"></a>五层验证架构</h3><ol>
<li><p><strong>路径验证</strong>：</p>
<ul>
<li>绝对路径要求</li>
<li>路径遍历攻击防护</li>
<li>边界检查（项目根目录限制）</li>
<li>敏感文件保护（.git、.ssh等）</li>
</ul>
</li>
<li><p><strong>权限检查</strong>：</p>
<ul>
<li>多层权限规则评估</li>
<li>用户交互式确认</li>
<li>操作类型权限映射</li>
</ul>
</li>
<li><p><strong>文件状态验证</strong>：</p>
<ul>
<li>缓存状态一致性检查</li>
<li>外部修改检测</li>
<li>文件存在性验证</li>
</ul>
</li>
<li><p><strong>内容验证</strong>：</p>
<ul>
<li>编辑内容合理性检查</li>
<li>无操作检测</li>
<li>特殊字符处理</li>
</ul>
</li>
<li><p><strong>安全检查</strong>：</p>
<ul>
<li>恶意代码检测</li>
<li>危险操作识别</li>
<li>系统安全边界检查</li>
</ul>
</li>
</ol>
<h2 id="差异生成和反馈系统"><a href="#差异生成和反馈系统" class="headerlink" title="差异生成和反馈系统"></a>差异生成和反馈系统</h2><h3 id="智能差异策略"><a href="#智能差异策略" class="headerlink" title="智能差异策略"></a>智能差异策略</h3><ul>
<li><strong>小更改（&lt;10%）</strong>：统一差异格式，5行上下文</li>
<li><strong>中等更改（10-50%）</strong>：单词级差异</li>
<li><strong>大更改（&gt;50%）</strong>：摘要差异格式</li>
<li><strong>上下文片段</strong>：围绕更改区域的5行上下文，最大1000字符</li>
</ul>
<h3 id="反馈机制"><a href="#反馈机制" class="headerlink" title="反馈机制"></a>反馈机制</h3><ul>
<li><strong>实时差异显示</strong>：Myers算法的高效实现</li>
<li><strong>上下文高亮</strong>：更改行的特殊标记</li>
<li><strong>统计信息</strong>：替换次数、更改大小等</li>
</ul>
<h2 id="边缘情况处理"><a href="#边缘情况处理" class="headerlink" title="边缘情况处理"></a>边缘情况处理</h2><h3 id="特殊文件类型"><a href="#特殊文件类型" class="headerlink" title="特殊文件类型"></a>特殊文件类型</h3><ol>
<li><p><strong>空文件</strong>：</p>
<ul>
<li>编辑操作被拒绝，建议使用WriteTool</li>
<li>ReadTool返回特殊系统提醒</li>
</ul>
</li>
<li><p><strong>二进制文件</strong>：</p>
<ul>
<li>空字节检测（前8KB）</li>
<li>文件扩展名检查</li>
<li>文件魔数验证（PNG、JPG、PDF等）</li>
</ul>
</li>
<li><p><strong>符号链接</strong>：</p>
<ul>
<li>目标存在性验证</li>
<li>损坏链接检测</li>
<li>编辑操作的明确警告</li>
</ul>
</li>
<li><p><strong>编码检测</strong>：</p>
<ul>
<li>BOM检测（UTF-8、UTF-16）</li>
<li>编码回退策略（UTF-8 → Latin1 → UTF-16）</li>
<li>编码不确定的警告机制</li>
</ul>
</li>
</ol>
<h2 id="性能优化策略"><a href="#性能优化策略" class="headerlink" title="性能优化策略"></a>性能优化策略</h2><h3 id="大文件处理"><a href="#大文件处理" class="headerlink" title="大文件处理"></a>大文件处理</h3><ul>
<li><strong>文件大小分级</strong>：<ul>
<li>&lt;100KB：直接读取（&lt;5ms）</li>
<li>100KB-1MB：直接读取（5-20ms）</li>
<li>1-10MB：分块缓存（20-100ms）</li>
<li><blockquote>
<p>10MB：流式处理（100ms+）</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h3><ul>
<li><strong>分块缓存</strong>：256KB块大小，基于修改时间的失效</li>
<li><strong>文件状态缓存</strong>：WeakRef + FinalizationRegistry自动清理</li>
<li><strong>预计算优化</strong>：批量编辑的位置预计算</li>
</ul>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><ul>
<li><strong>流式差异生成</strong>：滑动窗口算法，1000行窗口</li>
<li><strong>块大小优化</strong>：64KB读写块，块间垃圾回收</li>
<li><strong>O(1)内存复杂度</strong>：大文件的恒定内存占用</li>
</ul>
<h2 id="故障恢复机制"><a href="#故障恢复机制" class="headerlink" title="故障恢复机制"></a>故障恢复机制</h2><h3 id="外部修改冲突"><a href="#外部修改冲突" class="headerlink" title="外部修改冲突"></a>外部修改冲突</h3><ul>
<li><strong>三向合并</strong>：基础版本、我们的更改、他们的更改</li>
<li><strong>冲突标记</strong>：标准Git冲突格式</li>
<li><strong>用户决策</strong>：覆盖、中止、重新读取选项</li>
</ul>
<h3 id="编码问题恢复"><a href="#编码问题恢复" class="headerlink" title="编码问题恢复"></a>编码问题恢复</h3><ul>
<li><strong>编码尝试序列</strong>：UTF-8 → Latin1 → UTF-16LE</li>
<li><strong>二进制回退</strong>：作为二进制文件处理</li>
<li><strong>测试写入</strong>：验证编码可用性</li>
</ul>
<h3 id="磁盘空间问题"><a href="#磁盘空间问题" class="headerlink" title="磁盘空间问题"></a>磁盘空间问题</h3><ul>
<li><strong>空间分析</strong>：可用空间检查和使用分析</li>
<li><strong>清理建议</strong>：可删除文件的建议列表</li>
<li><strong>配额检查</strong>：磁盘配额问题的检测</li>
</ul>
<h3 id="部分写入恢复"><a href="#部分写入恢复" class="headerlink" title="部分写入恢复"></a>部分写入恢复</h3><ul>
<li><strong>备份恢复</strong>：.backup文件的自动恢复</li>
<li><strong>临时文件恢复</strong>：.tmp文件的完整性检查</li>
<li><strong>大小验证</strong>：期望大小与实际大小的比较</li>
</ul>
<h2 id="技术创新点"><a href="#技术创新点" class="headerlink" title="技术创新点"></a>技术创新点</h2><h3 id="架构创新"><a href="#架构创新" class="headerlink" title="架构创新"></a>架构创新</h3><ol>
<li><strong>原子操作保证</strong>：MultiEditTool的全有或全无机制</li>
<li><strong>行号智能处理</strong>：自动检测和修正LLM的常见错误</li>
<li><strong>五层验证体系</strong>：深度防御的安全架构</li>
<li><strong>差异生成优化</strong>：基于更改大小的自适应策略</li>
</ol>
<h3 id="性能创新"><a href="#性能创新" class="headerlink" title="性能创新"></a>性能创新</h3><ol>
<li><strong>分级文件处理</strong>：根据文件大小的不同处理策略</li>
<li><strong>分块缓存机制</strong>：大文件的高效缓存策略</li>
<li><strong>流式差异算法</strong>：内存友好的大文件差异计算</li>
<li><strong>批量编辑优化</strong>：位置预计算和逆序应用</li>
</ol>
<h3 id="安全创新"><a href="#安全创新" class="headerlink" title="安全创新"></a>安全创新</h3><ol>
<li><strong>时间戳验证</strong>：防止外部修改冲突</li>
<li><strong>路径安全验证</strong>：多层次的路径安全检查</li>
<li><strong>敏感文件保护</strong>：系统关键文件的自动保护</li>
<li><strong>权限分层管理</strong>：基于操作类型的权限控制</li>
</ol>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><ol>
<li><strong>错误恢复机制</strong>：全面的故障处理和恢复策略</li>
<li><strong>格式保持机制</strong>：编码、行结尾、权限的智能保持</li>
<li><strong>反馈系统设计</strong>：丰富的编辑反馈和差异显示</li>
<li><strong>边缘情况覆盖</strong>：全面的特殊场景处理</li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Claude Code的文件编辑架构体现了现代软件工程的最佳实践，通过精密的验证机制、智能的冲突检测和可靠的原子操作，实现了既安全又高效的AI辅助代码修改功能。其核心价值在于：</p>
<ul>
<li><strong>安全性</strong>：多层验证确保文件操作的安全性</li>
<li><strong>可靠性</strong>：原子操作和冲突检测保证编辑的一致性</li>
<li><strong>性能</strong>：分级处理和缓存优化确保大文件的高效处理</li>
<li><strong>用户友好</strong>：智能的错误恢复和丰富的反馈机制</li>
</ul>
<p>这种复杂的文件编辑架构为AI辅助编程提供了优秀的技术参考，特别是在需要处理复杂文件操作、保证数据完整性和提供优秀用户体验的场景中。文档的深入分析为理解现代AI系统的文件操作设计提供了宝贵的技术指导。</p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/10/23/claude-code-ti-shi-ci-gong-cheng-zhi-dao-ai-de-yi-zhu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="claude-code提示词工程-指导AI的艺术">
                        
                        <span class="card-title">claude-code提示词工程-指导AI的艺术</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-10-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            寒霜
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/10/23/claude-code-xin-ying-de-zu-jian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="claude-code新颖的组件">
                        
                        <span class="card-title">claude-code新颖的组件</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-10-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            寒霜
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('6'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            <!-- Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
             -->
            <!-- <a href="/about" target="_blank">寒霜</a> -->
            <!-- |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
             -->
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">141.7k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
