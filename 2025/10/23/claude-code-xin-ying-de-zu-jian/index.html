<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="claude-code新颖的组件, 我的博客">
    <meta name="description" content="参考链接
Novel Components: The Innovations That Define Claude Code新颖组件：定义Claude Code的创新graph TB
    subgraph &#34;流式处理挑战&#34;
      ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>claude-code新颖的组件 | 我的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">我的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">我的博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">claude-code新颖的组件</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-10-23
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-10-24
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    9.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    47 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><a target="_blank" rel="noopener" href="https://southbridge-research.notion.site/Novel-Components-The-Innovations-That-Define-Claude-Code-2055fec70db181fdae5bd485823986c4">参考链接</a></p>
<h1 id="Novel-Components-The-Innovations-That-Define-Claude-Code"><a href="#Novel-Components-The-Innovations-That-Define-Claude-Code" class="headerlink" title="Novel Components: The Innovations That Define Claude Code"></a>Novel Components: The Innovations That Define Claude Code</h1><h1 id="新颖组件：定义Claude-Code的创新"><a href="#新颖组件：定义Claude-Code的创新" class="headerlink" title="新颖组件：定义Claude Code的创新"></a>新颖组件：定义Claude Code的创新</h1><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TB
    <span class="token keyword">subgraph</span> <span class="token string">"流式处理挑战"</span>
        PartialJSON<span class="token text string">[部分JSON流]</span>
        PartialXML<span class="token text string">[部分XML流]</span>
        Progress<span class="token text string">[并发进度]</span>

        PartialJSON <span class="token arrow operator">--></span> Parser1<span class="token text string">[流式JSON解析器]</span>
        PartialXML <span class="token arrow operator">--></span> Parser2<span class="token text string">[自定义XML解析器]</span>
        Progress <span class="token arrow operator">--></span> Aggregator<span class="token text string">[进度聚合器]</span>
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"数据挑战"</span>
        LargeObjects<span class="token text string">[大型对象]</span>
        Circular<span class="token text string">[循环引用]</span>
        TypedData<span class="token text string">[特殊类型]</span>

        LargeObjects <span class="token arrow operator">--></span> Normalizer<span class="token text string">[normalizeToSize]</span>
        Circular <span class="token arrow operator">--></span> Normalizer
        TypedData <span class="token arrow operator">--></span> Normalizer
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"LLM挑战"</span>
        Errors<span class="token text string">[工具错误]</span>
        Context<span class="token text string">[动态上下文]</span>
        Synthesis<span class="token text string">[多结果]</span>

        Errors <span class="token arrow operator">--></span> Formatter<span class="token text string">[错误格式化器]</span>
        Context <span class="token arrow operator">--></span> Assembler<span class="token text string">[上下文组装器]</span>
        Synthesis <span class="token arrow operator">--></span> Synthesizer<span class="token text string">[AgentTool合成器]</span>
    <span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2025/10/23/claude-code-xin-ying-de-zu-jian/1.svg" class="">
<h2 id="The-Streaming-JSON-Parser-Handling-LLM’s-Partial-Thoughts"><a href="#The-Streaming-JSON-Parser-Handling-LLM’s-Partial-Thoughts" class="headerlink" title="The Streaming JSON Parser: Handling LLM’s Partial Thoughts"></a>The Streaming JSON Parser: Handling LLM’s Partial Thoughts</h2><h2 id="流式JSON解析器：处理LLM的部分思维"><a href="#流式JSON解析器：处理LLM的部分思维" class="headerlink" title="流式JSON解析器：处理LLM的部分思维"></a>流式JSON解析器：处理LLM的部分思维</h2><p>When an LLM streams a tool use request, it doesn’t send complete JSON all at once. Instead, you might receive fragments like:<br>当LLM流式传输工具使用请求时，它不会一次性发送完整的JSON。相反，您可能会收到如下片段：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;file_path&quot;: &quot;&#x2F;src&#x2F;
&#123;&quot;file_path&quot;: &quot;&#x2F;src&#x2F;main.
&#123;&quot;file_path&quot;: &quot;&#x2F;src&#x2F;main.ts&quot;, &quot;old_str
&#123;&quot;file_path&quot;: &quot;&#x2F;src&#x2F;main.ts&quot;, &quot;old_string&quot;: &quot;console.log(&#39;hell
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>The streaming JSON parser solves this elegantly:<br>流式JSON解析器优雅地解决了这个问题：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">StreamingToolInputParser</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> buffer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> state <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    depth<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>           <span class="token comment">// &#123;&#125;/[]的嵌套级别</span>
    inString<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>  <span class="token comment">// 当前在字符串内吗？</span>
    escape<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>    <span class="token comment">// 前一个字符是反斜杠吗？</span>
    stringChar<span class="token operator">:</span> <span class="token string">'"'</span> <span class="token operator">|</span> <span class="token string">"'"</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token comment">// 哪个引号开始当前字符串</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token function">addChunk</span><span class="token punctuation">(</span>chunk<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ParseResult <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">+=</span> chunk<span class="token punctuation">;</span>

    <span class="token comment">// 逐字符更新解析器状态</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> char <span class="token operator">=</span> chunk<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> prevChar <span class="token operator">=</span> i <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> chunk<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>length <span class="token operator">-</span> chunk<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 处理转义序列</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>escape<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>escape <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\\\\'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>inString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>escape <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 字符串边界检测</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>inString <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'"'</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>inString <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>stringChar <span class="token operator">=</span> char<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>inString <span class="token operator">&amp;&amp;</span> char <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>stringChar<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>inString <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>stringChar <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 在字符串外跟踪嵌套深度</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>inString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'&#123;'</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">'['</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>depth<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'&#125;'</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">']'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>depth<span class="token operator">--</span><span class="token punctuation">;</span>

          <span class="token comment">// 当我们返回到深度0时尝试解析</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>depth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryParse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 即使没有深度0也可能完成（格式错误的JSON）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 安全限制</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryParseWithRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> complete<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">tryParse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ParseResult <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> complete<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token operator">:</span> parsed <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> complete<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> partial<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">tryParseWithRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ParseResult <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> attemptBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>

    <span class="token comment">// 恢复策略1：关闭未闭合的字符串</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>inString <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>stringChar<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      attemptBuffer <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>stringChar<span class="token punctuation">;</span>

      <span class="token comment">// 尝试关闭任何未闭合的结构</span>
      attemptBuffer <span class="token operator">+=</span> <span class="token string">'&#125;'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>depth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      attemptBuffer <span class="token operator">+=</span> <span class="token string">']'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>
        Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>attemptBuffer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token operator">/</span>\\<span class="token punctuation">[</span><span class="token operator">/</span>g<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span>
                    <span class="token punctuation">(</span>attemptBuffer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 恢复策略2：基于结构分析自动关闭</span>
    <span class="token keyword">const</span> braceBalance <span class="token operator">=</span> <span class="token punctuation">(</span>attemptBuffer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&#123;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span>
                        <span class="token punctuation">(</span>attemptBuffer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&#125;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> bracketBalance <span class="token operator">=</span> <span class="token punctuation">(</span>attemptBuffer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token operator">/</span>\\<span class="token punctuation">[</span><span class="token operator">/</span>g<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span>
                          <span class="token punctuation">(</span>attemptBuffer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    attemptBuffer <span class="token operator">+=</span> <span class="token string">'&#125;'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> braceBalance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    attemptBuffer <span class="token operator">+=</span> <span class="token string">']'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bracketBalance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>attemptBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        complete<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> parsed<span class="token punctuation">,</span>
        wasRepaired<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        repairs<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          closedStrings<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>inString<span class="token punctuation">,</span>
          addedBraces<span class="token operator">:</span> braceBalance<span class="token punctuation">,</span>
          addedBrackets<span class="token operator">:</span> bracketBalance
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 恢复策略3：提取我们能获取的内容</span>
      <span class="token keyword">const</span> partialResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">extractPartialData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        complete<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        partial<span class="token operator">:</span> partialResult<span class="token punctuation">,</span>
        error<span class="token operator">:</span> e<span class="token punctuation">.</span>message
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">extractPartialData</span><span class="token punctuation">(</span>buffer<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 尝试提取完整的键值对</span>
    <span class="token keyword">const</span> result<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> keyValuePattern <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">"(\\w+)":\\s*("([^"\\\\]*(\\\\.[^"\\\\]*)*)"|true|false|null|\\d+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> match<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> keyValuePattern<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> match<span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span> <span class="token comment">// 如果解析失败，存储为字符串</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> result <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Is Novel</strong>:<br><strong>为什么这是新颖的</strong>：</p>
<ul>
<li>Traditional JSON parsers fail on incomplete input<br>传统的JSON解析器在输入不完整时会失败</li>
<li>This parser provides progressive parsing with meaningful partial results<br>此解析器提供渐进式解析，能够生成有意义的部分结果</li>
<li>Recovery strategies handle common LLM streaming issues<br>恢复策略处理常见的LLM流式传输问题</li>
<li>Enables responsive UI that shows tool inputs as they stream<br>支持响应式UI，能够实时显示流式传输的工具输入</li>
</ul>
<p><strong>Performance Characteristics</strong>:<br><strong>性能特征</strong>：</p>
<table>
<thead>
<tr>
<th>Input Size</th>
<th>Parse Time</th>
<th>Memory</th>
<th>Success Rate</th>
</tr>
</thead>
<tbody><tr>
<td>输入大小</td>
<td>解析时间</td>
<td>内存</td>
<td>成功率</td>
</tr>
<tr>
<td>&lt;1KB</td>
<td>&lt;0.1ms</td>
<td>O(n)</td>
<td>100%</td>
</tr>
<tr>
<td>1-10KB</td>
<td>0.1-1ms</td>
<td>O(n)</td>
<td>99.9%</td>
</tr>
<tr>
<td>10-100KB</td>
<td>1-10ms</td>
<td>O(n)</td>
<td>99.5%</td>
</tr>
<tr>
<td>&gt;100KB</td>
<td>10-50ms</td>
<td>O(n)</td>
<td>98% (带恢复)</td>
</tr>
</tbody></table>
<h2 id="The-normalizeToSize-Algorithm-Smart-Data-Truncation"><a href="#The-normalizeToSize-Algorithm-Smart-Data-Truncation" class="headerlink" title="The normalizeToSize Algorithm: Smart Data Truncation"></a>The <code>normalizeToSize</code> Algorithm: Smart Data Truncation</h2><h2 id="normalizeToSize算法：智能数据截断"><a href="#normalizeToSize算法：智能数据截断" class="headerlink" title="normalizeToSize算法：智能数据截断"></a><code>normalizeToSize</code>算法：智能数据截断</h2><p>When sending data to LLMs or telemetry services, size limits are critical. The <code>normalizeToSize</code> algorithm intelligently reduces object size while preserving structure:<br>当向LLM或遥测服务发送数据时，大小限制至关重要。<code>normalizeToSize</code>算法智能地减少对象大小，同时保持结构：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">DataNormalizer</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token function">normalizeToSize</span><span class="token punctuation">(</span>
    obj<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    maxDepth<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    maxSizeInBytes<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">100_000</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 首先尝试完整深度</span>
    <span class="token keyword">let</span> normalized <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> maxDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">estimateSize</span><span class="token punctuation">(</span>normalized<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 迭代减少深度直到大小适合</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>size <span class="token operator">></span> maxSizeInBytes <span class="token operator">&amp;&amp;</span> maxDepth <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      maxDepth<span class="token operator">--</span><span class="token punctuation">;</span>
      normalized <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> maxDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>
      size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">estimateSize</span><span class="token punctuation">(</span>normalized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> normalized<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">normalize</span><span class="token punctuation">(</span>
    obj<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    maxDepth<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
    currentDepth<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 处理基本类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'[null]'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'[undefined]'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'[NaN]'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'bigint'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[BigInt: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">n]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">// 处理函数和符号</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Function: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">'anonymous'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'symbol'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Symbol: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>description <span class="token operator">||</span> <span class="token string">'Symbol'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 基本类型直接通过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token string">'boolean'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 达到深度限制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentDepth <span class="token operator">>=</span> maxDepth<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Array(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">)]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>constructor<span class="token operator">?.</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token string">'[Object]'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 循环引用检测</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token string">'[Circular]'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 特殊类型的特殊处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isReactElement</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[React.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>type<span class="token operator">?.</span>name <span class="token operator">||</span> obj<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token string">'Element'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isVueComponent</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Vue.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>$options<span class="token operator">?.</span>name <span class="token operator">||</span> <span class="token string">'Component'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        name<span class="token operator">:</span> obj<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        message<span class="token operator">:</span> obj<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
        stack<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">truncateStack</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Date</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 处理DOM元素</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isDOMElement</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>tagName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>id <span class="token operator">?</span> <span class="token string">'#'</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span>id <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 处理toJSON方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">.</span>toJSON <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>
          obj<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          maxDepth<span class="token punctuation">,</span>
          currentDepth<span class="token punctuation">,</span>
          visited
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">'[Object with toJSON error]'</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> maxItems <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// 限制数组大小</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>length<span class="token punctuation">,</span> maxItems<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> maxDepth<span class="token punctuation">,</span> currentDepth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> visited<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>length <span class="token operator">></span> maxItems<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">... </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>obj<span class="token punctuation">.</span>length <span class="token operator">-</span> maxItems<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> more items</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 对象</span>
    <span class="token keyword">const</span> result<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> maxProps <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">// 限制对象属性数量</span>

    <span class="token comment">// 遵循Sentry指令</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>__sentry_skip_normalization__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> effectiveMaxDepth <span class="token operator">=</span>
      obj<span class="token punctuation">.</span>__sentry_override_normalization_depth__ <span class="token operator">||</span> maxDepth<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length<span class="token punctuation">,</span> maxProps<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>
          obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
          effectiveMaxDepth<span class="token punctuation">,</span>
          currentDepth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
          visited
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'[Error accessing property]'</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">></span> maxProps<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      result<span class="token punctuation">[</span><span class="token string">'...'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>keys<span class="token punctuation">.</span>length <span class="token operator">-</span> maxProps<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> more properties</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">estimateSize</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 在不完整序列化的情况下快速估算</span>
    <span class="token keyword">const</span> sample <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> avgCharSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>sample<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>size <span class="token operator">/</span> sample<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">const</span> fullLength <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">estimateJsonLength</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>fullLength <span class="token operator">*</span> avgCharSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">estimateJsonLength</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> obj <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// "null"</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj <span class="token operator">?</span> <span class="token number">4</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// "true" : "false"</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 引号</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>visited<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">// "[Circular]"</span>
    visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">let</span> length <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        length <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">estimateJsonLength</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> visited<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 逗号</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> length<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">let</span> length <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// &#123;&#125;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        length <span class="token operator">+=</span> key<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// "key":</span>
        length <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">estimateJsonLength</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> visited<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 逗号</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> length<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 默认估算</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Is Novel</strong>:<br><strong>为什么这是新颖的</strong>：</p>
<ul>
<li>Iterative depth reduction based on actual byte size<br>基于实际字节大小的迭代深度减少</li>
<li>Type-aware stringification for special objects<br>对特殊对象的类型感知字符串化</li>
<li>Respects framework-specific objects (React, Vue)<br>尊重框架特定对象（React、Vue）</li>
<li>Memory-efficient with WeakSet for circular detection<br>使用WeakSet进行循环检测，内存高效</li>
<li>Preserves as much information as possible within constraints<br>在约束内保留尽可能多的信息</li>
</ul>
<p><strong>Use Cases</strong>:<br><strong>使用案例</strong>：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// LLM上下文准备</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">normalizeToSize</span><span class="token punctuation">(</span>
  largeProjectState<span class="token punctuation">,</span>
  <span class="token number">10</span><span class="token punctuation">,</span>     <span class="token comment">// 从深度10开始</span>
  <span class="token number">50_000</span>  <span class="token comment">// 上下文限制50KB</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 遥测错误报告</span>
<span class="token keyword">const</span> errorContext <span class="token operator">=</span> <span class="token function">normalizeToSize</span><span class="token punctuation">(</span>
  applicationState<span class="token punctuation">,</span>
  <span class="token number">5</span><span class="token punctuation">,</span>       <span class="token comment">// 合理的深度</span>
  <span class="token number">10_000</span>   <span class="token comment">// 错误报告限制10KB</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="AgentTool-Synthesis-Orchestrating-Multiple-Perspectives"><a href="#AgentTool-Synthesis-Orchestrating-Multiple-Perspectives" class="headerlink" title="AgentTool Synthesis: Orchestrating Multiple Perspectives"></a>AgentTool Synthesis: Orchestrating Multiple Perspectives</h2><h2 id="AgentTool合成：协调多个视角"><a href="#AgentTool合成：协调多个视角" class="headerlink" title="AgentTool合成：协调多个视角"></a>AgentTool合成：协调多个视角</h2><p>The AgentTool doesn’t just run sub-agents—it intelligently combines their results:<br>AgentTool不仅仅是运行子代理——它智能地组合它们的结果：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">AgentToolSynthesizer</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">synthesizeResults</span><span class="token punctuation">(</span>
    results<span class="token operator">:</span> SubAgentResult<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    originalTask<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 单个结果——无需合成</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 准备合成上下文</span>
    <span class="token keyword">const</span> synthesisData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareSynthesisData</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 计算合成的令牌预算</span>
    <span class="token keyword">const</span> tokenBudget <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateSynthesisTokenBudget</span><span class="token punctuation">(</span>
      results<span class="token punctuation">,</span>
      originalTask
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构建合成提示</span>
    <span class="token keyword">const</span> synthesisPrompt <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildSynthesisPrompt</span><span class="token punctuation">(</span>
      originalTask<span class="token punctuation">,</span>
      synthesisData<span class="token punctuation">,</span>
      tokenBudget
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用快速模型进行合成</span>
    <span class="token keyword">const</span> synthesizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubAgentExecutor</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      prompt<span class="token operator">:</span> synthesisPrompt<span class="token punctuation">,</span>
      model<span class="token operator">:</span> <span class="token string">'claude-3-haiku-20240307'</span><span class="token punctuation">,</span>
      maxTokens<span class="token operator">:</span> tokenBudget<span class="token punctuation">.</span>output<span class="token punctuation">,</span>
      isSynthesis<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      temperature<span class="token operator">:</span> <span class="token number">0.3</span> <span class="token comment">// 降低温度以进行事实合成</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> synthesizer<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">prepareSynthesisData</span><span class="token punctuation">(</span>
    results<span class="token operator">:</span> SubAgentResult<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> SynthesisData <span class="token punctuation">&#123;</span>
    <span class="token comment">// 从每个结果中提取关键信息</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      agentId<span class="token operator">:</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> result<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      keyFindings<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">extractKeyFindings</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span>
      toolsUsed<span class="token operator">:</span> result<span class="token punctuation">.</span>toolsUsed<span class="token punctuation">,</span>
      confidence<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assessConfidence</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span>
      tokensUsed<span class="token operator">:</span> result<span class="token punctuation">.</span>usage<span class="token punctuation">.</span>total_tokens<span class="token punctuation">,</span>
      uniqueInsights<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 识别跨代理的独特见解</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">identifyUniqueInsights</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 找到共识和分歧</span>
    <span class="token keyword">const</span> consensus <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findConsensus</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> conflicts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findConflicts</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      agents<span class="token operator">:</span> data<span class="token punctuation">,</span>
      consensus<span class="token punctuation">,</span>
      conflicts<span class="token punctuation">,</span>
      coverageMap<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildCoverageMap</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">buildSynthesisPrompt</span><span class="token punctuation">(</span>
    originalTask<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> SynthesisData<span class="token punctuation">,</span>
    tokenBudget<span class="token operator">:</span> TokenBudget
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You are a synthesis agent tasked with combining findings from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>agents<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> independent investigations.
您是一个合成代理，负责合并来自</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>agents<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">个独立调查的结果。

## Original Task
原始任务
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>originalTask<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

## Investigation Results
调查结果

</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>agents<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>agent <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
### Agent </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>agentId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> Findings
代理 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>agentId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 的发现
**Tools Used**: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>toolsUsed<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'None'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
**使用的工具**: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>toolsUsed<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'无'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
**Confidence**: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>confidence<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/5
**置信度**: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>confidence<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/5
**Token Efficiency**: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>tokensUsed<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> tokens
**令牌效率**: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>tokensUsed<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 令牌

</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

**Key Points**:
**关键点**:
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>agent<span class="token punctuation">.</span>keyFindings<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>f<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n---\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

## Consensus Points
## 共识点
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>consensus<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>c<span class="token punctuation">.</span>point<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> (agreed by </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>c<span class="token punctuation">.</span>agentIds<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>consensus<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>c<span class="token punctuation">.</span>point<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> (由 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>c<span class="token punctuation">.</span>agentIds<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 同意)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

## Conflicting Information
## 冲突信息
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>conflicts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>c<span class="token punctuation">.</span>description<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'No conflicts found.'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>conflicts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>c<span class="token punctuation">.</span>description<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'未发现冲突。'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

## Coverage Analysis
## 覆盖分析
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatCoverageMap</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>coverageMap<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">

## Your Task
## 您的任务
Synthesize these findings into a single, comprehensive response that:
将这些发现综合成一个单一、全面的回复，该回复将：
1. Presents a unified view of the findings
呈现发现的统一视图
2. Highlights areas of agreement
突出一致领域
3. Notes any contradictions or uncertainties
注意任何矛盾或不确定性
4. Provides the most complete answer to the original task
为原始任务提供最完整的答案

Keep your response under </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tokenBudget<span class="token punctuation">.</span>output<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> tokens.
将您的回复保持在</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tokenBudget<span class="token punctuation">.</span>output<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">令牌以下。
Focus on actionable insights and concrete findings.
专注于可操作的见解和具体的发现。
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">extractKeyFindings</span><span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 使用启发式方法提取关键点</span>
    <span class="token keyword">const</span> findings<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 寻找项目符号点</span>
    <span class="token keyword">const</span> bulletPoints <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\\s-*•]+(.+)$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    findings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>bulletPoints<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>b <span class="token operator">=></span> b<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 寻找编号列表</span>
    <span class="token keyword">const</span> numberedItems <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\d+\\.\\s+(.+)$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    findings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>numberedItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>n <span class="token operator">=></span> n<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\d+\\.\\s+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 寻找结论标记</span>
    <span class="token keyword">const</span> conclusions <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>
      <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?:concluded?|found|discovered|determined):\\s*(.+?)(?:\\.|$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span>
    <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    findings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>conclusions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 限制和去重</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>findings<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">assessConfidence</span><span class="token punctuation">(</span>result<span class="token operator">:</span> SubAgentResult<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> confidence <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 基准线</span>

    <span class="token comment">// 更多工具使用带来更高置信度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>toolsUsed<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> confidence<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>toolsUsed<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span> confidence<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">// 错误降低置信度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>hadErrors<span class="token punctuation">)</span> confidence<span class="token operator">--</span><span class="token punctuation">;</span>

    <span class="token comment">// 基于结果模式的置信度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'unable to'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        result<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'could not find'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      confidence<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'successfully'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        result<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'confirmed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      confidence<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> confidence<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">identifyUniqueInsights</span><span class="token punctuation">(</span>data<span class="token operator">:</span> AgentData<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 建立见解频率映射</span>
    <span class="token keyword">const</span> insightFrequency <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> agent <span class="token keyword">of</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> finding <span class="token keyword">of</span> agent<span class="token punctuation">.</span>keyFindings<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> normalized <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalizeInsight</span><span class="token punctuation">(</span>finding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        insightFrequency<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
          normalized<span class="token punctuation">,</span>
          <span class="token punctuation">(</span>insightFrequency<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>normalized<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 标记独特见解</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> agent <span class="token keyword">of</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      agent<span class="token punctuation">.</span>uniqueInsights <span class="token operator">=</span> agent<span class="token punctuation">.</span>keyFindings<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>finding <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> normalized <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalizeInsight</span><span class="token punctuation">(</span>finding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> insightFrequency<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>normalized<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Is Novel</strong>:<br><strong>为什么这是新颖的</strong>：</p>
<ul>
<li>Goes beyond simple concatenation to intelligent synthesis<br>超越简单连接，实现智能合成</li>
<li>Extracts and compares key findings across agents<br>提取并比较跨代理的关键发现</li>
<li>Identifies consensus and conflicts<br>识别共识和冲突</li>
<li>Uses a dedicated synthesis model for efficiency<br>使用专用合成模型提高效率</li>
<li>Preserves unique insights while removing redundancy<br>保留独特见解，同时消除冗余</li>
</ul>
<h2 id="Error-Formatting-Pipeline-Making-Failures-Actionable"><a href="#Error-Formatting-Pipeline-Making-Failures-Actionable" class="headerlink" title="Error Formatting Pipeline: Making Failures Actionable"></a>Error Formatting Pipeline: Making Failures Actionable</h2><h2 id="错误格式化管道：使失败可操作"><a href="#错误格式化管道：使失败可操作" class="headerlink" title="错误格式化管道：使失败可操作"></a>错误格式化管道：使失败可操作</h2><p>Errors need to be formatted differently for LLMs than for humans:<br>错误对LLM的格式化需要与对人类不同：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ErrorFormatter</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token function">formatToolErrorContent</span><span class="token punctuation">(</span>
    error<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">,</span>
    context<span class="token operator">?</span><span class="token operator">:</span> ErrorContext
  <span class="token punctuation">)</span><span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> errorType <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">classifyError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> formatter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>formatters<span class="token punctuation">[</span>errorType<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultFormatter<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">formatter</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> tool<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> formatters <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    shell<span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> ShellError<span class="token punctuation">,</span> tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">)</span><span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> blocks<span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 主要错误消息</span>
      blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Tool '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">' failed with exit code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>exitCode<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果存在stdout则包含</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>stdout <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stdout:\\n\\</span><span class="token template-punctuation string">`</span></span>\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\</span><span class="token template-punctuation string">`</span></span>\\n$<span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">truncateOutput</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>\\n\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\</span><span class="token template-punctuation string">`</span></span>\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 如果存在stderr则包含</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>stderr <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stderr:\\n\\</span><span class="token template-punctuation string">`</span></span>\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\</span><span class="token template-punctuation string">`</span></span>\\n$<span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">truncateOutput</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>\\n\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\</span><span class="token template-punctuation string">`</span></span>\\<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 添加上下文提示</span>
      <span class="token keyword">const</span> hints <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateShellErrorHints</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hints<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\nPossible issues:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hints<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>h <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>h<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 建议替代方案</span>
      <span class="token keyword">const</span> suggestions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateShellSuggestions</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>suggestions<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\nSuggestions:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>suggestions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>s<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> blocks<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

    validation<span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> ZodError<span class="token punctuation">,</span> tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">)</span><span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> issues <span class="token operator">=</span> error<span class="token punctuation">.</span>issues<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>issue <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> path <span class="token operator">=</span> issue<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> fieldName <span class="token operator">=</span> path <span class="token operator">||</span> <span class="token string">'input'</span><span class="token punctuation">;</span>

        <span class="token comment">// 基于错误类型格式化</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>issue<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">case</span> <span class="token string">'invalid_type'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: Expected </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>expected<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>received<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: 期望 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>expected<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">，收到 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>received<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

          <span class="token keyword">case</span> <span class="token string">'too_small'</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>issue<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: Must be at least </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>minimum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> characters</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: 必须至少有 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>minimum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 个字符</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>issue<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'array'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: Must have at least </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>minimum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> items</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: 必须至少有 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>minimum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 个项目</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: Value too small</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: 值太小</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

          <span class="token keyword">case</span> <span class="token string">'too_big'</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>issue<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: Must be at most </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>maximum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> characters</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: 最多可以有 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>maximum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 个字符</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: Value too large</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: 值太大</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

          <span class="token keyword">case</span> <span class="token string">'invalid_enum_value'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: Must be one of: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: 必须是以下之一: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

          <span class="token keyword">case</span> <span class="token string">'custom'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

          <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fieldName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issue<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Tool '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">' input validation failed:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issues<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\n\\nPlease check your input parameters and try again.</span><span class="token template-punctuation string">`</span></span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">工具 '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">' 输入验证失败：\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>issues<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\n\\n请检查您的输入参数并重试。</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

    permission<span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> PermissionError<span class="token punctuation">,</span> tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">)</span><span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> blocks<span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Permission denied for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 的权限被拒绝</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>reason<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reason: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>reason<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">原因: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>reason<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>rule<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Denied by rule: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>scope<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>pattern<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">被规则拒绝: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>scope<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>rule<span class="token punctuation">.</span>pattern<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 提供可操作的指导</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>suggestions <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>suggestions<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\nTo proceed, you could:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>suggestions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>s<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\n要继续，您可以：\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>suggestions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>s<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token string">'\\nThis operation requires explicit user permission. Please ask the user if they want to proceed.'</span>
          text<span class="token operator">:</span> <span class="token string">'\\n此操作需要明确的用户权限。请询问用户是否要继续。'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> blocks<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

    filesystem<span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> FileSystemError<span class="token punctuation">,</span> tool<span class="token operator">:</span> ToolDefinition<span class="token punctuation">)</span><span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> blocks<span class="token operator">:</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">File system error in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>tool<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 中的文件系统错误: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 基于错误代码的特定指导</span>
      <span class="token keyword">const</span> guidance <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string-property property">'ENOENT'</span><span class="token operator">:</span> <span class="token string">'File or directory not found. Check the path exists.'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'ENOENT'</span><span class="token operator">:</span> <span class="token string">'文件或目录未找到。检查路径是否存在。'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EACCES'</span><span class="token operator">:</span> <span class="token string">'Permission denied. The file may be read-only or require elevated permissions.'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EACCES'</span><span class="token operator">:</span> <span class="token string">'权限被拒绝。文件可能是只读的或需要提升权限。'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EEXIST'</span><span class="token operator">:</span> <span class="token string">'File already exists. Consider using a different name or checking before creating.'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EEXIST'</span><span class="token operator">:</span> <span class="token string">'文件已存在。考虑使用不同的名称或在创建前检查。'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EISDIR'</span><span class="token operator">:</span> <span class="token string">'Expected a file but found a directory.'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EISDIR'</span><span class="token operator">:</span> <span class="token string">'期望是文件但找到了目录。'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'ENOTDIR'</span><span class="token operator">:</span> <span class="token string">'Expected a directory but found a file.'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'ENOTDIR'</span><span class="token operator">:</span> <span class="token string">'期望是目录但找到了文件。'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EMFILE'</span><span class="token operator">:</span> <span class="token string">'Too many open files. Some file handles may need to be closed.'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EMFILE'</span><span class="token operator">:</span> <span class="token string">'打开的文件太多。一些文件句柄可能需要关闭。'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'ENOSPC'</span><span class="token operator">:</span> <span class="token string">'No space left on device.'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'ENOSPC'</span><span class="token operator">:</span> <span class="token string">'设备上没有剩余空间。'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'EROFS'</span><span class="token operator">:</span> <span class="token string">'Read-only file system.'</span>
        <span class="token string-property property">'EROFS'</span><span class="token operator">:</span> <span class="token string">'只读文件系统。'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>guidance<span class="token punctuation">[</span>error<span class="token punctuation">.</span>code<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> guidance<span class="token punctuation">[</span>error<span class="token punctuation">.</span>code<span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        blocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Path: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
          text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">路径: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> blocks<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateShellErrorHints</span><span class="token punctuation">(</span>error<span class="token operator">:</span> ShellError<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> hints<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Command not found</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>stderr<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'command not found'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        error<span class="token punctuation">.</span>stderr<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'not found'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'The command may not be installed or not in PATH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'命令可能未安装或不在PATH中'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 建议常见替代方案</span>
      <span class="token keyword">const</span> command <span class="token operator">=</span> error<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> alternatives <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string-property property">'python'</span><span class="token operator">:</span> <span class="token string">'Try python3 instead'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'python'</span><span class="token operator">:</span> <span class="token string">'尝试使用python3'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'pip'</span><span class="token operator">:</span> <span class="token string">'Try pip3 instead'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'pip'</span><span class="token operator">:</span> <span class="token string">'尝试使用pip3'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'node'</span><span class="token operator">:</span> <span class="token string">'Node.js may not be installed'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'node'</span><span class="token operator">:</span> <span class="token string">'Node.js可能未安装'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'npm'</span><span class="token operator">:</span> <span class="token string">'npm may not be installed'</span>
        <span class="token string-property property">'npm'</span><span class="token operator">:</span> <span class="token string">'npm可能未安装'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>alternatives<span class="token punctuation">[</span>command<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>alternatives<span class="token punctuation">[</span>command<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Permission denied</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>stderr<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Permission denied'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        error<span class="token punctuation">.</span>stderr<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Operation not permitted'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Try running with different permissions or in a different directory'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'尝试使用不同的权限或在不同的目录中运行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Check if the file/directory has the correct ownership'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'检查文件/目录是否具有正确的所有权'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Network errors</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>stderr<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Could not resolve host'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        error<span class="token punctuation">.</span>stderr<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Connection refused'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Network connectivity issue detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'检测到网络连接问题'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Check if you need to set sandbox=false for network access'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'检查是否需要设置sandbox=false以进行网络访问'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> hints<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">truncateOutput</span><span class="token punctuation">(</span>output<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> maxLength<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>output<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> maxLength<span class="token punctuation">)</span> <span class="token keyword">return</span> output<span class="token punctuation">;</span>

    <span class="token comment">// Try to truncate at a newline</span>
    <span class="token comment">// 尝试在换行符处截断</span>
    <span class="token keyword">const</span> truncatePoint <span class="token operator">=</span> output<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">,</span> maxLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> actualTruncate <span class="token operator">=</span> truncatePoint <span class="token operator">></span> maxLength <span class="token operator">*</span> <span class="token number">0.8</span> <span class="token operator">?</span> truncatePoint <span class="token operator">:</span> maxLength<span class="token punctuation">;</span>

    <span class="token keyword">return</span> output<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> actualTruncate<span class="token punctuation">)</span> <span class="token operator">+</span>
           <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\n... (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>output<span class="token punctuation">.</span>length <span class="token operator">-</span> actualTruncate<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> characters truncated)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
           <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\n... (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>output<span class="token punctuation">.</span>length <span class="token operator">-</span> actualTruncate<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 个字符被截断)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Is Novel</strong>:<br><strong>为什么这是新颖的</strong>：</p>
<ul>
<li>Error messages tailored for LLM comprehension<br>为LLM理解量身定制的错误消息</li>
<li>Includes actionable suggestions<br>包含可操作的建议</li>
<li>Preserves critical debugging information (stdout/stderr)<br>保留关键的调试信息（stdout/stderr）</li>
<li>Provides context-aware hints<br>提供上下文感知的提示</li>
<li>Formats Zod validation errors in natural language<br>以自然语言格式化Zod验证错误</li>
</ul>
<h2 id="Dynamic-Context-Assembly-Intelligent-Prioritization"><a href="#Dynamic-Context-Assembly-Intelligent-Prioritization" class="headerlink" title="Dynamic Context Assembly: Intelligent Prioritization"></a>Dynamic Context Assembly: Intelligent Prioritization</h2><h2 id="动态上下文组装：智能优先级排序"><a href="#动态上下文组装：智能优先级排序" class="headerlink" title="动态上下文组装：智能优先级排序"></a>动态上下文组装：智能优先级排序</h2><p>The context assembly system goes beyond simple concatenation:<br>上下文组装系统超越了简单的连接：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">DynamicContextAssembler</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token constant">CONTEXT_PRIORITIES</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    baseInstructions<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    modelAdaptations<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    claudeMdContent<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    gitContext<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    directoryStructure<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    toolSpecifications<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
    activeSelections<span class="token operator">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span> <span class="token comment">// Between CLAUDE.md and git</span>
    recentErrors<span class="token operator">:</span> <span class="token number">2.5</span>      <span class="token comment">// High priority for error context</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">assembleSystemPrompt</span><span class="token punctuation">(</span>
    components<span class="token operator">:</span> ContextComponents<span class="token punctuation">,</span>
    tokenBudget<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
    model<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Phase 1: Gather all components with metadata</span>
    <span class="token comment">// 阶段1：收集所有带有元数据的组件</span>
    <span class="token keyword">const</span> sections <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">gatherSections</span><span class="token punctuation">(</span>components<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 2: Calculate token costs</span>
    <span class="token comment">// 阶段2：计算令牌成本</span>
    <span class="token keyword">const</span> tokenizedSections <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tokenizeSections</span><span class="token punctuation">(</span>sections<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 3: Intelligent truncation</span>
    <span class="token comment">// 阶段3：智能截断</span>
    <span class="token keyword">const</span> selectedSections <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">selectSections</span><span class="token punctuation">(</span>
      tokenizedSections<span class="token punctuation">,</span>
      tokenBudget
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Phase 4: Format and combine</span>
    <span class="token comment">// 阶段4：格式化和组合</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatSystemPrompt</span><span class="token punctuation">(</span>selectedSections<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">gatherSections</span><span class="token punctuation">(</span>
    components<span class="token operator">:</span> ContextComponents<span class="token punctuation">,</span>
    model<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ContextSection<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> sections<span class="token operator">:</span> ContextSection<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Base instructions (always included)</span>
    <span class="token comment">// 基本指令（始终包含）</span>
    sections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      priority<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_PRIORITIES</span><span class="token punctuation">.</span>baseInstructions<span class="token punctuation">,</span>
      content<span class="token operator">:</span> components<span class="token punctuation">.</span>baseInstructions<span class="token punctuation">,</span>
      required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'base'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Model-specific adaptations</span>
    <span class="token comment">// 模型特定适配</span>
    <span class="token keyword">const</span> modelAdaptations <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModelAdaptations</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      priority<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_PRIORITIES</span><span class="token punctuation">.</span>modelAdaptations<span class="token punctuation">,</span>
      content<span class="token operator">:</span> modelAdaptations<span class="token punctuation">,</span>
      required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'model'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// CLAUDE.md with hierarchical loading</span>
    <span class="token comment">// 带有分层加载的CLAUDE.md</span>
    <span class="token keyword">const</span> claudeMdContent <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadClaudeMdHierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      priority<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_PRIORITIES</span><span class="token punctuation">.</span>claudeMdContent<span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatClaudeMd</span><span class="token punctuation">(</span>claudeMdContent<span class="token punctuation">)</span><span class="token punctuation">,</span>
      required<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'claudemd'</span><span class="token punctuation">,</span>
      metadata<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        sources<span class="token operator">:</span> claudeMdContent<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=></span> c<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span>
        totalSize<span class="token operator">:</span> claudeMdContent<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">=></span> sum <span class="token operator">+</span> c<span class="token punctuation">.</span>content<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Git context with smart summarization</span>
    <span class="token comment">// 带有智能摘要的Git上下文</span>
    <span class="token keyword">const</span> gitContext <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getGitContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      priority<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_PRIORITIES</span><span class="token punctuation">.</span>gitContext<span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatGitContext</span><span class="token punctuation">(</span>gitContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
      required<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'git'</span><span class="token punctuation">,</span>
      canSummarize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">summarizer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">summarizeGitContext</span><span class="token punctuation">(</span>gitContext<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Directory structure with depth control</span>
    <span class="token comment">// 带有深度控制的目录结构</span>
    <span class="token keyword">const</span> dirStructure <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDirectoryStructure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      priority<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_PRIORITIES</span><span class="token punctuation">.</span>directoryStructure<span class="token punctuation">,</span>
      content<span class="token operator">:</span> dirStructure<span class="token punctuation">.</span>full<span class="token punctuation">,</span>
      required<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'directory'</span><span class="token punctuation">,</span>
      alternatives<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span> depth<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> content<span class="token operator">:</span> dirStructure<span class="token punctuation">.</span>depth3 <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> depth<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> content<span class="token operator">:</span> dirStructure<span class="token punctuation">.</span>depth2 <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> depth<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">:</span> dirStructure<span class="token punctuation">.</span>depth1 <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 工具规范</span>
    <span class="token keyword">const</span> toolSpecs <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatToolSpecifications</span><span class="token punctuation">(</span>components<span class="token punctuation">.</span>tools<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      priority<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_PRIORITIES</span><span class="token punctuation">.</span>toolSpecifications<span class="token punctuation">,</span>
      content<span class="token operator">:</span> toolSpecs<span class="token punctuation">.</span>full<span class="token punctuation">,</span>
      required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Tools must be included</span>
      required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 工具必须包含</span>
      type<span class="token operator">:</span> <span class="token string">'tools'</span><span class="token punctuation">,</span>
      alternatives<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span> level<span class="token operator">:</span> <span class="token string">'minimal'</span><span class="token punctuation">,</span> content<span class="token operator">:</span> toolSpecs<span class="token punctuation">.</span>minimal <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> level<span class="token operator">:</span> <span class="token string">'names-only'</span><span class="token punctuation">,</span> content<span class="token operator">:</span> toolSpecs<span class="token punctuation">.</span>namesOnly <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> sections<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">loadClaudeMdHierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> sources <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span> path<span class="token operator">:</span> <span class="token string">'/etc/claude-code/CLAUDE.md'</span><span class="token punctuation">,</span> scope<span class="token operator">:</span> <span class="token string">'managed'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> path<span class="token operator">:</span> <span class="token string">'~/.claude/CLAUDE.md'</span><span class="token punctuation">,</span> scope<span class="token operator">:</span> <span class="token string">'user'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> path<span class="token operator">:</span> <span class="token string">'.claude/CLAUDE.md'</span><span class="token punctuation">,</span> scope<span class="token operator">:</span> <span class="token string">'project'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> path<span class="token operator">:</span> <span class="token string">'.claude/CLAUDE.local.md'</span><span class="token punctuation">,</span> scope<span class="token operator">:</span> <span class="token string">'local'</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> contents<span class="token operator">:</span> ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> source <span class="token keyword">of</span> sources<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> processed <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processClaudeMd</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> source<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        contents<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>processed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// File doesn't exist, skip</span>
        <span class="token comment">// 文件不存在，跳过</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mergeClaudeMdContents</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">processClaudeMd</span><span class="token punctuation">(</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    scope<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ClaudeMdContent<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Process @mentions for includes</span>
    <span class="token comment">// 处理@提及以包含内容</span>
    <span class="token keyword">const</span> processed <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveMentions</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Extract directives</span>
    <span class="token comment">// 提取指令</span>
    <span class="token keyword">const</span> directives <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">extractDirectives</span><span class="token punctuation">(</span>processed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      scope<span class="token punctuation">,</span>
      content<span class="token operator">:</span> processed<span class="token punctuation">,</span>
      directives<span class="token punctuation">,</span>
      source<span class="token operator">:</span> scope
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">mergeClaudeMdContents</span><span class="token punctuation">(</span>
    contents<span class="token operator">:</span> ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> merged<span class="token operator">:</span> ClaudeMdContent<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> overrides <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Process in reverse order (local overrides managed)</span>
    <span class="token comment">// 以相反顺序处理（本地覆盖托管）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> contents<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> contents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// Handle @override directives</span>
      <span class="token comment">// 处理@override指令</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> directive <span class="token keyword">of</span> content<span class="token punctuation">.</span>directives<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>directive<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'override'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          overrides<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>directive<span class="token punctuation">.</span>key<span class="token punctuation">,</span> content<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// Include content if not overridden</span>
      <span class="token comment">// 如果未被覆盖则包含内容</span>
      <span class="token keyword">const</span> isOverridden <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>overrides<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">[</span>key<span class="token punctuation">,</span> scope<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span>
          content<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> scope <span class="token operator">!==</span> content<span class="token punctuation">.</span>scope
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isOverridden<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        merged<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> merged<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">selectSections</span><span class="token punctuation">(</span>
    sections<span class="token operator">:</span> TokenizedSection<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    budget<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> TokenizedSection<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Sort by priority</span>
    <span class="token comment">// 按优先级排序</span>
    <span class="token keyword">const</span> sorted <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>sections<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>priority <span class="token operator">-</span> b<span class="token punctuation">.</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> selected<span class="token operator">:</span> TokenizedSection<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> usedTokens <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// First pass: include all required sections</span>
    <span class="token comment">// 第一遍：包含所有必需的部分</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> section <span class="token keyword">of</span> sorted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>section<span class="token punctuation">.</span>required<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        selected<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>section<span class="token punctuation">)</span><span class="token punctuation">;</span>
        usedTokens <span class="token operator">+=</span> section<span class="token punctuation">.</span>tokenCount<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Second pass: include optional sections by priority</span>
    <span class="token comment">// 第二遍：按优先级包含可选部分</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> section <span class="token keyword">of</span> sorted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>section<span class="token punctuation">.</span>required <span class="token operator">&amp;&amp;</span> usedTokens <span class="token operator">+</span> section<span class="token punctuation">.</span>tokenCount <span class="token operator">&lt;=</span> budget<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        selected<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>section<span class="token punctuation">)</span><span class="token punctuation">;</span>
        usedTokens <span class="token operator">+=</span> section<span class="token punctuation">.</span>tokenCount<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>section<span class="token punctuation">.</span>required <span class="token operator">&amp;&amp;</span> section<span class="token punctuation">.</span>alternatives<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Try alternatives</span>
        <span class="token comment">// 尝试替代方案</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> alt <span class="token keyword">of</span> section<span class="token punctuation">.</span>alternatives<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>usedTokens <span class="token operator">+</span> alt<span class="token punctuation">.</span>tokenCount <span class="token operator">&lt;=</span> budget<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            selected<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
              <span class="token operator">...</span>section<span class="token punctuation">,</span>
              content<span class="token operator">:</span> alt<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
              tokenCount<span class="token operator">:</span> alt<span class="token punctuation">.</span>tokenCount
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            usedTokens <span class="token operator">+=</span> alt<span class="token punctuation">.</span>tokenCount<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> selected<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Is Novel</strong>:<br><strong>为什么这是新颖的</strong>：</p>
<ul>
<li>Priority-based truncation preserves most important context<br>基于优先级的截断保留最重要的上下文</li>
<li>Hierarchical <a target="_blank" rel="noopener" href="http://claude.md/">CLAUDE.md</a> loading with override semantics<br>带有覆盖语义的分层CLAUDE.md加载</li>
<li>Dynamic alternatives (e.g., directory depth reduction)<br>动态替代方案（例如，目录深度减少）</li>
<li>Model-specific prompt adaptations<br>模型特定的提示适配</li>
<li>Smart summarization fallbacks<br>智能摘要回退</li>
</ul>
<h2 id="Memory-Management-Patterns-Keeping-It-Lean"><a href="#Memory-Management-Patterns-Keeping-It-Lean" class="headerlink" title="Memory Management Patterns: Keeping It Lean"></a>Memory Management Patterns: Keeping It Lean</h2><h2 id="内存管理模式：保持精简"><a href="#内存管理模式：保持精简" class="headerlink" title="内存管理模式：保持精简"></a>内存管理模式：保持精简</h2><p>Claude Code implements sophisticated memory management:<br>Claude Code实现了复杂的内存管理：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">MemoryManager</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Pattern 1: Weak references for large objects</span>
  <span class="token comment">// 模式1：大对象的弱引用</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> fileCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> WeakRef<span class="token operator">&lt;</span>FileContent<span class="token operator">>></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizationRegistry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Garbage collected: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">垃圾回收: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token function">cacheFile</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> content<span class="token operator">:</span> FileContent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Store weak reference</span>
    <span class="token comment">// 存储弱引用</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Register for cleanup notification</span>
    <span class="token comment">// 注册清理通知</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">static</span> <span class="token function">getFile</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> FileContent <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ref<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> content <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Was garbage collected</span>
      <span class="token comment">// 已被垃圾回收</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fileCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> content<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Pattern 2: Streaming with backpressure</span>
  <span class="token comment">// 模式2：带背压的流式处理</span>
  <span class="token keyword">static</span> async <span class="token operator">*</span><span class="token function">streamLargeFile</span><span class="token punctuation">(</span>
    path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> StreamOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>Buffer<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>chunkSize <span class="token operator">||</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 64KB chunks</span>
    <span class="token keyword">const</span> highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>chunkSize <span class="token operator">||</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 64KB块</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> highWaterMark <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> totalRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> isPaused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      totalRead <span class="token operator">+=</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token comment">// Check memory pressure</span>
      <span class="token comment">// 检查内存压力</span>
      <span class="token keyword">const</span> memUsage <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>memUsage<span class="token punctuation">.</span>heapUsed <span class="token operator">/</span> memUsage<span class="token punctuation">.</span>heapTotal <span class="token operator">></span> <span class="token number">0.9</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPaused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'High memory pressure, pausing stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          stream<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          isPaused <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

          <span class="token comment">// Force garbage collection if available</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>global<span class="token punctuation">.</span>gc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            global<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token comment">// Wait for memory to free up</span>
          <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isPaused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        stream<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        isPaused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">yield</span> chunk<span class="token punctuation">;</span>

      <span class="token comment">// Yield to event loop periodically</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>totalRead <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Every MB</span>
        <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=></span> <span class="token function">setImmediate</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Pattern 3: Object pooling for frequent allocations</span>
  <span class="token keyword">static</span> bufferPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    size<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    bufferSize<span class="token operator">:</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Pattern 4: Memory pressure detection</span>
  <span class="token keyword">static</span> <span class="token function">monitorMemoryPressure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> usage <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> heapPercent <span class="token operator">=</span> usage<span class="token punctuation">.</span>heapUsed <span class="token operator">/</span> usage<span class="token punctuation">.</span>heapTotal<span class="token punctuation">;</span>
      <span class="token keyword">const</span> rssGB <span class="token operator">=</span> usage<span class="token punctuation">.</span>rss <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>heapPercent <span class="token operator">></span> <span class="token number">0.85</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">High heap usage: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span>heapPercent <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Trigger cleanup actions</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performMemoryCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>rssGB <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">High RSS memory: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>rssGB<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">GB</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">performMemoryCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Clear non-essential caches</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>patternCache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>patternCache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Compact conversation if needed</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ConversationManager<span class="token punctuation">.</span><span class="token function">shouldCompact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      ConversationManager<span class="token punctuation">.</span><span class="token function">triggerCompaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Force GC if available</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>global<span class="token punctuation">.</span>gc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> before <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>heapUsed<span class="token punctuation">;</span>
      global<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> after <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>heapUsed<span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GC freed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>before <span class="token operator">-</span> after<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">MB</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Buffer pool implementation</span>
<span class="token keyword">class</span> <span class="token class-name">BufferPool</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> available<span class="token operator">:</span> Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> inUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap<span class="token operator">&lt;</span>Buffer<span class="token punctuation">,</span> <span class="token builtin">boolean</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> config<span class="token operator">:</span> BufferPoolConfig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Pre-allocate buffers</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> config<span class="token punctuation">.</span>size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">allocUnsafe</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Buffer <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Pool exhausted, allocate new</span>
      <span class="token class-name"><span class="token builtin">console</span></span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Buffer pool exhausted, allocating new buffer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">allocUnsafe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>inUse<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">release</span><span class="token punctuation">(</span>buffer<span class="token operator">:</span> Buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>inUse<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Buffer not from this pool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>inUse<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Clear buffer content for security</span>
    buffer<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>available<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Is Novel</strong>:</p>
<ul>
<li>Weak references allow automatic cleanup of large cached files</li>
<li>Streaming with backpressure prevents memory exhaustion</li>
<li>Buffer pooling reduces allocation overhead</li>
<li>Active memory pressure monitoring and response</li>
</ul>
<h2 id="Permission-Rule-Compilation-Fast-Security-Decisions"><a href="#Permission-Rule-Compilation-Fast-Security-Decisions" class="headerlink" title="Permission Rule Compilation: Fast Security Decisions"></a>Permission Rule Compilation: Fast Security Decisions</h2><p>The permission system compiles rules for efficient evaluation:</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">PermissionRuleCompiler</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> compiledRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CompiledRule<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">compile</span><span class="token punctuation">(</span>rule<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> CompiledRule <span class="token punctuation">&#123;</span>
    <span class="token comment">// Check cache</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>compiledRules<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compiledRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Parse rule syntax</span>
    <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileRule</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>compiledRules<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> compiled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> compiled<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">parseRule</span><span class="token punctuation">(</span>rule<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ParsedRule <span class="token punctuation">&#123;</span>
    <span class="token comment">// Rule formats:</span>
    <span class="token comment">// - ToolName</span>
    <span class="token comment">// - ToolName(path/pattern)</span>
    <span class="token comment">// - ToolName(path/pattern, condition)</span>
    <span class="token comment">// - @tag:ToolName</span>

    <span class="token keyword">const</span> patterns <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      simple<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\\w+)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      withPath<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\\w+)\\(([^,)]+)\\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      withCondition<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\\w+)\\(([^,]+),\\s*(.+)\\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      tagged<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^@(\\w+):(.+)$</span><span class="token regex-delimiter">/</span></span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Try tagged format first</span>
    <span class="token keyword">const</span> taggedMatch <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>patterns<span class="token punctuation">.</span>tagged<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taggedMatch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> tag<span class="token punctuation">,</span> rest<span class="token punctuation">]</span> <span class="token operator">=</span> taggedMatch<span class="token punctuation">;</span>
      <span class="token keyword">const</span> innerRule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseRule</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>innerRule<span class="token punctuation">,</span> tags<span class="token operator">:</span> <span class="token punctuation">[</span>tag<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Try with condition</span>
    <span class="token keyword">const</span> conditionMatch <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>patterns<span class="token punctuation">.</span>withCondition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionMatch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> tool<span class="token punctuation">,</span> path<span class="token punctuation">,</span> condition<span class="token punctuation">]</span> <span class="token operator">=</span> conditionMatch<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        tool<span class="token punctuation">,</span>
        path<span class="token punctuation">,</span>
        condition<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseCondition</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">,</span>
        tags<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Try with path</span>
    <span class="token keyword">const</span> pathMatch <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>patterns<span class="token punctuation">.</span>withPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathMatch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> tool<span class="token punctuation">,</span> path<span class="token punctuation">]</span> <span class="token operator">=</span> pathMatch<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> tool<span class="token punctuation">,</span> path<span class="token punctuation">,</span> tags<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Simple tool name</span>
    <span class="token keyword">const</span> simpleMatch <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>patterns<span class="token punctuation">.</span>simple<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>simpleMatch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> tool<span class="token operator">:</span> simpleMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tags<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid rule syntax: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>rule<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">compileRule</span><span class="token punctuation">(</span>parsed<span class="token operator">:</span> ParsedRule<span class="token punctuation">)</span><span class="token operator">:</span> CompiledRule <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> compiled<span class="token operator">:</span> CompiledRule <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      original<span class="token operator">:</span> parsed<span class="token punctuation">,</span>
      matchers<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      evaluate<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token keyword">as</span> <span class="token builtin">any</span> <span class="token comment">// Will be set below</span>
      evaluate<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token keyword">as</span> <span class="token builtin">any</span> <span class="token comment">// 将在下面设置</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Compile tool matcher</span>
    <span class="token comment">// 编译工具匹配器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>tool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Wildcard in tool name</span>
      <span class="token comment">// 工具名中的通配符</span>
      <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>
        <span class="token string">'^'</span> <span class="token operator">+</span> parsed<span class="token punctuation">.</span>tool<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\*</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'.*'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      compiled<span class="token punctuation">.</span>matchers<span class="token punctuation">.</span><span class="token function-variable function">tool</span> <span class="token operator">=</span> <span class="token punctuation">(</span>tool<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> regex<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>tool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Exact match</span>
      <span class="token comment">// 精确匹配</span>
      compiled<span class="token punctuation">.</span>matchers<span class="token punctuation">.</span><span class="token function-variable function">tool</span> <span class="token operator">=</span> <span class="token punctuation">(</span>tool<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> tool <span class="token operator">===</span> parsed<span class="token punctuation">.</span>tool<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Compile path matcher</span>
    <span class="token comment">// 编译路径匹配器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token operator">||</span> parsed<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Glob pattern</span>
        <span class="token comment">// Glob模式</span>
        <span class="token keyword">const</span> matcher <span class="token operator">=</span> <span class="token function">picomatch</span><span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        compiled<span class="token punctuation">.</span>matchers<span class="token punctuation">.</span><span class="token function-variable function">path</span> <span class="token operator">=</span> <span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">matcher</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Exact or prefix match</span>
        <span class="token comment">// 精确或前缀匹配</span>
        compiled<span class="token punctuation">.</span>matchers<span class="token punctuation">.</span><span class="token function-variable function">path</span> <span class="token operator">=</span> <span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> normalizedRule <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> normalizedInput <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizedRule<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Directory prefix</span>
            <span class="token comment">// 目录前缀</span>
            <span class="token keyword">return</span> normalizedInput<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>normalizedRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Exact match</span>
            <span class="token comment">// 精确匹配</span>
            <span class="token keyword">return</span> normalizedInput <span class="token operator">===</span> normalizedRule<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Compile condition</span>
    <span class="token comment">// 编译条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      compiled<span class="token punctuation">.</span>matchers<span class="token punctuation">.</span>condition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileCondition</span><span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>condition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Create optimized evaluator</span>
    <span class="token comment">// 创建优化的评估器</span>
    compiled<span class="token punctuation">.</span>evaluate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createEvaluator</span><span class="token punctuation">(</span>compiled<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> compiled<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">createEvaluator</span><span class="token punctuation">(</span>rule<span class="token operator">:</span> CompiledRule<span class="token punctuation">)</span><span class="token operator">:</span> RuleEvaluator <span class="token punctuation">&#123;</span>
    <span class="token comment">// Generate optimized evaluation function</span>
    <span class="token comment">// 生成优化的评估函数</span>
    <span class="token keyword">const</span> checks<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span>matchers<span class="token punctuation">.</span>tool<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      checks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'if (!matchers.tool(input.tool)) return false;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span>matchers<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      checks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'if (input.path &amp;&amp; !matchers.path(input.path)) return false;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span>matchers<span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      checks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'if (!matchers.condition(input, context)) return false;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    checks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'return true;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create function with minimal overhead</span>
    <span class="token comment">// 创建最小开销的函数</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Function</span></span><span class="token punctuation">(</span>
      <span class="token string">'matchers'</span><span class="token punctuation">,</span>
      <span class="token string">'input'</span><span class="token punctuation">,</span>
      <span class="token string">'context'</span><span class="token punctuation">,</span>
      checks<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>input<span class="token operator">:</span> RuleInput<span class="token punctuation">,</span> context<span class="token operator">:</span> RuleContext<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>matchers<span class="token punctuation">,</span> input<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">evaluateRules</span><span class="token punctuation">(</span>
    rules<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    input<span class="token operator">:</span> RuleInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> RuleContext
  <span class="token punctuation">)</span><span class="token operator">:</span> RuleMatch <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Compile and evaluate rules in order</span>
    <span class="token comment">// 按顺序编译和评估规则</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> ruleStr <span class="token keyword">of</span> rules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> rule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>ruleStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          matched<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          rule<span class="token operator">:</span> ruleStr<span class="token punctuation">,</span>
          compiled<span class="token operator">:</span> rule
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Is Novel</strong>:<br><strong>为什么这是新颖的</strong>：</p>
<ul>
<li>JIT compilation of rules for performance<br>为性能进行规则的JIT编译</li>
<li>Support for complex rule syntax with conditions<br>支持带条件的复杂规则语法</li>
<li>Caching of compiled rules<br>编译规则的缓存</li>
<li>Optimized evaluator generation<br>优化的评估器生成</li>
</ul>
<h2 id="Progress-Aggregation-Coordinating-Parallel-Operations"><a href="#Progress-Aggregation-Coordinating-Parallel-Operations" class="headerlink" title="Progress Aggregation: Coordinating Parallel Operations"></a>Progress Aggregation: Coordinating Parallel Operations</h2><h2 id="进度聚合：协调并行操作"><a href="#进度聚合：协调并行操作" class="headerlink" title="进度聚合：协调并行操作"></a>进度聚合：协调并行操作</h2><p>When multiple tools run in parallel, their progress needs coordination:<br>当多个工具并行运行时，它们的进度需要协调：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">ProgressAggregator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> streams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ProgressStream<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> subscribers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span>ProgressSubscriber<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RingBuffer<span class="token operator">&lt;</span>AggregatedProgress<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  async <span class="token operator">*</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
    operations<span class="token operator">:</span> ToolOperation<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>AggregatedProgress<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Start all operations</span>
    <span class="token comment">// 开始所有操作</span>
    <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> op <span class="token keyword">of</span> operations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createProgressStream</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>streams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>id<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Start operation in background</span>
      <span class="token comment">// 在后台开始操作</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runOperation</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Yield aggregated progress</span>
    <span class="token comment">// 生成聚合进度</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>streams<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNextEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> aggregated<span class="token operator">:</span> AggregatedProgress <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        type<span class="token operator">:</span> <span class="token string">'aggregated_progress'</span><span class="token punctuation">,</span>
        timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        elapsed<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
        source<span class="token operator">:</span> event<span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        event<span class="token operator">:</span> event<span class="token punctuation">,</span>

        <span class="token comment">// Overall statistics</span>
        <span class="token comment">// 整体统计</span>
        statistics<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          total<span class="token operator">:</span> operations<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
          completed<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          failed<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          inProgress<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>streams<span class="token punctuation">.</span>size<span class="token punctuation">,</span>

          <span class="token comment">// Per-tool breakdown</span>
          <span class="token comment">// 按工具细分</span>
          byTool<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getToolStatistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

          <span class="token comment">// Performance metrics</span>
          <span class="token comment">// 性能指标</span>
          avgDuration<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAverageDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          throughput<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThroughput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

        <span class="token comment">// Visual progress representation</span>
        <span class="token comment">// 可视化进度表示</span>
        visualization<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createVisualization</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

      <span class="token comment">// Buffer for UI throttling</span>
      <span class="token comment">// UI节流缓冲区</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>aggregated<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Yield based on throttling strategy</span>
      <span class="token comment">// 基于节流策略生成</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shouldYield</span><span class="token punctuation">(</span>aggregated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">yield</span> aggregated<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Final summary</span>
    <span class="token comment">// 最终摘要</span>
    <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFinalSummary</span><span class="token punctuation">(</span>operations<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">getNextEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ProgressEvent <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>streams<span class="token punctuation">.</span>size <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// Create race of all active streams</span>
    <span class="token comment">// 创建所有活动流的竞争</span>
    <span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>streams<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
      <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> stream<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">await</span> stream<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> id<span class="token punctuation">,</span> event <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Race with timeout to prevent hanging</span>
      <span class="token comment">// 与超时竞争以防止挂起</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token operator">...</span>promises<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> id<span class="token operator">:</span> <span class="token string">'timeout'</span><span class="token punctuation">,</span> event<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token string">'timeout'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>event<span class="token operator">?.</span>done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>streams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> result<span class="token punctuation">.</span>event<span class="token operator">?.</span>value <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Handle stream errors gracefully</span>
      <span class="token comment">// 优雅地处理流错误</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Progress stream error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'进度流错误:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">shouldYield</span><span class="token punctuation">(</span>event<span class="token operator">:</span> AggregatedProgress<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Throttling logic</span>
    <span class="token comment">// 节流逻辑</span>
    <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Always yield completion events</span>
    <span class="token comment">// 始终生成完成事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'complete'</span> <span class="token operator">||</span> event<span class="token punctuation">.</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'error'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Throttle progress updates</span>
    <span class="token comment">// 节流进度更新</span>
    <span class="token keyword">const</span> lastYield <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastYieldTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>source<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> timeSinceLastYield <span class="token operator">=</span> now <span class="token operator">-</span> lastYield<span class="token punctuation">;</span>

    <span class="token comment">// Dynamic throttling based on number of operations</span>
    <span class="token comment">// 基于操作数量的动态节流</span>
    <span class="token keyword">const</span> throttleMs <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>streams<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeSinceLastYield <span class="token operator">>=</span> throttleMs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastYieldTime<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>source<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">createVisualization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ProgressVisualization <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> bars <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>streams<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> stream<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> percentage <span class="token operator">=</span> state<span class="token punctuation">.</span>progress <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> barLength <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> filled <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>percentage <span class="token operator">*</span> barLength <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        id<span class="token punctuation">,</span>
        tool<span class="token operator">:</span> state<span class="token punctuation">.</span>tool<span class="token punctuation">,</span>
        bar<span class="token operator">:</span> <span class="token string">'█'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>filled<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'░'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>barLength <span class="token operator">-</span> filled<span class="token punctuation">)</span><span class="token punctuation">,</span>
        percentage<span class="token punctuation">,</span>
        status<span class="token operator">:</span> state<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
        eta<span class="token operator">:</span> state<span class="token punctuation">.</span>eta
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'bars'</span><span class="token punctuation">,</span>
      bars<span class="token punctuation">,</span>
      summary<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSummaryLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Is Novel</strong>:<br><strong>为什么这是新颖的</strong>：</p>
<ul>
<li>Coordinates progress from multiple concurrent operations<br>协调来自多个并发操作的进度</li>
<li>Dynamic throttling based on operation count<br>基于操作数量的动态节流</li>
<li>Rich statistics and visualization<br>丰富的统计和可视化</li>
<li>Graceful handling of stream errors<br>优雅地处理流错误</li>
<li>Ring buffer for UI throttling<br>用于UI节流的环形缓冲区</li>
</ul>
<hr>
<p><em>This analysis showcases the innovative components that make Claude Code exceptional. These aren’t just optimizations—they’re fundamental architectural innovations designed specifically for the challenges of LLM-integrated development environments.</em><br><em>本分析展示了使Claude Code卓越的创新组件。这些不仅仅是优化——它们是专为LLM集成开发环境的挑战设计的基础架构创新。</em></p>
<h1 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档深入分析了Claude Code的创新组件，揭示了其独特的技术实现和架构设计。通过反编译和逆向工程分析，文档详细展示了Claude Code如何通过创新的算法和系统设计来解决LLM集成开发环境中的复杂挑战。</p>
<h2 id="核心创新组件"><a href="#核心创新组件" class="headerlink" title="核心创新组件"></a>核心创新组件</h2><h3 id="1-流式JSON解析器：处理LLM的部分思维"><a href="#1-流式JSON解析器：处理LLM的部分思维" class="headerlink" title="1. 流式JSON解析器：处理LLM的部分思维"></a>1. 流式JSON解析器：处理LLM的部分思维</h3><ul>
<li><strong>核心挑战</strong>：LLM流式传输工具使用请求时不会一次性发送完整JSON</li>
<li><strong>解决方案</strong>：渐进式解析器，能够处理不完整输入并提供有意义的部分结果</li>
<li><strong>恢复策略</strong>：<ul>
<li>关闭未闭合的字符串</li>
<li>基于结构分析自动关闭</li>
<li>提取完整的键值对</li>
</ul>
</li>
<li><strong>性能特征</strong>：<ul>
<li>&lt;1KB：&lt;0.1ms，100%成功率</li>
<li>1-10KB：0.1-1ms，99.9%成功率</li>
<li>10-100KB：1-10ms，99.5%成功率</li>
<li><blockquote>
<p>100KB：10-50ms，98%成功率（带恢复）</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="2-normalizeToSize算法：智能数据截断"><a href="#2-normalizeToSize算法：智能数据截断" class="headerlink" title="2. normalizeToSize算法：智能数据截断"></a>2. normalizeToSize算法：智能数据截断</h3><ul>
<li><strong>核心功能</strong>：基于实际字节大小的迭代深度减少</li>
<li><strong>类型感知处理</strong>：<ul>
<li>基本类型：null、undefined、NaN、BigInt</li>
<li>特殊对象：React元素、Vue组件、错误对象、日期、正则表达式</li>
<li>DOM元素：标签名称和ID识别</li>
</ul>
</li>
<li><strong>循环引用检测</strong>：使用WeakSet进行高效的循环检测</li>
<li><strong>内存优化</strong>：在约束内保留尽可能多的信息</li>
<li><strong>应用场景</strong>：<ul>
<li>LLM上下文准备（深度10，50KB限制）</li>
<li>遥测错误报告（深度5，10KB限制）</li>
</ul>
</li>
</ul>
<h3 id="3-AgentTool合成：协调多个视角"><a href="#3-AgentTool合成：协调多个视角" class="headerlink" title="3. AgentTool合成：协调多个视角"></a>3. AgentTool合成：协调多个视角</h3><ul>
<li><strong>智能合成</strong>：超越简单连接，实现多代理结果的智能合并</li>
<li><strong>关键功能</strong>：<ul>
<li>提取并比较跨代理的关键发现</li>
<li>识别共识和冲突</li>
<li>使用专用合成模型（Claude-3-haiku，温度0.3）</li>
<li>保留独特见解，消除冗余</li>
</ul>
</li>
<li><strong>置信度评估</strong>：基于工具使用、错误率、结果模式的动态评估</li>
<li><strong>令牌预算管理</strong>：智能计算合成所需的令牌预算</li>
</ul>
<h3 id="4-错误格式化管道：使失败可操作"><a href="#4-错误格式化管道：使失败可操作" class="headerlink" title="4. 错误格式化管道：使失败可操作"></a>4. 错误格式化管道：使失败可操作</h3><ul>
<li><strong>多层次错误处理</strong>：<ul>
<li>Shell错误：包含stdout/stderr、上下文提示、替代方案</li>
<li>验证错误：Zod错误的自然语言格式化</li>
<li>权限错误：明确的拒绝原因和操作指导</li>
<li>文件系统错误：特定错误代码的指导建议</li>
</ul>
</li>
<li><strong>智能提示生成</strong>：<ul>
<li>命令未找到：建议常见替代方案</li>
<li>权限拒绝：建议不同权限或目录</li>
<li>网络错误：提示sandbox设置</li>
</ul>
</li>
<li><strong>输出截断</strong>：在换行符处智能截断，保持可读性</li>
</ul>
<h3 id="5-动态上下文组装：智能优先级排序"><a href="#5-动态上下文组装：智能优先级排序" class="headerlink" title="5. 动态上下文组装：智能优先级排序"></a>5. 动态上下文组装：智能优先级排序</h3><ul>
<li><strong>六级优先级系统</strong>：<ol>
<li>基础指令（优先级1，~2KB）</li>
<li>模型特定适配（优先级2，~500B）</li>
<li>CLAUDE.md内容（优先级3，5-50KB）</li>
<li>Git上下文（优先级4，~1-5KB）</li>
<li>目录结构（优先级5，动态截断）</li>
<li>工具规格（优先级6，~10-20KB）</li>
</ol>
</li>
<li><strong>分层CLAUDE.md加载</strong>：<ul>
<li>四级优先级：托管、用户、项目、本地</li>
<li>@override指令支持</li>
<li>@提及包含机制</li>
</ul>
</li>
<li><strong>动态替代方案</strong>：<ul>
<li>目录深度：3层、2层、1层</li>
<li>工具规格：完整、最小、仅名称</li>
</ul>
</li>
<li><strong>智能截断策略</strong>：必需部分优先，可选部分按优先级</li>
</ul>
<h3 id="6-内存管理模式：保持精简"><a href="#6-内存管理模式：保持精简" class="headerlink" title="6. 内存管理模式：保持精简"></a>6. 内存管理模式：保持精简</h3><ul>
<li><strong>四种内存管理模式</strong>：<ol>
<li><strong>弱引用缓存</strong>：WeakRef + FinalizationRegistry自动清理</li>
<li><strong>背压流处理</strong>：64KB块，内存压力检测和流暂停</li>
<li><strong>对象池</strong>：预分配Buffer池，减少分配开销</li>
<li><strong>内存压力监控</strong>：定期检查并触发清理操作</li>
</ol>
</li>
<li><strong>内存压力处理</strong>：<ul>
<li>堆使用率&gt;85%时触发警告</li>
<li>自动垃圾回收（如可用）</li>
<li>强制对话压缩</li>
<li>清理非必要缓存</li>
</ul>
</li>
</ul>
<h3 id="7-权限规则编译：快速安全决策"><a href="#7-权限规则编译：快速安全决策" class="headerlink" title="7. 权限规则编译：快速安全决策"></a>7. 权限规则编译：快速安全决策</h3><ul>
<li><strong>JIT编译优化</strong>：<ul>
<li>规则语法解析：简单、带路径、带条件、标签化</li>
<li>编译缓存：避免重复编译</li>
<li>优化评估器生成：最小开销函数</li>
</ul>
</li>
<li><strong>规则语法支持</strong>：<ul>
<li>工具名通配符</li>
<li>路径glob模式</li>
<li>复杂条件表达式</li>
<li>标签化规则组织</li>
</ul>
</li>
<li><strong>评估性能</strong>：编译后的规则评估具有极低的运行时开销</li>
</ul>
<h3 id="8-进度聚合：协调并行操作"><a href="#8-进度聚合：协调并行操作" class="headerlink" title="8. 进度聚合：协调并行操作"></a>8. 进度聚合：协调并行操作</h3><ul>
<li><strong>多操作协调</strong>：<ul>
<li>环形缓冲区（1000事件）用于UI节流</li>
<li>Promise.race获取下一个事件</li>
<li>100ms超时防止挂起</li>
</ul>
</li>
<li><strong>动态节流</strong>：<ul>
<li>完成事件总是立即生成</li>
<li>基于操作数量的动态节流（50ms * 操作数，最大500ms）</li>
</ul>
</li>
<li><strong>丰富统计</strong>：<ul>
<li>整体统计：总数、完成、失败、进行中</li>
<li>按工具细分</li>
<li>性能指标：平均持续时间、吞吐量</li>
</ul>
</li>
<li><strong>可视化表示</strong>：基于Unicode字符的进度条</li>
</ul>
<h2 id="技术创新特点"><a href="#技术创新特点" class="headerlink" title="技术创新特点"></a>技术创新特点</h2><h3 id="算法创新"><a href="#算法创新" class="headerlink" title="算法创新"></a>算法创新</h3><ol>
<li><strong>渐进式JSON解析</strong>：传统解析器无法处理不完整输入的突破性解决方案</li>
<li><strong>迭代深度减少</strong>：基于字节大小的智能数据截断算法</li>
<li><strong>多代理智能合成</strong>：超越简单连接的复杂结果协调</li>
<li><strong>动态优先级截断</strong>：保持最重要上下文的智能策略</li>
</ol>
<h3 id="架构创新"><a href="#架构创新" class="headerlink" title="架构创新"></a>架构创新</h3><ol>
<li><strong>错误管道</strong>：为LLM理解量身定制的多层级错误处理</li>
<li><strong>上下文组装</strong>：超越简单连接的智能优先级管理</li>
<li><strong>内存管理模式</strong>：四种模式的综合内存管理策略</li>
<li><strong>进度聚合系统</strong>：协调并行操作的统一框架</li>
</ol>
<h3 id="性能创新"><a href="#性能创新" class="headerlink" title="性能创新"></a>性能创新</h3><ol>
<li><strong>JIT编译规则</strong>：运行时优化安全决策</li>
<li><strong>弱引用缓存</strong>：自动内存管理的文件缓存</li>
<li><strong>背压控制流</strong>：防止内存溢出的流式处理</li>
<li><strong>对象池模式</strong>：减少分配开销的资源复用</li>
</ol>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><ol>
<li><strong>类型安全设计</strong>：完整的TypeScript类型系统</li>
<li><strong>错误恢复机制</strong>：多层次的错误恢复和降级策略</li>
<li><strong>可观测性</strong>：全面的性能监控和统计</li>
<li><strong>模块化架构</strong>：高度解耦的组件设计</li>
</ol>
<h2 id="技术价值与应用"><a href="#技术价值与应用" class="headerlink" title="技术价值与应用"></a>技术价值与应用</h2><h3 id="解决的核心问题"><a href="#解决的核心问题" class="headerlink" title="解决的核心问题"></a>解决的核心问题</h3><ol>
<li><strong>LLM流式数据处理</strong>：处理不完整JSON和XML流</li>
<li><strong>内存效率</strong>：在约束内保留最大信息量</li>
<li><strong>多代理协调</strong>：智能合并多个AI代理的结果</li>
<li><strong>用户体验</strong>：提供可操作的错误信息和进度反馈</li>
<li><strong>性能优化</strong>：多层次缓存和内存管理策略</li>
</ol>
<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li><strong>AI开发工具</strong>：需要处理复杂LLM交互的开发环境</li>
<li><strong>流式数据处理</strong>：需要实时处理不完整数据的应用</li>
<li><strong>多代理系统</strong>：需要协调多个AI代理的系统</li>
<li><strong>内存敏感应用</strong>：需要在有限内存中处理大量数据的应用</li>
<li><strong>错误处理密集型系统</strong>：需要提供详细错误信息的企业级应用</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Claude Code的创新组件体现了现代软件工程的最高水平，通过精心设计的算法和架构，解决了LLM集成开发环境中的独特挑战。这些创新不仅仅是优化，而是基础性的架构突破，为构建下一代AI驱动的开发工具提供了宝贵的技术参考。</p>
<p>每个组件都针对特定的技术挑战提供了优雅的解决方案，从流式JSON解析到智能数据截断，从多代理合成到内存管理，展现了深度的技术洞察和工程智慧。这些创新组件的成功证明了在AI时代，传统的软件工程原则需要与AI特有的挑战相结合，创造出全新的技术解决方案。</p>
<p>整个架构的成功关键在于：</p>
<ul>
<li><strong>创新性</strong>：每个组件都解决了传统方法无法解决的问题</li>
<li><strong>实用性</strong>：所有创新都有明确的实际应用价值</li>
<li><strong>性能</strong>：在保证功能的同时维持了卓越的性能</li>
<li><strong>可扩展性</strong>：模块化设计支持未来的功能扩展</li>
</ul>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/10/23/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="claude-code文件编辑-AI辅助的代码修改">
                        
                        <span class="card-title">claude-code文件编辑-AI辅助的代码修改</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-10-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            寒霜
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/10/23/claude-code-jia-gou-yin-qing-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="claude-code架构-引擎室">
                        
                        <span class="card-title">claude-code架构-引擎室</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-10-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            寒霜
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('6'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            <!-- Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
             -->
            <!-- <a href="/about" target="_blank">寒霜</a> -->
            <!-- |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
             -->
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">147.5k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
