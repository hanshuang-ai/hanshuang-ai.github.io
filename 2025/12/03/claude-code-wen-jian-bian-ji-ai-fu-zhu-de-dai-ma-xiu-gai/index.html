<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>claude-code文件编辑-AI辅助的代码修改 | 我的博客</title><meta name="keywords" content="claude-code,ai,文件编辑,代码生成"><meta name="author" content="寒霜"><meta name="copyright" content="寒霜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="claude-code文件编辑-AI辅助的代码修改"><meta name="application-name" content="claude-code文件编辑-AI辅助的代码修改"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="claude-code文件编辑-AI辅助的代码修改"><meta property="og:url" content="https://hanshuang-ai.github.io/2025/12/03/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/index.html"><meta property="og:site_name" content="我的博客"><meta property="og:description" content="参考链接 File Editing: AI-Assisted Code Modification文件编辑：AI辅助的代码修改graph TB     subgraph &amp;quot;文件编辑管道&amp;quot;         Read[读取工具] --&amp;gt;|cat -n 格式| Display[LLM看到]"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="寒霜"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="参考链接 File Editing: AI-Assisted Code Modification文件编辑：AI辅助的代码修改graph TB     subgraph &amp;quot;文件编辑管道&amp;quot;         Read[读取工具] --&amp;gt;|cat -n 格式| Display[LLM看到]"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://hanshuang-ai.github.io/2025/12/03/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '我的博客',
  title: 'claude-code文件编辑-AI辅助的代码修改',
  postAI: '',
  pageFillDescription: 'File Editing AI-Assisted Code Modification, 文件编辑：AI辅助的代码修改, 文件编辑管道架构, 行号问题：一个看似复杂的挑战, EditTool：字符串替换的手术级精度, MultiEditTool：原子顺序操作, WriteTool：完整文件操作, 验证层：深度防御, 差异生成和反馈：闭环处理, 特殊情况和边缘条件, 性能优化, 常见失败模式和恢复, 文件总结, 概述, 核心架构特点, 1. 四阶段编辑管道, 2. 行号问题的解决方案, 3. EditTool：手术级精度编辑, 4. MultiEditTool：原子批量操作, 5. WriteTool：完整文件操作, 深度防御验证体系, 五层验证架构, 差异生成和反馈系统, 智能差异策略, 反馈机制, 边缘情况处理, 特殊文件类型, 性能优化策略, 大文件处理, 缓存机制, 内存管理, 故障恢复机制, 外部修改冲突, 编码问题恢复, 磁盘空间问题, 部分写入恢复, 技术创新点, 架构创新, 性能创新, 安全创新, 工程实践, 结论参考链接文件编辑辅助的代码修改文件编辑管道读取工具格式看到去除行号编辑工具验证通过应用编辑失败错误结果更新缓存生成差异确认验证检查文件已读取文件未更改字符串存在计数匹配不是无操作文件编辑管道架构中的文件编辑不仅仅是更改文本它是一个精心编排的管道旨在处理辅助代码修改的复杂性四阶段编辑循环阶段验证阶段准备阶段应用阶段验证状态跟踪系统为什么使用多个工具而不是一个通用编辑器工具目的保证失败模式单个字符串替换精确匹配计数如果出现次数预期则失败顺序编辑原子批处理如果任何编辑无效则失败完整替换完全覆盖如果未先读取则失败单元格操作结构保留如果单元格缺失则失败每个工具都提供特定的保证这是通用编辑器在保持友好性的同时无法维持的行号问题一个看似复杂的挑战文件编辑中最关键的挑战是行号前缀问题从看到的内容可能错误尝试编辑的内容错误包含行号它应该使用的内容正确无行号行号去除逻辑收到关于此问题的广泛指令但真正的挑战是确保做到这一点检查是否包含行号前缀似乎包含行号前缀请移除开头的数字和制表符检查字符串是否存在于文件中尝试检测是否是行号问题未找到字符串您是否包含了行号字符串替换的手术级精度实现零歧义的精确字符串匹配步骤检索缓存文件状态文件必须在编辑前使用读取这确保您拥有当前文件内容步骤验证文件未被外部更改文件自上次读取以来已被外部修改请再次读取文件以查看当前内容步骤验证编辑步骤应用替换步骤生成差异用于验证步骤以相同编码行结尾写入步骤更新缓存步骤生成上下文片段上下文行数无操作检查和相同不会进行任何更改空特殊情况插入不允许空的对于新文件请使用使用精确字符串匹配计算出现次数在文件中未找到确保包括空白字符在内的精确匹配期望次替换但找到次出现将设置为或优化转义特殊正则表达式字符以进行精确匹配特殊替换模式的字符转义保留换行符保留回车符手动替换以尊重限制使用原始字符串而非转义字符串使用统一差异格式编辑前编辑后为什么很重要场景多次出现不使用结果所有出现都被替换包括函数参数使用仅使用处不包括参数结果失败强制使用更具体的原子顺序操作解决了多个相关编辑的复杂问题加载文件一次文件必须在编辑前读取在应用任何编辑之前验证所有编辑顺序应用编辑到工作副本根据当前工作内容验证此编辑编辑失败应用编辑原子失败不写入任何更改在编辑处中止所有编辑已验证并应用一次性写入更新缓存检查空编辑数组未提供编辑检测潜在冲突检测到编辑冲突模拟所有编辑以确保它们有效编辑未找到之前的编辑可能已删除它编辑期望次替换但找到次应用到模拟冲突类型后面的编辑修改前面编辑的结果编辑依赖于编辑的结果冲突类型重叠替换编辑和影响重叠文本冲突类型相同目标不同替换编辑和以不同方式替换相同文本查找所有出现的位置检查是否有任何位置重叠检查重叠冲突检测的实际应用示例依赖编辑依赖第一个编辑结果检测到冲突编辑依赖于编辑示例安全的顺序编辑结果无冲突独立更改完整文件操作处理完整的文件创建或替换检查文件是否存在现有文件必须已被读取现有文件必须在覆盖前使用读取这可以防止意外数据丢失验证未被外部修改文件已被外部修改在覆盖前再次读取文件以查看当前内容文档文件限制创建文档文件需要明确的用户请求除非特别要求文档否则专注于代码实现准备写入操作确保目录存在写入文件更新缓存生成结果检测或保留行结尾默认为保留现有行结尾上新文件默认为规范化然后应用正确的行结尾检测编码简化实际实现更复杂更新时保留文件模式验证层深度防御每个编辑操作都经过多层验证层路径验证层权限检查层文件状态验证层内容验证层安全检查绝对路径要求文件路径必须是绝对路径路径遍历防护路径包含可疑的遍历模式边界检查路径在允许的目录之外特殊文件防护不允许对敏感文件进行操作检查文件是否已存在文件已存在使用并在之前读取以覆盖文件必须在编辑前读取陈旧性检查文件已被外部修改文件不再存在或无法访问差异生成和反馈闭环处理每个编辑都为生成丰富的反馈根据更改大小使用不同的差异策略小更改使用统一差异中等更改使用单词差异大更改使用摘要差异限制总片段大小截断使用差异算法格式化为统一差异编辑前编辑后特殊情况和边缘条件文件编辑必须处理许多边缘情况空文件处理无法编辑空文件使用添加内容的特殊反馈警告文件存在但内容为空二进制文件检测检查空字节二进制文件中常见检查文件扩展名使用文件魔数符号链接处理检查目标是否存在损坏的符号链接指向不存在的对于编辑操作提供选择这是指向的符号链接编辑将修改目标文件编码检测和处理检查尝试检查替换字符回退启发式默认为并附带警告编码不确定假设为性能优化大规模文件编辑需要仔细优化大文件的缓存策略对超过的文件使用流式处理对的文件使用分块缓存小文件直接读取使用缓存块分块读取块缓存以备将来使用批量编辑准备预计算所有位置按位置排序编辑逆序以安全应用内存高效差异生成对大文件使用滑动窗口性能特征文件大小操作方法时间内存读取直接读取直接读取分块读取流式任何编辑单个内存中任何编辑多个顺序任何写入直接常见失败模式和恢复理解常见失败有助于构建健壮的编辑外部修改冲突尝试三向合并基础我们的他们的文件已被外部修改更改已合并生成冲突标记检测到合并冲突需要手动解决回退显示差异并询问文件被外部修改覆盖外部更改中止编辑再次读取文件编码问题尝试不同编码使用编码而不是二进制回退视为二进制文件磁盘空间问题计算可以释放什么磁盘空间不足需要有可能是配额问题尽管有可用空间但写入失败检查磁盘配额部分写入恢复完全失败检查备份部分写入检查临时文件文件总结概述本文档深入分析了的文件编辑架构揭示了辅助代码修改背后的精密设计通过反编译和逆向工程分析文档详细展示了如何通过多层验证智能冲突检测和原子操作来确保文件编辑的安全性和可靠性核心架构特点四阶段编辑管道阶段验证路径权限文件状态检查阶段准备编辑前预处理和状态获取阶段应用执行实际的文件修改阶段验证编辑后的验证和反馈生成优势确保每个编辑操作都经过严格的检查和验证流程行号问题的解决方案挑战识别容易在中包含行号前缀检测机制正则表达式匹配模式智能建议自动去除行号并提供修正建议预防策略通过广泛指令和示例引导正确使用手术级精度编辑精确匹配基于字符串出现次数的严格验证外部修改检测通过文件修改时间戳防止并发冲突替换限制参数防止意外替换格式保持保留原始文件的编码和行结尾格式原子批量操作冲突检测依赖关系检测后续编辑修改前面编辑的结果重叠检测编辑影响相同文本区域矛盾检测相同目标的不同替换原子性保证要么全部成功要么全部失败顺序验证逐步验证每个编辑在当前状态下的有效性完整文件操作安全机制现有文件必须先读取才能覆盖外部修改时间戳验证文档文件创建限制格式保持智能检测和保留原始文件的编码行结尾权限目录创建自动创建不存在的目录结构深度防御验证体系五层验证架构路径验证绝对路径要求路径遍历攻击防护边界检查项目根目录限制敏感文件保护等权限检查多层权限规则评估用户交互式确认操作类型权限映射文件状态验证缓存状态一致性检查外部修改检测文件存在性验证内容验证编辑内容合理性检查无操作检测特殊字符处理安全检查恶意代码检测危险操作识别系统安全边界检查差异生成和反馈系统智能差异策略小更改统一差异格式行上下文中等更改单词级差异大更改摘要差异格式上下文片段围绕更改区域的行上下文最大字符反馈机制实时差异显示算法的高效实现上下文高亮更改行的特殊标记统计信息替换次数更改大小等边缘情况处理特殊文件类型空文件编辑操作被拒绝建议使用返回特殊系统提醒二进制文件空字节检测前文件扩展名检查文件魔数验证等符号链接目标存在性验证损坏链接检测编辑操作的明确警告编码检测检测编码回退策略编码不确定的警告机制性能优化策略大文件处理文件大小分级直接读取直接读取分块缓存流式处理缓存机制分块缓存块大小基于修改时间的失效文件状态缓存自动清理预计算优化批量编辑的位置预计算内存管理流式差异生成滑动窗口算法行窗口块大小优化读写块块间垃圾回收内存复杂度大文件的恒定内存占用故障恢复机制外部修改冲突三向合并基础版本我们的更改他们的更改冲突标记标准冲突格式用户决策覆盖中止重新读取选项编码问题恢复编码尝试序列二进制回退作为二进制文件处理测试写入验证编码可用性磁盘空间问题空间分析可用空间检查和使用分析清理建议可删除文件的建议列表配额检查磁盘配额问题的检测部分写入恢复备份恢复文件的自动恢复临时文件恢复文件的完整性检查大小验证期望大小与实际大小的比较技术创新点架构创新原子操作保证的全有或全无机制行号智能处理自动检测和修正的常见错误五层验证体系深度防御的安全架构差异生成优化基于更改大小的自适应策略性能创新分级文件处理根据文件大小的不同处理策略分块缓存机制大文件的高效缓存策略流式差异算法内存友好的大文件差异计算批量编辑优化位置预计算和逆序应用安全创新时间戳验证防止外部修改冲突路径安全验证多层次的路径安全检查敏感文件保护系统关键文件的自动保护权限分层管理基于操作类型的权限控制工程实践错误恢复机制全面的故障处理和恢复策略格式保持机制编码行结尾权限的智能保持反馈系统设计丰富的编辑反馈和差异显示边缘情况覆盖全面的特殊场景处理结论的文件编辑架构体现了现代软件工程的最佳实践通过精密的验证机制智能的冲突检测和可靠的原子操作实现了既安全又高效的辅助代码修改功能其核心价值在于安全性多层验证确保文件操作的安全性可靠性原子操作和冲突检测保证编辑的一致性性能分级处理和缓存优化确保大文件的高效处理用户友好智能的错误恢复和丰富的反馈机制这种复杂的文件编辑架构为辅助编程提供了优秀的技术参考特别是在需要处理复杂文件操作保证数据完整性和提供优秀用户体验的场景中文档的深入分析为理解现代系统的文件操作设计提供了宝贵的技术指导',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-12-29 18:57:24',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="我的博客" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">我的博客</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/ai%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">ai工具<sup>3</sup></a><a href="/tags/amd/" style="font-size: 1.05rem;">amd<sup>1</sup></a><a href="/tags/claude-code/" style="font-size: 1.05rem;">claude-code<sup>17</sup></a><a href="/tags/cmd/" style="font-size: 1.05rem;">cmd<sup>1</sup></a><a href="/tags/commonjs/" style="font-size: 1.05rem;">commonjs<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>11</sup></a><a href="/tags/deepseek/" style="font-size: 1.05rem;">deepseek<sup>1</sup></a><a href="/tags/dom/" style="font-size: 1.05rem;">dom<sup>4</sup></a><a href="/tags/flex/" style="font-size: 1.05rem;">flex<sup>2</sup></a><a href="/tags/go/" style="font-size: 1.05rem;">go<sup>1</sup></a><a href="/tags/golang/" style="font-size: 1.05rem;">golang<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>4</sup></a><a href="/tags/javascript/" style="font-size: 1.05rem;">javascript<sup>12</sup></a><a href="/tags/js/" style="font-size: 1.05rem;">js<sup>1</sup></a><a href="/tags/js%E8%A7%84%E8%8C%83/" style="font-size: 1.05rem;">js规范<sup>1</sup></a><a href="/tags/llm/" style="font-size: 1.05rem;">llm<sup>2</sup></a><a href="/tags/position/" style="font-size: 1.05rem;">position<sup>2</sup></a><a href="/tags/router/" style="font-size: 1.05rem;">router<sup>1</sup></a><a href="/tags/sdk/" style="font-size: 1.05rem;">sdk<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 1.05rem;">中间件<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" style="font-size: 1.05rem;">事件循环<sup>2</sup></a><a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 1.05rem;">入门<sup>1</sup></a><a href="/tags/%E5%88%86%E6%9E%90/" style="font-size: 1.05rem;">分析<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 1.05rem;">后端<sup>1</sup></a><a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/" style="font-size: 1.05rem;">响应式<sup>3</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">基础<sup>2</sup></a><a href="/tags/%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7/" style="font-size: 1.05rem;">实用技巧<sup>1</sup></a><a href="/tags/%E5%B8%83%E5%B1%80/" style="font-size: 1.05rem;">布局<sup>5</sup></a><a href="/tags/%E5%BC%B9%E6%80%A7%E7%9B%92%E5%AD%90/" style="font-size: 1.05rem;">弹性盒子<sup>1</sup></a><a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">插件开发<sup>1</sup></a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 1.05rem;">架构<sup>8</sup></a><a href="/tags/%E6%A0%87%E7%AD%BE/" style="font-size: 1.05rem;">标签<sup>1</sup></a><a href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/" style="font-size: 1.05rem;">模块化<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 1.05rem;">正则<sup>2</sup></a><a href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/" style="font-size: 1.05rem;">盒模型<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">编程语言<sup>1</sup></a><a href="/tags/%E7%BD%91%E6%A0%BC/" style="font-size: 1.05rem;">网格<sup>1</sup></a><a href="/tags/%E8%8A%82%E6%B5%81/" style="font-size: 1.05rem;">节流<sup>1</sup></a><a href="/tags/%E8%AF%AD%E4%B9%89%E5%8C%96/" style="font-size: 1.05rem;">语义化<sup>1</sup></a><a href="/tags/%E9%98%B2%E6%8A%96/" style="font-size: 1.05rem;">防抖<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B8%8EAI/" itemprop="url">大模型与AI</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/claude-code/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>claude-code</span></a><a class="article-meta__tags" href="/tags/ai/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ai</span></a><a class="article-meta__tags" href="/tags/%E6%96%87%E4%BB%B6%E7%BC%96%E8%BE%91/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>文件编辑</span></a><a class="article-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>代码生成</span></a></span></div></div><h1 class="post-title" itemprop="name headline">claude-code文件编辑-AI辅助的代码修改</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-12-02T16:00:00.000Z" title="发表于 2025-12-03 00:00:00">2025-12-03</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-12-29T10:57:24.488Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为北京"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>北京</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://hanshuang-ai.github.io/2025/12/03/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/"><header><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B8%8EAI/" itemprop="url">大模型与AI</a><a href="/tags/claude-code/" tabindex="-1" itemprop="url">claude-code</a><a href="/tags/ai/" tabindex="-1" itemprop="url">ai</a><a href="/tags/%E6%96%87%E4%BB%B6%E7%BC%96%E8%BE%91/" tabindex="-1" itemprop="url">文件编辑</a><a href="/tags/%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/" tabindex="-1" itemprop="url">代码生成</a><h1 id="CrawlerTitle" itemprop="name headline">claude-code文件编辑-AI辅助的代码修改</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">寒霜</span><time itemprop="dateCreated datePublished" datetime="2025-12-02T16:00:00.000Z" title="发表于 2025-12-03 00:00:00">2025-12-03</time><time itemprop="dateCreated datePublished" datetime="2025-12-29T10:57:24.488Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></header><p><a target="_blank" rel="noopener" href="https://southbridge-research.notion.site/File-Editing-AI-Assisted-Code-Modification-2055fec70db18100803ff7287c24c6cc">参考链接</a></p>
<h1 id="File-Editing-AI-Assisted-Code-Modification"><a href="#File-Editing-AI-Assisted-Code-Modification" class="headerlink" title="File Editing: AI-Assisted Code Modification"></a>File Editing: AI-Assisted Code Modification</h1><h1 id="文件编辑：AI辅助的代码修改"><a href="#文件编辑：AI辅助的代码修改" class="headerlink" title="文件编辑：AI辅助的代码修改"></a>文件编辑：AI辅助的代码修改</h1><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TB
    <span class="token keyword">subgraph</span> <span class="token string">"文件编辑管道"</span>
        Read<span class="token text string">[读取工具]</span> <span class="token arrow operator">--></span><span class="token label property">|cat -n 格式|</span> Display<span class="token text string">[LLM看到]</span>
        Display <span class="token arrow operator">--></span><span class="token label property">|去除行号|</span> Edit<span class="token text string">[编辑工具]</span>

        Edit <span class="token arrow operator">--></span> Validate<span class="token text string">&#123;验证&#125;</span>
        Validate <span class="token arrow operator">--></span><span class="token label property">|通过|</span> Apply<span class="token text string">[应用编辑]</span>
        Validate <span class="token arrow operator">--></span><span class="token label property">|失败|</span> Error<span class="token text string">[错误结果]</span>

        Apply <span class="token arrow operator">--></span> Cache<span class="token text string">[更新缓存]</span>
        Cache <span class="token arrow operator">--></span> Diff<span class="token text string">[生成差异]</span>
        Diff <span class="token arrow operator">--></span> Confirm<span class="token text string">[确认]</span>

        <span class="token keyword">subgraph</span> <span class="token string">"验证检查"</span>
            V1<span class="token text string">[文件已读取?]</span>
            V2<span class="token text string">[文件未更改?]</span>
            V3<span class="token text string">[字符串存在?]</span>
            V4<span class="token text string">[计数匹配?]</span>
            V5<span class="token text string">[不是无操作?]</span>
        <span class="token keyword">end</span>

        Validate <span class="token arrow operator">--></span> V1
        V1 <span class="token arrow operator">--></span> V2
        V2 <span class="token arrow operator">--></span> V3
        V3 <span class="token arrow operator">--></span> V4
        V4 <span class="token arrow operator">--></span> V5
    <span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/12/03/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/1.svg" class="">
<h2 id="文件编辑管道架构"><a href="#文件编辑管道架构" class="headerlink" title="文件编辑管道架构"></a>文件编辑管道架构</h2><p>Claude Code中的文件编辑不仅仅是更改文本——它是一个精心编排的管道，旨在处理AI辅助代码修改的复杂性：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FileEditingPipeline</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 四阶段编辑循环</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">executeEdit</span><span class="token punctuation">(</span>
    tool<span class="token operator">:</span> EditTool<span class="token punctuation">,</span>
    input<span class="token operator">:</span> EditInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>EditResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 阶段1：验证</span>
    <span class="token keyword">const</span> validation <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateEdit</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token operator">:</span> validation<span class="token punctuation">.</span>error <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 阶段2：准备</span>
    <span class="token keyword">const</span> prepared <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareEdit</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> validation<span class="token punctuation">.</span>fileState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段3：应用</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyEdit</span><span class="token punctuation">(</span>prepared<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段4：验证</span>
    <span class="token keyword">const</span> verified <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verifyEdit</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> verified<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 状态跟踪系统</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> fileStates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> FileState<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">interface</span> <span class="token class-name">FileState</span> <span class="token punctuation">&#123;</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    hash<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    mtime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    encoding<span class="token operator">:</span> BufferEncoding<span class="token punctuation">;</span>
    lineEndings<span class="token operator">:</span> <span class="token string">'\\n'</span> <span class="token operator">|</span> <span class="token string">'\\r\\n'</span> <span class="token operator">|</span> <span class="token string">'\\r'</span><span class="token punctuation">;</span>
    isBinary<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    size<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>为什么使用多个工具而不是一个通用编辑器？</strong></p>
<table>
<thead>
<tr>
<th>工具</th>
<th>目的</th>
<th>保证</th>
<th>失败模式</th>
</tr>
</thead>
<tbody><tr>
<td><code>EditTool</code></td>
<td>单个字符串替换</td>
<td>精确匹配计数</td>
<td>如果出现次数≠预期则失败</td>
</tr>
<tr>
<td><code>MultiEditTool</code></td>
<td>顺序编辑</td>
<td>原子批处理</td>
<td>如果任何编辑无效则失败</td>
</tr>
<tr>
<td><code>WriteTool</code></td>
<td>完整替换</td>
<td>完全覆盖</td>
<td>如果未先读取则失败</td>
</tr>
<tr>
<td><code>NotebookEditTool</code></td>
<td>单元格操作</td>
<td>结构保留</td>
<td>如果单元格缺失则失败</td>
</tr>
</tbody></table>
<p>每个工具都提供特定的保证，这是通用编辑器在保持LLM友好性的同时无法维持的。</p>
<h2 id="行号问题：一个看似复杂的挑战"><a href="#行号问题：一个看似复杂的挑战" class="headerlink" title="行号问题：一个看似复杂的挑战"></a>行号问题：一个看似复杂的挑战</h2><p>文件编辑中最关键的挑战是行号前缀问题：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// LLM从ReadTool看到的内容：</span>
<span class="token keyword">const</span> readOutput <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
1	function hello() &#123;
2	  console.log('Hello, world!');
3	&#125;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// LLM可能错误尝试编辑的内容：</span>
<span class="token keyword">const</span> wrongOldString <span class="token operator">=</span> <span class="token string">"2	  console.log('Hello, world!');"</span><span class="token punctuation">;</span>  <span class="token comment">// 错误 - 包含行号</span>

<span class="token comment">// 它应该使用的内容：</span>
<span class="token keyword">const</span> correctOldString <span class="token operator">=</span> <span class="token string">"  console.log('Hello, world!');"</span><span class="token punctuation">;</span>  <span class="token comment">// 正确 - 无行号</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>行号去除逻辑：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">LineNumberHandler</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// LLM收到关于此问题的广泛指令</span>
  <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token constant">LINE_NUMBER_PATTERN</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\d+\\t</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token function">stripLineNumbers</span><span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> content
      <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=></span> line<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">LINE_NUMBER_PATTERN</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 但真正的挑战是确保LLM做到这一点</span>
  <span class="token keyword">static</span> <span class="token function">validateOldString</span><span class="token punctuation">(</span>
    oldString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    fileContent<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> ValidationResult <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查1：oldString是否包含行号前缀？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">LINE_NUMBER_PATTERN</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>oldString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'old_string似乎包含行号前缀。'</span> <span class="token operator">+</span>
               <span class="token string">'请移除开头的数字和制表符。'</span><span class="token punctuation">,</span>
        suggestion<span class="token operator">:</span> oldString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">LINE_NUMBER_PATTERN</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查2：字符串是否存在于文件中？</span>
    <span class="token keyword">const</span> occurrences <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countOccurrences</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> oldString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 尝试检测是否是行号问题</span>
      <span class="token keyword">const</span> possibleLineNumber <span class="token operator">=</span> oldString<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\\d+)\\t</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>possibleLineNumber<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> lineNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>possibleLineNumber<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> actualLine <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLine</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> lineNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">未找到字符串。您是否包含了行号</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>lineNum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">？</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          suggestion<span class="token operator">:</span> actualLine
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> occurrences <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="EditTool：字符串替换的手术级精度"><a href="#EditTool：字符串替换的手术级精度" class="headerlink" title="EditTool：字符串替换的手术级精度"></a>EditTool：字符串替换的手术级精度</h2><p>EditTool实现零歧义的精确字符串匹配：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">EditToolImplementation</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">executeEdit</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> EditInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>EditResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> old_string<span class="token punctuation">,</span> new_string<span class="token punctuation">,</span> expected_replacements <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// 步骤1：检索缓存文件状态</span>
    <span class="token keyword">const</span> cachedFile <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'文件必须在编辑前使用ReadFileTool读取。'</span> <span class="token operator">+</span>
        <span class="token string">'这确保您拥有当前文件内容。'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 步骤2：验证文件未被外部更改</span>
    <span class="token keyword">const</span> currentStats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cachedFile<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'文件自上次读取以来已被外部修改。'</span> <span class="token operator">+</span>
        <span class="token string">'请再次读取文件以查看当前内容。'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 步骤3：验证编辑</span>
    <span class="token keyword">const</span> validation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateEdit</span><span class="token punctuation">(</span>
      old_string<span class="token punctuation">,</span>
      new_string<span class="token punctuation">,</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      expected_replacements
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>validation<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 步骤4：应用替换</span>
    <span class="token keyword">const</span> newContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performReplacement</span><span class="token punctuation">(</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      old_string<span class="token punctuation">,</span>
      new_string<span class="token punctuation">,</span>
      expected_replacements
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤5：生成差异用于验证</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>
      cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      newContent<span class="token punctuation">,</span>
      file_path
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤6：以相同编码/行结尾写入</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFilePreservingFormat</span><span class="token punctuation">(</span>
      file_path<span class="token punctuation">,</span>
      newContent<span class="token punctuation">,</span>
      cachedFile
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤7：更新缓存</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> newContent<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤8：生成上下文片段</span>
    <span class="token keyword">const</span> snippet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateContextSnippet</span><span class="token punctuation">(</span>
      newContent<span class="token punctuation">,</span>
      new_string<span class="token punctuation">,</span>
      <span class="token number">5</span> <span class="token comment">// 上下文行数</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      diff<span class="token punctuation">,</span>
      snippet<span class="token punctuation">,</span>
      replacements<span class="token operator">:</span> expected_replacements
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">validateEdit</span><span class="token punctuation">(</span>
    oldString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    fileContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    expectedReplacements<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> EditValidation <span class="token punctuation">&#123;</span>
    <span class="token comment">// 无操作检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldString <span class="token operator">===</span> newString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'old_string和new_string相同。不会进行任何更改。'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 空old_string特殊情况（插入）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldString <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'不允许空的old_string。对于新文件请使用WriteTool。'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 使用精确字符串匹配计算出现次数</span>
    <span class="token keyword">const</span> occurrences <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countExactOccurrences</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> oldString<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'在文件中未找到old_string。确保包括空白字符在内的精确匹配。'</span><span class="token punctuation">,</span>
        suggestion<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findSimilarStrings</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> oldString<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">!==</span> expectedReplacements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">期望</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>expectedReplacements<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">次替换但找到</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>occurrences<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">次出现。</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">将expected_replacements设置为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>occurrences<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">或优化old_string。</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">countExactOccurrences</span><span class="token punctuation">(</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    searchString<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 转义特殊正则表达式字符以进行精确匹配</span>
    <span class="token keyword">const</span> escaped <span class="token operator">=</span> searchString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[.*+?^$&#123;&#125;()|[\\]\\\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\\\$&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>escaped<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">performReplacement</span><span class="token punctuation">(</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    oldString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    limit<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 特殊替换模式的字符转义</span>
    <span class="token keyword">const</span> <span class="token function-variable function">escapeReplacement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> str
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$$$$'</span><span class="token punctuation">)</span>  <span class="token comment">// $ -> $$</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\n'</span><span class="token punctuation">)</span>    <span class="token comment">// 保留换行符</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\r</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 保留回车符</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> escapedNew <span class="token operator">=</span> <span class="token function">escapeReplacement</span><span class="token punctuation">(</span>newString<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 手动替换以尊重限制</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>oldString<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">+</span>
               newString <span class="token operator">+</span>  <span class="token comment">// 使用原始字符串，而非转义字符串</span>
               result<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> oldString<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      lastIndex <span class="token operator">=</span> index <span class="token operator">+</span> newString<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateDiff</span><span class="token punctuation">(</span>
    oldContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 使用统一差异格式</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token function">createUnifiedDiff</span><span class="token punctuation">(</span>
      filePath<span class="token punctuation">,</span>
      filePath<span class="token punctuation">,</span>
      oldContent<span class="token punctuation">,</span>
      newContent<span class="token punctuation">,</span>
      <span class="token string">'编辑前'</span><span class="token punctuation">,</span>
      <span class="token string">'编辑后'</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> context<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> diff<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>为什么<code>expected_replacements</code>很重要</strong>：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 场景：多次出现</span>
<span class="token keyword">const</span> fileContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
function processUser(user) &#123;
  console.log(user);
  return user;
&#125;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 不使用expected_replacements：</span>
<span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  old_string<span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
  new_string<span class="token operator">:</span> <span class="token string">"userData"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：所有出现都被替换（包括函数参数！）</span>

<span class="token comment">// 使用expected_replacements：</span>
<span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  old_string<span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
  new_string<span class="token operator">:</span> <span class="token string">"userData"</span><span class="token punctuation">,</span>
  expected_replacements<span class="token operator">:</span> <span class="token number">2</span>  <span class="token comment">// 仅使用处，不包括参数</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：失败 - 强制使用更具体的old_string</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="MultiEditTool：原子顺序操作"><a href="#MultiEditTool：原子顺序操作" class="headerlink" title="MultiEditTool：原子顺序操作"></a>MultiEditTool：原子顺序操作</h2><p>MultiEditTool解决了多个相关编辑的复杂问题：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">MultiEditToolImplementation</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">executeMultiEdit</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> MultiEditInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>MultiEditResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> edits <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// 加载文件一次</span>
    <span class="token keyword">const</span> cachedFile <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'文件必须在编辑前读取'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 在应用任何编辑之前验证所有编辑</span>
    <span class="token keyword">const</span> validationResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateAllEdits</span><span class="token punctuation">(</span>
      edits<span class="token punctuation">,</span>
      cachedFile<span class="token punctuation">.</span>content
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationResult<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>validationResult<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 顺序应用编辑到工作副本</span>
    <span class="token keyword">let</span> workingContent <span class="token operator">=</span> cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token keyword">const</span> appliedEdits<span class="token operator">:</span> AppliedEdit<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> edit <span class="token operator">=</span> edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据当前工作内容验证此编辑</span>
        <span class="token keyword">const</span> validation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateSingleEdit</span><span class="token punctuation">(</span>
          edit<span class="token punctuation">,</span>
          workingContent<span class="token punctuation">,</span>
          i
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">失败：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>validation<span class="token punctuation">.</span>error<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 应用编辑</span>
        <span class="token keyword">const</span> beforeEdit <span class="token operator">=</span> workingContent<span class="token punctuation">;</span>
        workingContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyEdit</span><span class="token punctuation">(</span>
          workingContent<span class="token punctuation">,</span>
          edit
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        appliedEdits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          index<span class="token operator">:</span> i<span class="token punctuation">,</span>
          edit<span class="token punctuation">,</span>
          diff<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateEditDiff</span><span class="token punctuation">(</span>beforeEdit<span class="token punctuation">,</span> workingContent<span class="token punctuation">)</span><span class="token punctuation">,</span>
          summary<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">summarizeEdit</span><span class="token punctuation">(</span>edit<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 原子失败 - 不写入任何更改</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">MultiEdit在编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>edits<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">处中止：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 所有编辑已验证并应用 - 一次性写入</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFilePreservingFormat</span><span class="token punctuation">(</span>
      file_path<span class="token punctuation">,</span>
      workingContent<span class="token punctuation">,</span>
      cachedFile
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新缓存</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> workingContent<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      editsApplied<span class="token operator">:</span> appliedEdits<span class="token punctuation">,</span>
      totalDiff<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>
        cachedFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        workingContent<span class="token punctuation">,</span>
        file_path
      <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">validateAllEdits</span><span class="token punctuation">(</span>
    edits<span class="token operator">:</span> Edit<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    originalContent<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> ValidationResult <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查空编辑数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>edits<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'未提供编辑'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检测潜在冲突</span>
    <span class="token keyword">const</span> conflicts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">detectEditConflicts</span><span class="token punctuation">(</span>edits<span class="token punctuation">,</span> originalContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conflicts<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'检测到编辑冲突：\\n'</span> <span class="token operator">+</span>
               conflicts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=></span> c<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 模拟所有编辑以确保它们有效</span>
    <span class="token keyword">let</span> simulatedContent <span class="token operator">=</span> originalContent<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> edit <span class="token operator">=</span> edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> occurrences <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countOccurrences</span><span class="token punctuation">(</span>
        simulatedContent<span class="token punctuation">,</span>
        edit<span class="token punctuation">.</span>old_string
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">：未找到old_string。</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">之前的编辑可能已删除它。</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>occurrences <span class="token operator">!==</span> <span class="token punctuation">(</span>edit<span class="token punctuation">.</span>expected_replacements <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">：期望</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>edit<span class="token punctuation">.</span>expected_replacements <span class="token operator">||</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">次</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">替换但找到</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>occurrences<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">次</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 应用到模拟</span>
      simulatedContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyEdit</span><span class="token punctuation">(</span>simulatedContent<span class="token punctuation">,</span> edit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">detectEditConflicts</span><span class="token punctuation">(</span>
    edits<span class="token operator">:</span> Edit<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> EditConflict<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> conflicts<span class="token operator">:</span> EditConflict<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> edits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> edit1 <span class="token operator">=</span> edits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> edit2 <span class="token operator">=</span> edits<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 冲突类型1：后面的编辑修改前面编辑的结果</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>edit2<span class="token punctuation">.</span>old_string<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>edit1<span class="token punctuation">.</span>new_string<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conflicts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token string">'dependency'</span><span class="token punctuation">,</span>
            edits<span class="token operator">:</span> <span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span>
            description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">依赖于编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">的结果</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 冲突类型2：重叠替换</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">editsOverlap</span><span class="token punctuation">(</span>edit1<span class="token punctuation">,</span> edit2<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conflicts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token string">'overlap'</span><span class="token punctuation">,</span>
            edits<span class="token operator">:</span> <span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span>
            description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">和</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">影响重叠文本</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 冲突类型3：相同目标，不同替换</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>edit1<span class="token punctuation">.</span>old_string <span class="token operator">===</span> edit2<span class="token punctuation">.</span>old_string <span class="token operator">&amp;&amp;</span>
            edit1<span class="token punctuation">.</span>new_string <span class="token operator">!==</span> edit2<span class="token punctuation">.</span>new_string<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          conflicts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token string">'contradiction'</span><span class="token punctuation">,</span>
            edits<span class="token operator">:</span> <span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span>
            description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">编辑</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">和</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">以不同方式替换相同文本</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> conflicts<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">editsOverlap</span><span class="token punctuation">(</span>
    edit1<span class="token operator">:</span> Edit<span class="token punctuation">,</span>
    edit2<span class="token operator">:</span> Edit<span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 查找所有出现的位置</span>
    <span class="token keyword">const</span> positions1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findAllPositions</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> edit1<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> positions2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findAllPositions</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> edit2<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查是否有任何位置重叠</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pos1 <span class="token keyword">of</span> positions1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> end1 <span class="token operator">=</span> pos1 <span class="token operator">+</span> edit1<span class="token punctuation">.</span>old_string<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pos2 <span class="token keyword">of</span> positions2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> end2 <span class="token operator">=</span> pos2 <span class="token operator">+</span> edit2<span class="token punctuation">.</span>old_string<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

        <span class="token comment">// 检查重叠</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos1 <span class="token operator">&lt;</span> end2 <span class="token operator">&amp;&amp;</span> pos2 <span class="token operator">&lt;</span> end1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>冲突检测的实际应用</strong>：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// 示例：依赖编辑</span>
<span class="token keyword">const</span> edits <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    old_string<span class="token operator">:</span> <span class="token string">"console.log"</span><span class="token punctuation">,</span>
    new_string<span class="token operator">:</span> <span class="token string">"logger.info"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    old_string<span class="token operator">:</span> <span class="token string">"logger.info('test')"</span><span class="token punctuation">,</span>  <span class="token comment">// 依赖第一个编辑！</span>
    new_string<span class="token operator">:</span> <span class="token string">"logger.debug('test')"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：检测到冲突 - 编辑2依赖于编辑1</span>

<span class="token comment">// 示例：安全的顺序编辑</span>
<span class="token keyword">const</span> safeEdits <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    old_string<span class="token operator">:</span> <span class="token string">"var x"</span><span class="token punctuation">,</span>
    new_string<span class="token operator">:</span> <span class="token string">"let x"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    old_string<span class="token operator">:</span> <span class="token string">"var y"</span><span class="token punctuation">,</span>
    new_string<span class="token operator">:</span> <span class="token string">"let y"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：无冲突 - 独立更改</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="WriteTool：完整文件操作"><a href="#WriteTool：完整文件操作" class="headerlink" title="WriteTool：完整文件操作"></a>WriteTool：完整文件操作</h2><p>WriteTool处理完整的文件创建或替换：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">WriteToolImplementation</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">executeWrite</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> WriteInput<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>WriteResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> file_path<span class="token punctuation">,</span> content <span class="token punctuation">&#125;</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>

    <span class="token comment">// 检查文件是否存在</span>
    <span class="token keyword">const</span> exists <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>exists<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 现有文件 - 必须已被读取</span>
      <span class="token keyword">const</span> cachedFile <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">'现有文件必须在覆盖前使用ReadFileTool读取。'</span> <span class="token operator">+</span>
          <span class="token string">'这可以防止意外数据丢失。'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 验证未被外部修改</span>
      <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cachedFile<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">'文件已被外部修改。'</span> <span class="token operator">+</span>
          <span class="token string">'在覆盖前再次读取文件以查看当前内容。'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 文档文件限制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isDocumentationFile</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>context<span class="token punctuation">.</span>explicitlyAllowed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">'创建文档文件（*.md, README）需要明确的用户请求。'</span> <span class="token operator">+</span>
        <span class="token string">'除非特别要求文档，否则专注于代码实现。'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 准备写入操作</span>
    <span class="token keyword">const</span> writeData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareWriteData</span><span class="token punctuation">(</span>
      content<span class="token punctuation">,</span>
      exists <span class="token operator">?</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 确保目录存在</span>
    <span class="token keyword">const</span> dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 写入文件</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> writeData<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      encoding<span class="token operator">:</span> writeData<span class="token punctuation">.</span>encoding<span class="token punctuation">,</span>
      mode<span class="token operator">:</span> writeData<span class="token punctuation">.</span>mode
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新缓存</span>
    context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> content<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 生成结果</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exists<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> snippet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateContextSnippet</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        action<span class="token operator">:</span> <span class="token string">'updated'</span><span class="token punctuation">,</span>
        snippet
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        action<span class="token operator">:</span> <span class="token string">'created'</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> file_path
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">prepareWriteData</span><span class="token punctuation">(</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    existingFile<span class="token operator">:</span> FileState <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>WriteData<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检测或保留行结尾</span>
    <span class="token keyword">let</span> lineEnding <span class="token operator">=</span> <span class="token string">'\\n'</span><span class="token punctuation">;</span> <span class="token comment">// 默认为LF</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 保留现有行结尾</span>
      lineEnding <span class="token operator">=</span> existingFile<span class="token punctuation">.</span>lineEndings<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'win32'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Windows上新文件默认为CRLF</span>
      lineEnding <span class="token operator">=</span> <span class="token string">'\\r\\n'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 规范化然后应用正确的行结尾</span>
    <span class="token keyword">const</span> normalizedContent <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\r\\n|\\r|\\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> finalContent <span class="token operator">=</span> normalizedContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> lineEnding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测编码（简化 - 实际实现更复杂）</span>
    <span class="token keyword">const</span> encoding <span class="token operator">=</span> existingFile<span class="token operator">?.</span>encoding <span class="token operator">||</span> <span class="token string">'utf8'</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新时保留文件模式</span>
    <span class="token keyword">const</span> mode <span class="token operator">=</span> existingFile <span class="token operator">?</span>
      <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>existingFile<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mode <span class="token operator">:</span>
      <span class="token number">0o644</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      content<span class="token operator">:</span> finalContent<span class="token punctuation">,</span>
      encoding<span class="token punctuation">,</span>
      mode
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="验证层：深度防御"><a href="#验证层：深度防御" class="headerlink" title="验证层：深度防御"></a>验证层：深度防御</h2><p>每个编辑操作都经过多层验证：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FileValidationPipeline</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">validateFileOperation</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> FileOperation<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ValidationResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 层1：路径验证</span>
    <span class="token keyword">const</span> pathValidation <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validatePath</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>path<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathValidation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> pathValidation<span class="token punctuation">;</span>

    <span class="token comment">// 层2：权限检查</span>
    <span class="token keyword">const</span> permissionCheck <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkPermissions</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permissionCheck<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> permissionCheck<span class="token punctuation">;</span>

    <span class="token comment">// 层3：文件状态验证</span>
    <span class="token keyword">const</span> stateValidation <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateFileState</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stateValidation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> stateValidation<span class="token punctuation">;</span>

    <span class="token comment">// 层4：内容验证</span>
    <span class="token keyword">const</span> contentValidation <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateContent</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contentValidation<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> contentValidation<span class="token punctuation">;</span>

    <span class="token comment">// 层5：安全检查</span>
    <span class="token keyword">const</span> safetyCheck <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performSafetyChecks</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>safetyCheck<span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span> safetyCheck<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">validatePath</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ValidationResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 绝对路径要求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'文件路径必须是绝对路径'</span><span class="token punctuation">,</span>
        suggestion<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 路径遍历防护</span>
    <span class="token keyword">const</span> resolved <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> normalized <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved <span class="token operator">!==</span> normalized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'路径包含可疑的遍历模式'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 边界检查</span>
    <span class="token keyword">const</span> projectRoot <span class="token operator">=</span> context<span class="token punctuation">.</span>projectRoot<span class="token punctuation">;</span>
    <span class="token keyword">const</span> allowed <span class="token operator">=</span> <span class="token punctuation">[</span>
      projectRoot<span class="token punctuation">,</span>
      <span class="token operator">...</span>context<span class="token punctuation">.</span>additionalWorkingDirectories
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> isAllowed <span class="token operator">=</span> allowed<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>dir <span class="token operator">=></span>
      resolved<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAllowed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'路径在允许的目录之外'</span><span class="token punctuation">,</span>
        allowedDirs<span class="token operator">:</span> allowed
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 特殊文件防护</span>
    <span class="token keyword">const</span> forbidden <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span>git\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>
      <span class="token operator">/</span>node_modules\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>
      <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.env$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span>ssh\\<span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">,</span>
      <span class="token operator">/</span>\\<span class="token punctuation">.</span>gnupg\\<span class="token operator">/</span><span class="token operator">/</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>forbidden<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>pattern <span class="token operator">=></span> pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'不允许对敏感文件进行操作'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">validateFileState</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> FileOperation<span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolContext
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ValidationResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'create'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 检查文件是否已存在</span>
      <span class="token keyword">const</span> exists <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>exists <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>operation<span class="token punctuation">.</span>overwrite<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token string">'文件已存在。使用WriteTool并在之前读取以覆盖。'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'edit'</span> <span class="token operator">||</span> operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'overwrite'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> cached <span class="token operator">=</span> context<span class="token punctuation">.</span>readFileState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token string">'文件必须在编辑前读取'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 陈旧性检查</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>mtimeMs <span class="token operator">!==</span> cached<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> timeDiff <span class="token operator">=</span> stats<span class="token punctuation">.</span>mtimeMs <span class="token operator">-</span> cached<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            error<span class="token operator">:</span> <span class="token string">'文件已被外部修改'</span><span class="token punctuation">,</span>
            details<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              cachedTime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">,</span>
              currentTime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>mtimeMs<span class="token punctuation">)</span><span class="token punctuation">,</span>
              difference<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>timeDiff<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          valid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token string">'文件不再存在或无法访问'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> valid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="差异生成和反馈：闭环处理"><a href="#差异生成和反馈：闭环处理" class="headerlink" title="差异生成和反馈：闭环处理"></a>差异生成和反馈：闭环处理</h2><p>每个编辑都为LLM生成丰富的反馈：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">DiffGenerator</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token function">generateEditFeedback</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> EditOperation<span class="token punctuation">,</span>
    result<span class="token operator">:</span> EditResult
  <span class="token punctuation">)</span><span class="token operator">:</span> EditFeedback <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> feedback<span class="token operator">:</span> EditFeedback <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      summary<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSummary</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span>
      diff<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span>
      snippet<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateContextSnippet</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span>
      statistics<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateStatistics</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> feedback<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateDiff</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> EditOperation<span class="token punctuation">,</span>
    result<span class="token operator">:</span> EditResult
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> oldContent<span class="token punctuation">,</span> newContent<span class="token punctuation">,</span> filePath <span class="token punctuation">&#125;</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>

    <span class="token comment">// 根据更改大小使用不同的差异策略</span>
    <span class="token keyword">const</span> changeRatio <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateChangeRatio</span><span class="token punctuation">(</span>oldContent<span class="token punctuation">,</span> newContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>changeRatio <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 小更改 - 使用统一差异</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateUnifiedDiff</span><span class="token punctuation">(</span>
        oldContent<span class="token punctuation">,</span>
        newContent<span class="token punctuation">,</span>
        filePath<span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> context<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>changeRatio <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 中等更改 - 使用单词差异</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateWordDiff</span><span class="token punctuation">(</span>
        oldContent<span class="token punctuation">,</span>
        newContent<span class="token punctuation">,</span>
        filePath
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 大更改 - 使用摘要差异</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateSummaryDiff</span><span class="token punctuation">(</span>
        oldContent<span class="token punctuation">,</span>
        newContent<span class="token punctuation">,</span>
        filePath
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateContextSnippet</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> EditOperation<span class="token punctuation">,</span>
    result<span class="token operator">:</span> EditResult
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> newContent<span class="token punctuation">,</span> changedRanges <span class="token punctuation">&#125;</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
    <span class="token keyword">const</span> lines <span class="token operator">=</span> newContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> snippets<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> range <span class="token keyword">of</span> changedRanges<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> range<span class="token punctuation">.</span>start <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>lines<span class="token punctuation">.</span>length<span class="token punctuation">,</span> range<span class="token punctuation">.</span>end <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> snippet <span class="token operator">=</span> lines
        <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> lineNum <span class="token operator">=</span> start <span class="token operator">+</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> isChanged <span class="token operator">=</span> lineNum <span class="token operator">>=</span> range<span class="token punctuation">.</span>start <span class="token operator">&amp;&amp;</span> lineNum <span class="token operator">&lt;=</span> range<span class="token punctuation">.</span>end<span class="token punctuation">;</span>
          <span class="token keyword">const</span> prefix <span class="token operator">=</span> isChanged <span class="token operator">?</span> <span class="token string">'>'</span> <span class="token operator">:</span> <span class="token string">' '</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>prefix<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>lineNum<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>line<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      snippets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>snippet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 限制总片段大小</span>
    <span class="token keyword">const</span> combined <span class="token operator">=</span> snippets<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n...\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>combined<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> combined<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\\n... (截断)'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> combined<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">generateUnifiedDiff</span><span class="token punctuation">(</span>
    oldContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> DiffOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> oldLines <span class="token operator">=</span> oldContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newLines <span class="token operator">=</span> newContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用Myers差异算法</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyersDiff</span><span class="token punctuation">(</span>oldLines<span class="token punctuation">,</span> newLines<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hunks <span class="token operator">=</span> diff<span class="token punctuation">.</span><span class="token function">getHunks</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 格式化为统一差异</span>
    <span class="token keyword">const</span> header <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filePath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\t(编辑前)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+++ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filePath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\t(编辑后)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string">''</span>
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> formattedHunks <span class="token operator">=</span> hunks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>hunk <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> range <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@@ -</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hunk<span class="token punctuation">.</span>oldStart<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hunk<span class="token punctuation">.</span>oldLength<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hunk<span class="token punctuation">.</span>newStart<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hunk<span class="token punctuation">.</span>newLength<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> @@</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> lines <span class="token operator">=</span> hunk<span class="token punctuation">.</span>lines<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">case</span> <span class="token string">'unchanged'</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>line<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'deleted'</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>line<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'added'</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>line<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">[</span>range<span class="token punctuation">,</span> <span class="token operator">...</span>lines<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> header <span class="token operator">+</span> formattedHunks<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="特殊情况和边缘条件"><a href="#特殊情况和边缘条件" class="headerlink" title="特殊情况和边缘条件"></a>特殊情况和边缘条件</h2><p>文件编辑必须处理许多边缘情况：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">EdgeCaseHandlers</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 空文件处理</span>
  <span class="token keyword">static</span> <span class="token function">handleEmptyFile</span><span class="token punctuation">(</span>
    operation<span class="token operator">:</span> EditOperation<span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> HandlerResult <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'edit'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          error<span class="token operator">:</span> <span class="token string">'无法编辑空文件。使用WriteTool添加内容。'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// ReadTool的特殊反馈</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        warning<span class="token operator">:</span> <span class="token string">'&lt;system-reminder>警告：文件存在但内容为空。&lt;/system-reminder>'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 二进制文件检测</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">detectBinaryFile</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> Buffer
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查空字节（二进制文件中常见）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查文件扩展名</span>
    <span class="token keyword">const</span> binaryExtensions <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.gif'</span><span class="token punctuation">,</span> <span class="token string">'.pdf'</span><span class="token punctuation">,</span> <span class="token string">'.zip'</span><span class="token punctuation">,</span>
      <span class="token string">'.exe'</span><span class="token punctuation">,</span> <span class="token string">'.dll'</span><span class="token punctuation">,</span> <span class="token string">'.so'</span><span class="token punctuation">,</span> <span class="token string">'.dylib'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>binaryExtensions<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 使用文件魔数</span>
    <span class="token keyword">const</span> magicNumbers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">'png'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x4E</span><span class="token punctuation">,</span> <span class="token number">0x47</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">'jpg'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xD8</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">'pdf'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x25</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">'zip'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x4B</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>type<span class="token punctuation">,</span> magic<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>magicNumbers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bufferStartsWith</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> magic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 符号链接处理</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">handleSymlink</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    operation<span class="token operator">:</span> FileOperation
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>SymlinkResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">lstat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stats<span class="token punctuation">.</span><span class="token function">isSymbolicLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> isSymlink<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readlink</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedTarget <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 检查目标是否存在</span>
      <span class="token keyword">const</span> targetExists <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>resolvedTarget<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetExists <span class="token operator">&amp;&amp;</span> operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'read'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          isSymlink<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">损坏的符号链接：指向不存在的</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 对于编辑操作，提供选择</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>operation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'edit'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          isSymlink<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          warning<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">这是指向</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">的符号链接。编辑将修改目标文件。</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          target<span class="token operator">:</span> resolvedTarget
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        isSymlink<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        target<span class="token operator">:</span> resolvedTarget
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> isSymlink<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 编码检测和处理</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">detectEncoding</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    buffer<span class="token operator">:</span> Buffer
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>EncodingInfo<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查BOM</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xEF</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xBB</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xBF</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xFF</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xFE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf16le'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xFE</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf16be'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 尝试UTF-8</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> decoded <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 检查替换字符</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>decoded<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'\\ufffd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token comment">// 回退启发式</span>
    <span class="token keyword">const</span> nullBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">=></span> b <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> highBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>b <span class="token operator">=></span> b <span class="token operator">></span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nullBytes <span class="token operator">></span> buffer<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'binary'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>highBytes <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> encoding<span class="token operator">:</span> <span class="token string">'ascii'</span><span class="token punctuation">,</span> hasBOM<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 默认为utf8并附带警告</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
      hasBOM<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      warning<span class="token operator">:</span> <span class="token string">'编码不确定，假设为UTF-8'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>大规模文件编辑需要仔细优化：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FileEditingPerformance</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 大文件的缓存策略</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> chunkCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ChunkedFile<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">readLargeFile</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> ReadOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>FileContent<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 对超过10MB的文件使用流式处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">streamRead</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 对1-10MB的文件使用分块缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">chunkedRead</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 小文件直接读取</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">directRead</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">chunkedRead</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> ReadOptions
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>FileContent<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> cached <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">&amp;&amp;</span> cached<span class="token punctuation">.</span>mtime <span class="token operator">===</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mtimeMs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 使用缓存块</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assembleFromChunks</span><span class="token punctuation">(</span>cached<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 分块读取</span>
    <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 256KB块</span>
    <span class="token keyword">const</span> chunks<span class="token operator">:</span> Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      highWaterMark<span class="token operator">:</span> chunkSize
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> stream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 缓存以备将来使用</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>chunkCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      chunks<span class="token punctuation">,</span>
      mtime<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mtimeMs<span class="token punctuation">,</span>
      encoding<span class="token operator">:</span> <span class="token string">'utf8'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assembleFromChunks</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> chunks <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 批量编辑准备</span>
  <span class="token keyword">static</span> <span class="token function">prepareBatchEdits</span><span class="token punctuation">(</span>
    edits<span class="token operator">:</span> Edit<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> PreparedBatch <span class="token punctuation">&#123;</span>
    <span class="token comment">// 预计算所有位置</span>
    <span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> edit <span class="token keyword">of</span> edits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>positions<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>edit<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        positions<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
          edit<span class="token punctuation">.</span>old_string<span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findAllPositions</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> edit<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 按位置排序编辑（逆序以安全应用）</span>
    <span class="token keyword">const</span> sortedEdits <span class="token operator">=</span> edits
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>edit <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        edit<span class="token punctuation">,</span>
        position<span class="token operator">:</span> positions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>edit<span class="token punctuation">.</span>old_string<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>position <span class="token operator">-</span> a<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      edits<span class="token operator">:</span> sortedEdits<span class="token punctuation">,</span>
      positions<span class="token punctuation">,</span>
      canApplyInReverse<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 内存高效差异生成</span>
  <span class="token keyword">static</span> <span class="token operator">*</span><span class="token function">generateStreamingDiff</span><span class="token punctuation">(</span>
    oldContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    newContent<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Generator<span class="token operator">&lt;</span>DiffChunk<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> oldLines <span class="token operator">=</span> oldContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newLines <span class="token operator">=</span> newContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 对大文件使用滑动窗口</span>
    <span class="token keyword">const</span> windowSize <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">&lt;</span> oldLines<span class="token punctuation">.</span>length <span class="token operator">||</span> newIndex <span class="token operator">&lt;</span> newLines<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> oldWindow <span class="token operator">=</span> oldLines<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>oldIndex<span class="token punctuation">,</span> oldIndex <span class="token operator">+</span> windowSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> newWindow <span class="token operator">=</span> newLines<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>newIndex<span class="token punctuation">,</span> newIndex <span class="token operator">+</span> windowSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">computeWindowDiff</span><span class="token punctuation">(</span>
        oldWindow<span class="token punctuation">,</span>
        newWindow<span class="token punctuation">,</span>
        oldIndex<span class="token punctuation">,</span>
        newIndex
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">yield</span> diff<span class="token punctuation">;</span>

      oldIndex <span class="token operator">+=</span> diff<span class="token punctuation">.</span>oldConsumed<span class="token punctuation">;</span>
      newIndex <span class="token operator">+=</span> diff<span class="token punctuation">.</span>newConsumed<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能特征</strong>：</p>
<table>
<thead>
<tr>
<th>文件大小</th>
<th>操作</th>
<th>方法</th>
<th>时间</th>
<th>内存</th>
</tr>
</thead>
<tbody><tr>
<td>&lt;100KB</td>
<td>读取</td>
<td>直接</td>
<td>&lt;5ms</td>
<td>O(n)</td>
</tr>
<tr>
<td>100KB-1MB</td>
<td>读取</td>
<td>直接</td>
<td>5-20ms</td>
<td>O(n)</td>
</tr>
<tr>
<td>1-10MB</td>
<td>读取</td>
<td>分块</td>
<td>20-100ms</td>
<td>O(chunk)</td>
</tr>
<tr>
<td>&gt;10MB</td>
<td>读取</td>
<td>流式</td>
<td>100ms+</td>
<td>O(1)</td>
</tr>
<tr>
<td>任何</td>
<td>编辑（单个）</td>
<td>内存中</td>
<td>&lt;10ms</td>
<td>O(n)</td>
</tr>
<tr>
<td>任何</td>
<td>编辑（多个）</td>
<td>顺序</td>
<td>&lt;50ms</td>
<td>O(n)</td>
</tr>
<tr>
<td>任何</td>
<td>写入</td>
<td>直接</td>
<td>&lt;20ms</td>
<td>O(n)</td>
</tr>
</tbody></table>
<h2 id="常见失败模式和恢复"><a href="#常见失败模式和恢复" class="headerlink" title="常见失败模式和恢复"></a>常见失败模式和恢复</h2><p>理解常见失败有助于构建健壮的编辑：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">FailureRecovery</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 外部修改冲突</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">handleExternalModification</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    cachedState<span class="token operator">:</span> FileState<span class="token punctuation">,</span>
    operation<span class="token operator">:</span> EditOperation
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RecoveryStrategy<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> currentContent <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currentStats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 尝试三向合并</span>
    <span class="token keyword">const</span> mergeResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attemptThreeWayMerge</span><span class="token punctuation">(</span>
      cachedState<span class="token punctuation">.</span>content<span class="token punctuation">,</span>    <span class="token comment">// 基础</span>
      operation<span class="token punctuation">.</span>newContent<span class="token punctuation">,</span>   <span class="token comment">// 我们的</span>
      currentContent         <span class="token comment">// 他们的</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeResult<span class="token punctuation">.</span>success <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mergeResult<span class="token punctuation">.</span>conflicts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        strategy<span class="token operator">:</span> <span class="token string">'auto_merge'</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> mergeResult<span class="token punctuation">.</span>merged<span class="token punctuation">,</span>
        warning<span class="token operator">:</span> <span class="token string">'文件已被外部修改。更改已合并。'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 生成冲突标记</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeResult<span class="token punctuation">.</span>conflicts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        strategy<span class="token operator">:</span> <span class="token string">'conflict_markers'</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> mergeResult<span class="token punctuation">.</span>conflictMarked<span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token string">'检测到合并冲突。需要手动解决。'</span><span class="token punctuation">,</span>
        conflicts<span class="token operator">:</span> mergeResult<span class="token punctuation">.</span>conflicts
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 回退：显示差异并询问</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      strategy<span class="token operator">:</span> <span class="token string">'user_decision'</span><span class="token punctuation">,</span>
      error<span class="token operator">:</span> <span class="token string">'文件被外部修改'</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'覆盖外部更改'</span><span class="token punctuation">,</span>
        <span class="token string">'中止编辑'</span><span class="token punctuation">,</span>
        <span class="token string">'再次读取文件'</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      diff<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateDiff</span><span class="token punctuation">(</span>cachedState<span class="token punctuation">.</span>content<span class="token punctuation">,</span> currentContent<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 编码问题</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">handleEncodingError</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    error<span class="token operator">:</span> Error<span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RecoveryStrategy<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 尝试不同编码</span>
    <span class="token keyword">const</span> encodings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token string">'latin1'</span><span class="token punctuation">,</span> <span class="token string">'utf16le'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> encoding <span class="token keyword">of</span> encodings<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> encoding <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> <span class="token string">'.test'</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> <span class="token string">'.test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          strategy<span class="token operator">:</span> <span class="token string">'alternate_encoding'</span><span class="token punctuation">,</span>
          encoding<span class="token punctuation">,</span>
          warning<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">使用</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>encoding<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">编码而不是UTF-8</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 二进制回退</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      strategy<span class="token operator">:</span> <span class="token string">'binary_write'</span><span class="token punctuation">,</span>
      warning<span class="token operator">:</span> <span class="token string">'视为二进制文件'</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 磁盘空间问题</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">handleDiskSpaceError</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    requiredBytes<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RecoveryStrategy<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> diskInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDiskInfo</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>diskInfo<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">available</span> <span class="token generic class-name"><span class="token operator">&lt;</span> requiredBytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 计算可以释放什么</span>
      <span class="token keyword">const</span> suggestions <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyzeDiskUsage</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        strategy<span class="token operator">:</span> <span class="token string">'free_space'</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">磁盘空间不足。需要</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatBytes</span><span class="token punctuation">(</span>requiredBytes<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">，</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">有</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatBytes</span><span class="token punctuation">(</span>diskInfo<span class="token punctuation">.</span>available<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        suggestions<span class="token operator">:</span> suggestions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">=></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          path<span class="token operator">:</span> s<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
          size<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatBytes</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span>
          type<span class="token operator">:</span> s<span class="token punctuation">.</span>type
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 可能是配额问题</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      strategy<span class="token operator">:</span> <span class="token string">'quota_check'</span><span class="token punctuation">,</span>
      error<span class="token operator">:</span> <span class="token string">'尽管有可用空间但写入失败。检查磁盘配额。'</span><span class="token punctuation">,</span>
      command<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">quota -v </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">USER</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 部分写入恢复</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">recoverPartialWrite</span><span class="token punctuation">(</span>
    filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    expectedSize<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RecoveryResult<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>size <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 完全失败 - 检查备份</span>
        <span class="token keyword">const</span> backupPath <span class="token operator">=</span> filePath <span class="token operator">+</span> <span class="token string">'.backup'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>backupPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>backupPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            recovered<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            method<span class="token operator">:</span> <span class="token string">'backup_restore'</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> expectedSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 部分写入 - 检查临时文件</span>
        <span class="token keyword">const</span> tempPath <span class="token operator">=</span> filePath <span class="token operator">+</span> <span class="token string">'.tmp'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> tempStats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tempStats<span class="token punctuation">.</span>size <span class="token operator">===</span> expectedSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
              recovered<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              method<span class="token operator">:</span> <span class="token string">'temp_file_restore'</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        recovered<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        partialSize<span class="token operator">:</span> stats<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        expectedSize
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        recovered<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        error<span class="token operator">:</span> error<span class="token punctuation">.</span>message
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档深入分析了Claude Code的文件编辑架构，揭示了AI辅助代码修改背后的精密设计。通过反编译和逆向工程分析，文档详细展示了Claude Code如何通过多层验证、智能冲突检测和原子操作来确保文件编辑的安全性和可靠性。</p>
<h2 id="核心架构特点"><a href="#核心架构特点" class="headerlink" title="核心架构特点"></a>核心架构特点</h2><h3 id="1-四阶段编辑管道"><a href="#1-四阶段编辑管道" class="headerlink" title="1. 四阶段编辑管道"></a>1. 四阶段编辑管道</h3><ul>
<li><strong>阶段1：验证</strong> - 路径、权限、文件状态检查</li>
<li><strong>阶段2：准备</strong> - 编辑前预处理和状态获取</li>
<li><strong>阶段3：应用</strong> - 执行实际的文件修改</li>
<li><strong>阶段4：验证</strong> - 编辑后的验证和反馈生成</li>
<li><strong>优势</strong>：确保每个编辑操作都经过严格的检查和验证流程</li>
</ul>
<h3 id="2-行号问题的解决方案"><a href="#2-行号问题的解决方案" class="headerlink" title="2. 行号问题的解决方案"></a>2. 行号问题的解决方案</h3><ul>
<li><strong>挑战识别</strong>：LLM容易在old_string中包含行号前缀</li>
<li><strong>检测机制</strong>：正则表达式匹配<code>/^\d+\t/</code>模式</li>
<li><strong>智能建议</strong>：自动去除行号并提供修正建议</li>
<li><strong>预防策略</strong>：通过广泛指令和示例引导正确使用</li>
</ul>
<h3 id="3-EditTool：手术级精度编辑"><a href="#3-EditTool：手术级精度编辑" class="headerlink" title="3. EditTool：手术级精度编辑"></a>3. EditTool：手术级精度编辑</h3><ul>
<li><strong>精确匹配</strong>：基于字符串出现次数的严格验证</li>
<li><strong>外部修改检测</strong>：通过文件修改时间戳防止并发冲突</li>
<li><strong>替换限制</strong>：expected_replacements参数防止意外替换</li>
<li><strong>格式保持</strong>：保留原始文件的编码和行结尾格式</li>
</ul>
<h3 id="4-MultiEditTool：原子批量操作"><a href="#4-MultiEditTool：原子批量操作" class="headerlink" title="4. MultiEditTool：原子批量操作"></a>4. MultiEditTool：原子批量操作</h3><ul>
<li><strong>冲突检测</strong>：<ul>
<li>依赖关系检测（后续编辑修改前面编辑的结果）</li>
<li>重叠检测（编辑影响相同文本区域）</li>
<li>矛盾检测（相同目标的不同替换）</li>
</ul>
</li>
<li><strong>原子性保证</strong>：要么全部成功，要么全部失败</li>
<li><strong>顺序验证</strong>：逐步验证每个编辑在当前状态下的有效性</li>
</ul>
<h3 id="5-WriteTool：完整文件操作"><a href="#5-WriteTool：完整文件操作" class="headerlink" title="5. WriteTool：完整文件操作"></a>5. WriteTool：完整文件操作</h3><ul>
<li><strong>安全机制</strong>：<ul>
<li>现有文件必须先读取才能覆盖</li>
<li>外部修改时间戳验证</li>
<li>文档文件创建限制</li>
</ul>
</li>
<li><strong>格式保持</strong>：智能检测和保留原始文件的编码、行结尾、权限</li>
<li><strong>目录创建</strong>：自动创建不存在的目录结构</li>
</ul>
<h2 id="深度防御验证体系"><a href="#深度防御验证体系" class="headerlink" title="深度防御验证体系"></a>深度防御验证体系</h2><h3 id="五层验证架构"><a href="#五层验证架构" class="headerlink" title="五层验证架构"></a>五层验证架构</h3><ol>
<li><p><strong>路径验证</strong>：</p>
<ul>
<li>绝对路径要求</li>
<li>路径遍历攻击防护</li>
<li>边界检查（项目根目录限制）</li>
<li>敏感文件保护（.git、.ssh等）</li>
</ul>
</li>
<li><p><strong>权限检查</strong>：</p>
<ul>
<li>多层权限规则评估</li>
<li>用户交互式确认</li>
<li>操作类型权限映射</li>
</ul>
</li>
<li><p><strong>文件状态验证</strong>：</p>
<ul>
<li>缓存状态一致性检查</li>
<li>外部修改检测</li>
<li>文件存在性验证</li>
</ul>
</li>
<li><p><strong>内容验证</strong>：</p>
<ul>
<li>编辑内容合理性检查</li>
<li>无操作检测</li>
<li>特殊字符处理</li>
</ul>
</li>
<li><p><strong>安全检查</strong>：</p>
<ul>
<li>恶意代码检测</li>
<li>危险操作识别</li>
<li>系统安全边界检查</li>
</ul>
</li>
</ol>
<h2 id="差异生成和反馈系统"><a href="#差异生成和反馈系统" class="headerlink" title="差异生成和反馈系统"></a>差异生成和反馈系统</h2><h3 id="智能差异策略"><a href="#智能差异策略" class="headerlink" title="智能差异策略"></a>智能差异策略</h3><ul>
<li><strong>小更改（&lt;10%）</strong>：统一差异格式，5行上下文</li>
<li><strong>中等更改（10-50%）</strong>：单词级差异</li>
<li><strong>大更改（&gt;50%）</strong>：摘要差异格式</li>
<li><strong>上下文片段</strong>：围绕更改区域的5行上下文，最大1000字符</li>
</ul>
<h3 id="反馈机制"><a href="#反馈机制" class="headerlink" title="反馈机制"></a>反馈机制</h3><ul>
<li><strong>实时差异显示</strong>：Myers算法的高效实现</li>
<li><strong>上下文高亮</strong>：更改行的特殊标记</li>
<li><strong>统计信息</strong>：替换次数、更改大小等</li>
</ul>
<h2 id="边缘情况处理"><a href="#边缘情况处理" class="headerlink" title="边缘情况处理"></a>边缘情况处理</h2><h3 id="特殊文件类型"><a href="#特殊文件类型" class="headerlink" title="特殊文件类型"></a>特殊文件类型</h3><ol>
<li><p><strong>空文件</strong>：</p>
<ul>
<li>编辑操作被拒绝，建议使用WriteTool</li>
<li>ReadTool返回特殊系统提醒</li>
</ul>
</li>
<li><p><strong>二进制文件</strong>：</p>
<ul>
<li>空字节检测（前8KB）</li>
<li>文件扩展名检查</li>
<li>文件魔数验证（PNG、JPG、PDF等）</li>
</ul>
</li>
<li><p><strong>符号链接</strong>：</p>
<ul>
<li>目标存在性验证</li>
<li>损坏链接检测</li>
<li>编辑操作的明确警告</li>
</ul>
</li>
<li><p><strong>编码检测</strong>：</p>
<ul>
<li>BOM检测（UTF-8、UTF-16）</li>
<li>编码回退策略（UTF-8 → Latin1 → UTF-16）</li>
<li>编码不确定的警告机制</li>
</ul>
</li>
</ol>
<h2 id="性能优化策略"><a href="#性能优化策略" class="headerlink" title="性能优化策略"></a>性能优化策略</h2><h3 id="大文件处理"><a href="#大文件处理" class="headerlink" title="大文件处理"></a>大文件处理</h3><ul>
<li><strong>文件大小分级</strong>：<ul>
<li>&lt;100KB：直接读取（&lt;5ms）</li>
<li>100KB-1MB：直接读取（5-20ms）</li>
<li>1-10MB：分块缓存（20-100ms）</li>
<li><blockquote>
<p>10MB：流式处理（100ms+）</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h3><ul>
<li><strong>分块缓存</strong>：256KB块大小，基于修改时间的失效</li>
<li><strong>文件状态缓存</strong>：WeakRef + FinalizationRegistry自动清理</li>
<li><strong>预计算优化</strong>：批量编辑的位置预计算</li>
</ul>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><ul>
<li><strong>流式差异生成</strong>：滑动窗口算法，1000行窗口</li>
<li><strong>块大小优化</strong>：64KB读写块，块间垃圾回收</li>
<li><strong>O(1)内存复杂度</strong>：大文件的恒定内存占用</li>
</ul>
<h2 id="故障恢复机制"><a href="#故障恢复机制" class="headerlink" title="故障恢复机制"></a>故障恢复机制</h2><h3 id="外部修改冲突"><a href="#外部修改冲突" class="headerlink" title="外部修改冲突"></a>外部修改冲突</h3><ul>
<li><strong>三向合并</strong>：基础版本、我们的更改、他们的更改</li>
<li><strong>冲突标记</strong>：标准Git冲突格式</li>
<li><strong>用户决策</strong>：覆盖、中止、重新读取选项</li>
</ul>
<h3 id="编码问题恢复"><a href="#编码问题恢复" class="headerlink" title="编码问题恢复"></a>编码问题恢复</h3><ul>
<li><strong>编码尝试序列</strong>：UTF-8 → Latin1 → UTF-16LE</li>
<li><strong>二进制回退</strong>：作为二进制文件处理</li>
<li><strong>测试写入</strong>：验证编码可用性</li>
</ul>
<h3 id="磁盘空间问题"><a href="#磁盘空间问题" class="headerlink" title="磁盘空间问题"></a>磁盘空间问题</h3><ul>
<li><strong>空间分析</strong>：可用空间检查和使用分析</li>
<li><strong>清理建议</strong>：可删除文件的建议列表</li>
<li><strong>配额检查</strong>：磁盘配额问题的检测</li>
</ul>
<h3 id="部分写入恢复"><a href="#部分写入恢复" class="headerlink" title="部分写入恢复"></a>部分写入恢复</h3><ul>
<li><strong>备份恢复</strong>：.backup文件的自动恢复</li>
<li><strong>临时文件恢复</strong>：.tmp文件的完整性检查</li>
<li><strong>大小验证</strong>：期望大小与实际大小的比较</li>
</ul>
<h2 id="技术创新点"><a href="#技术创新点" class="headerlink" title="技术创新点"></a>技术创新点</h2><h3 id="架构创新"><a href="#架构创新" class="headerlink" title="架构创新"></a>架构创新</h3><ol>
<li><strong>原子操作保证</strong>：MultiEditTool的全有或全无机制</li>
<li><strong>行号智能处理</strong>：自动检测和修正LLM的常见错误</li>
<li><strong>五层验证体系</strong>：深度防御的安全架构</li>
<li><strong>差异生成优化</strong>：基于更改大小的自适应策略</li>
</ol>
<h3 id="性能创新"><a href="#性能创新" class="headerlink" title="性能创新"></a>性能创新</h3><ol>
<li><strong>分级文件处理</strong>：根据文件大小的不同处理策略</li>
<li><strong>分块缓存机制</strong>：大文件的高效缓存策略</li>
<li><strong>流式差异算法</strong>：内存友好的大文件差异计算</li>
<li><strong>批量编辑优化</strong>：位置预计算和逆序应用</li>
</ol>
<h3 id="安全创新"><a href="#安全创新" class="headerlink" title="安全创新"></a>安全创新</h3><ol>
<li><strong>时间戳验证</strong>：防止外部修改冲突</li>
<li><strong>路径安全验证</strong>：多层次的路径安全检查</li>
<li><strong>敏感文件保护</strong>：系统关键文件的自动保护</li>
<li><strong>权限分层管理</strong>：基于操作类型的权限控制</li>
</ol>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><ol>
<li><strong>错误恢复机制</strong>：全面的故障处理和恢复策略</li>
<li><strong>格式保持机制</strong>：编码、行结尾、权限的智能保持</li>
<li><strong>反馈系统设计</strong>：丰富的编辑反馈和差异显示</li>
<li><strong>边缘情况覆盖</strong>：全面的特殊场景处理</li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Claude Code的文件编辑架构体现了现代软件工程的最佳实践，通过精密的验证机制、智能的冲突检测和可靠的原子操作，实现了既安全又高效的AI辅助代码修改功能。其核心价值在于：</p>
<ul>
<li><strong>安全性</strong>：多层验证确保文件操作的安全性</li>
<li><strong>可靠性</strong>：原子操作和冲突检测保证编辑的一致性</li>
<li><strong>性能</strong>：分级处理和缓存优化确保大文件的高效处理</li>
<li><strong>用户友好</strong>：智能的错误恢复和丰富的反馈机制</li>
</ul>
<p>这种复杂的文件编辑架构为AI辅助编程提供了优秀的技术参考，特别是在需要处理复杂文件操作、保证数据完整性和提供优秀用户体验的场景中。文档的深入分析为理解现代AI系统的文件操作设计提供了宝贵的技术指导。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">寒霜</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://hanshuang-ai.github.io/2025/12/03/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://hanshuang-ai.github.io/2025/12/03/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/')">claude-code文件编辑-AI辅助的代码修改</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://hanshuang-ai.github.io/2025/12/03/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=claude-code文件编辑-AI辅助的代码修改&amp;url=https://hanshuang-ai.github.io/2025/12/03/claude-code-wen-jian-bian-ji-ai-fu-zhu-de-dai-ma-xiu-gai/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hanshuang-ai.github.io" target="_blank">我的博客</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/claude-code/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>claude-code<span class="tagsPageCount">17</span></a><a class="post-meta__box__tags" href="/tags/ai/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ai<span class="tagsPageCount">7</span></a><a class="post-meta__box__tags" href="/tags/%E6%96%87%E4%BB%B6%E7%BC%96%E8%BE%91/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>文件编辑<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>代码生成<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/11/23/claude-code-router-wan-quan-fen-xi/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Claude Code Router完全分析</div></div></a></div><div class="next-post pull-right"><a href="/2025/12/05/claude-code-ti-shi-ci-gong-cheng-zhi-dao-ai-de-yi-zhu/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">claude-code提示词工程-指导AI的艺术</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/11/02/claude-code-todowrite-ti-shi-ci/" title="claude-code-TodoWrite提示词"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code-TodoWrite提示词</div></div></a></div><div><a href="/2025/12/05/claude-code-ti-shi-ci-gong-cheng-zhi-dao-ai-de-yi-zhu/" title="claude-code提示词工程-指导AI的艺术"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code提示词工程-指导AI的艺术</div></div></a></div><div><a href="/2025/11/02/claude-code-xi-tong-ti-shi-ci/" title="claude-code系统提示词"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code系统提示词</div></div></a></div><div><a href="/2025/12/17/claude-code-agent-sdk-jie-ru-zi-yan-cha-jian/" title="Claude Code Agent SDK 接入自研插件"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">Claude Code Agent SDK 接入自研插件</div></div></a></div><div><a href="/2025/11/23/claude-code-router-wan-quan-fen-xi/" title="Claude Code Router完全分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">Claude Code Router完全分析</div></div></a></div><div><a href="/2025/11/07/claude-code-task-ti-shi-ci/" title="claude-code-Task提示词"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code-Task提示词</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#File-Editing-AI-Assisted-Code-Modification"><span class="toc-number">1.</span> <span class="toc-text">File Editing: AI-Assisted Code Modification</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BC%96%E8%BE%91%EF%BC%9AAI%E8%BE%85%E5%8A%A9%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="toc-number">2.</span> <span class="toc-text">文件编辑：AI辅助的代码修改</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BC%96%E8%BE%91%E7%AE%A1%E9%81%93%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">文件编辑管道架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E5%8F%B7%E9%97%AE%E9%A2%98%EF%BC%9A%E4%B8%80%E4%B8%AA%E7%9C%8B%E4%BC%BC%E5%A4%8D%E6%9D%82%E7%9A%84%E6%8C%91%E6%88%98"><span class="toc-number">2.2.</span> <span class="toc-text">行号问题：一个看似复杂的挑战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EditTool%EF%BC%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9B%BF%E6%8D%A2%E7%9A%84%E6%89%8B%E6%9C%AF%E7%BA%A7%E7%B2%BE%E5%BA%A6"><span class="toc-number">2.3.</span> <span class="toc-text">EditTool：字符串替换的手术级精度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MultiEditTool%EF%BC%9A%E5%8E%9F%E5%AD%90%E9%A1%BA%E5%BA%8F%E6%93%8D%E4%BD%9C"><span class="toc-number">2.4.</span> <span class="toc-text">MultiEditTool：原子顺序操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WriteTool%EF%BC%9A%E5%AE%8C%E6%95%B4%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">2.5.</span> <span class="toc-text">WriteTool：完整文件操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%B1%82%EF%BC%9A%E6%B7%B1%E5%BA%A6%E9%98%B2%E5%BE%A1"><span class="toc-number">2.6.</span> <span class="toc-text">验证层：深度防御</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82%E7%94%9F%E6%88%90%E5%92%8C%E5%8F%8D%E9%A6%88%EF%BC%9A%E9%97%AD%E7%8E%AF%E5%A4%84%E7%90%86"><span class="toc-number">2.7.</span> <span class="toc-text">差异生成和反馈：闭环处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5%E5%92%8C%E8%BE%B9%E7%BC%98%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.8.</span> <span class="toc-text">特殊情况和边缘条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">2.9.</span> <span class="toc-text">性能优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%A4%B1%E8%B4%A5%E6%A8%A1%E5%BC%8F%E5%92%8C%E6%81%A2%E5%A4%8D"><span class="toc-number">2.10.</span> <span class="toc-text">常见失败模式和恢复</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">文件总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E7%89%B9%E7%82%B9"><span class="toc-number">3.2.</span> <span class="toc-text">核心架构特点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9B%9B%E9%98%B6%E6%AE%B5%E7%BC%96%E8%BE%91%E7%AE%A1%E9%81%93"><span class="toc-number">3.2.1.</span> <span class="toc-text">1. 四阶段编辑管道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%A1%8C%E5%8F%B7%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.2.2.</span> <span class="toc-text">2. 行号问题的解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-EditTool%EF%BC%9A%E6%89%8B%E6%9C%AF%E7%BA%A7%E7%B2%BE%E5%BA%A6%E7%BC%96%E8%BE%91"><span class="toc-number">3.2.3.</span> <span class="toc-text">3. EditTool：手术级精度编辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-MultiEditTool%EF%BC%9A%E5%8E%9F%E5%AD%90%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="toc-number">3.2.4.</span> <span class="toc-text">4. MultiEditTool：原子批量操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-WriteTool%EF%BC%9A%E5%AE%8C%E6%95%B4%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">3.2.5.</span> <span class="toc-text">5. WriteTool：完整文件操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E9%98%B2%E5%BE%A1%E9%AA%8C%E8%AF%81%E4%BD%93%E7%B3%BB"><span class="toc-number">3.3.</span> <span class="toc-text">深度防御验证体系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E5%B1%82%E9%AA%8C%E8%AF%81%E6%9E%B6%E6%9E%84"><span class="toc-number">3.3.1.</span> <span class="toc-text">五层验证架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82%E7%94%9F%E6%88%90%E5%92%8C%E5%8F%8D%E9%A6%88%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.4.</span> <span class="toc-text">差异生成和反馈系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%B7%AE%E5%BC%82%E7%AD%96%E7%95%A5"><span class="toc-number">3.4.1.</span> <span class="toc-text">智能差异策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E9%A6%88%E6%9C%BA%E5%88%B6"><span class="toc-number">3.4.2.</span> <span class="toc-text">反馈机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%B9%E7%BC%98%E6%83%85%E5%86%B5%E5%A4%84%E7%90%86"><span class="toc-number">3.5.</span> <span class="toc-text">边缘情况处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.5.1.</span> <span class="toc-text">特殊文件类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">3.6.</span> <span class="toc-text">性能优化策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-number">3.6.1.</span> <span class="toc-text">大文件处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-number">3.6.2.</span> <span class="toc-text">缓存机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">3.6.3.</span> <span class="toc-text">内存管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">3.7.</span> <span class="toc-text">故障恢复机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E4%BF%AE%E6%94%B9%E5%86%B2%E7%AA%81"><span class="toc-number">3.7.1.</span> <span class="toc-text">外部修改冲突</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E9%97%AE%E9%A2%98%E6%81%A2%E5%A4%8D"><span class="toc-number">3.7.2.</span> <span class="toc-text">编码问题恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E9%97%AE%E9%A2%98"><span class="toc-number">3.7.3.</span> <span class="toc-text">磁盘空间问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%86%99%E5%85%A5%E6%81%A2%E5%A4%8D"><span class="toc-number">3.7.4.</span> <span class="toc-text">部分写入恢复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%88%9B%E6%96%B0%E7%82%B9"><span class="toc-number">3.8.</span> <span class="toc-text">技术创新点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%88%9B%E6%96%B0"><span class="toc-number">3.8.1.</span> <span class="toc-text">架构创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%9B%E6%96%B0"><span class="toc-number">3.8.2.</span> <span class="toc-text">性能创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%88%9B%E6%96%B0"><span class="toc-number">3.8.3.</span> <span class="toc-text">安全创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.8.4.</span> <span class="toc-text">工程实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">3.9.</span> <span class="toc-text">结论</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/02/xiang-liang-shu-ju-ku/" title="向量数据库">向量数据库</a><time datetime="2025-12-29T10:57:24.518Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/11/da-mo-xing-he-ji/" title="大模型合集">大模型合集</a><time datetime="2025-12-29T10:57:24.509Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/18/claude-code-todoread-ti-shi-ci/" title="claude-code TodoRead提示词">claude-code TodoRead提示词</a><time datetime="2025-12-29T10:57:24.506Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/10/da-mo-xing-xun-lian-yu-you-hua-wan-quan-zhi-nan/" title="大模型训练与优化完全指南">大模型训练与优化完全指南</a><time datetime="2025-12-29T10:57:24.505Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/12/claude-code-gong-ju-yu-zhi-xing-yin-qing/" title="claude-code工具与执行引擎">claude-code工具与执行引擎</a><time datetime="2025-12-29T10:57:24.501Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 寒霜</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">145</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">385</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">9</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://hexo.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/ai%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">ai工具<sup>3</sup></a><a href="/tags/amd/" style="font-size: 0.88rem;">amd<sup>1</sup></a><a href="/tags/claude-code/" style="font-size: 0.88rem;">claude-code<sup>17</sup></a><a href="/tags/cmd/" style="font-size: 0.88rem;">cmd<sup>1</sup></a><a href="/tags/commonjs/" style="font-size: 0.88rem;">commonjs<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>11</sup></a><a href="/tags/deepseek/" style="font-size: 0.88rem;">deepseek<sup>1</sup></a><a href="/tags/dom/" style="font-size: 0.88rem;">dom<sup>4</sup></a><a href="/tags/flex/" style="font-size: 0.88rem;">flex<sup>2</sup></a><a href="/tags/go/" style="font-size: 0.88rem;">go<sup>1</sup></a><a href="/tags/golang/" style="font-size: 0.88rem;">golang<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>4</sup></a><a href="/tags/javascript/" style="font-size: 0.88rem;">javascript<sup>12</sup></a><a href="/tags/js/" style="font-size: 0.88rem;">js<sup>1</sup></a><a href="/tags/js%E8%A7%84%E8%8C%83/" style="font-size: 0.88rem;">js规范<sup>1</sup></a><a href="/tags/llm/" style="font-size: 0.88rem;">llm<sup>2</sup></a><a href="/tags/position/" style="font-size: 0.88rem;">position<sup>2</sup></a><a href="/tags/router/" style="font-size: 0.88rem;">router<sup>1</sup></a><a href="/tags/sdk/" style="font-size: 0.88rem;">sdk<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">中间件<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" style="font-size: 0.88rem;">事件循环<sup>2</sup></a><a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 0.88rem;">入门<sup>1</sup></a><a href="/tags/%E5%88%86%E6%9E%90/" style="font-size: 0.88rem;">分析<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 0.88rem;">后端<sup>1</sup></a><a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/" style="font-size: 0.88rem;">响应式<sup>3</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">基础<sup>2</sup></a><a href="/tags/%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7/" style="font-size: 0.88rem;">实用技巧<sup>1</sup></a><a href="/tags/%E5%B8%83%E5%B1%80/" style="font-size: 0.88rem;">布局<sup>5</sup></a><a href="/tags/%E5%BC%B9%E6%80%A7%E7%9B%92%E5%AD%90/" style="font-size: 0.88rem;">弹性盒子<sup>1</sup></a><a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">插件开发<sup>1</sup></a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">架构<sup>8</sup></a><a href="/tags/%E6%A0%87%E7%AD%BE/" style="font-size: 0.88rem;">标签<sup>1</sup></a><a href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/" style="font-size: 0.88rem;">模块化<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 0.88rem;">正则<sup>2</sup></a><a href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/" style="font-size: 0.88rem;">盒模型<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">编程语言<sup>1</sup></a><a href="/tags/%E7%BD%91%E6%A0%BC/" style="font-size: 0.88rem;">网格<sup>1</sup></a><a href="/tags/%E8%8A%82%E6%B5%81/" style="font-size: 0.88rem;">节流<sup>1</sup></a><a href="/tags/%E8%AF%AD%E4%B9%89%E5%8C%96/" style="font-size: 0.88rem;">语义化<sup>1</sup></a><a href="/tags/%E9%98%B2%E6%8A%96/" style="font-size: 0.88rem;">防抖<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.7.1",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 寒霜 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>