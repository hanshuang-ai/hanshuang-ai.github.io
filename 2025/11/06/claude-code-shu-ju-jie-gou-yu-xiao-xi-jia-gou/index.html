<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>claude-code数据结构与消息架构 | 我的博客</title><meta name="keywords" content="claude-code,架构,数据结构,消息"><meta name="author" content="寒霜"><meta name="copyright" content="寒霜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="claude-code数据结构与消息架构"><meta name="application-name" content="claude-code数据结构与消息架构"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="claude-code数据结构与消息架构"><meta property="og:url" content="https://hanshuang-ai.github.io/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/index.html"><meta property="og:site_name" content="我的博客"><meta property="og:description" content="参考链接 Data Structures &amp;amp; The Information Architecture数据结构与信息架构stateDiagram-v2     [*] --&amp;gt; UserInput: User types&amp;#x2F;pastes     UserInput --&amp;gt; CliMessage:"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="寒霜"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="参考链接 Data Structures &amp;amp; The Information Architecture数据结构与信息架构stateDiagram-v2     [*] --&amp;gt; UserInput: User types&amp;#x2F;pastes     UserInput --&amp;gt; CliMessage:"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://hanshuang-ai.github.io/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '我的博客',
  title: 'claude-code数据结构与消息架构',
  postAI: '',
  pageFillDescription: 'Data Structures amp The Information Architecture, 数据结构与信息架构, The Streaming State Machine How Messages Transform, 流式状态机：消息如何转换, ContentBlock The Polymorphic Building Block, ContentBlock：多态构建块, The Streaming JSON Challenge, 流式JSON的挑战, Message Lifecycle From User Input to LLM and Back, 消息生命周期：从用户输入到LLM再返回, The CliMessage Structure More Than Meets the Eye, CliMessage结构：不仅仅是表面所见, Mutation Points and State Transitions, 变异点和状态转换, The System Prompt Dynamic Context Assembly, 系统提示：动态上下文组装, Memory Layout  Hierarchical Loading, 内存布局：CLAUDE.md层次化加载, Tool-Related Data Structures, 工具相关数据结构, ToolDefinition The Complete Tool Interface, ToolDefinition：完整的工具接口, The Execution Context Everything a Tool Needs, 执行上下文：工具所需的一切, MCP Protocol Structures, MCP协议结构, MCP State Machine, MCP状态机, Session State The Global Memory, 会话状态：全局内存, Bidirectional Streaming Implementation, 双向流实现, Performance Optimizations in Data Structures, 数据结构中的性能优化, 1. String Interning for Common Values, 1. 常用值的字符串驻留, 2. Lazy Content Block Parsing, 2. 延迟内容块解析, 3. ReadFileState Weak References, 3. ReadFileState弱引用, 文件总结, 概述, 核心架构特点, 1. 流式状态机架构, 2. 多态内容块系统, 3. 流式JSON解析器, 消息生命周期管理, 输入处理管道, 令牌管理策略, CliMessage：中枢神经系统, 结构设计, 变异控制机制, 系统提示动态组装, 多源数据集成, Git上下文实时感知, CLAUDE.md层次化加载, 工具系统架构, ToolDefinition完整接口, 执行上下文, 权限安全模型, MCP协议实现, JSON-RPC 2.0扩展, 状态机管理, 会话状态管理, 全局内存结构, 单例访问模式, 双向流协议, 载荷结构设计, 流处理机制, 性能优化策略, 1. 字符串驻留, 2. 延迟解析, 3. 弱引用缓存, 技术创新点, 架构创新, 性能创新, 工程实践, 结论参考链接数据结构与信息架构流式状态机消息如何转换数据架构最引人入胜的方面是它如何在保持流式性能的同时管理数据通过多种表示形式的转换让我们从核心创新开始双表示消息系统从分析推断阶段内部表示特定跟踪仅用于用户助手仅用于附件仅用于进度阶段线路格式无特定字段阶段流累加器累积为何重要这种三阶段表示允许在处理复杂流式协议的同时保持响应性可以使用元数据更新进度指示器而实际的通信使用干净的格式多态构建块基于反编译分析为内容实现了一个复杂的类型系统判别联合体重构平台特定平台特定平台特定平台特定平台特定基于推断用法的性能注释内存大小解析时间序列化时间可流式传输引用解析时间序列化时间不可流式传输内存大小解析时间序列化时间可流式传输可以流式传输流式的挑战最巧妙的创新之一是处理工具输入的流式流式解析器的推断实现缓冲区深度是否在字符串内是否转义跟踪结构深度跟踪字符串边界在深度时尝试解析尝试自动关闭未闭合的字符串已修复此解析器可以处理来自的增量块在结构看起来完整时立即尝试解析消息生命周期从用户输入到再返回输入处理用户文本输入斜杠命令命令内存笔记粘贴的图片文本创建用户处理命令合成消息更新检测类型创建创建消息转换清洁的消息计算令牌数超过限制压缩过程未超限发送到摘要消息结构不仅仅是表面所见类型作为应用程序的中枢神经系统消息类型唯一标识符时间戳仅用于用户助手消息角色提供的响应的模型生成停止原因命中的特定停止序列详细令牌计数内容特定元数据计算成本调用持续时间用于调试错误显示标志系统生成消息类型特定字段附件内容工具使用用于子工具工具特定进度性能特征创建时间序列化时间大内容使用弱引用从历史数组移除时可回收变异点和状态转换仔细控制数据结构可以被修改的位置推断的变异控制模式变异点流累积变异变异点工具结果注入系统生成其他字段变异变异点成本计算变异变异系统提示动态上下文组装也许最复杂的数据结构是动态组装的系统提示系统提示组装管道重构静态基础层次结构实时缓存新鲜可用工具每个模型组装顺序部分分隔符令牌预算优先级策略结构揭示实时感知当前分支已修改文件未跟踪文件已暂存文件最近提交哈希值提交消息作者时间戳昂贵的条件性的内存布局层次化加载项目根目录本地最高优先级用户第二优先级项目第三优先级托管最低优先级加载机制实现了高效的合并策略推断的加载算法托管用户项目本地使用覆盖语义合并后面的层覆盖前面的层指令用于显式覆盖指令用于添加默认使用分隔符连接工具相关数据结构完整的工具接口身份标识工具名称工具描述额外的指令模式双重表示运行时验证通信执行异步生成器权限权限决策输出格式化内容块或块数组元数据是否只读是否启用函数路径获取函数用户界面渲染函数工具定义的内存特征静态大小延迟编译缓存生成一次记忆化保留上下文引用执行上下文工具所需的一切取消机制中止控制器文件状态跟踪读取文件状态内容修改时间权限解析获取工具权限上下文选项包工具定义列表主循环模型调试模式详细模式非交互式会话最大思考令牌数连接客户端数组权限上下文揭示了复杂的安全模型模式额外工作目录层次化规则系统始终允许规则始终拒绝规则最高优先级本地设置项目设置策略设置最低优先级协议结构多云进程协议揭示了一个复杂的系统带扩展的版本通知的可选方法名参数响应必需的结果错误错误代码错误消息错误数据能力协商结构实验性功能功能标志工作区根目录采样委托动态提示资源服务工具暴露日志转发服务器发送的工具规范工具名称工具描述始终是模式特定元数据是否只读是否需要确认超时时间最大重试次数状态机断开连接连接传输就绪能力交换完成请求响应通知关闭错误协商失败已关闭重置会话状态全局内存身份会话原始工作目录当前工作目录可通过改变成本跟踪可变累加器总成本美元总持续时间模型令牌记录输入令牌数输出令牌数缓存读取输入令牌数缓存创建输入令牌数模型选择主循环模型覆盖初始主循环模型活动指标会话计数器代码行数拉取请求数提交数状态标志最后交互时间是否有未知模型成本最大速率限制回退是否激活可用模型模型字符串数组会话状态访问模式推断单例异步非阻塞双向流实现平台级别的流处理揭示了一个复杂的协议双向流载荷结构客户端到服务器编码编码方式解码的内容类型持续用户输入工具结果块对话回合输入服务器到客户端编码编码方式解码的事件类型内容块增量事件工具使用请求事件错误事件元数据事件双向流的流状态机文本编码器文本解码器缓冲区流读取器部分数据解码并按换行符分割格式基于协议缓冲区或进一步解码数据结构中的性能优化常用值的字符串驻留推断的字符串驻留模式字符串池在消息处理中的使用用户助手等结束回合工具使用等延迟内容块解析内容块可以使用延迟解析来提高性能原始数据解析后的数据只在访问时进行昂贵的解析弱引用带自动内存管理的文件缓存文件内容缓存终结注册表删除缓存条目设置文件内容创建弱引用添加到缓存注册到终结注册表获取文件内容获取弱引用解引用如果内容已被垃圾回收从缓存中删除文件总结概述本文档深入分析了的数据结构与消息架构揭示了其高性能流式处理背后的技术实现通过反编译和逆向工程分析文档详细展示了如何通过精心设计的数据结构来处理复杂的多层消息转换和流式协议核心架构特点流式状态机架构三阶段表示系统内部表示包含元数据和跟踪信息线路格式与通信的简洁格式流累加器处理增量数据的缓冲机制优势保持响应性同时处理复杂流式协议多态内容块系统联合类型支持文本图像工具调用结果等多种内容类型性能优化不同内容块具有不同的内存特征和序列化特性流式支持文本和工具块支持流式传输图像块通过引用优化流式解析器智能解析支持增量块的解析可自动修复未闭合字符串深度跟踪通过结构深度判断完整性字符串边界检测精确跟踪字符串状态和转义字符消息生命周期管理输入处理管道多样化输入源用户文本斜杠命令命令内存笔记粘贴内容智能类型检测自动识别输入内容类型并转换为相应格式消息转换去除特定字段生成纯净的消息令牌管理策略动态压缩超过令牌限制时自动压缩历史消息成本控制实时计算调用成本和持续时间性能指标详细的令牌使用统计和分析中枢神经系统结构设计类型安全支持用户助手附件进度四种消息类型元数据丰富包含成本持续时间请求等调试信息性能优化大内容使用弱引用从历史数组移除时可垃圾回收变异控制机制三个变异点流累积增量构建文本内容工具结果注入添加系统生成的工具结果消息成本计算动态更新成本和时间元数据系统提示动态组装多源数据集成基础指令静态的系统级指令层次支持本地用户项目托管四个优先级实时上下文状态目录结构可用工具模型适配针对不同模型的特定提示上下文实时感知分支信息当前分支状态和文件修改情况提交历史最近的提交记录和作者信息差异分析条件性的未提交差异计算层次化加载四级优先级本地用户项目托管高效合并覆盖语义显式覆盖添加指令缓存机制文件修改时间检查和内容缓存工具系统架构完整接口双重模式运行时验证通信模式异步执行支持进度更新的生成器模式权限系统分层权限检查和决策机制输出格式化工具结果到内容块的转换执行上下文取消机制支持文件状态跟踪读取文件的缓存和修改时间管理权限解析多层次的权限规则系统选项配置调试详细模式非交互会话等权限安全模型五级规则范围参数本地设置项目设置策略设置用户设置模式控制默认接受编辑绕过权限三种模式工作目录管理额外的授权工作目录集合协议实现扩展消息结构统一的请求响应通知格式能力协商工作区根目录采样动态提示等功能工具规范特定的元数据和安全配置状态机管理连接生命周期断开连接初始化就绪关闭错误处理连接失败协商失败的恢复机制双向通信支持请求响应和通知模式会话状态管理全局内存结构身份跟踪会话工作目录状态成本统计成本持续时间模型令牌详细统计活动指标会话代码行拉取请求提交计数器状态标志最后交互时间未知成本速率限制状态单例访问模式线程安全静态单例状态管理持久化异步非阻塞的磁盘持久化增量更新支持单个字段的更新和计数器递增双向流协议载荷结构设计客户端到服务器持续用户输入工具结果对话回合服务器到客户端内容增量工具请求错误元数据事件编码优化编码的紧凑载荷格式流处理机制格式服务器发送事件的标准化处理缓冲管理缓冲区和增量解码协议解析多层数据解码和提取性能优化策略字符串驻留内存优化常用字符串的池化管理减少重复消息类型停止原因等重复值的复用快速比较驻留字符串的指针比较延迟解析按需计算内容块仅在访问时解析成本分摊昂贵的解析操作延迟到必要时内存效率原始字符串和解析结果的智能管理弱引用缓存自动内存管理文件内容的弱引用缓存垃圾回收友好自动清理内存安全防止内存泄漏和悬挂引用技术创新点架构创新三层消息表示流的清晰分离多态内容系统统一接口处理多种内容类型动态系统提示实时上下文的高效组装双向流协议客户端和服务器的平等通信性能创新智能解析增量解析和自动修复分层权限系统灵活的安全控制机制内存优化策略驻留延迟弱引用的组合使用缓存管理多级缓存和自动失效机制工程实践类型安全接口的全面应用错误处理优雅的降级和恢复机制可观测性丰富的元数据和调试信息扩展性协议和工具系统的模块化设计结论的数据结构与消息架构体现了现代软件工程的最佳实践通过精心设计的数据结构实现了高性能的流式处理其架构的核心价值在于性能卓越多层次的优化确保了快速的响应时间架构清晰清晰的职责分离和模块化设计扩展性强灵活的工具系统和协议支持用户友好丰富的进度反馈和错误处理这种架构设计为处理复杂的交互场景提供了优秀的解决方案特别是在需要实时响应和大量数据处理的场景中表现出色文档的分析为理解现代应用的数据架构设计提供了宝贵的参考价值',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-12-29 18:57:24',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="我的博客" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">我的博客</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/ai%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">ai工具<sup>3</sup></a><a href="/tags/amd/" style="font-size: 1.05rem;">amd<sup>1</sup></a><a href="/tags/claude-code/" style="font-size: 1.05rem;">claude-code<sup>17</sup></a><a href="/tags/cmd/" style="font-size: 1.05rem;">cmd<sup>1</sup></a><a href="/tags/commonjs/" style="font-size: 1.05rem;">commonjs<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>11</sup></a><a href="/tags/deepseek/" style="font-size: 1.05rem;">deepseek<sup>1</sup></a><a href="/tags/dom/" style="font-size: 1.05rem;">dom<sup>4</sup></a><a href="/tags/flex/" style="font-size: 1.05rem;">flex<sup>2</sup></a><a href="/tags/go/" style="font-size: 1.05rem;">go<sup>1</sup></a><a href="/tags/golang/" style="font-size: 1.05rem;">golang<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>4</sup></a><a href="/tags/javascript/" style="font-size: 1.05rem;">javascript<sup>12</sup></a><a href="/tags/js/" style="font-size: 1.05rem;">js<sup>1</sup></a><a href="/tags/js%E8%A7%84%E8%8C%83/" style="font-size: 1.05rem;">js规范<sup>1</sup></a><a href="/tags/llm/" style="font-size: 1.05rem;">llm<sup>2</sup></a><a href="/tags/position/" style="font-size: 1.05rem;">position<sup>2</sup></a><a href="/tags/router/" style="font-size: 1.05rem;">router<sup>1</sup></a><a href="/tags/sdk/" style="font-size: 1.05rem;">sdk<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 1.05rem;">中间件<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" style="font-size: 1.05rem;">事件循环<sup>2</sup></a><a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 1.05rem;">入门<sup>1</sup></a><a href="/tags/%E5%88%86%E6%9E%90/" style="font-size: 1.05rem;">分析<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 1.05rem;">后端<sup>1</sup></a><a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/" style="font-size: 1.05rem;">响应式<sup>3</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">基础<sup>2</sup></a><a href="/tags/%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7/" style="font-size: 1.05rem;">实用技巧<sup>1</sup></a><a href="/tags/%E5%B8%83%E5%B1%80/" style="font-size: 1.05rem;">布局<sup>5</sup></a><a href="/tags/%E5%BC%B9%E6%80%A7%E7%9B%92%E5%AD%90/" style="font-size: 1.05rem;">弹性盒子<sup>1</sup></a><a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">插件开发<sup>1</sup></a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 1.05rem;">架构<sup>8</sup></a><a href="/tags/%E6%A0%87%E7%AD%BE/" style="font-size: 1.05rem;">标签<sup>1</sup></a><a href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/" style="font-size: 1.05rem;">模块化<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 1.05rem;">正则<sup>2</sup></a><a href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/" style="font-size: 1.05rem;">盒模型<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">编程语言<sup>1</sup></a><a href="/tags/%E7%BD%91%E6%A0%BC/" style="font-size: 1.05rem;">网格<sup>1</sup></a><a href="/tags/%E8%8A%82%E6%B5%81/" style="font-size: 1.05rem;">节流<sup>1</sup></a><a href="/tags/%E8%AF%AD%E4%B9%89%E5%8C%96/" style="font-size: 1.05rem;">语义化<sup>1</sup></a><a href="/tags/%E9%98%B2%E6%8A%96/" style="font-size: 1.05rem;">防抖<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B8%8EAI/" itemprop="url">大模型与AI</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/claude-code/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>claude-code</span></a><a class="article-meta__tags" href="/tags/%E6%9E%B6%E6%9E%84/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>架构</span></a><a class="article-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>数据结构</span></a><a class="article-meta__tags" href="/tags/%E6%B6%88%E6%81%AF/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>消息</span></a></span></div></div><h1 class="post-title" itemprop="name headline">claude-code数据结构与消息架构</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-11-05T16:00:00.000Z" title="发表于 2025-11-06 00:00:00">2025-11-06</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-12-29T10:57:24.474Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为北京"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>北京</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://hanshuang-ai.github.io/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/"><header><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B8%8EAI/" itemprop="url">大模型与AI</a><a href="/tags/claude-code/" tabindex="-1" itemprop="url">claude-code</a><a href="/tags/%E6%9E%B6%E6%9E%84/" tabindex="-1" itemprop="url">架构</a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" tabindex="-1" itemprop="url">数据结构</a><a href="/tags/%E6%B6%88%E6%81%AF/" tabindex="-1" itemprop="url">消息</a><h1 id="CrawlerTitle" itemprop="name headline">claude-code数据结构与消息架构</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">寒霜</span><time itemprop="dateCreated datePublished" datetime="2025-11-05T16:00:00.000Z" title="发表于 2025-11-06 00:00:00">2025-11-06</time><time itemprop="dateCreated datePublished" datetime="2025-12-29T10:57:24.474Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></header><p><a target="_blank" rel="noopener" href="https://southbridge-research.notion.site/Data-Structures-The-Information-Architecture-2055fec70db1814ba2a7c5fa2879ac21">参考链接</a></p>
<h1 id="Data-Structures-amp-The-Information-Architecture"><a href="#Data-Structures-amp-The-Information-Architecture" class="headerlink" title="Data Structures &amp; The Information Architecture"></a>Data Structures &amp; The Information Architecture</h1><h1 id="数据结构与信息架构"><a href="#数据结构与信息架构" class="headerlink" title="数据结构与信息架构"></a>数据结构与信息架构</h1><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">stateDiagram-v2</span>
    <span class="token text string">[*]</span> <span class="token arrow operator">--></span> UserInput<span class="token operator">:</span> User types/pastes
    UserInput <span class="token arrow operator">--></span> CliMessage<span class="token operator">:</span> CLI processes input
    CliMessage <span class="token arrow operator">--></span> APIMessage<span class="token operator">:</span> Format for LLM
    APIMessage <span class="token arrow operator">--></span> LLMStream<span class="token operator">:</span> API Request

    LLMStream <span class="token arrow operator">--></span> StreamEvent<span class="token operator">:</span> Server sends chunks
    StreamEvent <span class="token arrow operator">--></span> ContentBlockDelta<span class="token operator">:</span> Parse deltas
    ContentBlockDelta <span class="token arrow operator">--></span> AccumulatedMessage<span class="token operator">:</span> Build message

    AccumulatedMessage <span class="token arrow operator">--></span> ToolUseBlock<span class="token operator">:</span> Contains tool requests?
    ToolUseBlock <span class="token arrow operator">--></span> ToolExecution<span class="token operator">:</span> Execute tools
    ToolExecution <span class="token arrow operator">--></span> ToolProgress<span class="token operator">:</span> Yield progress
    ToolProgress <span class="token arrow operator">--></span> CliMessage<span class="token operator">:</span> Progress updates
    ToolExecution <span class="token arrow operator">--></span> ToolResult<span class="token operator">:</span> Complete execution
    ToolResult <span class="token arrow operator">--></span> ToolResultBlock<span class="token operator">:</span> Format result
    ToolResultBlock <span class="token arrow operator">--></span> CliMessage<span class="token operator">:</span> Tool result message

    AccumulatedMessage <span class="token arrow operator">--></span> CliMessage<span class="token operator">:</span> Final assistant message
    CliMessage <span class="token arrow operator">--></span> <span class="token text string">[*]</span><span class="token operator">:</span> Display to user

    CliMessage <span class="token arrow operator">--></span> APIMessage<span class="token operator">:</span> Loop continues
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/1.svg" class="">
<h2 id="The-Streaming-State-Machine-How-Messages-Transform"><a href="#The-Streaming-State-Machine-How-Messages-Transform" class="headerlink" title="The Streaming State Machine: How Messages Transform"></a>The Streaming State Machine: How Messages Transform</h2><h2 id="流式状态机：消息如何转换"><a href="#流式状态机：消息如何转换" class="headerlink" title="流式状态机：消息如何转换"></a>流式状态机：消息如何转换</h2><p>The most fascinating aspect of Claude Code’s data architecture is how it manages the transformation of data through multiple representations while maintaining streaming performance. Let’s start with the core innovation:<br>Claude Code数据架构最引人入胜的方面是它如何在保持流式性能的同时管理数据通过多种表示形式的转换。让我们从核心创新开始：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// The dual-representation message system (inferred from analysis)</span>
<span class="token comment">// 双表示消息系统（从分析推断）</span>
<span class="token keyword">interface</span> <span class="token class-name">MessageTransformPipeline</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Stage 1: CLI Internal Representation</span>
  <span class="token comment">// 阶段1：CLI内部表示</span>
  cliMessage<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    type<span class="token operator">:</span> <span class="token string">"user"</span> <span class="token operator">|</span> <span class="token string">"assistant"</span> <span class="token operator">|</span> <span class="token string">"attachment"</span> <span class="token operator">|</span> <span class="token string">"progress"</span>
    uuid<span class="token operator">:</span> <span class="token builtin">string</span>  <span class="token comment">// CLI-specific tracking CLI特定跟踪</span>
    timestamp<span class="token operator">:</span> <span class="token builtin">string</span>
    message<span class="token operator">?</span><span class="token operator">:</span> APICompatibleMessage  <span class="token comment">// Only for user/assistant 仅用于用户/助手</span>
    attachment<span class="token operator">?</span><span class="token operator">:</span> AttachmentContent   <span class="token comment">// Only for attachment 仅用于附件</span>
    progress<span class="token operator">?</span><span class="token operator">:</span> ProgressUpdate        <span class="token comment">// Only for progress 仅用于进度</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Stage 2: API Wire Format</span>
  <span class="token comment">// 阶段2：API线路格式</span>
  apiMessage<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    role<span class="token operator">:</span> <span class="token string">"user"</span> <span class="token operator">|</span> <span class="token string">"assistant"</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// No CLI-specific fields</span>
    <span class="token comment">// 无CLI特定字段</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Stage 3: Streaming Accumulator</span>
  <span class="token comment">// 阶段3：流累加器</span>
  streamAccumulator<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    partial<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>APIMessage<span class="token operator">></span>
    deltas<span class="token operator">:</span> ContentBlockDelta<span class="token punctuation">[</span><span class="token punctuation">]</span>
    buffers<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span>  <span class="token comment">// tool_use_id → accumulating JSON tool_use_id → 累积JSON</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Why This Matters</strong>: This three-stage representation allows Claude Code to maintain UI responsiveness while handling complex streaming protocols. The CLI can update progress indicators using <code>CliMessage</code> metadata while the actual LLM communication uses a clean <code>APIMessage</code> format.<br><strong>为何重要</strong>：这种三阶段表示允许Claude Code在处理复杂流式协议的同时保持UI响应性。CLI可以使用<code>CliMessage</code>元数据更新进度指示器，而实际的LLM通信使用干净的<code>APIMessage</code>格式。</p>
<h2 id="ContentBlock-The-Polymorphic-Building-Block"><a href="#ContentBlock-The-Polymorphic-Building-Block" class="headerlink" title="ContentBlock: The Polymorphic Building Block"></a>ContentBlock: The Polymorphic Building Block</h2><h2 id="ContentBlock：多态构建块"><a href="#ContentBlock：多态构建块" class="headerlink" title="ContentBlock：多态构建块"></a>ContentBlock：多态构建块</h2><p>Based on decompilation analysis, Claude Code implements a sophisticated type system for content:<br>基于反编译分析，Claude Code为内容实现了一个复杂的类型系统：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// The ContentBlock discriminated union (reconstructed)</span>
<span class="token comment">// ContentBlock判别联合体（重构）</span>
<span class="token keyword">type</span> <span class="token class-name">ContentBlock</span> <span class="token operator">=</span>
  <span class="token operator">|</span> TextBlock
  <span class="token operator">|</span> ImageBlock
  <span class="token operator">|</span> ToolUseBlock
  <span class="token operator">|</span> ToolResultBlock
  <span class="token operator">|</span> ThinkingBlock
  <span class="token operator">|</span> DocumentBlock      <span class="token comment">// Platform-specific - 平台特定</span>
  <span class="token operator">|</span> VideoBlock         <span class="token comment">// Platform-specific - 平台特定</span>
  <span class="token operator">|</span> GuardContentBlock  <span class="token comment">// Platform-specific - 平台特定</span>
  <span class="token operator">|</span> ReasoningBlock     <span class="token comment">// Platform-specific - 平台特定</span>
  <span class="token operator">|</span> CachePointBlock    <span class="token comment">// Platform-specific - 平台特定</span>

<span class="token comment">// Performance annotations based on inferred usage</span>
<span class="token comment">// 基于推断用法的性能注释</span>
<span class="token keyword">interface</span> <span class="token class-name">ContentBlockMetrics</span> <span class="token punctuation">&#123;</span>
  TextBlock<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    memorySize<span class="token operator">:</span> <span class="token string">"O(text.length)"</span><span class="token punctuation">,</span>        <span class="token comment">// 内存大小</span>
    parseTime<span class="token operator">:</span> <span class="token string">"O(1)"</span><span class="token punctuation">,</span>                   <span class="token comment">// 解析时间</span>
    serializeTime<span class="token operator">:</span> <span class="token string">"O(n)"</span><span class="token punctuation">,</span>               <span class="token comment">// 序列化时间</span>
    streamable<span class="token operator">:</span> <span class="token boolean">true</span>                     <span class="token comment">// 可流式传输</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  ImageBlock<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    memorySize<span class="token operator">:</span> <span class="token string">"O(1) + external"</span><span class="token punctuation">,</span>  <span class="token comment">// Reference to base64/S3 - 引用base64/S3</span>
    parseTime<span class="token operator">:</span> <span class="token string">"O(1)"</span><span class="token punctuation">,</span>                   <span class="token comment">// 解析时间</span>
    serializeTime<span class="token operator">:</span> <span class="token string">"O(size)"</span> <span class="token operator">|</span> <span class="token string">"O(1) for S3"</span><span class="token punctuation">,</span>  <span class="token comment">// 序列化时间</span>
    streamable<span class="token operator">:</span> <span class="token boolean">false</span>                    <span class="token comment">// 不可流式传输</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  ToolUseBlock<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    memorySize<span class="token operator">:</span> <span class="token string">"O(JSON.stringify(input).length)"</span><span class="token punctuation">,</span>  <span class="token comment">// 内存大小</span>
    parseTime<span class="token operator">:</span> <span class="token string">"O(n) for JSON parse"</span><span class="token punctuation">,</span>      <span class="token comment">// JSON解析时间</span>
    serializeTime<span class="token operator">:</span> <span class="token string">"O(n)"</span><span class="token punctuation">,</span>                <span class="token comment">// 序列化时间</span>
    streamable<span class="token operator">:</span> <span class="token boolean">true</span>                      <span class="token comment">// 可流式传输 - JSON可以流式传输</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="The-Streaming-JSON-Challenge"><a href="#The-Streaming-JSON-Challenge" class="headerlink" title="The Streaming JSON Challenge"></a>The Streaming JSON Challenge</h3><h3 id="流式JSON的挑战"><a href="#流式JSON的挑战" class="headerlink" title="流式JSON的挑战"></a>流式JSON的挑战</h3><p>One of Claude Code’s most clever innovations is handling streaming JSON for tool inputs:<br>Claude Code最巧妙的创新之一是处理工具输入的流式JSON：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Inferred implementation of streaming JSON parser</span>
<span class="token comment">// 流式JSON解析器的推断实现</span>
<span class="token keyword">class</span> <span class="token class-name">StreamingToolInputParser</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> buffer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>      <span class="token comment">// 缓冲区</span>
  <span class="token keyword">private</span> depth<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// JSON深度</span>
  <span class="token keyword">private</span> inString<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否在字符串内</span>
  <span class="token keyword">private</span> escape<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>   <span class="token comment">// 是否转义</span>

  <span class="token function">addChunk</span><span class="token punctuation">(</span>chunk<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ParseResult <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">+=</span> chunk<span class="token punctuation">;</span>

    <span class="token comment">// Track JSON structure depth - 跟踪JSON结构深度</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> char <span class="token keyword">of</span> chunk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>inString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'&#123;'</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">'['</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depth<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'&#125;'</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">']'</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depth<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// Track string boundaries - 跟踪字符串边界</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'"'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>escape<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inString <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>inString<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>escape <span class="token operator">=</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\\\\'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>escape<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Attempt parse at depth 0 - 在深度0时尝试解析</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>depth <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> complete<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Try auto-closing unclosed strings - 尝试自动关闭未闭合的字符串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
              complete<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              value<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">+</span> <span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              repaired<span class="token operator">:</span> <span class="token boolean">true</span>    <span class="token comment">// 已修复</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> complete<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token operator">:</span> e <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> complete<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>This parser can handle incremental JSON chunks from the LLM, attempting to parse as soon as the structure appears complete.<br>此解析器可以处理来自LLM的增量JSON块，在结构看起来完整时立即尝试解析。</p>
<h2 id="Message-Lifecycle-From-User-Input-to-LLM-and-Back"><a href="#Message-Lifecycle-From-User-Input-to-LLM-and-Back" class="headerlink" title="Message Lifecycle: From User Input to LLM and Back"></a>Message Lifecycle: From User Input to LLM and Back</h2><h2 id="消息生命周期：从用户输入到LLM再返回"><a href="#消息生命周期：从用户输入到LLM再返回" class="headerlink" title="消息生命周期：从用户输入到LLM再返回"></a>消息生命周期：从用户输入到LLM再返回</h2><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TB
    <span class="token keyword">subgraph</span> <span class="token string">"Input Processing - 输入处理"</span>
        UserText<span class="token text string">[User Text Input - 用户文本输入]</span>
        SlashCmd<span class="token text string">["/command - 斜杠命令"]</span>
        BashCmd<span class="token text string">[!shell command - Shell命令]</span>
        MemoryCmd<span class="token text string">[#memory note - 内存笔记]</span>
        PastedContent<span class="token text string">[Pasted Image/Text - 粘贴的图片/文本]</span>

        UserText <span class="token arrow operator">--></span> NormalMessage<span class="token text string">[Create User CliMessage - 创建用户CliMessage]</span>
        SlashCmd <span class="token arrow operator">--></span> CommandProcessor<span class="token text string">[Process Command - 处理命令]</span>
        BashCmd <span class="token arrow operator">--></span> SyntheticTool<span class="token text string">[Synthetic BashTool Message - 合成BashTool消息]</span>
        MemoryCmd <span class="token arrow operator">--></span> MemoryUpdate<span class="token text string">[Update CLAUDE.md - 更新CLAUDE.md]</span>
        PastedContent <span class="token arrow operator">--></span> ContentDetection<span class="token text string">&#123;Detect Type - 检测类型&#125;</span>

        ContentDetection <span class="token arrow operator">--></span><span class="token label property">|Image|</span> ImageBlock<span class="token text string">[Create ImageBlock - 创建ImageBlock]</span>
        ContentDetection <span class="token arrow operator">--></span><span class="token label property">|Text|</span> TextBlock<span class="token text string">[Create TextBlock - 创建TextBlock]</span>
    <span class="token keyword">end</span>

    <span class="token keyword">subgraph</span> <span class="token string">"Message Transformation - 消息转换"</span>
        NormalMessage <span class="token arrow operator">--></span> StripMetadata<span class="token text string">[Remove CLI fields]</span>
        SyntheticTool <span class="token arrow operator">--></span> StripMetadata
        ImageBlock <span class="token arrow operator">--></span> StripMetadata
        TextBlock <span class="token arrow operator">--></span> StripMetadata

        StripMetadata <span class="token arrow operator">--></span> APIMessage<span class="token text string">[Clean API Message - 清洁的API消息]</span>
        APIMessage <span class="token arrow operator">--></span> TokenCount<span class="token text string">&#123;Count Tokens - 计算令牌数&#125;</span>

        TokenCount <span class="token arrow operator">--></span><span class="token label property">|Over Limit - 超过限制|</span> Compact<span class="token text string">[Compaction Process - 压缩过程]</span>
        TokenCount <span class="token arrow operator">--></span><span class="token label property">|Under Limit - 未超限|</span> Send<span class="token text string">[Send to LLM - 发送到LLM]</span>

        Compact <span class="token arrow operator">--></span> SummaryMessage<span class="token text string">[Summary Message - 摘要消息]</span>
        SummaryMessage <span class="token arrow operator">--></span> Send
    <span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/2.svg" class="">
<h3 id="The-CliMessage-Structure-More-Than-Meets-the-Eye"><a href="#The-CliMessage-Structure-More-Than-Meets-the-Eye" class="headerlink" title="The CliMessage Structure: More Than Meets the Eye"></a>The CliMessage Structure: More Than Meets the Eye</h3><h3 id="CliMessage结构：不仅仅是表面所见"><a href="#CliMessage结构：不仅仅是表面所见" class="headerlink" title="CliMessage结构：不仅仅是表面所见"></a>CliMessage结构：不仅仅是表面所见</h3><p>The <code>CliMessage</code> type serves as the central nervous system of the application:<br><code>CliMessage</code>类型作为应用程序的中枢神经系统：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">interface</span> <span class="token class-name">CliMessage</span> <span class="token punctuation">&#123;</span>
  type<span class="token operator">:</span> <span class="token string">"user"</span> <span class="token operator">|</span> <span class="token string">"assistant"</span> <span class="token operator">|</span> <span class="token string">"attachment"</span> <span class="token operator">|</span> <span class="token string">"progress"</span>  <span class="token comment">// 消息类型</span>
  uuid<span class="token operator">:</span> <span class="token builtin">string</span>                                           <span class="token comment">// 唯一标识符</span>
  timestamp<span class="token operator">:</span> <span class="token builtin">string</span>                                      <span class="token comment">// 时间戳</span>

  <span class="token comment">// For user/assistant messages only - 仅用于用户/助手消息</span>
  message<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    role<span class="token operator">:</span> <span class="token string">"user"</span> <span class="token operator">|</span> <span class="token string">"assistant"</span>                           <span class="token comment">// 角色</span>
    id<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>                    <span class="token comment">// LLM-provided ID - LLM提供的ID</span>
    model<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>                 <span class="token comment">// Which model responded - 响应的模型</span>
    stop_reason<span class="token operator">?</span><span class="token operator">:</span> StopReason       <span class="token comment">// Why generation stopped - 生成停止原因</span>
    stop_sequence<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>         <span class="token comment">// Specific stop sequence hit - 命中的特定停止序列</span>
    usage<span class="token operator">?</span><span class="token operator">:</span> TokenUsage             <span class="token comment">// Detailed token counts - 详细令牌计数</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span>                     <span class="token comment">// 内容</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// CLI-specific metadata - CLI特定元数据</span>
  costUSD<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>               <span class="token comment">// Calculated cost - 计算成本</span>
  durationMs<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>            <span class="token comment">// API call duration - API调用持续时间</span>
  requestId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>             <span class="token comment">// For debugging - 用于调试</span>
  isApiErrorMessage<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>    <span class="token comment">// Error display flag - 错误显示标志</span>
  isMeta<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>              <span class="token comment">// System-generated message - 系统生成消息</span>

  <span class="token comment">// Type-specific fields - 类型特定字段</span>
  attachment<span class="token operator">?</span><span class="token operator">:</span> AttachmentContent                         <span class="token comment">// 附件内容</span>
  progress<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    toolUseID<span class="token operator">:</span> <span class="token builtin">string</span>                                    <span class="token comment">// 工具使用ID</span>
    parentToolUseID<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>   <span class="token comment">// For AgentTool sub-tools - 用于AgentTool子工具</span>
    data<span class="token operator">:</span> <span class="token builtin">any</span>                  <span class="token comment">// Tool-specific progress - 工具特定进度</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Performance characteristics - 性能特征</span>
<span class="token keyword">interface</span> <span class="token class-name">CliMessagePerformance</span> <span class="token punctuation">&#123;</span>
  creation<span class="token operator">:</span> <span class="token string">"O(1)"</span><span class="token punctuation">,</span>                                     <span class="token comment">// 创建时间</span>
  serialization<span class="token operator">:</span> <span class="token string">"O(content size)"</span><span class="token punctuation">,</span>                      <span class="token comment">// 序列化时间</span>
  memoryRetention<span class="token operator">:</span> <span class="token string">"Weak references for large content"</span><span class="token punctuation">,</span>  <span class="token comment">// 大内容使用弱引用</span>
  garbageCollection<span class="token operator">:</span> <span class="token string">"Eligible when removed from history array"</span>  <span class="token comment">// 从历史数组移除时可回收</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Mutation-Points-and-State-Transitions"><a href="#Mutation-Points-and-State-Transitions" class="headerlink" title="Mutation Points and State Transitions"></a>Mutation Points and State Transitions</h3><h3 id="变异点和状态转换"><a href="#变异点和状态转换" class="headerlink" title="变异点和状态转换"></a>变异点和状态转换</h3><p>Claude Code carefully controls where data structures can be modified:<br>Claude Code仔细控制数据结构可以被修改的位置：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Inferred mutation control patterns - 推断的变异控制模式</span>
<span class="token keyword">class</span> <span class="token class-name">MessageMutationControl</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Mutation Point 1: Stream accumulation - 变异点1：流累积</span>
  <span class="token keyword">static</span> <span class="token function">accumulateStreamDelta</span><span class="token punctuation">(</span>
    message<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>CliMessage<span class="token operator">></span><span class="token punctuation">,</span>
    delta<span class="token operator">:</span> ContentBlockDelta
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delta<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'text_delta'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> lastBlock <span class="token operator">=</span> message<span class="token punctuation">.</span>content<span class="token punctuation">[</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastBlock<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lastBlock<span class="token punctuation">.</span>text <span class="token operator">+=</span> delta<span class="token punctuation">.</span>text<span class="token punctuation">;</span>  <span class="token comment">// MUTATION - 变异</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Mutation Point 2: Tool result injection - 变异点2：工具结果注入</span>
  <span class="token keyword">static</span> <span class="token function">injectToolResult</span><span class="token punctuation">(</span>
    history<span class="token operator">:</span> CliMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    toolResult<span class="token operator">:</span> ToolResultBlock
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> newMessage<span class="token operator">:</span> CliMessage <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
      isMeta<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// System-generated - 系统生成</span>
      message<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        role<span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> <span class="token punctuation">[</span>toolResult<span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token comment">// ... other fields - 其他字段</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// MUTATION - 变异</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Mutation Point 3: Cost calculation - 变异点3：成本计算</span>
  <span class="token keyword">static</span> <span class="token function">updateCostMetadata</span><span class="token punctuation">(</span>
    message<span class="token operator">:</span> CliMessage<span class="token punctuation">,</span>
    usage<span class="token operator">:</span> TokenUsage
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
    message<span class="token punctuation">.</span>costUSD <span class="token operator">=</span> <span class="token function">calculateCost</span><span class="token punctuation">(</span>usage<span class="token punctuation">,</span> message<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// MUTATION - 变异</span>
    message<span class="token punctuation">.</span>durationMs <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">parseISO</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// MUTATION - 变异</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="The-System-Prompt-Dynamic-Context-Assembly"><a href="#The-System-Prompt-Dynamic-Context-Assembly" class="headerlink" title="The System Prompt: Dynamic Context Assembly"></a>The System Prompt: Dynamic Context Assembly</h2><h2 id="系统提示：动态上下文组装"><a href="#系统提示：动态上下文组装" class="headerlink" title="系统提示：动态上下文组装"></a>系统提示：动态上下文组装</h2><p>Perhaps the most complex data structure is the dynamically assembled system prompt:<br>也许最复杂的数据结构是动态组装的系统提示：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// System prompt assembly pipeline (reconstructed) - 系统提示组装管道（重构）</span>
<span class="token keyword">interface</span> <span class="token class-name">SystemPromptPipeline</span> <span class="token punctuation">&#123;</span>
  sources<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    baseInstructions<span class="token operator">:</span> <span class="token builtin">string</span>        <span class="token comment">// Static base - 静态基础</span>
    claudeMdContent<span class="token operator">:</span> ClaudeMdLayer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Hierarchical - 层次结构</span>
    gitContext<span class="token operator">:</span> GitContextData       <span class="token comment">// Real-time - 实时</span>
    directoryStructure<span class="token operator">:</span> TreeData     <span class="token comment">// Cached/fresh - 缓存/新鲜</span>
    toolDefinitions<span class="token operator">:</span> ToolSpec<span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// Available tools - 可用工具</span>
    modelAdaptations<span class="token operator">:</span> ModelSpecificPrompt <span class="token comment">// Per-model - 每个模型</span>
  <span class="token punctuation">&#125;</span>

  assembly<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    order<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'base'</span><span class="token punctuation">,</span> <span class="token string">'model'</span><span class="token punctuation">,</span> <span class="token string">'claude.md'</span><span class="token punctuation">,</span> <span class="token string">'git'</span><span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token string">'tools'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 组装顺序</span>
    separators<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span><span class="token punctuation">,</span>  <span class="token comment">// Section delimiters - 部分分隔符</span>
    sizeLimit<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>                <span class="token comment">// Token budget - 令牌预算</span>
    prioritization<span class="token operator">:</span> <span class="token string">'recency'</span> <span class="token operator">|</span> <span class="token string">'relevance'</span>  <span class="token comment">// 优先级策略</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// The GitContext structure reveals real-time awareness - GitContext结构揭示实时感知</span>
<span class="token keyword">interface</span> <span class="token class-name">GitContextData</span> <span class="token punctuation">&#123;</span>
  currentBranch<span class="token operator">:</span> <span class="token builtin">string</span>                             <span class="token comment">// 当前分支</span>
  status<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    modified<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>                              <span class="token comment">// 已修改文件</span>
    untracked<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>                             <span class="token comment">// 未跟踪文件</span>
    staged<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>                                <span class="token comment">// 已暂存文件</span>
  <span class="token punctuation">&#125;</span>
  recentCommits<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">&#123;</span>                            <span class="token comment">// 最近提交</span>
    hash<span class="token operator">:</span> <span class="token builtin">string</span>                                    <span class="token comment">// 哈希值</span>
    message<span class="token operator">:</span> <span class="token builtin">string</span>                                 <span class="token comment">// 提交消息</span>
    author<span class="token operator">:</span> <span class="token builtin">string</span>                                  <span class="token comment">// 作者</span>
    timestamp<span class="token operator">:</span> <span class="token builtin">string</span>                               <span class="token comment">// 时间戳</span>
  <span class="token punctuation">&#125;</span><span class="token operator">></span>
  uncommittedDiff<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>  <span class="token comment">// Expensive, conditional - 昂贵的，条件性的</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Memory-Layout-CLAUDE-md-Hierarchical-Loading"><a href="#Memory-Layout-CLAUDE-md-Hierarchical-Loading" class="headerlink" title="Memory Layout: CLAUDE.md Hierarchical Loading"></a>Memory Layout: <a target="_blank" rel="noopener" href="http://claude.md/">CLAUDE.md</a> Hierarchical Loading</h3><h3 id="内存布局：CLAUDE-md层次化加载"><a href="#内存布局：CLAUDE-md层次化加载" class="headerlink" title="内存布局：CLAUDE.md层次化加载"></a>内存布局：CLAUDE.md层次化加载</h3><pre class="line-numbers language-none"><code class="language-none">Project Root - 项目根目录
├── .claude&#x2F;
│   ├── CLAUDE.md (Local - highest priority - 本地 - 最高优先级)
│   └── settings.json
├── ~&#x2F;
│   └── .claude&#x2F;
│       └── CLAUDE.md (User - second priority - 用户 - 第二优先级)
├── &lt;project-root&gt;&#x2F;
│   └── .claude&#x2F;
│       └── CLAUDE.md (Project - third priority - 项目 - 第三优先级)
└── &#x2F;etc&#x2F;claude-code&#x2F;
    └── CLAUDE.md (Managed - lowest priority - 托管 - 最低优先级)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The loading mechanism implements an efficient merge strategy:<br>加载机制实现了高效的合并策略：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Inferred CLAUDE.md loading algorithm - 推断的CLAUDE.md加载算法</span>
<span class="token keyword">class</span> <span class="token class-name">ClaudeMdLoader</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> mtime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">&#125;</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">loadMerged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> layers <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">'/etc/claude-code/CLAUDE.md'</span><span class="token punctuation">,</span>      <span class="token comment">// Managed - 托管</span>
      <span class="token string">'~/.claude/CLAUDE.md'</span><span class="token punctuation">,</span>              <span class="token comment">// User - 用户</span>
      <span class="token string">'&lt;project>/.claude/CLAUDE.md'</span><span class="token punctuation">,</span>      <span class="token comment">// Project - 项目</span>
      <span class="token string">'.claude/CLAUDE.md'</span>                 <span class="token comment">// Local - 本地</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      layers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>path <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadWithCache</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Merge with override semantics - 使用覆盖语义合并</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mergeWithOverrides</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">mergeWithOverrides</span><span class="token punctuation">(</span>contents<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Later layers override earlier ones - 后面的层覆盖前面的层</span>
    <span class="token comment">// @override directive for explicit overrides - @override指令用于显式覆盖</span>
    <span class="token comment">// @append directive for additions - @append指令用于添加</span>
    <span class="token comment">// Default: concatenate with separators - 默认：使用分隔符连接</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Tool-Related-Data-Structures"><a href="#Tool-Related-Data-Structures" class="headerlink" title="Tool-Related Data Structures"></a>Tool-Related Data Structures</h2><h2 id="工具相关数据结构"><a href="#工具相关数据结构" class="headerlink" title="工具相关数据结构"></a>工具相关数据结构</h2><h3 id="ToolDefinition-The-Complete-Tool-Interface"><a href="#ToolDefinition-The-Complete-Tool-Interface" class="headerlink" title="ToolDefinition: The Complete Tool Interface"></a>ToolDefinition: The Complete Tool Interface</h3><h3 id="ToolDefinition：完整的工具接口"><a href="#ToolDefinition：完整的工具接口" class="headerlink" title="ToolDefinition：完整的工具接口"></a>ToolDefinition：完整的工具接口</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">interface</span> <span class="token class-name">ToolDefinition</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Identity - 身份标识</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>                               <span class="token comment">// 工具名称</span>
  description<span class="token operator">:</span> <span class="token builtin">string</span>                        <span class="token comment">// 工具描述</span>
  prompt<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>  <span class="token comment">// Additional LLM instructions - 额外的LLM指令</span>

  <span class="token comment">// Schema (dual representation) - 模式（双重表示）</span>
  inputSchema<span class="token operator">:</span> ZodSchema          <span class="token comment">// Runtime validation - 运行时验证</span>
  inputJSONSchema<span class="token operator">?</span><span class="token operator">:</span> JSONSchema    <span class="token comment">// LLM communication - LLM通信</span>

  <span class="token comment">// Execution - 执行</span>
  call<span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span>ToolProgress <span class="token operator">|</span> ToolResult<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">></span>  <span class="token comment">// 异步生成器</span>

  <span class="token comment">// Permissions - 权限</span>
  checkPermissions<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> ToolUseContext<span class="token punctuation">,</span>
    permContext<span class="token operator">:</span> ToolPermissionContext
  <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>PermissionDecision<span class="token operator">></span>  <span class="token comment">// 权限决策</span>

  <span class="token comment">// Output formatting - 输出格式化</span>
  <span class="token function-variable function">mapToolResultToToolResultBlockParam</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    result<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    toolUseId<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span> <span class="token operator">=></span> ContentBlock <span class="token operator">|</span> ContentBlock<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment">// 内容块或块数组</span>

  <span class="token comment">// Metadata - 元数据</span>
  isReadOnly<span class="token operator">:</span> <span class="token builtin">boolean</span>                         <span class="token comment">// 是否只读</span>
  isMcp<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>                            <span class="token comment">// 是否MCP</span>
  isEnabled<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span>       <span class="token comment">// 启用函数</span>
  getPath<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>  <span class="token comment">// 路径获取函数</span>

  <span class="token comment">// UI - 用户界面</span>
  renderToolUseMessage<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=></span> ReactElement  <span class="token comment">// 渲染函数</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Memory characteristics of tool definitions - 工具定义的内存特征</span>
<span class="token keyword">interface</span> <span class="token class-name">ToolDefinitionMemory</span> <span class="token punctuation">&#123;</span>
  staticSize<span class="token operator">:</span> <span class="token string">"~2KB per tool"</span><span class="token punctuation">,</span>                    <span class="token comment">// 静态大小</span>
  zodSchema<span class="token operator">:</span> <span class="token string">"Lazy compilation, cached"</span><span class="token punctuation">,</span>          <span class="token comment">// 延迟编译，缓存</span>
  jsonSchema<span class="token operator">:</span> <span class="token string">"Generated once, memoized"</span><span class="token punctuation">,</span>         <span class="token comment">// 生成一次，记忆化</span>
  closures<span class="token operator">:</span> <span class="token string">"Retains context references"</span>          <span class="token comment">// 保留上下文引用</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="The-Execution-Context-Everything-a-Tool-Needs"><a href="#The-Execution-Context-Everything-a-Tool-Needs" class="headerlink" title="The Execution Context: Everything a Tool Needs"></a>The Execution Context: Everything a Tool Needs</h3><h3 id="执行上下文：工具所需的一切"><a href="#执行上下文：工具所需的一切" class="headerlink" title="执行上下文：工具所需的一切"></a>执行上下文：工具所需的一切</h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">interface</span> <span class="token class-name">ToolUseContext</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Cancellation - 取消机制</span>
  abortController<span class="token operator">:</span> AbortController                <span class="token comment">// 中止控制器</span>

  <span class="token comment">// File state tracking - 文件状态跟踪</span>
  readFileState<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                   <span class="token comment">// 读取文件状态</span>
    content<span class="token operator">:</span> <span class="token builtin">string</span>                              <span class="token comment">// 内容</span>
    timestamp<span class="token operator">:</span> <span class="token builtin">number</span>  <span class="token comment">// mtime - 修改时间</span>
  <span class="token punctuation">&#125;</span><span class="token operator">></span>

  <span class="token comment">// Permission resolution - 权限解析</span>
  <span class="token function-variable function">getToolPermissionContext</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> ToolPermissionContext  <span class="token comment">// 获取工具权限上下文</span>

  <span class="token comment">// Options bag - 选项包</span>
  options<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    tools<span class="token operator">:</span> ToolDefinition<span class="token punctuation">[</span><span class="token punctuation">]</span>                      <span class="token comment">// 工具定义列表</span>
    mainLoopModel<span class="token operator">:</span> <span class="token builtin">string</span>                        <span class="token comment">// 主循环模型</span>
    debug<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>                              <span class="token comment">// 调试模式</span>
    verbose<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>                            <span class="token comment">// 详细模式</span>
    isNonInteractiveSession<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>            <span class="token comment">// 非交互式会话</span>
    maxThinkingTokens<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>                   <span class="token comment">// 最大思考令牌数</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// MCP connections - MCP连接</span>
  mcpClients<span class="token operator">?</span><span class="token operator">:</span> McpClient<span class="token punctuation">[</span><span class="token punctuation">]</span>                       <span class="token comment">// MCP客户端数组</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// The permission context reveals a sophisticated security model - 权限上下文揭示了复杂的安全模型</span>
<span class="token keyword">interface</span> <span class="token class-name">ToolPermissionContext</span> <span class="token punctuation">&#123;</span>
  mode<span class="token operator">:</span> <span class="token string">"default"</span> <span class="token operator">|</span> <span class="token string">"acceptEdits"</span> <span class="token operator">|</span> <span class="token string">"bypassPermissions"</span>  <span class="token comment">// 模式</span>

  additionalWorkingDirectories<span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span>              <span class="token comment">// 额外工作目录</span>

  <span class="token comment">// Hierarchical rule system - 层次化规则系统</span>
  alwaysAllowRules<span class="token operator">:</span> Record<span class="token operator">&lt;</span>PermissionRuleScope<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token comment">// 始终允许规则</span>
  alwaysDenyRules<span class="token operator">:</span> Record<span class="token operator">&lt;</span>PermissionRuleScope<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token comment">// 始终拒绝规则</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> <span class="token class-name">PermissionRuleScope</span> <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token string">"cliArg"</span>         <span class="token comment">// Highest priority - 最高优先级</span>
  <span class="token operator">|</span> <span class="token string">"localSettings"</span>  <span class="token comment">// 本地设置</span>
  <span class="token operator">|</span> <span class="token string">"projectSettings"</span> <span class="token comment">// 项目设置</span>
  <span class="token operator">|</span> <span class="token string">"policySettings"</span> <span class="token comment">// 策略设置</span>
  <span class="token operator">|</span> <span class="token string">"userSettings"</span>   <span class="token comment">// Lowest priority - 最低优先级</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="MCP-Protocol-Structures"><a href="#MCP-Protocol-Structures" class="headerlink" title="MCP Protocol Structures"></a>MCP Protocol Structures</h2><h2 id="MCP协议结构"><a href="#MCP协议结构" class="headerlink" title="MCP协议结构"></a>MCP协议结构</h2><p>The Multi-Cloud/Process protocol reveals a sophisticated RPC system:<br>多云/进程协议揭示了一个复杂的RPC系统：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// JSON-RPC 2.0 with extensions - 带扩展的JSON-RPC 2.0</span>
<span class="token keyword">interface</span> <span class="token class-name">McpMessage</span> <span class="token punctuation">&#123;</span>
  jsonrpc<span class="token operator">:</span> <span class="token string">"2.0"</span>                               <span class="token comment">// 版本</span>
  id<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span>  <span class="token comment">// Optional for notifications - 通知的可选ID</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">interface</span> <span class="token class-name">McpRequest</span> <span class="token keyword">extends</span> <span class="token class-name">McpMessage</span> <span class="token punctuation">&#123;</span>
  method<span class="token operator">:</span> <span class="token builtin">string</span>                               <span class="token comment">// 方法名</span>
  params<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span>                             <span class="token comment">// 参数</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">interface</span> <span class="token class-name">McpResponse</span> <span class="token keyword">extends</span> <span class="token class-name">McpMessage</span> <span class="token punctuation">&#123;</span>
  id<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span>  <span class="token comment">// Required for responses - 响应必需的ID</span>
  result<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span>                             <span class="token comment">// 结果</span>
  error<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                                    <span class="token comment">// 错误</span>
    code<span class="token operator">:</span> <span class="token builtin">number</span>                               <span class="token comment">// 错误代码</span>
    message<span class="token operator">:</span> <span class="token builtin">string</span>                            <span class="token comment">// 错误消息</span>
    data<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span>                             <span class="token comment">// 错误数据</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Capability negotiation structure - 能力协商结构</span>
<span class="token keyword">interface</span> <span class="token class-name">McpCapabilities</span> <span class="token punctuation">&#123;</span>
  experimental<span class="token operator">?</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span>           <span class="token comment">// 实验性功能</span>

  <span class="token comment">// Feature flags - 功能标志</span>
  roots<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>      <span class="token comment">// Workspace roots - 工作区根目录</span>
  sampling<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>   <span class="token comment">// LLM sampling delegation - LLM采样委托</span>
  prompts<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>    <span class="token comment">// Dynamic prompts - 动态提示</span>
  resources<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>  <span class="token comment">// Resource serving - 资源服务</span>
  tools<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>      <span class="token comment">// Tool exposure - 工具暴露</span>
  logging<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>    <span class="token comment">// Log forwarding - 日志转发</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// The tool specification sent by MCP servers - MCP服务器发送的工具规范</span>
<span class="token keyword">interface</span> <span class="token class-name">McpToolSpec</span> <span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>                                 <span class="token comment">// 工具名称</span>
  description<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>                         <span class="token comment">// 工具描述</span>
  inputSchema<span class="token operator">:</span> JSONSchema  <span class="token comment">// Always JSON Schema - 始终是JSON模式</span>

  <span class="token comment">// MCP-specific metadata - MCP特定元数据</span>
  isReadOnly<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>                         <span class="token comment">// 是否只读</span>
  requiresConfirmation<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>               <span class="token comment">// 是否需要确认</span>
  timeout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>                             <span class="token comment">// 超时时间</span>
  maxRetries<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>                          <span class="token comment">// 最大重试次数</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="MCP-State-Machine"><a href="#MCP-State-Machine" class="headerlink" title="MCP State Machine"></a>MCP State Machine</h3><h3 id="MCP状态机"><a href="#MCP状态机" class="headerlink" title="MCP状态机"></a>MCP状态机</h3><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">stateDiagram-v2</span>
    <span class="token text string">[*]</span> <span class="token arrow operator">--></span> Disconnected - 断开连接
    Disconnected <span class="token arrow operator">--></span> Connecting<span class="token operator">:</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span> - 连接
    Connecting <span class="token arrow operator">--></span> Initializing<span class="token operator">:</span> transport ready - 传输就绪
    Initializing <span class="token arrow operator">--></span> Ready<span class="token operator">:</span> capabilities exchanged - 能力交换完成

    Ready <span class="token arrow operator">--></span> Ready<span class="token operator">:</span> request/response - 请求/响应
    Ready <span class="token arrow operator">--></span> Ready<span class="token operator">:</span> notification - 通知

    Ready <span class="token arrow operator">--></span> Closing<span class="token operator">:</span> close<span class="token punctuation">(</span><span class="token punctuation">)</span> - 关闭
    Connecting <span class="token arrow operator">--></span> Failed<span class="token operator">:</span> error - 错误
    Initializing <span class="token arrow operator">--></span> Failed<span class="token operator">:</span> negotiation failed - 协商失败

    Closing <span class="token arrow operator">--></span> Disconnected<span class="token operator">:</span> closed - 已关闭
    Failed <span class="token arrow operator">--></span> Disconnected<span class="token operator">:</span> reset - 重置
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/3.svg" class="">
<h2 id="Session-State-The-Global-Memory"><a href="#Session-State-The-Global-Memory" class="headerlink" title="Session State: The Global Memory"></a>Session State: The Global Memory</h2><h2 id="会话状态：全局内存"><a href="#会话状态：全局内存" class="headerlink" title="会话状态：全局内存"></a>会话状态：全局内存</h2><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">interface</span> <span class="token class-name">SessionState</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Identity - 身份</span>
  sessionId<span class="token operator">:</span> <span class="token builtin">string</span>  <span class="token comment">// UUID v4 - 会话ID</span>
  originalCwd<span class="token operator">:</span> <span class="token builtin">string</span>                          <span class="token comment">// 原始工作目录</span>
  cwd<span class="token operator">:</span> <span class="token builtin">string</span>  <span class="token comment">// Can change via bash cd - 当前工作目录（可通过bash cd改变）</span>

  <span class="token comment">// Cost tracking (mutable accumulator) - 成本跟踪（可变累加器）</span>
  totalCostUSD<span class="token operator">:</span> <span class="token builtin">number</span>                         <span class="token comment">// 总成本（美元）</span>
  totalAPIDuration<span class="token operator">:</span> <span class="token builtin">number</span>                     <span class="token comment">// API总持续时间</span>
  modelTokens<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 模型令牌记录</span>
    inputTokens<span class="token operator">:</span> <span class="token builtin">number</span>                        <span class="token comment">// 输入令牌数</span>
    outputTokens<span class="token operator">:</span> <span class="token builtin">number</span>                       <span class="token comment">// 输出令牌数</span>
    cacheReadInputTokens<span class="token operator">:</span> <span class="token builtin">number</span>               <span class="token comment">// 缓存读取输入令牌数</span>
    cacheCreationInputTokens<span class="token operator">:</span> <span class="token builtin">number</span>           <span class="token comment">// 缓存创建输入令牌数</span>
  <span class="token punctuation">&#125;</span><span class="token operator">></span>

  <span class="token comment">// Model selection - 模型选择</span>
  mainLoopModelOverride<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>               <span class="token comment">// 主循环模型覆盖</span>
  initialMainLoopModel<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>                <span class="token comment">// 初始主循环模型</span>

  <span class="token comment">// Activity metrics - 活动指标</span>
  sessionCounter<span class="token operator">:</span> <span class="token builtin">number</span>                       <span class="token comment">// 会话计数器</span>
  locCounter<span class="token operator">:</span> <span class="token builtin">number</span>      <span class="token comment">// Lines of code - 代码行数</span>
  prCounter<span class="token operator">:</span> <span class="token builtin">number</span>       <span class="token comment">// Pull requests - 拉取请求数</span>
  commitCounter<span class="token operator">:</span> <span class="token builtin">number</span>   <span class="token comment">// Git commits - Git提交数</span>

  <span class="token comment">// State flags - 状态标志</span>
  lastInteractionTime<span class="token operator">:</span> <span class="token builtin">number</span>                  <span class="token comment">// 最后交互时间</span>
  hasUnknownModelCost<span class="token operator">:</span> <span class="token builtin">boolean</span>                 <span class="token comment">// 是否有未知模型成本</span>
  maxRateLimitFallbackActive<span class="token operator">:</span> <span class="token builtin">boolean</span>          <span class="token comment">// 最大速率限制回退是否激活</span>

  <span class="token comment">// Available models - 可用模型</span>
  modelStrings<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>                       <span class="token comment">// 模型字符串数组</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Session state access pattern (inferred) - 会话状态访问模式（推断）</span>
<span class="token keyword">class</span> <span class="token class-name">SessionManager</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> state<span class="token operator">:</span> SessionState<span class="token punctuation">;</span>  <span class="token comment">// Singleton - 单例</span>

  <span class="token keyword">static</span> <span class="token generic-function"><span class="token function">update</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">K</span> <span class="token keyword">extends</span> <span class="token keyword">keyof</span> SessionState<span class="token operator">></span></span></span><span class="token punctuation">(</span>
    key<span class="token operator">:</span> <span class="token constant">K</span><span class="token punctuation">,</span>
    value<span class="token operator">:</span> SessionState<span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">persistToDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Async, non-blocking - 异步，非阻塞</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">static</span> <span class="token function">increment</span><span class="token punctuation">(</span>metric<span class="token operator">:</span> <span class="token keyword">keyof</span> SessionState<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">[</span>metric<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">[</span>metric<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Bidirectional-Streaming-Implementation"><a href="#Bidirectional-Streaming-Implementation" class="headerlink" title="Bidirectional Streaming Implementation"></a>Bidirectional Streaming Implementation</h2><h2 id="双向流实现"><a href="#双向流实现" class="headerlink" title="双向流实现"></a>双向流实现</h2><p>The platform-level streaming reveals a sophisticated protocol:<br>平台级别的流处理揭示了一个复杂的协议：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Bidirectional streaming payload structures - 双向流载荷结构</span>
<span class="token keyword">interface</span> <span class="token class-name">BidirectionalStreamingProtocol</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Client → Server - 客户端到服务器</span>
  clientPayload<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    bytes<span class="token operator">:</span> <span class="token builtin">string</span>  <span class="token comment">// Base64 encoded - Base64编码</span>
    encoding<span class="token operator">:</span> <span class="token string">'base64'</span>                        <span class="token comment">// 编码方式</span>

    <span class="token comment">// Decoded content types - 解码的内容类型</span>
    contentTypes<span class="token operator">:</span>
      <span class="token operator">|</span> ContinuedUserInput                    <span class="token comment">// 持续用户输入</span>
      <span class="token operator">|</span> ToolResultBlock                       <span class="token comment">// 工具结果块</span>
      <span class="token operator">|</span> ConversationTurnInput                 <span class="token comment">// 对话回合输入</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Server → Client - 服务器到客户端</span>
  serverPayload<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    bytes<span class="token operator">:</span> <span class="token builtin">string</span>  <span class="token comment">// Base64 encoded - Base64编码</span>
    encoding<span class="token operator">:</span> <span class="token string">'base64'</span>                        <span class="token comment">// 编码方式</span>

    <span class="token comment">// Decoded event types - 解码的事件类型</span>
    eventTypes<span class="token operator">:</span>
      <span class="token operator">|</span> ContentBlockDeltaEvent                <span class="token comment">// 内容块增量事件</span>
      <span class="token operator">|</span> ToolUseRequestEvent                   <span class="token comment">// 工具使用请求事件</span>
      <span class="token operator">|</span> ErrorEvent                            <span class="token comment">// 错误事件</span>
      <span class="token operator">|</span> MetadataEvent                         <span class="token comment">// 元数据事件</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// The streaming state machine for bidirectional flows - 双向流的流状态机</span>
<span class="token keyword">class</span> <span class="token class-name">BidirectionalStreamManager</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 文本编码器</span>
  <span class="token keyword">private</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 文本解码器</span>
  <span class="token keyword">private</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">65536</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 64KB buffer - 64KB缓冲区</span>

  async <span class="token operator">*</span><span class="token function">processStream</span><span class="token punctuation">(</span>stream<span class="token operator">:</span> ReadableStream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 流读取器</span>
    <span class="token keyword">let</span> partial <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>                         <span class="token comment">// 部分数据</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> done<span class="token punctuation">,</span> value <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token comment">// Decode and split by newlines (SSE format) - 解码并按换行符分割（SSE格式）</span>
      partial <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> lines <span class="token operator">=</span> partial<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      partial <span class="token operator">=</span> lines<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> line <span class="token keyword">of</span> lines<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'data: '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">yield</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">decodePayload</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">decodePayload</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> bytes <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>bytes<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Further decode based on protocol buffers or JSON - 基于协议缓冲区或JSON进一步解码</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Performance-Optimizations-in-Data-Structures"><a href="#Performance-Optimizations-in-Data-Structures" class="headerlink" title="Performance Optimizations in Data Structures"></a>Performance Optimizations in Data Structures</h2><h2 id="数据结构中的性能优化"><a href="#数据结构中的性能优化" class="headerlink" title="数据结构中的性能优化"></a>数据结构中的性能优化</h2><h3 id="1-String-Interning-for-Common-Values"><a href="#1-String-Interning-for-Common-Values" class="headerlink" title="1. String Interning for Common Values"></a>1. <strong>String Interning for Common Values</strong></h3><h3 id="1-常用值的字符串驻留"><a href="#1-常用值的字符串驻留" class="headerlink" title="1. 常用值的字符串驻留"></a>1. <strong>常用值的字符串驻留</strong></h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Inferred string interning pattern - 推断的字符串驻留模式</span>
<span class="token keyword">class</span> <span class="token class-name">StringIntern</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 字符串池</span>

  <span class="token keyword">static</span> <span class="token function">intern</span><span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Usage in message processing - 在消息处理中的使用</span>
message<span class="token punctuation">.</span>type <span class="token operator">=</span> StringIntern<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span>rawType<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 'user', 'assistant' etc - 用户、助手等</span>
message<span class="token punctuation">.</span>stop_reason <span class="token operator">=</span> StringIntern<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 'end_turn', 'tool_use' etc - 结束回合、工具使用等</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-Lazy-Content-Block-Parsing"><a href="#2-Lazy-Content-Block-Parsing" class="headerlink" title="2. Lazy Content Block Parsing"></a>2. <strong>Lazy Content Block Parsing</strong></h3><h3 id="2-延迟内容块解析"><a href="#2-延迟内容块解析" class="headerlink" title="2. 延迟内容块解析"></a>2. <strong>延迟内容块解析</strong></h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// Content blocks may use lazy parsing for performance - 内容块可以使用延迟解析来提高性能</span>
<span class="token keyword">class</span> <span class="token class-name">LazyContentBlock</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> _raw<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>                          <span class="token comment">// 原始数据</span>
  <span class="token keyword">private</span> _parsed<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>                         <span class="token comment">// 解析后的数据</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>raw<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_raw <span class="token operator">=</span> raw<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">get</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_parsed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_parsed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_parsed<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">parse</span><span class="token punctuation">(</span>raw<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Expensive parsing only when accessed - 只在访问时进行昂贵的解析</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-ReadFileState-Weak-References"><a href="#3-ReadFileState-Weak-References" class="headerlink" title="3. ReadFileState Weak References"></a>3. <strong>ReadFileState Weak References</strong></h3><h3 id="3-ReadFileState弱引用"><a href="#3-ReadFileState弱引用" class="headerlink" title="3. ReadFileState弱引用"></a>3. <strong>ReadFileState弱引用</strong></h3><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// File cache with automatic memory management - 带自动内存管理的文件缓存</span>
<span class="token keyword">class</span> <span class="token class-name">ReadFileState</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> WeakRef<span class="token operator">&lt;</span>FileContent<span class="token operator">>></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 文件内容缓存</span>
  <span class="token keyword">private</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizationRegistry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 终结注册表</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 删除缓存条目</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">set</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> content<span class="token operator">:</span> FileContent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 设置文件内容</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 创建弱引用</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 添加到缓存</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 注册到终结注册表</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">get</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> FileContent <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 获取文件内容</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 获取弱引用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 解引用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                           <span class="token comment">// 如果内容已被垃圾回收</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 从缓存中删除</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档深入分析了Claude Code的数据结构与消息架构，揭示了其高性能流式处理背后的技术实现。通过反编译和逆向工程分析，文档详细展示了Claude Code如何通过精心设计的数据结构来处理复杂的多层消息转换和流式协议。</p>
<h2 id="核心架构特点"><a href="#核心架构特点" class="headerlink" title="核心架构特点"></a>核心架构特点</h2><h3 id="1-流式状态机架构"><a href="#1-流式状态机架构" class="headerlink" title="1. 流式状态机架构"></a>1. 流式状态机架构</h3><ul>
<li><strong>三阶段表示系统</strong>：<ul>
<li>CLI内部表示（CliMessage）：包含UI元数据和跟踪信息</li>
<li>API线路格式（APIMessage）：与LLM通信的简洁格式</li>
<li>流累加器（StreamAccumulator）：处理增量数据的缓冲机制</li>
</ul>
</li>
<li><strong>优势</strong>：保持UI响应性同时处理复杂流式协议</li>
</ul>
<h3 id="2-多态内容块系统"><a href="#2-多态内容块系统" class="headerlink" title="2. 多态内容块系统"></a>2. 多态内容块系统</h3><ul>
<li><strong>ContentBlock联合类型</strong>：支持文本、图像、工具调用、结果等多种内容类型</li>
<li><strong>性能优化</strong>：不同内容块具有不同的内存特征和序列化特性</li>
<li><strong>流式支持</strong>：文本和工具块支持流式传输，图像块通过引用优化</li>
</ul>
<h3 id="3-流式JSON解析器"><a href="#3-流式JSON解析器" class="headerlink" title="3. 流式JSON解析器"></a>3. 流式JSON解析器</h3><ul>
<li><strong>智能解析</strong>：支持增量JSON块的解析，可自动修复未闭合字符串</li>
<li><strong>深度跟踪</strong>：通过JSON结构深度判断完整性</li>
<li><strong>字符串边界检测</strong>：精确跟踪字符串状态和转义字符</li>
</ul>
<h2 id="消息生命周期管理"><a href="#消息生命周期管理" class="headerlink" title="消息生命周期管理"></a>消息生命周期管理</h2><h3 id="输入处理管道"><a href="#输入处理管道" class="headerlink" title="输入处理管道"></a>输入处理管道</h3><ul>
<li><strong>多样化输入源</strong>：用户文本、斜杠命令、Shell命令、内存笔记、粘贴内容</li>
<li><strong>智能类型检测</strong>：自动识别输入内容类型并转换为相应格式</li>
<li><strong>消息转换</strong>：去除CLI特定字段，生成纯净的API消息</li>
</ul>
<h3 id="令牌管理策略"><a href="#令牌管理策略" class="headerlink" title="令牌管理策略"></a>令牌管理策略</h3><ul>
<li><strong>动态压缩</strong>：超过令牌限制时自动压缩历史消息</li>
<li><strong>成本控制</strong>：实时计算API调用成本和持续时间</li>
<li><strong>性能指标</strong>：详细的令牌使用统计和分析</li>
</ul>
<h2 id="CliMessage：中枢神经系统"><a href="#CliMessage：中枢神经系统" class="headerlink" title="CliMessage：中枢神经系统"></a>CliMessage：中枢神经系统</h2><h3 id="结构设计"><a href="#结构设计" class="headerlink" title="结构设计"></a>结构设计</h3><ul>
<li><strong>类型安全</strong>：支持用户、助手、附件、进度四种消息类型</li>
<li><strong>元数据丰富</strong>：包含成本、持续时间、请求ID等调试信息</li>
<li><strong>性能优化</strong>：大内容使用弱引用，从历史数组移除时可垃圾回收</li>
</ul>
<h3 id="变异控制机制"><a href="#变异控制机制" class="headerlink" title="变异控制机制"></a>变异控制机制</h3><ul>
<li><strong>三个变异点</strong>：<ol>
<li>流累积：增量构建文本内容</li>
<li>工具结果注入：添加系统生成的工具结果消息</li>
<li>成本计算：动态更新成本和时间元数据</li>
</ol>
</li>
</ul>
<h2 id="系统提示动态组装"><a href="#系统提示动态组装" class="headerlink" title="系统提示动态组装"></a>系统提示动态组装</h2><h3 id="多源数据集成"><a href="#多源数据集成" class="headerlink" title="多源数据集成"></a>多源数据集成</h3><ul>
<li><strong>基础指令</strong>：静态的系统级指令</li>
<li><strong>CLAUDE.md层次</strong>：支持本地、用户、项目、托管四个优先级</li>
<li><strong>实时上下文</strong>：Git状态、目录结构、可用工具</li>
<li><strong>模型适配</strong>：针对不同模型的特定提示</li>
</ul>
<h3 id="Git上下文实时感知"><a href="#Git上下文实时感知" class="headerlink" title="Git上下文实时感知"></a>Git上下文实时感知</h3><ul>
<li><strong>分支信息</strong>：当前分支状态和文件修改情况</li>
<li><strong>提交历史</strong>：最近的提交记录和作者信息</li>
<li><strong>差异分析</strong>：条件性的未提交差异计算</li>
</ul>
<h3 id="CLAUDE-md层次化加载"><a href="#CLAUDE-md层次化加载" class="headerlink" title="CLAUDE.md层次化加载"></a>CLAUDE.md层次化加载</h3><ul>
<li><strong>四级优先级</strong>：本地 &gt; 用户 &gt; 项目 &gt; 托管</li>
<li><strong>高效合并</strong>：覆盖语义、显式覆盖、添加指令</li>
<li><strong>缓存机制</strong>：文件修改时间检查和内容缓存</li>
</ul>
<h2 id="工具系统架构"><a href="#工具系统架构" class="headerlink" title="工具系统架构"></a>工具系统架构</h2><h3 id="ToolDefinition完整接口"><a href="#ToolDefinition完整接口" class="headerlink" title="ToolDefinition完整接口"></a>ToolDefinition完整接口</h3><ul>
<li><strong>双重模式</strong>：运行时Zod验证 + LLM通信JSON模式</li>
<li><strong>异步执行</strong>：支持进度更新的生成器模式</li>
<li><strong>权限系统</strong>：分层权限检查和决策机制</li>
<li><strong>输出格式化</strong>：工具结果到内容块的转换</li>
</ul>
<h3 id="执行上下文"><a href="#执行上下文" class="headerlink" title="执行上下文"></a>执行上下文</h3><ul>
<li><strong>取消机制</strong>：AbortController支持</li>
<li><strong>文件状态跟踪</strong>：读取文件的缓存和修改时间管理</li>
<li><strong>权限解析</strong>：多层次的权限规则系统</li>
<li><strong>选项配置</strong>：调试、详细模式、非交互会话等</li>
</ul>
<h3 id="权限安全模型"><a href="#权限安全模型" class="headerlink" title="权限安全模型"></a>权限安全模型</h3><ul>
<li><strong>五级规则范围</strong>：CLI参数 &gt; 本地设置 &gt; 项目设置 &gt; 策略设置 &gt; 用户设置</li>
<li><strong>模式控制</strong>：默认、接受编辑、绕过权限三种模式</li>
<li><strong>工作目录管理</strong>：额外的授权工作目录集合</li>
</ul>
<h2 id="MCP协议实现"><a href="#MCP协议实现" class="headerlink" title="MCP协议实现"></a>MCP协议实现</h2><h3 id="JSON-RPC-2-0扩展"><a href="#JSON-RPC-2-0扩展" class="headerlink" title="JSON-RPC 2.0扩展"></a>JSON-RPC 2.0扩展</h3><ul>
<li><strong>消息结构</strong>：统一的请求、响应、通知格式</li>
<li><strong>能力协商</strong>：工作区根目录、LLM采样、动态提示等功能</li>
<li><strong>工具规范</strong>：MCP特定的元数据和安全配置</li>
</ul>
<h3 id="状态机管理"><a href="#状态机管理" class="headerlink" title="状态机管理"></a>状态机管理</h3><ul>
<li><strong>连接生命周期</strong>：断开 → 连接 → 初始化 → 就绪 → 关闭</li>
<li><strong>错误处理</strong>：连接失败、协商失败的恢复机制</li>
<li><strong>双向通信</strong>：支持请求/响应和通知模式</li>
</ul>
<h2 id="会话状态管理"><a href="#会话状态管理" class="headerlink" title="会话状态管理"></a>会话状态管理</h2><h3 id="全局内存结构"><a href="#全局内存结构" class="headerlink" title="全局内存结构"></a>全局内存结构</h3><ul>
<li><strong>身份跟踪</strong>：会话ID、工作目录状态</li>
<li><strong>成本统计</strong>：USD成本、API持续时间、模型令牌详细统计</li>
<li><strong>活动指标</strong>：会话、代码行、拉取请求、提交计数器</li>
<li><strong>状态标志</strong>：最后交互时间、未知成本、速率限制状态</li>
</ul>
<h3 id="单例访问模式"><a href="#单例访问模式" class="headerlink" title="单例访问模式"></a>单例访问模式</h3><ul>
<li><strong>线程安全</strong>：静态单例状态管理</li>
<li><strong>持久化</strong>：异步非阻塞的磁盘持久化</li>
<li><strong>增量更新</strong>：支持单个字段的更新和计数器递增</li>
</ul>
<h2 id="双向流协议"><a href="#双向流协议" class="headerlink" title="双向流协议"></a>双向流协议</h2><h3 id="载荷结构设计"><a href="#载荷结构设计" class="headerlink" title="载荷结构设计"></a>载荷结构设计</h3><ul>
<li><strong>客户端到服务器</strong>：持续用户输入、工具结果、对话回合</li>
<li><strong>服务器到客户端</strong>：内容增量、工具请求、错误、元数据事件</li>
<li><strong>编码优化</strong>：Base64编码的紧凑载荷格式</li>
</ul>
<h3 id="流处理机制"><a href="#流处理机制" class="headerlink" title="流处理机制"></a>流处理机制</h3><ul>
<li><strong>SSE格式</strong>：服务器发送事件的标准化处理</li>
<li><strong>缓冲管理</strong>：64KB缓冲区和增量解码</li>
<li><strong>协议解析</strong>：多层数据解码和JSON提取</li>
</ul>
<h2 id="性能优化策略"><a href="#性能优化策略" class="headerlink" title="性能优化策略"></a>性能优化策略</h2><h3 id="1-字符串驻留"><a href="#1-字符串驻留" class="headerlink" title="1. 字符串驻留"></a>1. 字符串驻留</h3><ul>
<li><strong>内存优化</strong>：常用字符串的池化管理</li>
<li><strong>减少重复</strong>：消息类型、停止原因等重复值的复用</li>
<li><strong>快速比较</strong>：驻留字符串的指针比较</li>
</ul>
<h3 id="2-延迟解析"><a href="#2-延迟解析" class="headerlink" title="2. 延迟解析"></a>2. 延迟解析</h3><ul>
<li><strong>按需计算</strong>：内容块仅在访问时解析</li>
<li><strong>成本分摊</strong>：昂贵的JSON解析操作延迟到必要时</li>
<li><strong>内存效率</strong>：原始字符串和解析结果的智能管理</li>
</ul>
<h3 id="3-弱引用缓存"><a href="#3-弱引用缓存" class="headerlink" title="3. 弱引用缓存"></a>3. 弱引用缓存</h3><ul>
<li><strong>自动内存管理</strong>：文件内容的弱引用缓存</li>
<li><strong>垃圾回收友好</strong>：FinalizationRegistry自动清理</li>
<li><strong>内存安全</strong>：防止内存泄漏和悬挂引用</li>
</ul>
<h2 id="技术创新点"><a href="#技术创新点" class="headerlink" title="技术创新点"></a>技术创新点</h2><h3 id="架构创新"><a href="#架构创新" class="headerlink" title="架构创新"></a>架构创新</h3><ol>
<li><strong>三层消息表示</strong>：UI、API、流的清晰分离</li>
<li><strong>多态内容系统</strong>：统一接口处理多种内容类型</li>
<li><strong>动态系统提示</strong>：实时上下文的高效组装</li>
<li><strong>双向流协议</strong>：客户端和服务器的平等通信</li>
</ol>
<h3 id="性能创新"><a href="#性能创新" class="headerlink" title="性能创新"></a>性能创新</h3><ol>
<li><strong>智能JSON解析</strong>：增量解析和自动修复</li>
<li><strong>分层权限系统</strong>：灵活的安全控制机制</li>
<li><strong>内存优化策略</strong>：驻留、延迟、弱引用的组合使用</li>
<li><strong>缓存管理</strong>：多级缓存和自动失效机制</li>
</ol>
<h3 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h3><ol>
<li><strong>类型安全</strong>：TypeScript接口的全面应用</li>
<li><strong>错误处理</strong>：优雅的降级和恢复机制</li>
<li><strong>可观测性</strong>：丰富的元数据和调试信息</li>
<li><strong>扩展性</strong>：MCP协议和工具系统的模块化设计</li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Claude Code的数据结构与消息架构体现了现代软件工程的最佳实践，通过精心设计的数据结构实现了高性能的流式处理。其架构的核心价值在于：</p>
<ul>
<li><strong>性能卓越</strong>：多层次的优化确保了快速的响应时间</li>
<li><strong>架构清晰</strong>：清晰的职责分离和模块化设计</li>
<li><strong>扩展性强</strong>：灵活的工具系统和MCP协议支持</li>
<li><strong>用户友好</strong>：丰富的进度反馈和错误处理</li>
</ul>
<p>这种架构设计为处理复杂的AI交互场景提供了优秀的解决方案，特别是在需要实时响应和大量数据处理的场景中表现出色。文档的分析为理解现代AI应用的数据架构设计提供了宝贵的参考价值。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">寒霜</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://hanshuang-ai.github.io/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://hanshuang-ai.github.io/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/')">claude-code数据结构与消息架构</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://hanshuang-ai.github.io/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=claude-code数据结构与消息架构&amp;url=https://hanshuang-ai.github.io/2025/11/06/claude-code-shu-ju-jie-gou-yu-xiao-xi-jia-gou/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hanshuang-ai.github.io" target="_blank">我的博客</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/claude-code/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>claude-code<span class="tagsPageCount">17</span></a><a class="post-meta__box__tags" href="/tags/%E6%9E%B6%E6%9E%84/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>架构<span class="tagsPageCount">8</span></a><a class="post-meta__box__tags" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>数据结构<span class="tagsPageCount">2</span></a><a class="post-meta__box__tags" href="/tags/%E6%B6%88%E6%81%AF/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>消息<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/11/02/claude-code-todowrite-ti-shi-ci/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">claude-code-TodoWrite提示词</div></div></a></div><div class="next-post pull-right"><a href="/2025/11/07/claude-code-task-ti-shi-ci/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">claude-code-Task提示词</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/11/23/claude-code-router-wan-quan-fen-xi/" title="Claude Code Router完全分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">Claude Code Router完全分析</div></div></a></div><div><a href="/2025/10/31/claude-code-ji-chu-jia-gou/" title="claude-code基础架构"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code基础架构</div></div></a></div><div><a href="/2025/12/12/claude-code-gong-ju-yu-zhi-xing-yin-qing/" title="claude-code工具与执行引擎"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code工具与执行引擎</div></div></a></div><div><a href="/2025/12/16/claude-code-kong-zhi-liu-yu-bian-pai-yin-qing/" title="claude-code控制流与编排引擎"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code控制流与编排引擎</div></div></a></div><div><a href="/2025/12/13/claude-code-jia-gou-yin-qing-shi/" title="claude-code架构-引擎室"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code架构-引擎室</div></div></a></div><div><a href="/2025/11/08/claude-code-xin-ying-de-zu-jian/" title="claude-code新颖的组件"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-history fa-fw"></i> 2025-12-29</div><div class="title">claude-code新颖的组件</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Data-Structures-amp-The-Information-Architecture"><span class="toc-number">1.</span> <span class="toc-text">Data Structures &amp; The Information Architecture</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E4%BF%A1%E6%81%AF%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">数据结构与信息架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Streaming-State-Machine-How-Messages-Transform"><span class="toc-number">2.1.</span> <span class="toc-text">The Streaming State Machine: How Messages Transform</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E7%8A%B6%E6%80%81%E6%9C%BA%EF%BC%9A%E6%B6%88%E6%81%AF%E5%A6%82%E4%BD%95%E8%BD%AC%E6%8D%A2"><span class="toc-number">2.2.</span> <span class="toc-text">流式状态机：消息如何转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ContentBlock-The-Polymorphic-Building-Block"><span class="toc-number">2.3.</span> <span class="toc-text">ContentBlock: The Polymorphic Building Block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ContentBlock%EF%BC%9A%E5%A4%9A%E6%80%81%E6%9E%84%E5%BB%BA%E5%9D%97"><span class="toc-number">2.4.</span> <span class="toc-text">ContentBlock：多态构建块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Streaming-JSON-Challenge"><span class="toc-number">2.4.1.</span> <span class="toc-text">The Streaming JSON Challenge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E5%BC%8FJSON%E7%9A%84%E6%8C%91%E6%88%98"><span class="toc-number">2.4.2.</span> <span class="toc-text">流式JSON的挑战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Message-Lifecycle-From-User-Input-to-LLM-and-Back"><span class="toc-number">2.5.</span> <span class="toc-text">Message Lifecycle: From User Input to LLM and Back</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9A%E4%BB%8E%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E5%88%B0LLM%E5%86%8D%E8%BF%94%E5%9B%9E"><span class="toc-number">2.6.</span> <span class="toc-text">消息生命周期：从用户输入到LLM再返回</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-CliMessage-Structure-More-Than-Meets-the-Eye"><span class="toc-number">2.6.1.</span> <span class="toc-text">The CliMessage Structure: More Than Meets the Eye</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CliMessage%E7%BB%93%E6%9E%84%EF%BC%9A%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E8%A1%A8%E9%9D%A2%E6%89%80%E8%A7%81"><span class="toc-number">2.6.2.</span> <span class="toc-text">CliMessage结构：不仅仅是表面所见</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mutation-Points-and-State-Transitions"><span class="toc-number">2.6.3.</span> <span class="toc-text">Mutation Points and State Transitions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E5%BC%82%E7%82%B9%E5%92%8C%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2"><span class="toc-number">2.6.4.</span> <span class="toc-text">变异点和状态转换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-System-Prompt-Dynamic-Context-Assembly"><span class="toc-number">2.7.</span> <span class="toc-text">The System Prompt: Dynamic Context Assembly</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%EF%BC%9A%E5%8A%A8%E6%80%81%E4%B8%8A%E4%B8%8B%E6%96%87%E7%BB%84%E8%A3%85"><span class="toc-number">2.8.</span> <span class="toc-text">系统提示：动态上下文组装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Layout-CLAUDE-md-Hierarchical-Loading"><span class="toc-number">2.8.1.</span> <span class="toc-text">Memory Layout: CLAUDE.md Hierarchical Loading</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%EF%BC%9ACLAUDE-md%E5%B1%82%E6%AC%A1%E5%8C%96%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.8.2.</span> <span class="toc-text">内存布局：CLAUDE.md层次化加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tool-Related-Data-Structures"><span class="toc-number">2.9.</span> <span class="toc-text">Tool-Related Data Structures</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.10.</span> <span class="toc-text">工具相关数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ToolDefinition-The-Complete-Tool-Interface"><span class="toc-number">2.10.1.</span> <span class="toc-text">ToolDefinition: The Complete Tool Interface</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ToolDefinition%EF%BC%9A%E5%AE%8C%E6%95%B4%E7%9A%84%E5%B7%A5%E5%85%B7%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.10.2.</span> <span class="toc-text">ToolDefinition：完整的工具接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Execution-Context-Everything-a-Tool-Needs"><span class="toc-number">2.10.3.</span> <span class="toc-text">The Execution Context: Everything a Tool Needs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%9A%E5%B7%A5%E5%85%B7%E6%89%80%E9%9C%80%E7%9A%84%E4%B8%80%E5%88%87"><span class="toc-number">2.10.4.</span> <span class="toc-text">执行上下文：工具所需的一切</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MCP-Protocol-Structures"><span class="toc-number">2.11.</span> <span class="toc-text">MCP Protocol Structures</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MCP%E5%8D%8F%E8%AE%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.12.</span> <span class="toc-text">MCP协议结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MCP-State-Machine"><span class="toc-number">2.12.1.</span> <span class="toc-text">MCP State Machine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MCP%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">2.12.2.</span> <span class="toc-text">MCP状态机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session-State-The-Global-Memory"><span class="toc-number">2.13.</span> <span class="toc-text">Session State: The Global Memory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%8A%B6%E6%80%81%EF%BC%9A%E5%85%A8%E5%B1%80%E5%86%85%E5%AD%98"><span class="toc-number">2.14.</span> <span class="toc-text">会话状态：全局内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bidirectional-Streaming-Implementation"><span class="toc-number">2.15.</span> <span class="toc-text">Bidirectional Streaming Implementation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E5%90%91%E6%B5%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.16.</span> <span class="toc-text">双向流实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performance-Optimizations-in-Data-Structures"><span class="toc-number">2.17.</span> <span class="toc-text">Performance Optimizations in Data Structures</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%AD%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">2.18.</span> <span class="toc-text">数据结构中的性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-String-Interning-for-Common-Values"><span class="toc-number">2.18.1.</span> <span class="toc-text">1. String Interning for Common Values</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B8%B8%E7%94%A8%E5%80%BC%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A9%BB%E7%95%99"><span class="toc-number">2.18.2.</span> <span class="toc-text">1. 常用值的字符串驻留</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Lazy-Content-Block-Parsing"><span class="toc-number">2.18.3.</span> <span class="toc-text">2. Lazy Content Block Parsing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BB%B6%E8%BF%9F%E5%86%85%E5%AE%B9%E5%9D%97%E8%A7%A3%E6%9E%90"><span class="toc-number">2.18.4.</span> <span class="toc-text">2. 延迟内容块解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ReadFileState-Weak-References"><span class="toc-number">2.18.5.</span> <span class="toc-text">3. ReadFileState Weak References</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ReadFileState%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-number">2.18.6.</span> <span class="toc-text">3. ReadFileState弱引用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">文件总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E7%89%B9%E7%82%B9"><span class="toc-number">3.2.</span> <span class="toc-text">核心架构特点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%B5%81%E5%BC%8F%E7%8A%B6%E6%80%81%E6%9C%BA%E6%9E%B6%E6%9E%84"><span class="toc-number">3.2.1.</span> <span class="toc-text">1. 流式状态机架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A4%9A%E6%80%81%E5%86%85%E5%AE%B9%E5%9D%97%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.2.2.</span> <span class="toc-text">2. 多态内容块系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%B5%81%E5%BC%8FJSON%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">3.2.3.</span> <span class="toc-text">3. 流式JSON解析器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="toc-number">3.3.</span> <span class="toc-text">消息生命周期管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E5%A4%84%E7%90%86%E7%AE%A1%E9%81%93"><span class="toc-number">3.3.1.</span> <span class="toc-text">输入处理管道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A4%E7%89%8C%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number">3.3.2.</span> <span class="toc-text">令牌管理策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CliMessage%EF%BC%9A%E4%B8%AD%E6%9E%A2%E7%A5%9E%E7%BB%8F%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.4.</span> <span class="toc-text">CliMessage：中枢神经系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.4.1.</span> <span class="toc-text">结构设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E5%BC%82%E6%8E%A7%E5%88%B6%E6%9C%BA%E5%88%B6"><span class="toc-number">3.4.2.</span> <span class="toc-text">变异控制机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%E5%8A%A8%E6%80%81%E7%BB%84%E8%A3%85"><span class="toc-number">3.5.</span> <span class="toc-text">系统提示动态组装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%BA%90%E6%95%B0%E6%8D%AE%E9%9B%86%E6%88%90"><span class="toc-number">3.5.1.</span> <span class="toc-text">多源数据集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Git%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AE%9E%E6%97%B6%E6%84%9F%E7%9F%A5"><span class="toc-number">3.5.2.</span> <span class="toc-text">Git上下文实时感知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLAUDE-md%E5%B1%82%E6%AC%A1%E5%8C%96%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.5.3.</span> <span class="toc-text">CLAUDE.md层次化加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">3.6.</span> <span class="toc-text">工具系统架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ToolDefinition%E5%AE%8C%E6%95%B4%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.6.1.</span> <span class="toc-text">ToolDefinition完整接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">3.6.2.</span> <span class="toc-text">执行上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E5%AE%89%E5%85%A8%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.6.3.</span> <span class="toc-text">权限安全模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MCP%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.7.</span> <span class="toc-text">MCP协议实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON-RPC-2-0%E6%89%A9%E5%B1%95"><span class="toc-number">3.7.1.</span> <span class="toc-text">JSON-RPC 2.0扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%9C%BA%E7%AE%A1%E7%90%86"><span class="toc-number">3.7.2.</span> <span class="toc-text">状态机管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">3.8.</span> <span class="toc-text">会话状态管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="toc-number">3.8.1.</span> <span class="toc-text">全局内存结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.8.2.</span> <span class="toc-text">单例访问模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E5%90%91%E6%B5%81%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.9.</span> <span class="toc-text">双向流协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%BD%E8%8D%B7%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.9.1.</span> <span class="toc-text">载荷结构设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">3.9.2.</span> <span class="toc-text">流处理机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">3.10.</span> <span class="toc-text">性能优化策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A9%BB%E7%95%99"><span class="toc-number">3.10.1.</span> <span class="toc-text">1. 字符串驻留</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BB%B6%E8%BF%9F%E8%A7%A3%E6%9E%90"><span class="toc-number">3.10.2.</span> <span class="toc-text">2. 延迟解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%BC%B1%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98"><span class="toc-number">3.10.3.</span> <span class="toc-text">3. 弱引用缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%88%9B%E6%96%B0%E7%82%B9"><span class="toc-number">3.11.</span> <span class="toc-text">技术创新点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%88%9B%E6%96%B0"><span class="toc-number">3.11.1.</span> <span class="toc-text">架构创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%9B%E6%96%B0"><span class="toc-number">3.11.2.</span> <span class="toc-text">性能创新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.11.3.</span> <span class="toc-text">工程实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">3.12.</span> <span class="toc-text">结论</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/02/xiang-liang-shu-ju-ku/" title="向量数据库">向量数据库</a><time datetime="2025-12-29T10:57:24.518Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/11/da-mo-xing-he-ji/" title="大模型合集">大模型合集</a><time datetime="2025-12-29T10:57:24.509Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/18/claude-code-todoread-ti-shi-ci/" title="claude-code TodoRead提示词">claude-code TodoRead提示词</a><time datetime="2025-12-29T10:57:24.506Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/10/da-mo-xing-xun-lian-yu-you-hua-wan-quan-zhi-nan/" title="大模型训练与优化完全指南">大模型训练与优化完全指南</a><time datetime="2025-12-29T10:57:24.505Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/12/claude-code-gong-ju-yu-zhi-xing-yin-qing/" title="claude-code工具与执行引擎">claude-code工具与执行引擎</a><time datetime="2025-12-29T10:57:24.501Z" title="更新于 2025-12-29 18:57:24">2025-12-29</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 寒霜</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">145</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">385</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">9</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://hexo.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/ai%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">ai工具<sup>3</sup></a><a href="/tags/amd/" style="font-size: 0.88rem;">amd<sup>1</sup></a><a href="/tags/claude-code/" style="font-size: 0.88rem;">claude-code<sup>17</sup></a><a href="/tags/cmd/" style="font-size: 0.88rem;">cmd<sup>1</sup></a><a href="/tags/commonjs/" style="font-size: 0.88rem;">commonjs<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>11</sup></a><a href="/tags/deepseek/" style="font-size: 0.88rem;">deepseek<sup>1</sup></a><a href="/tags/dom/" style="font-size: 0.88rem;">dom<sup>4</sup></a><a href="/tags/flex/" style="font-size: 0.88rem;">flex<sup>2</sup></a><a href="/tags/go/" style="font-size: 0.88rem;">go<sup>1</sup></a><a href="/tags/golang/" style="font-size: 0.88rem;">golang<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>4</sup></a><a href="/tags/javascript/" style="font-size: 0.88rem;">javascript<sup>12</sup></a><a href="/tags/js/" style="font-size: 0.88rem;">js<sup>1</sup></a><a href="/tags/js%E8%A7%84%E8%8C%83/" style="font-size: 0.88rem;">js规范<sup>1</sup></a><a href="/tags/llm/" style="font-size: 0.88rem;">llm<sup>2</sup></a><a href="/tags/position/" style="font-size: 0.88rem;">position<sup>2</sup></a><a href="/tags/router/" style="font-size: 0.88rem;">router<sup>1</sup></a><a href="/tags/sdk/" style="font-size: 0.88rem;">sdk<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">中间件<sup>1</sup></a><a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" style="font-size: 0.88rem;">事件循环<sup>2</sup></a><a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 0.88rem;">入门<sup>1</sup></a><a href="/tags/%E5%88%86%E6%9E%90/" style="font-size: 0.88rem;">分析<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 0.88rem;">后端<sup>1</sup></a><a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/" style="font-size: 0.88rem;">响应式<sup>3</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">基础<sup>2</sup></a><a href="/tags/%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7/" style="font-size: 0.88rem;">实用技巧<sup>1</sup></a><a href="/tags/%E5%B8%83%E5%B1%80/" style="font-size: 0.88rem;">布局<sup>5</sup></a><a href="/tags/%E5%BC%B9%E6%80%A7%E7%9B%92%E5%AD%90/" style="font-size: 0.88rem;">弹性盒子<sup>1</sup></a><a href="/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">插件开发<sup>1</sup></a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">架构<sup>8</sup></a><a href="/tags/%E6%A0%87%E7%AD%BE/" style="font-size: 0.88rem;">标签<sup>1</sup></a><a href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/" style="font-size: 0.88rem;">模块化<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 0.88rem;">正则<sup>2</sup></a><a href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/" style="font-size: 0.88rem;">盒模型<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">编程语言<sup>1</sup></a><a href="/tags/%E7%BD%91%E6%A0%BC/" style="font-size: 0.88rem;">网格<sup>1</sup></a><a href="/tags/%E8%8A%82%E6%B5%81/" style="font-size: 0.88rem;">节流<sup>1</sup></a><a href="/tags/%E8%AF%AD%E4%B9%89%E5%8C%96/" style="font-size: 0.88rem;">语义化<sup>1</sup></a><a href="/tags/%E9%98%B2%E6%8A%96/" style="font-size: 0.88rem;">防抖<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.7.1",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 寒霜 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>